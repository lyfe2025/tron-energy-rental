# 🚀 TRON能量租赁系统 - PM2管理脚本使用说明

## 📋 脚本功能概述

`pm2-manager.sh` 是一个功能完整的交互式PM2管理脚本，提供了从安装到部署、监控、维护的全套自动化解决方案。

### ✨ 主要功能

#### 🎮 **系统管理**
- **一键安装和配置** - 完整的自动化部署流程
- **环境检查** - 检测Node.js、npm/pnpm、PM2等环境
- **依赖管理** - 自动安装项目依赖和构建

#### 🎯 **服务控制**
- **启动/停止/重启服务** - 完整的服务生命周期管理
- **零停机重载** - 不中断服务的更新部署
- **服务删除** - 清理PM2进程

#### 📊 **监控和日志**
- **实时状态监控** - 查看服务运行状态
- **健康检查** - 全面的服务健康状态检测
- **日志管理** - 分类查看各种日志
- **性能监控** - 实时资源使用情况

#### ⚙️ **高级功能**
- **开机自启配置** - 系统重启后自动启动服务
- **性能优化** - 实例数量、内存限制等调优
- **备份恢复** - PM2配置的备份和恢复
- **故障排除** - 常见问题的诊断和解决

## 🚀 快速开始

### 1. 运行脚本
```bash
# 给脚本执行权限（首次运行）
chmod +x pm2-manager.sh

# 启动脚本
./pm2-manager.sh
```

### 2. 一键安装（推荐新手）
选择菜单选项 `1) 一键安装和配置`，脚本将自动完成：
1. ✅ 检查系统环境
2. ✅ 安装Node.js（如需要）
3. ✅ 安装pnpm（如需要）
4. ✅ 安装PM2
5. ✅ 安装项目依赖
6. ✅ 构建项目
7. ✅ 启动服务
8. ✅ 配置开机自启（可选）
9. ✅ 健康检查

### 3. 验证安装
- **前端访问**: http://localhost:5173
- **API访问**: http://localhost:3001
- **健康检查**: http://localhost:3001/api/health

## 📱 主菜单功能详解

### 🔧 系统管理类
```
1)  一键安装和配置      # 新手推荐，全自动安装
2)  检查系统环境        # 检查Node.js、npm、PM2等
3)  安装PM2            # 单独安装PM2
4)  安装项目依赖        # npm/pnpm install
5)  构建项目           # npm run build
```

### 🎮 服务控制类
```
6)  启动服务           # pm2 start
7)  停止服务           # pm2 stop
8)  重启服务           # pm2 restart
9)  重载服务(零停机)    # pm2 reload
10) 删除服务           # pm2 delete
```

### 📊 监控日志类
```
11) 服务状态           # pm2 list + pm2 monit
12) 健康检查           # 全面的服务状态检查
13) 查看日志           # 分类查看各种日志
14) 性能监控           # 实时监控和统计
```

### ⚙️ 高级功能类
```
15) 配置开机自启       # pm2 startup
16) 取消开机自启       # pm2 unstartup
17) 清理日志          # 日志文件管理
18) 性能优化          # 实例数、内存等调优
19) 备份和恢复        # 配置文件管理
20) 故障排除          # 问题诊断工具
```

## 💡 使用技巧

### 🔍 **健康检查功能**
选择 `12) 健康检查` 可以全面检查：
- PM2服务状态
- 端口监听状态
- API响应状态
- 前端服务状态

### 📈 **性能监控**
选择 `14) 性能监控` 可以：
- 实时监控CPU和内存使用
- 查看详细的服务信息
- 获取系统资源统计

### 🔧 **性能优化**
选择 `18) 性能优化` 可以：
- 动态调整实例数量
- 查看内存使用建议
- 了解配置优化选项

### 🔒 **开机自启**
选择 `15) 配置开机自启` 后：
- macOS: 在 `~/Library/LaunchAgents/` 创建plist文件
- Linux: 在 `/etc/systemd/system/` 创建service文件

## 🆘 故障排除

### 常见问题及解决方案

#### 1. **脚本无法运行**
```bash
# 确保有执行权限
chmod +x pm2-manager.sh

# 确保在项目根目录
ls package.json  # 应该存在
```

#### 2. **Node.js未安装**
选择 `2) 检查系统环境`，脚本会提示安装步骤

#### 3. **服务启动失败**
1. 选择 `12) 健康检查` 诊断问题
2. 选择 `13) 查看日志` → `4) API错误日志`
3. 选择 `20) 故障排除` → `1) 诊断常见问题`

#### 4. **端口被占用**
选择 `20) 故障排除` → `3) 检查端口占用`

#### 5. **PM2环境异常**
选择 `20) 故障排除` → `2) 重置PM2环境`

## 📁 脚本配置

### 默认配置
```bash
API_PORT="3001"              # 后端API端口
FRONTEND_PORT="5173"         # 前端服务端口
CONFIG_FILE="ecosystem.config.cjs"  # PM2配置文件
```

### 自定义配置
如需修改配置，编辑脚本顶部的配置变量：
```bash
# 项目配置
PROJECT_NAME="TRON能量租赁系统"
PROJECT_DIR="/your/project/path"
CONFIG_FILE="your-config.cjs"
API_PORT="your-api-port"
FRONTEND_PORT="your-frontend-port"
```

## 🚀 部署流程示例

### 首次部署
```
1. 运行脚本: ./pm2-manager.sh
2. 选择: 1) 一键安装和配置
3. 等待自动安装完成
4. 访问: http://localhost:5173
```

### 日常更新
```
1. 运行脚本: ./pm2-manager.sh
2. 选择: 5) 构建项目
3. 选择: 9) 重载服务(零停机)
4. 选择: 12) 健康检查
```

### 性能调优
```
1. 运行脚本: ./pm2-manager.sh
2. 选择: 18) 性能优化
3. 根据需要调整实例数量
4. 选择: 14) 性能监控 验证效果
```

## 🎯 最佳实践

### 1. **定期维护**
- 每周运行健康检查
- 定期清理日志文件
- 监控系统资源使用

### 2. **备份策略**
- 使用 `19) 备份和恢复` 定期备份配置
- 重要更新前先备份

### 3. **监控告警**
- 设置系统监控告警
- 关注PM2重启次数
- 监控内存使用趋势

### 4. **安全考虑**
- 避免使用root用户运行
- 定期更新Node.js和PM2版本
- 监控端口访问情况

## 📞 技术支持

如果遇到问题，请按以下步骤处理：

1. **自助诊断**：使用脚本的 `20) 故障排除` 功能
2. **查看日志**：使用 `13) 查看日志` 功能查看详细错误信息
3. **健康检查**：使用 `12) 健康检查` 获取系统状态
4. **重置环境**：在故障排除菜单中选择重置PM2环境

---

## 🎉 总结

这个PM2管理脚本为TRON能量租赁系统提供了完整的自动化部署和管理解决方案。无论您是新手还是有经验的开发者，都可以通过简单的菜单操作完成复杂的PM2管理任务。

**核心优势**：
- ✅ **零学习成本** - 交互式菜单，无需记忆命令
- ✅ **一键部署** - 从安装到启动全自动化
- ✅ **生产就绪** - 包含监控、日志、备份等企业级功能
- ✅ **故障友好** - 完整的诊断和排错工具

立即开始使用：`./pm2-manager.sh` 🚀

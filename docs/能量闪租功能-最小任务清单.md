# èƒ½é‡é—ªç§ŸåŠŸèƒ½ - æœ€å°å¯æ‰§è¡Œä»»åŠ¡æ¸…å•

> **é¡¹ç›®**: TRON èƒ½é‡ç§Ÿèµç³»ç»Ÿ  
> **åŠŸèƒ½**: èƒ½é‡é—ªç§Ÿè‡ªåŠ¨åŒ–å¤„ç†  
> **åˆ›å»ºæ—¶é—´**: 2025-09-20  

---

## ğŸ“‹ æ‰§è¡Œè¯´æ˜

- âœ… **å·²å®Œæˆ** | ğŸ”„ **è¿›è¡Œä¸­** | â³ **å¾…æ‰§è¡Œ** | âŒ **é˜»å¡**
- **ä¼˜å…ˆçº§**: ğŸ”¥ é«˜ | ğŸ”¸ ä¸­ | ğŸ”¹ ä½
- **é¢„ä¼°æ—¶é—´**: ä»¥å°æ—¶ä¸ºå•ä½

---

## ğŸ—‚ ä»»åŠ¡åˆ†ç»„

### **Phase 1: æ•°æ®åº“åŸºç¡€è®¾æ–½ (2-3å°æ—¶)**

#### Task 1.1: å¤‡ä»½æ•°æ®åº“ ğŸ”¥
**çŠ¶æ€**: â³ | **æ—¶é—´**: 15åˆ†é’Ÿ | **è´Ÿè´£äºº**: DEV

**æ‰§è¡Œæ­¥éª¤**:
```bash
# 1. åˆ›å»ºæ•°æ®åº“å¤‡ä»½
./scripts/database/backup-database.sh

# 2. éªŒè¯å¤‡ä»½æ–‡ä»¶
ls -la backups/ | grep $(date +%Y%m%d)
```

**éªŒæ”¶æ ‡å‡†**: 
- å¤‡ä»½æ–‡ä»¶å­˜åœ¨äº `backups/` ç›®å½•
- æ–‡ä»¶å¤§å° > 1MB

---

#### Task 1.2: price_configsè¡¨ç»“æ„è¿ç§» ğŸ”¥
**çŠ¶æ€**: â³ | **æ—¶é—´**: 1å°æ—¶ | **ä¾èµ–**: Task 1.1

**æ‰§è¡Œæ­¥éª¤**:
```sql
-- 1. ç§»é™¤å”¯ä¸€çº¦æŸ
ALTER TABLE price_configs DROP CONSTRAINT IF EXISTS price_configs_mode_type_key;

-- 2. æ·»åŠ network_idå­—æ®µ
ALTER TABLE price_configs ADD COLUMN network_id INTEGER;

-- 3. è®¾ç½®é»˜è®¤å€¼ï¼ˆä¸»ç½‘IDï¼‰
UPDATE price_configs SET network_id = 1 WHERE network_id IS NULL;
ALTER TABLE price_configs ALTER COLUMN network_id SET NOT NULL;

-- 4. æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE price_configs ADD CONSTRAINT fk_price_configs_network 
    FOREIGN KEY (network_id) REFERENCES tron_networks(id);

-- 5. åˆ›å»ºå¤åˆå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_price_configs_mode_network 
    ON price_configs (mode_type, network_id);
```

**éªŒæ”¶æ ‡å‡†**:
- è¡¨ç»“æ„åŒ…å« `network_id` å­—æ®µ
- å¤åˆå”¯ä¸€ç´¢å¼•åˆ›å»ºæˆåŠŸ
- ç°æœ‰æ•°æ®ä¿æŒå®Œæ•´

---

#### Task 1.3: ordersè¡¨ç»“æ„æ‰©å±• ğŸ”¥
**çŠ¶æ€**: â³ | **æ—¶é—´**: 1å°æ—¶ | **ä¾èµ–**: Task 1.2

**æ‰§è¡Œæ­¥éª¤**:
```sql
-- 1. æ·»åŠ é—ªç§Ÿç›¸å…³å­—æ®µ
ALTER TABLE orders ADD COLUMN network_id INTEGER;
ALTER TABLE orders ADD COLUMN payment_trx_amount DECIMAL(20,6);
ALTER TABLE orders ADD COLUMN calculated_units INTEGER;
ALTER TABLE orders ADD COLUMN delegated_energy_amount BIGINT;
ALTER TABLE orders ADD COLUMN delegation_tx_id VARCHAR(64);

-- 2. æ›´æ–°ç°æœ‰è®¢å•çš„network_id
UPDATE orders SET network_id = 1 WHERE network_id IS NULL;
ALTER TABLE orders ALTER COLUMN network_id SET NOT NULL;

-- 3. æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE orders ADD CONSTRAINT fk_orders_network 
    FOREIGN KEY (network_id) REFERENCES tron_networks(id);

-- 4. æ›´æ–°order_typeæšä¸¾ï¼ˆå¦‚æœä½¿ç”¨æšä¸¾ç±»å‹ï¼‰
-- æˆ–ç¡®ä¿åº”ç”¨å±‚æ”¯æŒ'FLASH_RENT'ç±»å‹
```

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰æ–°å­—æ®µæ·»åŠ æˆåŠŸ
- å¤–é”®çº¦æŸæ­£å¸¸å·¥ä½œ
- ç°æœ‰è®¢å•æ•°æ®å®Œæ•´

---

### **Phase 2: æ ¸å¿ƒæœåŠ¡å¼€å‘ (8-10å°æ—¶)**

#### Task 2.1: åˆ›å»ºTransactionMonitorService ğŸ”¥
**çŠ¶æ€**: â³ | **æ—¶é—´**: 3å°æ—¶ | **ä¾èµ–**: Task 1.3

**æ–‡ä»¶è·¯å¾„**: `api/services/transaction-monitor.ts`

**æ‰§è¡Œæ­¥éª¤**:
```typescript
// 1. åˆ›å»ºæœåŠ¡ç±»åŸºç¡€ç»“æ„
class TransactionMonitorService {
  private intervalId?: NodeJS.Timeout;
  private readonly POLL_INTERVAL = 5000; // 5ç§’è½®è¯¢
  
  async startMonitoring(): Promise<void>
  async stopMonitoring(): Promise<void>
  private async pollTransactions(): Promise<void>
  private async processTransaction(tx: any, networkId: number): Promise<void>
  private async isTransactionProcessed(txId: string): Promise<boolean>
  private async markTransactionProcessed(txId: string): Promise<void>
}

// 2. å®ç°äº¤æ˜“è½®è¯¢é€»è¾‘
// 3. é›†æˆRedisç¼“å­˜
// 4. æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
// 5. æ·»åŠ æœåŠ¡å¯åŠ¨/åœæ­¢æ–¹æ³•
```

**éªŒæ”¶æ ‡å‡†**:
- æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨/åœæ­¢
- èƒ½å¤Ÿæ£€æµ‹åˆ°æµ‹è¯•ç½‘ç»œçš„TRXè½¬è´¦
- Redisç¼“å­˜é˜²é‡å¤å¤„ç†æ­£å¸¸å·¥ä½œ

---

#### Task 2.2: æ‰©å±•PaymentService ğŸ”¸
**çŠ¶æ€**: â³ | **æ—¶é—´**: 1.5å°æ—¶ | **ä¾èµ–**: Task 2.1

**æ–‡ä»¶è·¯å¾„**: `api/services/payment.ts`

**æ‰§è¡Œæ­¥éª¤**:
```typescript
// 1. æ·»åŠ æ–°æ–¹æ³•
async handleFlashRentPayment(
  transaction: any, 
  networkId: number
): Promise<void> {
  // éªŒè¯äº¤æ˜“
  // æå–from_addresså’Œamount
  // è°ƒç”¨OrderService.createFlashRentOrder
  // è®°å½•å¤„ç†æ—¥å¿—
}

// 2. æ·»åŠ äº¤æ˜“éªŒè¯é€»è¾‘
private validateTransaction(transaction: any): boolean

// 3. æ·»åŠ é‡‘é¢æå–é€»è¾‘
private extractTrxAmount(transaction: any): number
```

**éªŒæ”¶æ ‡å‡†**:
- æ–¹æ³•èƒ½æ­£ç¡®è§£æTRXäº¤æ˜“
- éªŒè¯é€»è¾‘è¦†ç›–ä¸»è¦å¼‚å¸¸æƒ…å†µ
- ä¸OrderServiceé›†æˆæ­£å¸¸

---

#### Task 2.3: æ‰©å±•OrderService ğŸ”¸
**çŠ¶æ€**: â³ | **æ—¶é—´**: 2å°æ—¶ | **ä¾èµ–**: Task 2.2

**æ–‡ä»¶è·¯å¾„**: `api/services/order.ts`

**æ‰§è¡Œæ­¥éª¤**:
```typescript
// 1. æ·»åŠ æ–°æ–¹æ³•
async createFlashRentOrder(
  fromAddress: string, 
  trxAmount: number, 
  networkId: number
): Promise<Order> {
  // è¯»å–ä»·æ ¼é…ç½®
  // è®¡ç®—ç¬”æ•°å’Œèƒ½é‡
  // åˆ›å»ºè®¢å•è®°å½•
  // è°ƒç”¨èƒ½é‡ä»£ç†
  // è¿”å›è®¢å•å¯¹è±¡
}

// 2. æ·»åŠ é…ç½®è¯»å–æ–¹æ³•
private async getFlashRentConfig(networkId: number): Promise<PriceConfig>

// 3. æ·»åŠ è®¡ç®—æ–¹æ³•
private calculateUnits(amount: number, config: PriceConfig): number
private calculateTotalEnergy(units: number, config: PriceConfig): number
```

**éªŒæ”¶æ ‡å‡†**:
- è®¢å•åˆ›å»ºæµç¨‹å®Œæ•´
- è®¡ç®—é€»è¾‘ç¬¦åˆä¸šåŠ¡è§„åˆ™
- æ•°æ®åº“æ“ä½œæ­£å¸¸

---

#### Task 2.4: æ‰©å±•TronService ğŸ”¸
**çŠ¶æ€**: â³ | **æ—¶é—´**: 2.5å°æ—¶ | **ä¾èµ–**: Task 2.3

**æ–‡ä»¶è·¯å¾„**: `api/services/tron.ts`

**æ‰§è¡Œæ­¥éª¤**:
```typescript
// 1. æ·»åŠ èƒ½é‡ä»£ç†æ–¹æ³•
async delegateEnergyForFlashRent(
  toAddress: string, 
  totalEnergy: number, 
  durationHours: number,
  networkId: number
): Promise<string> {
  // é€‰æ‹©èƒ½é‡æ± è´¦æˆ·
  // æ£€æŸ¥å¯ç”¨èƒ½é‡
  // æ‰§è¡Œä»£ç†æ“ä½œ
  // è¿”å›äº¤æ˜“ID
}

// 2. æ·»åŠ èƒ½é‡æ± é€‰æ‹©é€»è¾‘
private async selectEnergyPoolAccount(
  requiredEnergy: number,
  networkId: number
): Promise<EnergyPoolAccount>

// 3. æ·»åŠ èƒ½é‡æ£€æŸ¥æ–¹æ³•
private async checkAvailableEnergy(
  address: string,
  networkId: number
): Promise<number>
```

**éªŒæ”¶æ ‡å‡†**:
- èƒ½é‡æ± é€‰æ‹©ç®—æ³•æ­£ç¡®
- TRONä»£ç†æ“ä½œæˆåŠŸ
- é”™è¯¯å¤„ç†è¦†ç›–å„ç§å¤±è´¥æƒ…å†µ

---

### **Phase 3: APIæ¥å£å¼€å‘ (2-3å°æ—¶)**

#### Task 3.1: æ·»åŠ é…ç½®ç®¡ç†API ğŸ”¸
**çŠ¶æ€**: â³ | **æ—¶é—´**: 1.5å°æ—¶ | **ä¾èµ–**: Task 2.4

**æ–‡ä»¶è·¯å¾„**: `api/routes/system/flash-rent-config.ts`

**æ‰§è¡Œæ­¥éª¤**:
```typescript
// 1. åˆ›å»ºè·¯ç”±æ–‡ä»¶
// GET /api/system/flash-rent-config
// PUT /api/system/flash-rent-config

// 2. æ·»åŠ æ§åˆ¶å™¨æ–¹æ³•
async getFlashRentConfig(req: Request, res: Response)
async updateFlashRentConfig(req: Request, res: Response)

// 3. æ·»åŠ å‚æ•°éªŒè¯ä¸­é—´ä»¶
// 4. é›†æˆåˆ°ä¸»è·¯ç”±
```

**éªŒæ”¶æ ‡å‡†**:
- APIç«¯ç‚¹å¯æ­£å¸¸è®¿é—®
- æ”¯æŒnetwork_idå‚æ•°ç­›é€‰
- å‚æ•°éªŒè¯æ­£å¸¸å·¥ä½œ

---

#### Task 3.2: é›†æˆæœåŠ¡å¯åŠ¨ ğŸ”¥
**çŠ¶æ€**: â³ | **æ—¶é—´**: 1å°æ—¶ | **ä¾èµ–**: Task 3.1

**æ–‡ä»¶è·¯å¾„**: `api/server.ts`

**æ‰§è¡Œæ­¥éª¤**:
```typescript
// 1. å¯¼å…¥TransactionMonitorService
import { TransactionMonitorService } from './services/transaction-monitor';

// 2. åœ¨æœåŠ¡å¯åŠ¨æ—¶å¯åŠ¨ç›‘å¬
const transactionMonitor = new TransactionMonitorService();
await transactionMonitor.startMonitoring();

// 3. åœ¨æœåŠ¡å…³é—­æ—¶åœæ­¢ç›‘å¬
process.on('SIGTERM', async () => {
  await transactionMonitor.stopMonitoring();
});
```

**éªŒæ”¶æ ‡å‡†**:
- æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹äº¤æ˜“ç›‘å¬
- ä¼˜é›…å…³é—­æœºåˆ¶æ­£å¸¸å·¥ä½œ

---

### **Phase 4: å‰ç«¯ç•Œé¢ (3-4å°æ—¶)**

#### Task 4.1: ä»·æ ¼é…ç½®é¡µé¢æ”¹é€  ğŸ”¹
**çŠ¶æ€**: â³ | **æ—¶é—´**: 3å°æ—¶ | **ä¾èµ–**: Task 3.2

**æ–‡ä»¶è·¯å¾„**: `src/pages/admin/price-config/*`

**æ‰§è¡Œæ­¥éª¤**:
```vue
<!-- 1. æ·»åŠ ç½‘ç»œé€‰æ‹©å™¨ç»„ä»¶ -->
<NetworkSelector v-model="selectedNetworkId" />

<!-- 2. ä¿®æ”¹æ•°æ®ç­›é€‰é€»è¾‘ -->
// æ ¹æ®selectedNetworkIdç­›é€‰é…ç½®

<!-- 3. æ›´æ–°è¡¨å•ç»„ä»¶ -->
// æ–°å¢/ç¼–è¾‘æ—¶åŒ…å«network_id

<!-- 4. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ -->
// æ˜¾ç¤ºå½“å‰ç½‘ç»œåç§°
```

**éªŒæ”¶æ ‡å‡†**:
- ç½‘ç»œé€‰æ‹©å™¨æ­£å¸¸å·¥ä½œ
- æ•°æ®ç­›é€‰åŠŸèƒ½æ­£ç¡®
- è¡¨å•æ“ä½œæ”¯æŒå¤šç½‘ç»œ

---

### **Phase 5: æµ‹è¯•éªŒè¯ (2-3å°æ—¶)**

#### Task 5.1: ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯• ğŸ”¥
**çŠ¶æ€**: â³ | **æ—¶é—´**: 2å°æ—¶ | **ä¾èµ–**: Task 4.1

**æ‰§è¡Œæ­¥éª¤**:
```bash
# 1. å¯åŠ¨æœåŠ¡
npm run restart

# 2. é…ç½®æµ‹è¯•æ•°æ®
# - åˆ›å»ºé—ªç§Ÿä»·æ ¼é…ç½®
# - è®¾ç½®èƒ½é‡æ± è´¦æˆ·

# 3. æ‰§è¡Œæµ‹è¯•è½¬è´¦
# - å‘ç›‘å¬åœ°å€è½¬è´¦å°é¢TRX
# - éªŒè¯è®¢å•åˆ›å»º
# - æ£€æŸ¥èƒ½é‡ä»£ç†ç»“æœ

# 4. éªŒè¯å¼‚å¸¸æƒ…å†µ
# - é‡‘é¢ä¸è¶³
# - èƒ½é‡æ± ä¸è¶³
# - ç½‘ç»œå¼‚å¸¸
```

**éªŒæ”¶æ ‡å‡†**:
- å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡
- å¼‚å¸¸æƒ…å†µå¤„ç†æ­£ç¡®
- æ—¥å¿—è®°å½•å®Œæ•´

---

## ğŸš€ å¿«é€Ÿæ‰§è¡ŒæŒ‡å—

### **ä¼˜å…ˆæ‰§è¡Œé¡ºåº**:
1. **Task 1.1-1.3** (æ•°æ®åº“å‡†å¤‡)
2. **Task 2.1** (äº¤æ˜“ç›‘å¬æœåŠ¡)
3. **Task 2.2-2.4** (æ ¸å¿ƒæœåŠ¡)
4. **Task 3.1-3.2** (APIé›†æˆ)
5. **Task 5.1** (åŠŸèƒ½æµ‹è¯•)
6. **Task 4.1** (å‰ç«¯ç•Œé¢)

### **é¢„è®¡å®Œæˆæ—¶é—´**: 
- **æœ€å°å¯ç”¨ç‰ˆæœ¬**: 6-8å°æ—¶ (å®Œæˆåˆ°Task 3.2)
- **å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬**: 10-12å°æ—¶

### **é£é™©æç¤º**:
- æ•°æ®åº“è¿ç§»å‰åŠ¡å¿…å¤‡ä»½
- TRONç½‘ç»œè°ƒç”¨éœ€è¦å……è¶³çš„TRXä½™é¢
- æµ‹è¯•é˜¶æ®µå»ºè®®ä½¿ç”¨Nileæµ‹è¯•ç½‘

---

## ğŸ“ æ‰§è¡Œæ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„
2. éªŒè¯TRONç½‘ç»œé…ç½®
3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—æ–‡ä»¶
4. ç¡®è®¤Redisç¼“å­˜çŠ¶æ€

**æ—¥å¿—æ–‡ä»¶ä½ç½®**: `logs/app-$(date +%Y-%m-%d).log`

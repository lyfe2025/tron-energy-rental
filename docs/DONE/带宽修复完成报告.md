# ğŸ”§ èƒ½é‡æ± ç®¡ç†-è´¦æˆ·ç®¡ç†-å¸¦å®½æ˜¾ç¤ºä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°
èƒ½é‡æ± ç®¡ç†ä¸­çš„è´¦æˆ·ç®¡ç†é¡µé¢ï¼Œåœ¨æŸ¥çœ‹è¯¦æƒ…æ—¶æ˜¾ç¤ºçš„"å·²ä½¿ç”¨å¸¦å®½"å§‹ç»ˆä¸º0ï¼Œæ— æ³•æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·çš„å®é™…å¸¦å®½ä½¿ç”¨æƒ…å†µã€‚

## ğŸ” é—®é¢˜åˆ†æ

### åŸå› å®šä½
ç»è¿‡è¯¦ç»†åˆ†æï¼Œå‘ç°é—®é¢˜å‡ºç°åœ¨ `AccountService.ts` çš„ `getAccountResources` æ–¹æ³•ä¸­ï¼š

1. **å¸¦å®½è®¡ç®—é€»è¾‘é”™è¯¯**ï¼šåŸä»£ç åªè®¡ç®—äº†è´¨æŠ¼å¸¦å®½çš„ä½¿ç”¨æƒ…å†µï¼Œå¿½ç•¥äº†å…è´¹å¸¦å®½çš„ä½¿ç”¨
2. **TRON APIè¿”å›å­—æ®µç†è§£åå·®**ï¼šæ²¡æœ‰æ­£ç¡®å¤„ç† `freeNetUsed` å’Œ `NetUsed` å­—æ®µ
3. **å‰ç«¯ç±»å‹å®šä¹‰ç¼ºå¤±**ï¼šç¼ºå°‘è°ƒè¯•ä¿¡æ¯å­—æ®µçš„ç±»å‹æ”¯æŒ

### TRONå®˜æ–¹APIå­—æ®µè¯´æ˜
æ ¹æ® [TRONå®˜æ–¹æ–‡æ¡£](https://developers.tron.network/reference/getaccountresource)ï¼Œ`getAccountResource` æ¥å£è¿”å›çš„å…³é”®å­—æ®µï¼š

- `freeNetUsed`: å…è´¹å¸¦å®½å·²ä½¿ç”¨
- `freeNetLimit`: å…è´¹å¸¦å®½æ€»é¢ (é€šå¸¸ä¸º600)
- `NetUsed`: è´¨æŠ¼è·å¾—çš„å¸¦å®½å·²ä½¿ç”¨
- `NetLimit`: è´¨æŠ¼è·å¾—çš„å¸¦å®½æ€»é¢

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯ä¿®å¤ - AccountService.ts

**ä¿®å¤ä½ç½®**: `/api/services/tron/services/AccountService.ts`

**ä¸»è¦ä¿®æ”¹**:
```typescript
// ä¿®å¤å‰ï¼šåªè®¡ç®—è´¨æŠ¼å¸¦å®½ä½¿ç”¨
const netUsed = resources.NetUsed || 0;
const availableBandwidth = totalBandwidth - netUsed;

// ä¿®å¤åï¼šæ­£ç¡®è®¡ç®—æ€»å¸¦å®½ä½¿ç”¨
const freeNetUsed = resources.freeNetUsed || 0; // å…è´¹å¸¦å®½å·²ä½¿ç”¨
const stakedNetUsed = resources.NetUsed || 0; // è´¨æŠ¼å¸¦å®½å·²ä½¿ç”¨
const totalUsedBandwidth = freeNetUsed + stakedNetUsed; // æ€»å·²ä½¿ç”¨
const availableBandwidth = Math.max(0, totalBandwidth - totalUsedBandwidth);
```

**å¢åŠ è°ƒè¯•ä¿¡æ¯**:
```typescript
bandwidth: {
  used: totalUsedBandwidth, // æ€»å·²ä½¿ç”¨å¸¦å®½ï¼ˆå…è´¹+è´¨æŠ¼ï¼‰
  // ... å…¶ä»–å­—æ®µ
  freeUsed: freeNetUsed, // å…è´¹å¸¦å®½å·²ä½¿ç”¨
  stakedUsed: stakedNetUsed // è´¨æŠ¼å¸¦å®½å·²ä½¿ç”¨
}
```

### 2. ç±»å‹å®šä¹‰æ›´æ–°

**åç«¯ç±»å‹**: `/api/services/tron/types/tron.types.ts`
```typescript
bandwidth: {
  // ... ç°æœ‰å­—æ®µ
  freeUsed?: number; // å…è´¹å¸¦å®½å·²ä½¿ç”¨ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
  stakedUsed?: number; // è´¨æŠ¼å¸¦å®½å·²ä½¿ç”¨ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
}
```

**å‰ç«¯ç±»å‹**: `/src/composables/useRealTimeAccountData.ts`
```typescript
bandwidth: { 
  // ... ç°æœ‰å­—æ®µ
  freeUsed?: number // å…è´¹å¸¦å®½å·²ä½¿ç”¨ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
  stakedUsed?: number // è´¨æŠ¼å¸¦å®½å·²ä½¿ç”¨ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
}
```

### 3. å‰ç«¯æ˜¾ç¤ºä¼˜åŒ–

**ä¿®å¤ä½ç½®**: `/src/pages/EnergyPool/components/AccountDetailsModal.vue`

**æ–°å¢è¯¦ç»†æ˜¾ç¤º**:
```vue
<div class="text-center bg-red-50 p-2 rounded">
  <div class="font-semibold text-red-600">{{ formatBandwidth(bandwidth.used || 0) }}</div>
  <div class="text-red-700">å·²ä½¿ç”¨</div>
  <div v-if="bandwidth.freeUsed !== undefined" class="text-xs text-red-500 mt-1">
    å…è´¹: {{ formatBandwidth(bandwidth.freeUsed || 0) }}
    è´¨æŠ¼: {{ formatBandwidth(bandwidth.stakedUsed || 0) }}
  </div>
</div>
```

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. åç«¯APIæµ‹è¯•
```bash
# ç™»å½•è·å–token
curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tronrental.com","password":"admin123456"}'

# æµ‹è¯•å¸¦å®½æ•°æ®è·å–
curl -s -X POST "http://localhost:3001/api/energy-pool/accounts/validate-address" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"address":"TRON_ADDRESS","private_key":"","network_id":"NETWORK_ID"}'
```

### 2. å‰ç«¯æµ‹è¯•
1. å¯åŠ¨é¡¹ç›®ï¼š`npm run restart`
2. è®¿é—®èƒ½é‡æ± ç®¡ç†é¡µé¢
3. ç‚¹å‡»ä»»æ„è´¦æˆ·çš„"æŸ¥çœ‹è¯¦æƒ…"
4. è§‚å¯Ÿå¸¦å®½ä¿¡æ¯åŒºåŸŸï¼Œåº”èƒ½çœ‹åˆ°ï¼š
   - æ€»å·²ä½¿ç”¨å¸¦å®½æ•°å€¼ > 0ï¼ˆå¦‚æœè´¦æˆ·ç¡®å®æœ‰ä½¿ç”¨è®°å½•ï¼‰
   - å…è´¹å¸¦å®½ä½¿ç”¨æƒ…å†µ
   - è´¨æŠ¼å¸¦å®½ä½¿ç”¨æƒ…å†µ

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ å·²ä½¿ç”¨å¸¦å®½å§‹ç»ˆæ˜¾ç¤ºä¸º 0
- âŒ æ— æ³•åŒºåˆ†å…è´¹å¸¦å®½å’Œè´¨æŠ¼å¸¦å®½çš„ä½¿ç”¨æƒ…å†µ
- âŒ ç”¨æˆ·æ— æ³•äº†è§£çœŸå®çš„å¸¦å®½æ¶ˆè€—

### ä¿®å¤å
- âœ… æ­£ç¡®æ˜¾ç¤ºå®é™…å·²ä½¿ç”¨å¸¦å®½ï¼ˆå…è´¹ + è´¨æŠ¼ï¼‰
- âœ… æä¾›è¯¦ç»†çš„ä½¿ç”¨æƒ…å†µåˆ†è§£
- âœ… å¢åŠ è°ƒè¯•ä¿¡æ¯ä¾¿äºé—®é¢˜æ’æŸ¥
- âœ… ç¬¦åˆTRONå®˜æ–¹APIè§„èŒƒ

## ğŸ”„ éƒ¨ç½²æ­¥éª¤

1. **åœæ­¢æœåŠ¡**
   ```bash
   ps aux | grep -E 'tron-energy-rental|tsx.*server\.ts|vite.*5173' | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true
   ```

2. **éªŒè¯TypeScript**
   ```bash
   rm -rf node_modules/.cache && rm -rf dist && npm run check
   ```

3. **é‡å¯æœåŠ¡**
   ```bash
   npm run restart
   ```

## ğŸ“ å½±å“èŒƒå›´

**ä¿®æ”¹æ–‡ä»¶**:
- `/api/services/tron/services/AccountService.ts` - ä¸»è¦ä¿®å¤é€»è¾‘
- `/api/services/tron/types/tron.types.ts` - åç«¯ç±»å‹å®šä¹‰
- `/src/composables/useRealTimeAccountData.ts` - å‰ç«¯ç±»å‹å®šä¹‰
- `/src/pages/EnergyPool/components/AccountDetailsModal.vue` - å‰ç«¯æ˜¾ç¤ºä¼˜åŒ–

**å½±å“åŠŸèƒ½**:
- âœ… èƒ½é‡æ± è´¦æˆ·è¯¦æƒ…é¡µé¢çš„å¸¦å®½æ˜¾ç¤º
- âœ… TRONåœ°å€éªŒè¯æ¥å£çš„è¿”å›æ•°æ®
- âœ… æ‰€æœ‰ä¾èµ– `getAccountResources` çš„åŠŸèƒ½

**å…¼å®¹æ€§**:
- âœ… å®Œå…¨å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… æ–°å¢å­—æ®µä¸ºå¯é€‰å­—æ®µï¼Œä¸ç ´åç°æœ‰æ¥å£
- âœ… å‰ç«¯ä¼˜é›…é™çº§ï¼Œæ— æ–°å­—æ®µæ—¶æ­£å¸¸æ˜¾ç¤º

## ğŸ¯ ä¿®å¤çŠ¶æ€
- [x] é—®é¢˜åˆ†æå’Œå®šä½
- [x] åç«¯AccountServiceä¿®å¤
- [x] ç±»å‹å®šä¹‰æ›´æ–°ï¼ˆåç«¯+å‰ç«¯ï¼‰
- [x] å‰ç«¯æ˜¾ç¤ºé€»è¾‘ä¼˜åŒ–
- [x] TypeScriptç¼–è¯‘éªŒè¯
- [x] åŸºç¡€APIæµ‹è¯•éªŒè¯
- [x] ä¿®å¤æ–‡æ¡£ç¼–å†™

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

1. **ç›‘æ§å®Œå–„**: æ·»åŠ å¸¦å®½ä½¿ç”¨æƒ…å†µçš„ç›‘æ§å’Œå‘Šè­¦
2. **ç¼“å­˜ä¼˜åŒ–**: å¯¹é¢‘ç¹æŸ¥è¯¢çš„è´¦æˆ·èµ„æºä¿¡æ¯æ·»åŠ é€‚å½“ç¼“å­˜
3. **ç”¨æˆ·ä½“éªŒ**: å¢åŠ å¸¦å®½ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
4. **æ•°æ®éªŒè¯**: å®šæœŸéªŒè¯TRON APIæ•°æ®çš„å‡†ç¡®æ€§

---
**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´9æœˆ16æ—¥  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: AI Assistant  
**ç‰ˆæœ¬**: v1.0.1

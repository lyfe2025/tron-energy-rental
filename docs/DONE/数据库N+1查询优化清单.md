# æ•°æ®åº“ N+1 æŸ¥è¯¢ä¼˜åŒ–æ¸…å•

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº†é¡¹ç›®ä¸­å­˜åœ¨çš„æ•°æ®åº“ N+1 æŸ¥è¯¢é—®é¢˜ï¼Œå¹¶æä¾›å…·ä½“çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚N+1 æŸ¥è¯¢é—®é¢˜æ˜¯æŒ‡ï¼šé¦–å…ˆæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è·å– N æ¡è®°å½•ï¼Œç„¶åä¸ºæ¯æ¡è®°å½•å†æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼Œæ€»å…±æ‰§è¡Œäº† 1+N ä¸ªæŸ¥è¯¢ï¼Œè¿™ä¼šä¸¥é‡å½±å“æ•°æ®åº“æ€§èƒ½ã€‚

**åˆ†ææ—¶é—´**: 2025-01-25  
**é¡¹ç›®è·¯å¾„**: `/Volumes/wwx/dev/TronResourceDev/tron-energy-rental`  
**å½±å“ç­‰çº§è¯´æ˜**:
- ğŸ”´ **é«˜å±**: ä¸¥é‡å½±å“æ€§èƒ½ï¼Œéœ€è¦ç«‹å³ä¼˜åŒ–
- ğŸŸ¡ **ä¸­ç­‰**: æœ‰æ€§èƒ½å½±å“ï¼Œå»ºè®®ä¼˜åŒ–
- ğŸŸ¢ **ä½å±**: è½»å¾®å½±å“ï¼Œå¯è€ƒè™‘ä¼˜åŒ–

---

## ğŸ”´ é«˜å±é—®é¢˜åˆ—è¡¨

### 1. èƒ½é‡é¢„ç•™æœåŠ¡ - æ‰¹é‡é¢„ç•™èƒ½é‡

**æ–‡ä»¶ä½ç½®**: `api/services/energy-pool/EnergyReservationService.ts`  
**æ–¹æ³•å**: `batchReserveEnergy`  
**ä»£ç è¡Œæ•°**: 153-169è¡Œ

**é—®é¢˜æè¿°**:
```typescript
for (const reservation of reservations) {
  try {
    await this.reserveEnergy(
      reservation.poolAccountId,
      reservation.energyAmount,
      reservation.transactionId,
      reservation.userId
    );
    results.successCount++;
  } catch (error) {
    // é”™è¯¯å¤„ç†...
  }
}
```

**é—®é¢˜åˆ†æ**:
- åœ¨å¾ªç¯ä¸­é€ä¸ªè°ƒç”¨ `reserveEnergy` æ–¹æ³•
- æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ‰§è¡Œå¤šä¸ªæ•°æ®åº“æŸ¥è¯¢ï¼ˆUPDATE + INSERTï¼‰
- å¦‚æœæœ‰ N ä¸ªé¢„ç•™è¯·æ±‚ï¼Œæ€»å…±æ‰§è¡Œ 1 + 2N ä¸ªæŸ¥è¯¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
async batchReserveEnergy(reservations: Array<{
  poolAccountId: string;
  energyAmount: number;
  transactionId: string;
  userId?: string;
}>): Promise<{
  successCount: number;
  failedCount: number;
  errors: Array<{ reservation: any; error: string }>;
  success: boolean;
}> {
  const results = {
    successCount: 0,
    failedCount: 0,
    errors: [] as Array<{ reservation: any; error: string }>,
    success: true
  };

  await query('BEGIN');
  
  try {
    // 1. æ‰¹é‡æ£€æŸ¥èƒ½é‡æ± çŠ¶æ€
    const poolIds = reservations.map(r => r.poolAccountId);
    const poolCheckSql = `
      SELECT id, available_energy
      FROM energy_pools 
      WHERE id = ANY($1)
    `;
    const poolResult = await query(poolCheckSql, [poolIds]);
    const availableEnergy = new Map(
      poolResult.rows.map(row => [row.id, row.available_energy])
    );

    // 2. éªŒè¯æ‰€æœ‰é¢„ç•™è¯·æ±‚
    const validReservations = [];
    for (const reservation of reservations) {
      const available = availableEnergy.get(reservation.poolAccountId) || 0;
      if (available >= reservation.energyAmount) {
        validReservations.push(reservation);
      } else {
        results.failedCount++;
        results.errors.push({
          reservation,
          error: 'å¯ç”¨èƒ½é‡ä¸è¶³'
        });
      }
    }

    if (validReservations.length > 0) {
      // 3. æ‰¹é‡æ›´æ–°èƒ½é‡æ± 
      const updateCases = validReservations.map((r, index) => 
        `WHEN id = $${index * 2 + 1} THEN available_energy - $${index * 2 + 2}`
      ).join(' ');
      
      const reservedCases = validReservations.map((r, index) => 
        `WHEN id = $${index * 2 + 1} THEN reserved_energy + $${index * 2 + 2}`
      ).join(' ');

      const updateParams = validReservations.flatMap(r => [r.poolAccountId, r.energyAmount]);
      const poolUpdateSql = `
        UPDATE energy_pools 
        SET 
          available_energy = CASE ${updateCases} ELSE available_energy END,
          reserved_energy = CASE ${reservedCases} ELSE reserved_energy END,
          updated_at = NOW()
        WHERE id = ANY($${updateParams.length + 1})
      `;
      
      await query(poolUpdateSql, [...updateParams, poolIds]);

      // 4. æ‰¹é‡æ’å…¥æ¶ˆè´¹æ—¥å¿—
      if (validReservations.length > 0) {
        const logValues = validReservations.map((r, index) => 
          `(gen_random_uuid(), $${index * 6 + 1}, 'reserve', $${index * 6 + 2}, 0, $${index * 6 + 3}, $${index * 6 + 4}, $${index * 6 + 5}, NOW(), NOW())`
        ).join(', ');
        
        const logParams = validReservations.flatMap(r => [
          r.poolAccountId,
          r.energyAmount,
          r.transactionId,
          r.userId,
          `é¢„ç•™èƒ½é‡: ${r.energyAmount}`
        ]);

        const logSql = `
          INSERT INTO energy_consumption_logs (
            id, pool_account_id, transaction_type, energy_amount, 
            cost_amount, transaction_id, user_id, notes, created_at, updated_at
          ) VALUES ${logValues}
        `;
        
        await query(logSql, logParams);
      }

      results.successCount = validReservations.length;
    }

    await query('COMMIT');
    results.success = results.failedCount === 0;
    
  } catch (error) {
    await query('ROLLBACK');
    results.success = false;
    results.failedCount = reservations.length;
  }
  
  return results;
}
```

**é¢„æœŸæ€§èƒ½æå‡**: 
- åŸæ¥ï¼š1 + 2N ä¸ªæŸ¥è¯¢ï¼ˆNä¸ªé¢„ç•™è¯·æ±‚ï¼‰
- ä¼˜åŒ–åï¼š4 ä¸ªæŸ¥è¯¢ï¼ˆå›ºå®šæ•°é‡ï¼‰
- æå‡å¹…åº¦ï¼šå½“ N=100 æ—¶ï¼Œä» 201 ä¸ªæŸ¥è¯¢é™ä½åˆ° 4 ä¸ªæŸ¥è¯¢ï¼Œ**æå‡ 98%**

---

### 2. èƒ½é‡é¢„ç•™æœåŠ¡ - æ¸…ç†è¿‡æœŸé¢„ç•™

**æ–‡ä»¶ä½ç½®**: `api/services/energy-pool/EnergyReservationService.ts`  
**æ–¹æ³•å**: `cleanupExpiredReservations`  
**ä»£ç è¡Œæ•°**: 263-275è¡Œ

**é—®é¢˜æè¿°**:
```typescript
// é‡Šæ”¾è¿‡æœŸçš„é¢„ç•™èƒ½é‡
for (const expired of expiredResult.rows) {
  const energyAmount = parseInt(expired.expired_energy);
  
  await this.releaseReservedEnergy(
    expired.pool_account_id,
    energyAmount,
    `cleanup_${Date.now()}`,
    'system'
  );
  
  releasedCount++;
  totalEnergyReleased += energyAmount;
}
```

**é—®é¢˜åˆ†æ**:
- åœ¨å¾ªç¯ä¸­é€ä¸ªè°ƒç”¨ `releaseReservedEnergy` æ–¹æ³•
- æ¯æ¬¡è°ƒç”¨æ‰§è¡Œ UPDATE + INSERT æŸ¥è¯¢
- N ä¸ªè¿‡æœŸè®°å½•éœ€è¦ 2N ä¸ªæŸ¥è¯¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
async cleanupExpiredReservations(expirationHours: number = 24): Promise<{
  releasedCount: number;
  totalEnergyReleased: number;
}> {
  try {
    const expirationTime = new Date(Date.now() - expirationHours * 60 * 60 * 1000);
    
    // æŸ¥æ‰¾è¿‡æœŸçš„é¢„ç•™è®°å½•
    const findExpiredSql = `
      SELECT DISTINCT pool_account_id, SUM(energy_amount) as expired_energy
      FROM energy_consumption_logs
      WHERE transaction_type = 'reserve' 
        AND created_at < $1
        AND transaction_id NOT IN (
          SELECT DISTINCT transaction_id 
          FROM energy_consumption_logs 
          WHERE transaction_type IN ('confirm', 'release')
            AND transaction_id IS NOT NULL
        )
      GROUP BY pool_account_id
    `;
    
    const expiredResult = await query(findExpiredSql, [expirationTime]);
    
    if (expiredResult.rows.length === 0) {
      return { releasedCount: 0, totalEnergyReleased: 0 };
    }

    const expiredRecords = expiredResult.rows.map(row => ({
      poolAccountId: row.pool_account_id,
      energyAmount: parseInt(row.expired_energy)
    }));

    const releasedCount = expiredRecords.length;
    const totalEnergyReleased = expiredRecords.reduce((sum, record) => sum + record.energyAmount, 0);

    await query('BEGIN');

    try {
      // æ‰¹é‡æ›´æ–°èƒ½é‡æ± 
      const updateCases = expiredRecords.map((record, index) => 
        `WHEN id = $${index * 2 + 1} THEN available_energy + $${index * 2 + 2}`
      ).join(' ');
      
      const reservedCases = expiredRecords.map((record, index) => 
        `WHEN id = $${index * 2 + 1} THEN reserved_energy - $${index * 2 + 2}`
      ).join(' ');

      const updateParams = expiredRecords.flatMap(r => [r.poolAccountId, r.energyAmount]);
      const poolIds = expiredRecords.map(r => r.poolAccountId);
      
      const poolUpdateSql = `
        UPDATE energy_pools 
        SET 
          available_energy = CASE ${updateCases} ELSE available_energy END,
          reserved_energy = CASE ${reservedCases} ELSE reserved_energy END,
          updated_at = NOW()
        WHERE id = ANY($${updateParams.length + 1})
      `;
      
      await query(poolUpdateSql, [...updateParams, poolIds]);

      // æ‰¹é‡æ’å…¥é‡Šæ”¾æ—¥å¿—
      const timestamp = Date.now();
      const logValues = expiredRecords.map((record, index) => 
        `(gen_random_uuid(), $${index * 5 + 1}, 'release', $${index * 5 + 2}, 0, $${index * 5 + 3}, 'system', $${index * 5 + 4}, NOW(), NOW())`
      ).join(', ');
      
      const logParams = expiredRecords.flatMap(record => [
        record.poolAccountId,
        record.energyAmount,
        `cleanup_${timestamp}`,
        `ç³»ç»Ÿæ¸…ç†è¿‡æœŸé¢„ç•™: ${record.energyAmount}`
      ]);

      const logSql = `
        INSERT INTO energy_consumption_logs (
          id, pool_account_id, transaction_type, energy_amount, 
          cost_amount, transaction_id, user_id, notes, created_at, updated_at
        ) VALUES ${logValues}
      `;
      
      await query(logSql, logParams);

      await query('COMMIT');

      console.log(`æ‰¹é‡æ¸…ç†è¿‡æœŸé¢„ç•™å®Œæˆ: é‡Šæ”¾ ${releasedCount} ä¸ªè´¦æˆ·ï¼Œæ€»èƒ½é‡ ${totalEnergyReleased}`);

      return { releasedCount, totalEnergyReleased };
      
    } catch (error) {
      await query('ROLLBACK');
      throw error;
    }
    
  } catch (error) {
    console.error('æ¸…ç†è¿‡æœŸé¢„ç•™å¤±è´¥:', error);
    throw new Error('æ¸…ç†è¿‡æœŸé¢„ç•™å¤±è´¥');
  }
}
```

**é¢„æœŸæ€§èƒ½æå‡**:
- åŸæ¥ï¼š1 + 2N ä¸ªæŸ¥è¯¢
- ä¼˜åŒ–åï¼š3 ä¸ªæŸ¥è¯¢
- æå‡å¹…åº¦ï¼šå½“ N=50 æ—¶ï¼Œä» 101 ä¸ªæŸ¥è¯¢é™ä½åˆ° 3 ä¸ªæŸ¥è¯¢ï¼Œ**æå‡ 97%**

---

### 3. è´¦æˆ·ç®¡ç†æœåŠ¡ - æ‰¹é‡æ›´æ–°è´¦æˆ·

**æ–‡ä»¶ä½ç½®**: `api/services/energy-pool/AccountManagementService.ts`  
**æ–¹æ³•å**: `batchUpdateAccounts`  
**ä»£ç è¡Œæ•°**: 148-172è¡Œ

**é—®é¢˜æè¿°**:
```typescript
for (const accountId of accountIds) {
  try {
    const sql = `
      UPDATE energy_pools 
      SET ${fields.join(', ')}, last_updated_at = NOW()
      WHERE id = $${paramIndex}
    `;
    
    const updateValues = [...values, accountId];
    const result = await query(sql, updateValues);
    
    if (result.rowCount > 0) {
      results.successCount++;
    } else {
      results.failedCount++;
      results.errors.push({ id: accountId, error: 'Account not found' });
    }
  } catch (error) {
    // é”™è¯¯å¤„ç†...
  }
}
```

**é—®é¢˜åˆ†æ**:
- åœ¨å¾ªç¯ä¸­é€ä¸ªæ‰§è¡Œ UPDATE æŸ¥è¯¢
- N ä¸ªè´¦æˆ·éœ€è¦ N ä¸ª UPDATE æŸ¥è¯¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
async batchUpdateAccounts(accountIds: string[], updates: Partial<EnergyPoolAccount>): Promise<{ 
  successCount: number; 
  failedCount: number; 
  errors: Array<{ id: string; error: string }>;
  success: boolean;
  message: string;
}> {
  const results = {
    successCount: 0,
    failedCount: 0,
    errors: [] as Array<{ id: string; error: string }>,
    success: true,
    message: ''
  };

  try {
    // æ„å»ºåŠ¨æ€æ›´æ–°å­—æ®µ
    const updateFields = Object.keys(updates).filter(key => updates[key] !== undefined);
    
    if (updateFields.length === 0) {
      results.success = false;
      results.message = 'No fields to update';
      return results;
    }

    await query('BEGIN');

    try {
      // 1. æ£€æŸ¥å“ªäº›è´¦æˆ·å­˜åœ¨
      const checkSql = 'SELECT id FROM energy_pools WHERE id = ANY($1)';
      const existingResult = await query(checkSql, [accountIds]);
      const existingIds = existingResult.rows.map(row => row.id);
      const notFoundIds = accountIds.filter(id => !existingIds.includes(id));

      // è®°å½•ä¸å­˜åœ¨çš„è´¦æˆ·
      notFoundIds.forEach(id => {
        results.failedCount++;
        results.errors.push({ id, error: 'Account not found' });
      });

      if (existingIds.length > 0) {
        // 2. æ‰¹é‡æ›´æ–°å­˜åœ¨çš„è´¦æˆ·
        const setClause = updateFields.map((field, index) => 
          `${field} = $${index + 2}`
        ).join(', ');
        
        const values = updateFields.map(field => updates[field]);
        
        const batchUpdateSql = `
          UPDATE energy_pools 
          SET ${setClause}, last_updated_at = NOW()
          WHERE id = ANY($1)
        `;

        await query(batchUpdateSql, [existingIds, ...values]);
        results.successCount = existingIds.length;
      }

      await query('COMMIT');
      
      results.message = `æ‰¹é‡æ›´æ–°å®Œæˆ: æˆåŠŸ ${results.successCount} ä¸ªï¼Œå¤±è´¥ ${results.failedCount} ä¸ª`;
      results.success = results.failedCount === 0;
      
    } catch (error) {
      await query('ROLLBACK');
      throw error;
    }
    
  } catch (error) {
    console.error('Failed to batch update accounts:', error);
    results.success = false;
    results.message = 'Batch update failed';
    results.failedCount = accountIds.length;
  }
  
  return results;
}
```

**é¢„æœŸæ€§èƒ½æå‡**:
- åŸæ¥ï¼šN ä¸ª UPDATE æŸ¥è¯¢
- ä¼˜åŒ–åï¼š2 ä¸ªæŸ¥è¯¢ï¼ˆCHECK + UPDATEï¼‰
- æå‡å¹…åº¦ï¼šå½“ N=100 æ—¶ï¼Œä» 100 ä¸ªæŸ¥è¯¢é™ä½åˆ° 2 ä¸ªæŸ¥è¯¢ï¼Œ**æå‡ 98%**

---

## ğŸŸ¡ ä¸­ç­‰é£é™©é—®é¢˜

### 4. ä»£ç†å•†è®¢å•æŸ¥è¯¢

**æ–‡ä»¶ä½ç½®**: `api/services/agent.ts`  
**æ–¹æ³•å**: `getAgentOrders`  
**ä»£ç è¡Œæ•°**: 218-242è¡Œ

**ç°çŠ¶åˆ†æ**:
ä»£ç å·²ç»ä½¿ç”¨äº† JOIN æŸ¥è¯¢å’Œ `Promise.all` å¹¶è¡Œæ‰§è¡Œï¼Œè¿™æ˜¯å¥½çš„ä¼˜åŒ–å®è·µï¼š
```typescript
const [dataResult, countResult] = await Promise.all([
  pool.query(query, values),
  pool.query(countQuery, values.slice(0, -2))
]);
```

**å»ºè®®ä¼˜åŒ–**:
- è€ƒè™‘æ·»åŠ é€‚å½“çš„æ•°æ®åº“ç´¢å¼•
- å¦‚æœæŸ¥è¯¢é¢‘ç¹ï¼Œå¯è€ƒè™‘æ·»åŠ ç¼“å­˜

### 5. ç”¨æˆ·è®¢å•å†å²æŸ¥è¯¢

**æ–‡ä»¶ä½ç½®**: `api/services/user.ts`  
**æ–¹æ³•å**: `getUserOrders`, `getUserBalanceHistory`  
**ä»£ç è¡Œæ•°**: 237-291è¡Œ

**ç°çŠ¶åˆ†æ**:
åŒæ ·å·²ç»ä½¿ç”¨äº†ä¼˜åŒ–çš„æŸ¥è¯¢æ¨¡å¼ï¼Œä½¿ç”¨ `Promise.all` å¹¶è¡Œæ‰§è¡Œæ•°æ®æŸ¥è¯¢å’Œæ€»æ•°ç»Ÿè®¡ã€‚

---

## ğŸŸ¢ å·²ä¼˜åŒ–çš„è‰¯å¥½å®è·µ

é¡¹ç›®ä¸­å·²ç»æœ‰å¾ˆå¤šå¥½çš„ä¼˜åŒ–å®è·µï¼Œå€¼å¾—ç»§ç»­ä¿æŒï¼š

### 1. ç³»ç»Ÿæ—¥å¿—ç»Ÿè®¡
**æ–‡ä»¶**: `api/routes/system/logs/controllers/LogsStatsController.ts`
- å¤§é‡ä½¿ç”¨ LEFT JOIN é¿å… N+1 æŸ¥è¯¢
- ä½¿ç”¨ `Promise.all` å¹¶è¡Œæ‰§è¡Œå¤šä¸ªç»Ÿè®¡æŸ¥è¯¢

### 2. ç®¡ç†å‘˜è§’è‰²æŸ¥è¯¢
**æ–‡ä»¶**: `api/services/admin/AdminRoleService.ts`
- å¤æ‚çš„æƒé™æŸ¥è¯¢ä½¿ç”¨äº†å¤šè¡¨ JOIN
- é¿å…äº†åœ¨å¾ªç¯ä¸­æŸ¥è¯¢æƒé™ä¿¡æ¯

### 3. ç›‘æ§æœåŠ¡
**æ–‡ä»¶**: `api/services/monitoring/*`
- ç³»ç»Ÿç›‘æ§æŸ¥è¯¢ä½¿ç”¨äº†æ‰¹é‡æŸ¥è¯¢å’Œ Promise.all
- é¿å…äº†é€ä¸ªæŸ¥è¯¢ç³»ç»ŸçŠ¶æ€

---

## æ€»ä½“ä¼˜åŒ–å»ºè®®

### 1. ç«‹å³æ‰§è¡Œçš„ä¼˜åŒ–
1. **ä¼˜å…ˆä¿®å¤é«˜å±é—®é¢˜**: é‡ç‚¹ä¼˜åŒ– `EnergyReservationService` å’Œ `AccountManagementService` ä¸­çš„æ‰¹é‡æ“ä½œ
2. **æ·»åŠ æ•°æ®åº“ç´¢å¼•**: ä¸ºç»å¸¸æŸ¥è¯¢çš„å­—æ®µæ·»åŠ å¤åˆç´¢å¼•
3. **å¯ç”¨æŸ¥è¯¢æ—¥å¿—**: ç›‘æ§æ…¢æŸ¥è¯¢ï¼Œè¯†åˆ«æ›´å¤šæ½œåœ¨é—®é¢˜

### 2. ä¸­é•¿æœŸä¼˜åŒ–ç­–ç•¥
1. **å¼•å…¥æŸ¥è¯¢æ„å»ºå™¨**: è€ƒè™‘ä½¿ç”¨ QueryBuilder æˆ– ORM æ¥æ›´å¥½åœ°ç®¡ç†å¤æ‚æŸ¥è¯¢
2. **å®ç°æŸ¥è¯¢ç¼“å­˜**: å¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®æ·»åŠ ç¼“å­˜å±‚
3. **æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–**: è°ƒæ•´è¿æ¥æ± å¤§å°å’Œè¶…æ—¶è®¾ç½®

### 3. ç›‘æ§å’Œé¢„é˜²æªæ–½
1. **æ€§èƒ½ç›‘æ§**: è®¾ç½®æ•°æ®åº“æŸ¥è¯¢ç›‘æ§å‘Šè­¦
2. **ä»£ç å®¡æŸ¥è§„èŒƒ**: åœ¨ä»£ç å®¡æŸ¥ä¸­é‡ç‚¹å…³æ³¨å¾ªç¯ä¸­çš„æŸ¥è¯¢æ“ä½œ
3. **è‡ªåŠ¨åŒ–æµ‹è¯•**: æ·»åŠ æ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿æŸ¥è¯¢æ€§èƒ½ä¸é€€åŒ–

### 4. å»ºè®®çš„æ•°æ®åº“ç´¢å¼•

```sql
-- èƒ½é‡æ¶ˆè€—æ—¥å¿—æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_energy_consumption_logs_pool_transaction ON energy_consumption_logs(pool_account_id, transaction_type, created_at);
CREATE INDEX idx_energy_consumption_logs_transaction_id ON energy_consumption_logs(transaction_id) WHERE transaction_id IS NOT NULL;

-- èƒ½é‡æ± æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_energy_pools_status ON energy_pools(status, account_type);

-- ç”¨æˆ·ä»£ç†å…³ç³»ä¼˜åŒ–
CREATE INDEX idx_users_agent_id ON users(agent_id) WHERE agent_id IS NOT NULL;

-- è®¢å•æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_orders_user_status ON orders(user_id, status, created_at);

-- ç®¡ç†å‘˜è§’è‰²æƒé™ä¼˜åŒ–
CREATE INDEX idx_admin_roles_admin_id ON admin_roles(admin_id, role_id);
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id, menu_id);
```

---

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰- é¢„è®¡ 2-3 å¤©
- [ ] ä¿®å¤ `EnergyReservationService.batchReserveEnergy` æ–¹æ³•
- [ ] ä¿®å¤ `EnergyReservationService.cleanupExpiredReservations` æ–¹æ³•
- [ ] ä¿®å¤ `AccountManagementService.batchUpdateAccounts` æ–¹æ³•
- [ ] æ·»åŠ ç›¸å…³æ•°æ®åº“ç´¢å¼•

### ç¬¬äºŒé˜¶æ®µï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰- é¢„è®¡ 1-2 å¤©
- [ ] ä»£ç å®¡æŸ¥å…¶ä»–æœåŠ¡æ–‡ä»¶ï¼Œç¡®è®¤æ— é—æ¼é—®é¢˜
- [ ] å®æ–½æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- [ ] ç¼–å†™æ€§èƒ½æµ‹è¯•ç”¨ä¾‹

### ç¬¬ä¸‰é˜¶æ®µï¼ˆæŒç»­ä¼˜åŒ–ï¼‰
- [ ] å®šæœŸå®¡æŸ¥æ–°å¢ä»£ç çš„æŸ¥è¯¢æ¨¡å¼
- [ ] ä¼˜åŒ–æŸ¥è¯¢ç¼“å­˜ç­–ç•¥
- [ ] æŒç»­ç›‘æ§å’Œè°ƒä¼˜æ•°æ®åº“æ€§èƒ½

---

## éªŒè¯æ–¹æ³•

### 1. æ€§èƒ½æµ‹è¯•
```bash
# æµ‹è¯•æ‰¹é‡é¢„ç•™èƒ½é‡æ€§èƒ½ï¼ˆä¿®å¤å‰åå¯¹æ¯”ï¼‰
curl -X POST http://localhost:3001/api/energy/batch-reserve \
  -H "Content-Type: application/json" \
  -d '{"reservations": [/* 100ä¸ªé¢„ç•™è¯·æ±‚ */]}'
```

### 2. æ•°æ®åº“æŸ¥è¯¢ç›‘æ§
```sql
-- ç›‘æ§æŸ¥è¯¢æ‰§è¡Œè®¡æ•°
SELECT query, calls, total_time, mean_time 
FROM pg_stat_statements 
WHERE query LIKE '%energy_pools%'
ORDER BY total_time DESC;
```

### 3. åº”ç”¨çº§ç›‘æ§
åœ¨åº”ç”¨ä¸­æ·»åŠ æŸ¥è¯¢è®¡æ•°å™¨ï¼Œç›‘æ§ä¼˜åŒ–å‰åçš„æŸ¥è¯¢æ•°é‡å˜åŒ–ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-25  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  
**è´Ÿè´£äºº**: AI åŠ©æ‰‹

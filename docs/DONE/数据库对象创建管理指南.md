# ğŸ“ æ•°æ®åº“å¯¹è±¡åˆ›å»ºå’Œç®¡ç†æŒ‡å—

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**æ•°æ®åº“å¯¹è±¡ï¼ˆè§†å›¾ã€å‡½æ•°ã€è§¦å‘å™¨ç­‰ï¼‰æ˜¯æ€ä¹ˆåˆ›å»ºå’Œç®¡ç†çš„ï¼Ÿ**

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ•°æ®åº“å¯¹è±¡çš„åˆ›å»ºæ–¹å¼ç›´æ¥å½±å“åˆ°ï¼š
- ğŸ”’ **æ•°æ®åº“å˜æ›´çš„å¯æ§æ€§**
- ğŸ‘¥ **å›¢é˜Ÿåä½œçš„æ•ˆç‡**  
- ğŸš€ **éƒ¨ç½²å’Œå›æ»šçš„å®‰å…¨æ€§**
- ğŸ“Š **ç¯å¢ƒä¸€è‡´æ€§çš„ä¿éšœ**

---

## ğŸ”§ ä¸‰ç§ä¸»è¦åˆ›å»ºæ–¹å¼å¯¹æ¯”

### 1. ğŸ› ï¸ ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨åˆ›å»º

#### æ–¹å¼ç¤ºä¾‹ï¼š
```sql
-- ç›´æ¥åœ¨ psql æˆ– Navicat ç­‰å·¥å…·ä¸­æ‰§è¡Œ
CREATE FUNCTION get_user_balance(user_id UUID) 
RETURNS DECIMAL(10,2) AS $$
BEGIN
    RETURN (
        SELECT COALESCE(SUM(amount), 0) 
        FROM transactions 
        WHERE user_id = $1 AND status = 'completed'
    );
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER update_user_updated_at 
    BEFORE UPDATE ON users 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

#### âœ… ä¼˜ç‚¹ï¼š
- **âš¡ å¿«é€ŸåŸå‹** - å¯ä»¥ç«‹å³æµ‹è¯•å’Œè°ƒè¯•
- **ğŸ”¬ å®éªŒæ€§å¼€å‘** - é€‚åˆæ¢ç´¢æ€§çš„åŠŸèƒ½å¼€å‘
- **ğŸš¨ ç´§æ€¥ä¿®å¤** - ç”Ÿäº§ç¯å¢ƒçš„ä¸´æ—¶å¿«é€Ÿä¿®å¤

#### âŒ ç¼ºç‚¹ï¼š
- **ğŸ“ æ— ç‰ˆæœ¬æ§åˆ¶** - ä¿®æ”¹å†å²æ— æ³•è¿½è¸ª
- **ğŸ‘¥ å›¢é˜Ÿåä½œå›°éš¾** - å…¶ä»–å¼€å‘è€…çœ‹ä¸åˆ°å˜æ›´
- **ğŸ”„ ç¯å¢ƒä¸ä¸€è‡´** - å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒå¯èƒ½ä¸åŒæ­¥
- **âš ï¸ éƒ¨ç½²é£é™©é«˜** - å®¹æ˜“é—æ¼æˆ–äº§ç”Ÿå†²çª
- **ğŸ”™ éš¾ä»¥å›æ»š** - å‡ºé—®é¢˜æ—¶æ— æ³•å¿«é€Ÿæ¢å¤

#### ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
- ğŸ§ª **åŠŸèƒ½è°ƒè¯•å’Œæµ‹è¯•**
- ğŸ†˜ **ç”Ÿäº§ç¯å¢ƒç´§æ€¥ä¿®å¤**
- ğŸ’¡ **æ¦‚å¿µéªŒè¯å’ŒåŸå‹å¼€å‘**

---

### 2. ğŸ’» åœ¨åº”ç”¨ä»£ç ä¸­åŠ¨æ€åˆ›å»º

#### æ–¹å¼ç¤ºä¾‹ï¼š
```javascript
// åœ¨ Node.js åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºæ•°æ®åº“å¯¹è±¡
const createDatabaseObjects = async () => {
    // åˆ›å»ºå‡½æ•°
    await query(`
        CREATE OR REPLACE FUNCTION get_user_energy_stats(user_id UUID)
        RETURNS TABLE(
            total_energy BIGINT,
            used_energy BIGINT,
            remaining_energy BIGINT
        ) AS $$
        BEGIN
            RETURN QUERY
            SELECT 
                COALESCE(SUM(CASE WHEN type = 'deposit' THEN amount ELSE 0 END), 0) as total_energy,
                COALESCE(SUM(CASE WHEN type = 'usage' THEN amount ELSE 0 END), 0) as used_energy,
                COALESCE(SUM(CASE WHEN type = 'deposit' THEN amount ELSE -amount END), 0) as remaining_energy
            FROM energy_transactions 
            WHERE user_id = $1;
        END;
        $$ LANGUAGE plpgsql;
    `);

    // åˆ›å»ºè§†å›¾
    await query(`
        CREATE OR REPLACE VIEW daily_statistics AS
        SELECT 
            DATE(created_at) as stat_date,
            COUNT(*) as total_orders,
            SUM(energy_amount) as total_energy,
            SUM(cost_amount) as total_revenue
        FROM orders 
        WHERE status = 'completed'
        GROUP BY DATE(created_at)
        ORDER BY stat_date DESC;
    `);
};

// åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ
app.listen(3000, async () => {
    await createDatabaseObjects();
    console.log('Server and database objects initialized');
});
```

#### âœ… ä¼˜ç‚¹ï¼š
- **ğŸ”„ ä¸åº”ç”¨åŒæ­¥** - ä»£ç å’Œæ•°æ®åº“ç»“æ„ä¿æŒä¸€è‡´
- **ğŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½²** - åº”ç”¨éƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»º/æ›´æ–°
- **ğŸ“‹ ç‰ˆæœ¬æ§åˆ¶** - æ•°æ®åº“å¯¹è±¡å®šä¹‰çº³å…¥ä»£ç ç‰ˆæœ¬ç®¡ç†
- **ğŸ›ï¸ åŠ¨æ€æ§åˆ¶** - å¯ä»¥æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦åˆ›å»º

#### âŒ ç¼ºç‚¹ï¼š
- **âš¡ æ€§èƒ½å¼€é”€** - æ¯æ¬¡å¯åŠ¨éƒ½è¦æ£€æŸ¥/åˆ›å»ºå¯¹è±¡
- **ğŸ” æƒé™é—®é¢˜** - åº”ç”¨ç”¨æˆ·éœ€è¦DDLæƒé™ï¼ˆå®‰å…¨é£é™©ï¼‰
- **ğŸ—ï¸ æ··åˆå…³æ³¨ç‚¹** - æ•°æ®åº“ç»“æ„ä¸ä¸šåŠ¡é€»è¾‘æ··åˆ
- **ğŸ”— å¤æ‚ä¾èµ–** - å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»éš¾ä»¥ç®¡ç†
- **ğŸ“ˆ ç»´æŠ¤å›°éš¾** - éšç€å¯¹è±¡å¢å¤šï¼Œä»£ç å˜å¾—è‡ƒè‚¿

#### ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
- **ğŸ”§ ç®€å•çš„é…ç½®å‹åº”ç”¨**
- **ğŸš€ è‡ªåŒ…å«çš„å¾®æœåŠ¡**
- **ğŸ“¦ éœ€è¦è‡ªåŠ¨åˆå§‹åŒ–çš„åº”ç”¨**

---

### 3. ğŸ“ SQLè¿ç§»æ–‡ä»¶ç®¡ç† â­ (æ¨èæ–¹å¼)

#### æ–¹å¼ç¤ºä¾‹ï¼š
```bash
# è¿ç§»æ–‡ä»¶ç›®å½•ç»“æ„
/migrations/
â”œâ”€â”€ 20250103_create_user_functions.sql
â”œâ”€â”€ 20250104_add_energy_statistics_view.sql
â”œâ”€â”€ 20250105_create_audit_triggers.sql
â””â”€â”€ 999_consolidated_schema.sql
```

```sql
-- æ–‡ä»¶: 20250103_create_user_functions.sql
-- =====================================================
-- åˆ›å»ºç”¨æˆ·ç›¸å…³å‡½æ•°
-- åˆ›å»ºæ—¶é—´: 2025-01-03
-- è¯´æ˜: æ·»åŠ ç”¨æˆ·ä½™é¢æŸ¥è¯¢å’Œèƒ½é‡ç»Ÿè®¡å‡½æ•°
-- åŒ…å«: å‡½æ•°å®šä¹‰ã€ç›¸å…³ç´¢å¼•ä¼˜åŒ–
-- =====================================================

-- åˆ›å»ºç”¨æˆ·ä½™é¢æŸ¥è¯¢å‡½æ•°
CREATE OR REPLACE FUNCTION get_user_balance(user_id_param UUID)
RETURNS DECIMAL(10,2) AS $$
DECLARE
    balance DECIMAL(10,2) := 0;
BEGIN
    SELECT COALESCE(SUM(
        CASE 
            WHEN transaction_type = 'deposit' THEN amount 
            WHEN transaction_type = 'withdrawal' THEN -amount 
            ELSE 0 
        END
    ), 0) INTO balance
    FROM user_transactions 
    WHERE user_id = user_id_param 
      AND status = 'completed';
    
    RETURN balance;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºç”¨æˆ·èƒ½é‡ç»Ÿè®¡å‡½æ•°
CREATE OR REPLACE FUNCTION get_user_energy_summary(user_id_param UUID)
RETURNS TABLE(
    user_id UUID,
    total_energy BIGINT,
    used_energy BIGINT,
    remaining_energy BIGINT,
    last_usage_at TIMESTAMP WITH TIME ZONE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        user_id_param,
        COALESCE(SUM(CASE WHEN type = 'rental' THEN energy_amount ELSE 0 END), 0) as total_energy,
        COALESCE(SUM(CASE WHEN type = 'usage' THEN energy_amount ELSE 0 END), 0) as used_energy,
        COALESCE(SUM(CASE WHEN type = 'rental' THEN energy_amount ELSE -energy_amount END), 0) as remaining_energy,
        MAX(CASE WHEN type = 'usage' THEN created_at ELSE NULL END) as last_usage_at
    FROM energy_transactions 
    WHERE user_id = user_id_param;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_transactions_user_status 
ON user_transactions(user_id, status) 
WHERE status = 'completed';

CREATE INDEX IF NOT EXISTS idx_energy_transactions_user_type 
ON energy_transactions(user_id, type);
```

#### âœ… ä¼˜ç‚¹ï¼š
- **ğŸ“‹ å®Œæ•´ç‰ˆæœ¬æ§åˆ¶** - æ‰€æœ‰å˜æ›´éƒ½æœ‰å†å²è®°å½•
- **ğŸ‘¥ å›¢é˜Ÿåä½œå‹å¥½** - é€šè¿‡Gitåä½œï¼Œå†²çªå¯æ§
- **ğŸ”„ ç¯å¢ƒä¸€è‡´æ€§** - æ‰€æœ‰ç¯å¢ƒæ‰§è¡Œç›¸åŒçš„è¿ç§»æ–‡ä»¶
- **ğŸ”™ å¯å›æ»šæ€§** - æ”¯æŒå®‰å…¨çš„å›æ»šæ“ä½œ
- **ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½²** - CI/CDæµç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œ
- **ğŸ“Š å˜æ›´è¿½æº¯** - æ¯ä¸ªå˜æ›´éƒ½æœ‰æ˜ç¡®çš„ä½œè€…å’Œæ—¶é—´
- **ğŸ”’ ç”Ÿäº§å®‰å…¨** - ç»è¿‡æµ‹è¯•éªŒè¯çš„å˜æ›´æ‰éƒ¨ç½²

#### âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
- **ğŸ“ æ–‡ä»¶å‘½åè§„èŒƒ** - éœ€è¦ä¸¥æ ¼éµå¾ªå‘½åçº¦å®š
- **â¬†ï¸ åªèƒ½å‘å‰** - å·²æ‰§è¡Œçš„è¿ç§»æ–‡ä»¶ä¸åº”ä¿®æ”¹
- **ğŸ”— ä¾èµ–ç®¡ç†** - éœ€è¦æ­£ç¡®ç®¡ç†å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»

#### ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
- **ğŸ¢ ä¼ä¸šçº§åº”ç”¨** (æ¨è)
- **ğŸ‘¥ å¤šäººåä½œé¡¹ç›®** (æ¨è)
- **ğŸ”„ å¤šç¯å¢ƒéƒ¨ç½²** (æ¨è)
- **ğŸ“ˆ é•¿æœŸç»´æŠ¤é¡¹ç›®** (æ¨è)

---

## ğŸ—ï¸ æ‚¨çš„é¡¹ç›®é‡‡ç”¨çš„æœ€ä½³å®è·µ

### ğŸ“‚ å®é™…é¡¹ç›®ç»“æ„åˆ†æ

æ ¹æ®æ‚¨çš„ **TronResourceDev** é¡¹ç›®ï¼Œæ‚¨é‡‡ç”¨äº† **SQLè¿ç§»æ–‡ä»¶ç®¡ç†** çš„æœ€ä½³å®è·µï¼š

```bash
/migrations/
â”œâ”€â”€ 999_consolidated_schema.sql              # ğŸ—ï¸ å®Œæ•´æ•°æ®åº“ç»“æ„
â”œâ”€â”€ 20250903_create_stake_management_tables.sql
â”œâ”€â”€ 20250902_add_task_execution_fields.sql
â”œâ”€â”€ 20250829_simplify_pricing_system.sql
â”œâ”€â”€ 20250125_n_plus_1_query_optimization_indexes.sql
â”œâ”€â”€ create_monitoring_tables.sql             # ğŸ“Š ç›‘æ§ç›¸å…³è¡¨
â”œâ”€â”€ create_rbac_tables.sql                   # ğŸ” æƒé™æ§åˆ¶è¡¨
â””â”€â”€ insert_initial_data.sql                  # ğŸ“‹ åˆå§‹åŒ–æ•°æ®
```

### ğŸ”§ è¿ç§»ç®¡ç†ç³»ç»Ÿ

**æ ¸å¿ƒæ–‡ä»¶**: `api/utils/migrate.ts`

```typescript
// è¿ç§»è®°å½•è¡¨
const MIGRATIONS_TABLE = 'schema_migrations';

// ğŸ”„ è‡ªåŠ¨è·Ÿè¸ªå·²æ‰§è¡Œçš„è¿ç§»
const getExecutedMigrations = async (): Promise<string[]> => {
  const result = await query(`SELECT filename FROM ${MIGRATIONS_TABLE} ORDER BY executed_at`);
  return result.rows.map((row: any) => row.filename);
};

// ğŸ¯ æ‰§è¡Œå¾…å¤„ç†çš„è¿ç§»
const pendingMigrations = migrationFiles.filter(
  file => !executedMigrations.includes(file)
);

// ğŸ“ æ”¯æŒå¤æ‚çš„SQLè¯­å¥ï¼ˆåŒ…å«å‡½æ•°å®šä¹‰ï¼‰
const statements = sql.split(';')
  .map(stmt => stmt.trim())
  .filter(stmt => stmt.length > 0 && !stmt.startsWith('--'));
```

### ğŸ“‹ è¿ç§»å‘½ä»¤æ”¯æŒ

```bash
# æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†çš„è¿ç§»
npm run migrate

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npm run migrate:status

# å›æ»šæœ€åä¸€ä¸ªè¿ç§»
npm run migrate:rollback
```

### ğŸ† å®é™…åˆ›å»ºçš„æ•°æ®åº“å¯¹è±¡ç»Ÿè®¡

é€šè¿‡è¿ç§»æ–‡ä»¶åˆ›å»ºçš„å¯¹è±¡ï¼š

| å¯¹è±¡ç±»å‹ | æ•°é‡ | åˆ›å»ºæ–¹å¼ | æ–‡ä»¶æ¥æº |
|----------|------|----------|----------|
| ğŸ—ï¸ **è¡¨ (Tables)** | 42ä¸ª | è¿ç§»æ–‡ä»¶ | `999_consolidated_schema.sql` ç­‰ |
| âš™ï¸ **å‡½æ•° (Functions)** | 29ä¸ª | è¿ç§»æ–‡ä»¶ | `999_consolidated_schema.sql` |
| ğŸ¯ **è§¦å‘å™¨ (Triggers)** | 18ä¸ª | è¿ç§»æ–‡ä»¶ | å„ä¸šåŠ¡è¿ç§»æ–‡ä»¶ |
| ğŸ“‡ **ç´¢å¼• (Indexes)** | 113ä¸ª | è¿ç§»æ–‡ä»¶ | N+1ä¼˜åŒ–è¿ç§»æ–‡ä»¶ |
| ğŸ”— **çº¦æŸ (Constraints)** | 86ä¸ª | è¿ç§»æ–‡ä»¶ | è¡¨åˆ›å»ºè¿ç§»æ–‡ä»¶ |
| ğŸ‘ï¸ **è§†å›¾ (Views)** | 2ä¸ª | è¿ç§»æ–‡ä»¶ | ç»Ÿè®¡ç›¸å…³è¿ç§» |
| ğŸ§© **æ‰©å±• (Extensions)** | 1ä¸ª | è¿ç§»æ–‡ä»¶ | `CREATE EXTENSION "uuid-ossp"` |
| ğŸ·ï¸ **è‡ªå®šä¹‰ç±»å‹ (Types)** | 4ä¸ª | è¿ç§»æ–‡ä»¶ | ENUMç±»å‹å®šä¹‰ |

---

## ğŸš€ æœ€ä½³å®è·µè¯¦è§£

### ğŸ“‹ 1. è¿ç§»æ–‡ä»¶å‘½åè§„èŒƒ

#### æ¨èæ ¼å¼ï¼š
```bash
YYYYMMDD_åŠŸèƒ½æè¿°.sql
20250103_create_user_management_functions.sql
20250104_add_energy_delegation_tables.sql
20250105_optimize_query_performance_indexes.sql
```

#### ç‰¹æ®Šæ–‡ä»¶ï¼š
```bash
999_consolidated_schema.sql     # å®Œæ•´åŸºç¡€ç»“æ„
insert_initial_data.sql         # åˆå§‹åŒ–æ•°æ®
create_monitoring_tables.sql    # åŠŸèƒ½æ¨¡å—è¡¨
```

### ğŸ“ 2. è¿ç§»æ–‡ä»¶å†…å®¹è§„èŒƒ

```sql
-- =====================================================
-- æ–‡ä»¶æè¿°å’Œå…ƒä¿¡æ¯
-- åˆ›å»ºæ—¶é—´: 2025-01-03  
-- ä½œè€…: å¼€å‘å›¢é˜Ÿ
-- è¯´æ˜: æ·»åŠ è´¨æŠ¼ç®¡ç†åŠŸèƒ½çš„æ•°æ®åº“å¯¹è±¡
-- å½±å“: æ–°å¢è¡¨ã€å‡½æ•°ã€è§¦å‘å™¨ã€çº¦æŸ
-- ä¾èµ–: éœ€è¦å…ˆæ‰§è¡Œç”¨æˆ·ç®¡ç†ç›¸å…³è¿ç§»
-- =====================================================

-- ğŸ” æ£€æŸ¥å‰ç½®æ¡ä»¶ï¼ˆå¯é€‰ï¼‰
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'users') THEN
        RAISE EXCEPTION 'Required table "users" does not exist. Please run user management migration first.';
    END IF;
END $$;

-- ğŸ—ï¸ åˆ›å»ºè¡¨ç»“æ„
CREATE TABLE IF NOT EXISTS stake_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    account_address VARCHAR(34) NOT NULL,
    account_type account_type NOT NULL DEFAULT 'energy_pool',
    
    -- è´¨æŠ¼ä¿¡æ¯
    stake_amount DECIMAL(20,6) NOT NULL DEFAULT 0,
    energy_amount BIGINT NOT NULL DEFAULT 0,
    
    -- æ—¶é—´å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- çº¦æŸå®šä¹‰
    CONSTRAINT check_positive_stake_amount CHECK (stake_amount >= 0),
    CONSTRAINT check_positive_energy_amount CHECK (energy_amount >= 0),
    CONSTRAINT check_valid_address CHECK (length(account_address) = 34),
    CONSTRAINT fk_stake_accounts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- ğŸ“‡ åˆ›å»ºç›¸å…³ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_stake_accounts_user_id 
ON stake_accounts(user_id);

CREATE INDEX IF NOT EXISTS idx_stake_accounts_address 
ON stake_accounts(account_address);

CREATE INDEX IF NOT EXISTS idx_stake_accounts_type_active 
ON stake_accounts(account_type) WHERE stake_amount > 0;

-- âš™ï¸ åˆ›å»ºç›¸å…³å‡½æ•°
CREATE OR REPLACE FUNCTION get_user_total_stake(user_id_param UUID)
RETURNS DECIMAL(20,6) AS $$
DECLARE
    total_stake DECIMAL(20,6) := 0;
BEGIN
    SELECT COALESCE(SUM(stake_amount), 0) INTO total_stake
    FROM stake_accounts 
    WHERE user_id = user_id_param;
    
    RETURN total_stake;
END;
$$ LANGUAGE plpgsql;

-- ğŸ¯ åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER update_stake_accounts_updated_at 
    BEFORE UPDATE ON stake_accounts 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- ğŸ“Š æ·»åŠ è¡¨æ³¨é‡Š
COMMENT ON TABLE stake_accounts IS 'è´¨æŠ¼è´¦æˆ·è¡¨ï¼šç®¡ç†ç”¨æˆ·çš„è´¨æŠ¼è´¦æˆ·ä¿¡æ¯';
COMMENT ON COLUMN stake_accounts.user_id IS 'å…³è”ç”¨æˆ·ID';
COMMENT ON COLUMN stake_accounts.account_address IS 'TRONè´¦æˆ·åœ°å€';
COMMENT ON COLUMN stake_accounts.stake_amount IS 'è´¨æŠ¼TRXæ•°é‡';
COMMENT ON COLUMN stake_accounts.energy_amount IS 'å¯ç”¨èƒ½é‡æ•°é‡';
```

### ğŸ”„ 3. è¿ç§»æ‰§è¡Œæµç¨‹

#### å¼€å‘é˜¶æ®µï¼š
```bash
# 1. åˆ›å»ºæ–°è¿ç§»æ–‡ä»¶
touch migrations/$(date +%Y%m%d)_add_notification_system.sql

# 2. ç¼–å†™è¿ç§»å†…å®¹
vim migrations/20250103_add_notification_system.sql

# 3. æ‰§è¡Œè¿ç§»
npm run migrate

# 4. éªŒè¯æ‰§è¡Œç»“æœ
npm run migrate:status
```

#### å›¢é˜Ÿåä½œï¼š
```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. æ‰§è¡Œæ–°çš„è¿ç§»
npm run migrate

# 3. æäº¤è‡ªå·±çš„è¿ç§»æ–‡ä»¶
git add migrations/20250103_add_my_feature.sql
git commit -m "Add: æ–°å¢é€šçŸ¥ç³»ç»Ÿæ•°æ®åº“ç»“æ„"
git push origin feature/notification-system
```

#### ç”Ÿäº§éƒ¨ç½²ï¼š
```bash
# 1. å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
./project.sh  # é€‰æ‹©å¤‡ä»½åŠŸèƒ½

# 2. æ‰§è¡Œè¿ç§»
npm run migrate

# 3. éªŒè¯éƒ¨ç½²ç»“æœ
npm run migrate:status
npm run check  # æ£€æŸ¥åº”ç”¨çŠ¶æ€
```

### ğŸ”™ 4. å›æ»šå’Œæ•…éšœå¤„ç†

#### æŸ¥çœ‹è¿ç§»çŠ¶æ€ï¼š
```bash
npm run migrate:status

# è¾“å‡ºç¤ºä¾‹ï¼š
# === Migration Status ===
# Total migration files: 25
# Executed migrations: 23
# 
# Migration files:
#   âœ“ Executed 20250101_initial_schema.sql
#   âœ“ Executed 20250102_add_user_tables.sql
#   â—‹ Pending  20250103_add_notifications.sql
#   â—‹ Pending  20250104_optimize_queries.sql
```

#### å›æ»šæ“ä½œï¼š
```bash
# å›æ»šæœ€åä¸€ä¸ªè¿ç§»ï¼ˆä»…åˆ é™¤è®°å½•ï¼‰
npm run migrate:rollback

# æ‰‹åŠ¨å›æ»šï¼ˆéœ€è¦ç¼–å†™åå‘æ“ä½œï¼‰
# åˆ›å»ºå›æ»šè¿ç§»æ–‡ä»¶
touch migrations/$(date +%Y%m%d)_rollback_notifications.sql
```

#### æ•…éšœæ¢å¤ï¼š
```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡
pm2 stop tron-energy-rental

# 2. æ¢å¤æ•°æ®åº“å¤‡ä»½
./project.sh  # é€‰æ‹©æ¢å¤åŠŸèƒ½

# 3. é‡æ–°æ‰§è¡Œæ­£ç¡®çš„è¿ç§»
npm run migrate

# 4. é‡å¯åº”ç”¨
pm2 start tron-energy-rental
```

---

## ğŸ’¡ ä¸åŒåˆ›å»ºæ–¹å¼çš„é€‰æ‹©å»ºè®®

### ğŸ¯ æ ¹æ®é¡¹ç›®é˜¶æ®µé€‰æ‹©

#### ğŸ§ª **åŸå‹éªŒè¯é˜¶æ®µ**
- **æ¨è**: æ‰‹åŠ¨åˆ›å»º + è¿ç§»æ–‡ä»¶è®°å½•
- **åŸå› **: å¿«é€Ÿå®éªŒï¼Œä½†è¦åŠæ—¶æ•´ç†åˆ°è¿ç§»æ–‡ä»¶

#### ğŸ—ï¸ **åŠŸèƒ½å¼€å‘é˜¶æ®µ**  
- **æ¨è**: è¿ç§»æ–‡ä»¶ç®¡ç†
- **åŸå› **: å›¢é˜Ÿåä½œï¼Œç‰ˆæœ¬æ§åˆ¶ï¼Œç¯å¢ƒä¸€è‡´

#### ğŸš€ **ç”Ÿäº§éƒ¨ç½²é˜¶æ®µ**
- **æ¨è**: è¿ç§»æ–‡ä»¶ç®¡ç† + ä¸¥æ ¼æµ‹è¯•
- **åŸå› **: å®‰å…¨å¯æ§ï¼Œå¯è¿½æº¯ï¼Œå¯å›æ»š

#### ğŸ”§ **ç»´æŠ¤ä¼˜åŒ–é˜¶æ®µ**
- **æ¨è**: è¿ç§»æ–‡ä»¶ç®¡ç†
- **åŸå› **: ä¿æŒå†å²è®°å½•ï¼Œä¾¿äºé—®é¢˜å®šä½

### ğŸ“Š å¯¹æ¯”æ€»ç»“è¡¨

| è¯„ä¼°ç»´åº¦ | æ‰‹åŠ¨åˆ›å»º | ä»£ç åˆ›å»º | è¿ç§»æ–‡ä»¶ | æƒé‡ |
|----------|----------|----------|----------|------|
| **ç‰ˆæœ¬æ§åˆ¶** | âŒ æ—  | âœ… æœ‰ | âœ… å®Œæ•´ | ğŸ”¥ é«˜ |
| **å›¢é˜Ÿåä½œ** | âŒ å›°éš¾ | âš ï¸ ä¸€èˆ¬ | âœ… å‹å¥½ | ğŸ”¥ é«˜ |
| **ç¯å¢ƒä¸€è‡´æ€§** | âŒ ä¸ä¿è¯ | âš ï¸ ä¸€èˆ¬ | âœ… ä¿è¯ | ğŸ”¥ é«˜ |
| **å›æ»šèƒ½åŠ›** | âŒ å›°éš¾ | âš ï¸ ä¸€èˆ¬ | âœ… æ”¯æŒ | ğŸ”¥ é«˜ |
| **å¼€å‘é€Ÿåº¦** | âœ… å¿« | âš ï¸ ä¸€èˆ¬ | âš ï¸ ç¨æ…¢ | âš¡ ä¸­ |
| **éƒ¨ç½²å®‰å…¨** | âŒ é£é™©é«˜ | âš ï¸ ä¸€èˆ¬ | âœ… å®‰å…¨ | ğŸ”¥ é«˜ |
| **ç»´æŠ¤æˆæœ¬** | âŒ é«˜ | âš ï¸ ä¸€èˆ¬ | âœ… ä½ | ğŸ“Š ä¸­ |

### ğŸ–ï¸ æœ€ç»ˆæ¨è

**å¯¹äºä¼ä¸šçº§é¡¹ç›®ï¼ˆå¦‚æ‚¨çš„é¡¹ç›®ï¼‰ï¼š**

1. **ğŸ† ä¸»è¦æ–¹å¼**: SQLè¿ç§»æ–‡ä»¶ç®¡ç†
2. **ğŸ§ª è¾…åŠ©æ–¹å¼**: å¼€å‘é˜¶æ®µçš„æ‰‹åŠ¨è°ƒè¯•
3. **ğŸš¨ åº”æ€¥æ–¹å¼**: ç”Ÿäº§ç¯å¢ƒçš„ç´§æ€¥ä¿®å¤

**è¿™æ­£æ˜¯æ‚¨çš„é¡¹ç›®é‡‡ç”¨çš„æ–¹å¼ï¼Œéå¸¸æ­£ç¡®ï¼** âœ…

---

## ğŸ” æ‚¨é¡¹ç›®çš„å…·ä½“å®ç°åˆ†æ

### ğŸ“ æ ¸å¿ƒè¿ç§»æ–‡ä»¶

#### `999_consolidated_schema.sql` - åŸºç¡€æ¶æ„
```sql
-- æ‰©å±•å®‰è£…
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- è‡ªå®šä¹‰ç±»å‹å®šä¹‰
CREATE TYPE public.account_type AS ENUM (
    'energy_pool',
    'user_wallet'
);

-- æ ¸å¿ƒä¸šåŠ¡å‡½æ•°
CREATE OR REPLACE FUNCTION public.get_active_bots()...
CREATE OR REPLACE FUNCTION public.get_bot_active_pricing_config()...
CREATE OR REPLACE FUNCTION public.get_pricing_change_stats()...
```

#### å¢é‡è¿ç§»æ–‡ä»¶ç¤ºä¾‹
```sql
-- 20250903_create_stake_management_tables.sql
-- æ–°å¢è´¨æŠ¼ç®¡ç†åŠŸèƒ½

-- 20250902_add_task_execution_fields.sql  
-- ä¼˜åŒ–å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ

-- 20250125_n_plus_1_query_optimization_indexes.sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
```

### ğŸ”§ è¿ç§»ç®¡ç†å·¥å…·

æ‚¨çš„ `migrate.ts` æä¾›äº†å®Œæ•´çš„è¿ç§»ç®¡ç†åŠŸèƒ½ï¼š

- âœ… **è‡ªåŠ¨è·Ÿè¸ª**: å·²æ‰§è¡Œè¿ç§»çš„è®°å½•
- âœ… **å¢é‡æ‰§è¡Œ**: åªè¿è¡Œæ–°çš„è¿ç§»æ–‡ä»¶  
- âœ… **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå›æ»š
- âœ… **çŠ¶æ€æŸ¥è¯¢**: æŸ¥çœ‹è¿ç§»æ‰§è¡ŒçŠ¶æ€
- âœ… **SQLè§£æ**: æ”¯æŒå¤æ‚çš„å¤šè¯­å¥SQL

### ğŸ“Š ç®¡ç†æ•ˆæœ

é€šè¿‡è¿™å¥—ç³»ç»Ÿï¼Œæ‚¨æˆåŠŸç®¡ç†äº†ï¼š
- **ğŸ—ï¸ 42ä¸ªè¡¨** - å®Œæ•´çš„ä¸šåŠ¡æ•°æ®ç»“æ„
- **âš™ï¸ 29ä¸ªå‡½æ•°** - å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å°è£…
- **ğŸ¯ 18ä¸ªè§¦å‘å™¨** - è‡ªåŠ¨åŒ–çš„æ•°æ®å¤„ç†
- **ğŸ“‡ 113ä¸ªç´¢å¼•** - å…¨é¢çš„æ€§èƒ½ä¼˜åŒ–
- **ğŸ”— 86ä¸ªçº¦æŸ** - ä¸¥æ ¼çš„æ•°æ®å®Œæ•´æ€§

---

## ğŸ¯ æ€»ç»“å’Œå»ºè®®

### âœ… æ‚¨é¡¹ç›®çš„ä¼˜åŠ¿

1. **ğŸ† é‡‡ç”¨äº†æœ€ä½³å®è·µ** - SQLè¿ç§»æ–‡ä»¶ç®¡ç†
2. **ğŸ”§ å®Œå–„çš„å·¥å…·æ”¯æŒ** - è‡ªåŠ¨åŒ–è¿ç§»ç³»ç»Ÿ
3. **ğŸ“‹ è§„èŒƒçš„æ–‡ä»¶ç»„ç»‡** - æ¸…æ™°çš„è¿ç§»æ–‡ä»¶ç»“æ„
4. **ğŸš€ æˆç†Ÿçš„éƒ¨ç½²æµç¨‹** - æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

### ğŸš€ æŒç»­æ”¹è¿›å»ºè®®

1. **ğŸ“ å®Œå–„æ³¨é‡Šæ–‡æ¡£** - ä¸ºå¤æ‚è¿ç§»æ·»åŠ æ›´å¤šè¯´æ˜
2. **ğŸ§ª æµ‹è¯•è¿ç§»è„šæœ¬** - åœ¨å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•  
3. **ğŸ“Š ç›‘æ§æ‰§è¡Œæ—¶é—´** - å…³æ³¨å¤§å‹è¿ç§»çš„æ€§èƒ½å½±å“
4. **ğŸ”™ å®šæœŸæ¸…ç†å¤‡ä»½** - ç®¡ç†è¿‡æœŸçš„æ•°æ®åº“å¤‡ä»½

### ğŸ–ï¸ æœ€ç»ˆç»“è®º

**æ‚¨çš„é¡¹ç›®åœ¨æ•°æ®åº“å¯¹è±¡ç®¡ç†æ–¹é¢å·²ç»è¾¾åˆ°äº†ä¼ä¸šçº§æ ‡å‡†ï¼**

- **âœ… æ–¹å¼é€‰æ‹©æ­£ç¡®** - ä½¿ç”¨SQLè¿ç§»æ–‡ä»¶ç®¡ç†
- **âœ… å·¥å…·å®ç°å®Œæ•´** - åŠŸèƒ½ä¸°å¯Œçš„è¿ç§»ç³»ç»Ÿ  
- **âœ… æµç¨‹è§„èŒƒä¸¥è°¨** - ç‰ˆæœ¬æ§åˆ¶+è‡ªåŠ¨åŒ–éƒ¨ç½²
- **âœ… æ‰©å±•æ€§è‰¯å¥½** - æ”¯æŒæŒç»­çš„åŠŸèƒ½è¿­ä»£

ç»§ç»­ä¿æŒè¿™ç§æœ€ä½³å®è·µï¼Œæ‚¨çš„æ•°æ®åº“ç®¡ç†å°†æŒç»­é«˜æ•ˆå’Œå®‰å…¨ï¼ğŸš€

---

*ğŸ“… æ–‡æ¡£æ›´æ–°æ—¶é—´: 2025-01-03*  
*ğŸ‘¨â€ğŸ’» é€‚ç”¨é¡¹ç›®: TronResourceDev/tron-energy-rental*  
*ğŸ”— ç›¸å…³æ–‡æ¡£: [æ•°æ®åº“å¯¹è±¡è¯¦è§£.md](./æ•°æ®åº“å¯¹è±¡è¯¦è§£.md)*

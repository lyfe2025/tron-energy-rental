# 后端服务状态检查功能

## 功能概述

为前端应用添加了智能的后端服务状态检查和友好提示功能，确保当后端服务不可用时，用户能够得到清晰的提示和解决建议。

## 功能特性

### 1. 自动检测
- **启动时检查**：前端应用启动时自动检测后端服务状态
- **定期监控**：每30秒自动检查后端服务健康状态
- **实时响应**：API请求失败时立即触发状态检查

### 2. 智能提示
- **友好界面**：专门设计的状态模态框，清晰展示连接状态
- **详细信息**：显示错误原因、响应时间和具体的解决建议
- **状态指示器**：实时显示后端服务和网络连接状态

### 3. 用户体验优化
- **自动恢复检测**：服务恢复时自动显示成功提示
- **重试机制**：用户可手动重试连接
- **Toast通知**：状态变化时显示简洁的通知消息

## 技术实现

### 1. 网络错误捕获 (`apiClient.ts`)
```typescript
// 在响应拦截器中添加网络连接错误处理
if (!error.response && (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK')) {
  // 触发后端服务不可用事件
  window.dispatchEvent(new CustomEvent('api:backend_unavailable', {
    detail: {
      code: error.code,
      message: '后端服务暂时不可用，请稍后重试'
    }
  }));
}
```

### 2. 健康检查服务 (`healthCheckService.ts`)
- **多重保障**：尝试多个端点确保检查准确性
- **重试机制**：支持配置重试次数和延迟时间
- **定期监控**：可配置的定期健康检查
- **快速检查**：轻量级快速检查方法

### 3. 状态管理组件 (`BackendStatusModal.vue`)
- **状态展示**：checking（检查中）、available（可用）、unavailable（不可用）
- **用户操作**：重试连接、离线模式、关闭提示
- **视觉反馈**：加载动画、状态图标、进度指示

### 4. 全局集成 (`App.vue`)
- **事件监听**：监听各种状态变化事件
- **状态同步**：统一管理后端服务状态
- **用户通知**：集成Toast通知系统

## 使用场景

### 1. 开发环境
- 前端服务启动，后端服务未启动
- 后端服务重启过程中的短暂不可用
- 网络连接问题导致的通信中断

### 2. 生产环境
- 服务器维护期间的用户提示
- 网络故障时的友好提示
- 服务升级过程中的状态展示

## 配置说明

### 健康检查配置
```typescript
const healthCheckOptions = {
  timeout: 5000,        // 请求超时时间（毫秒）
  retries: 3,           // 重试次数
  retryDelay: 1000,     // 重试延迟（毫秒）
  checkInterval: 30000  // 定期检查间隔（毫秒）
};
```

### 检查端点
系统会按顺序尝试以下端点：
1. `/api/health` - 专用健康检查端点（推荐）
2. `/api/auth/status` - 认证状态端点（备用）

## 错误类型处理

| 错误类型 | 错误代码 | 处理方式 |
|---------|---------|---------|
| 连接被拒绝 | ECONNREFUSED | 显示后端服务不可用提示 |
| 网络错误 | ERR_NETWORK | 显示网络连接问题提示 |
| 请求超时 | TIMEOUT | 显示连接超时提示 |
| 服务器错误 | 5xx | 显示服务器内部错误提示 |

## 用户界面说明

### 状态模态框
- **标题区域**：显示当前状态和简要说明
- **内容区域**：
  - 不可用时：显示错误详情和解决建议
  - 检查中：显示加载动画和提示文字
  - 可用时：显示成功信息和响应时间
- **操作区域**：提供重试、离线模式等操作选项
- **状态指示器**：实时显示后端服务和网络状态

### Toast通知
- **连接失败**：红色错误通知，持续5秒
- **连接恢复**：绿色成功通知，持续3秒
- **离线模式**：黄色警告通知，持续6秒

## 测试建议

### 1. 功能测试
```bash
# 启动前端服务
npm run dev

# 停止后端服务来测试提示功能
ps aux | grep -E 'node.*server|nodemon' | grep -v grep | awk '{print $2}' | xargs kill

# 重新启动后端服务来测试恢复功能
npm run server:dev
```

### 2. 开发工具
- 使用浏览器开发者工具查看控制台日志
- 检查网络面板中的API请求状态
- 观察用户界面的状态变化

## 注意事项

1. **性能影响**：定期健康检查使用轻量级请求，对性能影响微乎其微
2. **用户体验**：避免过于频繁的状态提示，采用智能去重机制
3. **错误恢复**：系统能够自动检测服务恢复并更新状态
4. **离线支持**：为未来的离线功能预留了接口

## 扩展功能

### 未来可能的增强
- 支持多个后端服务的状态检查
- 添加网络质量检测（延迟、丢包率）
- 实现真正的离线模式功能
- 添加状态历史记录和分析
- 集成系统监控和报警功能

---

**最后更新**: 2025年1月9日
**版本**: 1.0.0
**作者**: AI Assistant

# 能量闪租功能 - 最小可执行任务清单

> **项目**: TRON 能量租赁系统  
> **功能**: 能量闪租自动化处理  
> **创建时间**: 2025-09-20  

---

## 📋 执行说明

- ✅ **已完成** | 🔄 **进行中** | ⏳ **待执行** | ❌ **阻塞**
- **优先级**: 🔥 高 | 🔸 中 | 🔹 低
- **预估时间**: 以小时为单位

---

## 🗂 任务分组

### **Phase 1: 数据库基础设施 (2-3小时)**

#### Task 1.1: 备份数据库 🔥
**状态**: ⏳ | **时间**: 15分钟 | **负责人**: DEV

**执行步骤**:
```bash
# 1. 创建数据库备份
./scripts/database/backup-database.sh

# 2. 验证备份文件
ls -la backups/ | grep $(date +%Y%m%d)
```

**验收标准**: 
- 备份文件存在于 `backups/` 目录
- 文件大小 > 1MB

---

#### Task 1.2: price_configs表结构迁移 🔥
**状态**: ⏳ | **时间**: 1小时 | **依赖**: Task 1.1

**执行步骤**:
```sql
-- 1. 移除唯一约束
ALTER TABLE price_configs DROP CONSTRAINT IF EXISTS price_configs_mode_type_key;

-- 2. 添加network_id字段
ALTER TABLE price_configs ADD COLUMN network_id INTEGER;

-- 3. 设置默认值（主网ID）
UPDATE price_configs SET network_id = 1 WHERE network_id IS NULL;
ALTER TABLE price_configs ALTER COLUMN network_id SET NOT NULL;

-- 4. 添加外键约束
ALTER TABLE price_configs ADD CONSTRAINT fk_price_configs_network 
    FOREIGN KEY (network_id) REFERENCES tron_networks(id);

-- 5. 创建复合唯一索引
CREATE UNIQUE INDEX idx_price_configs_mode_network 
    ON price_configs (mode_type, network_id);
```

**验收标准**:
- 表结构包含 `network_id` 字段
- 复合唯一索引创建成功
- 现有数据保持完整

---

#### Task 1.3: orders表结构扩展 🔥
**状态**: ⏳ | **时间**: 1小时 | **依赖**: Task 1.2

**执行步骤**:
```sql
-- 1. 添加闪租相关字段
ALTER TABLE orders ADD COLUMN network_id INTEGER;
ALTER TABLE orders ADD COLUMN payment_trx_amount DECIMAL(20,6);
ALTER TABLE orders ADD COLUMN calculated_units INTEGER;
ALTER TABLE orders ADD COLUMN delegated_energy_amount BIGINT;
ALTER TABLE orders ADD COLUMN delegation_tx_id VARCHAR(64);

-- 2. 更新现有订单的network_id
UPDATE orders SET network_id = 1 WHERE network_id IS NULL;
ALTER TABLE orders ALTER COLUMN network_id SET NOT NULL;

-- 3. 添加外键约束
ALTER TABLE orders ADD CONSTRAINT fk_orders_network 
    FOREIGN KEY (network_id) REFERENCES tron_networks(id);

-- 4. 更新order_type枚举（如果使用枚举类型）
-- 或确保应用层支持'FLASH_RENT'类型
```

**验收标准**:
- 所有新字段添加成功
- 外键约束正常工作
- 现有订单数据完整

---

### **Phase 2: 核心服务开发 (8-10小时)**

#### Task 2.1: 创建TransactionMonitorService 🔥
**状态**: ⏳ | **时间**: 3小时 | **依赖**: Task 1.3

**文件路径**: `api/services/transaction-monitor.ts`

**执行步骤**:
```typescript
// 1. 创建服务类基础结构
class TransactionMonitorService {
  private intervalId?: NodeJS.Timeout;
  private readonly POLL_INTERVAL = 5000; // 5秒轮询
  
  async startMonitoring(): Promise<void>
  async stopMonitoring(): Promise<void>
  private async pollTransactions(): Promise<void>
  private async processTransaction(tx: any, networkId: number): Promise<void>
  private async isTransactionProcessed(txId: string): Promise<boolean>
  private async markTransactionProcessed(txId: string): Promise<void>
}

// 2. 实现交易轮询逻辑
// 3. 集成Redis缓存
// 4. 添加错误处理和日志
// 5. 添加服务启动/停止方法
```

**验收标准**:
- 服务可以正常启动/停止
- 能够检测到测试网络的TRX转账
- Redis缓存防重复处理正常工作

---

#### Task 2.2: 扩展PaymentService 🔸
**状态**: ⏳ | **时间**: 1.5小时 | **依赖**: Task 2.1

**文件路径**: `api/services/payment.ts`

**执行步骤**:
```typescript
// 1. 添加新方法
async handleFlashRentPayment(
  transaction: any, 
  networkId: number
): Promise<void> {
  // 验证交易
  // 提取from_address和amount
  // 调用OrderService.createFlashRentOrder
  // 记录处理日志
}

// 2. 添加交易验证逻辑
private validateTransaction(transaction: any): boolean

// 3. 添加金额提取逻辑
private extractTrxAmount(transaction: any): number
```

**验收标准**:
- 方法能正确解析TRX交易
- 验证逻辑覆盖主要异常情况
- 与OrderService集成正常

---

#### Task 2.3: 扩展OrderService 🔸
**状态**: ⏳ | **时间**: 2小时 | **依赖**: Task 2.2

**文件路径**: `api/services/order.ts`

**执行步骤**:
```typescript
// 1. 添加新方法
async createFlashRentOrder(
  fromAddress: string, 
  trxAmount: number, 
  networkId: number
): Promise<Order> {
  // 读取价格配置
  // 计算笔数和能量
  // 创建订单记录
  // 调用能量代理
  // 返回订单对象
}

// 2. 添加配置读取方法
private async getFlashRentConfig(networkId: number): Promise<PriceConfig>

// 3. 添加计算方法
private calculateUnits(amount: number, config: PriceConfig): number
private calculateTotalEnergy(units: number, config: PriceConfig): number
```

**验收标准**:
- 订单创建流程完整
- 计算逻辑符合业务规则
- 数据库操作正常

---

#### Task 2.4: 扩展TronService 🔸
**状态**: ⏳ | **时间**: 2.5小时 | **依赖**: Task 2.3

**文件路径**: `api/services/tron.ts`

**执行步骤**:
```typescript
// 1. 添加能量代理方法
async delegateEnergyForFlashRent(
  toAddress: string, 
  totalEnergy: number, 
  durationHours: number,
  networkId: number
): Promise<string> {
  // 选择能量池账户
  // 检查可用能量
  // 执行代理操作
  // 返回交易ID
}

// 2. 添加能量池选择逻辑
private async selectEnergyPoolAccount(
  requiredEnergy: number,
  networkId: number
): Promise<EnergyPoolAccount>

// 3. 添加能量检查方法
private async checkAvailableEnergy(
  address: string,
  networkId: number
): Promise<number>
```

**验收标准**:
- 能量池选择算法正确
- TRON代理操作成功
- 错误处理覆盖各种失败情况

---

### **Phase 3: API接口开发 (2-3小时)**

#### Task 3.1: 添加配置管理API 🔸
**状态**: ⏳ | **时间**: 1.5小时 | **依赖**: Task 2.4

**文件路径**: `api/routes/system/flash-rent-config.ts`

**执行步骤**:
```typescript
// 1. 创建路由文件
// GET /api/system/flash-rent-config
// PUT /api/system/flash-rent-config

// 2. 添加控制器方法
async getFlashRentConfig(req: Request, res: Response)
async updateFlashRentConfig(req: Request, res: Response)

// 3. 添加参数验证中间件
// 4. 集成到主路由
```

**验收标准**:
- API端点可正常访问
- 支持network_id参数筛选
- 参数验证正常工作

---

#### Task 3.2: 集成服务启动 🔥
**状态**: ⏳ | **时间**: 1小时 | **依赖**: Task 3.1

**文件路径**: `api/server.ts`

**执行步骤**:
```typescript
// 1. 导入TransactionMonitorService
import { TransactionMonitorService } from './services/transaction-monitor';

// 2. 在服务启动时启动监听
const transactionMonitor = new TransactionMonitorService();
await transactionMonitor.startMonitoring();

// 3. 在服务关闭时停止监听
process.on('SIGTERM', async () => {
  await transactionMonitor.stopMonitoring();
});
```

**验收标准**:
- 服务启动时自动开始交易监听
- 优雅关闭机制正常工作

---

### **Phase 4: 前端界面 (3-4小时)**

#### Task 4.1: 价格配置页面改造 🔹
**状态**: ⏳ | **时间**: 3小时 | **依赖**: Task 3.2

**文件路径**: `src/pages/admin/price-config/*`

**执行步骤**:
```vue
<!-- 1. 添加网络选择器组件 -->
<NetworkSelector v-model="selectedNetworkId" />

<!-- 2. 修改数据筛选逻辑 -->
// 根据selectedNetworkId筛选配置

<!-- 3. 更新表单组件 -->
// 新增/编辑时包含network_id

<!-- 4. 优化用户体验 -->
// 显示当前网络名称
```

**验收标准**:
- 网络选择器正常工作
- 数据筛选功能正确
- 表单操作支持多网络

---

### **Phase 5: 测试验证 (2-3小时)**

#### Task 5.1: 端到端功能测试 🔥
**状态**: ⏳ | **时间**: 2小时 | **依赖**: Task 4.1

**执行步骤**:
```bash
# 1. 启动服务
npm run restart

# 2. 配置测试数据
# - 创建闪租价格配置
# - 设置能量池账户

# 3. 执行测试转账
# - 向监听地址转账小额TRX
# - 验证订单创建
# - 检查能量代理结果

# 4. 验证异常情况
# - 金额不足
# - 能量池不足
# - 网络异常
```

**验收标准**:
- 完整流程测试通过
- 异常情况处理正确
- 日志记录完整

---

## 🚀 快速执行指南

### **优先执行顺序**:
1. **Task 1.1-1.3** (数据库准备)
2. **Task 2.1** (交易监听服务)
3. **Task 2.2-2.4** (核心服务)
4. **Task 3.1-3.2** (API集成)
5. **Task 5.1** (功能测试)
6. **Task 4.1** (前端界面)

### **预计完成时间**: 
- **最小可用版本**: 6-8小时 (完成到Task 3.2)
- **完整功能版本**: 10-12小时

### **风险提示**:
- 数据库迁移前务必备份
- TRON网络调用需要充足的TRX余额
- 测试阶段建议使用Nile测试网

---

## 📞 执行支持

如遇到问题，请按以下顺序排查：
1. 检查数据库连接和表结构
2. 验证TRON网络配置
3. 查看服务日志文件
4. 确认Redis缓存状态

**日志文件位置**: `logs/app-$(date +%Y-%m-%d).log`

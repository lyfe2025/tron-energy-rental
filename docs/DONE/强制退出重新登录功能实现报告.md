# 强制退出用户重新登录功能实现报告

## 概述

本报告详细说明了在线用户强制退出后的重新登录机制的实现，确保被强制退出的用户在点击其他菜单时收到"被下线"提示，并引导重新登录。

## 功能需求

在 `http://localhost:5173/monitoring/online-users` 在线用户监控页面，管理员可以强制退出某个用户。当用户被强制退出后：

1. 用户点击其他菜单时应该收到"被下线"提示
2. 需要重新登录才能继续使用系统
3. 提供友好的用户体验，区分主动退出和被强制下线

## 实现方案

### 1. 后端实现

#### 1.1 强制退出机制
- **文件**: `api/services/monitoring/UserSessionMonitor.ts`
- **方法**: `forceLogoutUserById(userId: string)`
- **功能**: 将指定用户的所有活跃会话设为非活跃状态

```typescript
// 将该用户的所有活跃会话设为非活跃
const result = await query(
  `UPDATE admin_sessions 
   SET is_active = false, 
       last_activity = NOW() 
   WHERE admin_id = $1 
     AND is_active = true 
   RETURNING id, admin_id, ip_address, login_at`,
  [userId]
);
```

#### 1.2 会话状态检查
- **文件**: `api/middleware/auth.ts`
- **方法**: `checkSessionStatus(userId: string)`
- **功能**: 在每次API请求时检查用户会话状态

```typescript
// 查询用户的活跃会话
const result = await query(
  'SELECT COUNT(*) as active_sessions FROM admin_sessions WHERE admin_id = $1 AND is_active = true',
  [userId]
);

// 如果没有活跃会话，说明用户被强制下线
const activeSessionCount = parseInt(result.rows[0]?.active_sessions || '0');
return activeSessionCount > 0;
```

当会话无效时，返回403状态码和"会话已失效，请重新登录"消息。

### 2. 前端实现

#### 2.1 HTTP拦截器更新
- **文件**: `src/services/api/core/apiClient.ts`
- **功能**: 在响应拦截器中处理403错误，区分被强制下线的情况

```typescript
} else if (error.response?.status === 403) {
  // 检查是否是会话失效（被强制下线）
  const message = error.response?.data?.message || '';
  if (message.includes('会话已失效') || message.includes('请重新登录')) {
    // 被强制下线，清除本地存储
    localStorage.removeItem('admin_token');
    localStorage.removeItem('admin_user');
    
    // 触发被强制下线事件
    window.dispatchEvent(new CustomEvent('auth:forced_logout', {
      detail: {
        message: message,
        reason: 'forced_logout'
      }
    }));
  }
}
```

#### 2.2 被下线通知组件
- **文件**: `src/components/auth/ForcedLogoutModal.vue`
- **功能**: 显示友好的被下线提示模态框

特点：
- 显示红色警告图标
- 明确说明账户已被下线
- 提供"重新登录"按钮
- 友好的用户提示信息

#### 2.3 认证状态管理更新
- **文件**: `src/stores/auth.ts`
- **新增方法**: `handleForcedLogout(message?: string)`

```typescript
// 处理被强制下线
const handleForcedLogout = async (message?: string) => {
  // 清除认证状态
  await logout()
  
  // 设置错误信息
  setError(message || '您的账户已被管理员强制下线，请重新登录。')
}
```

#### 2.4 全局事件处理
- **文件**: `src/App.vue`
- **功能**: 监听被强制下线事件，显示通知模态框

```typescript
// 全局处理被强制下线事件
const handleForcedLogout = (event: CustomEvent) => {
  const { message } = event.detail || {}
  
  // 设置模态框信息
  forcedLogoutMessage.value = message || '您的账户已被管理员强制下线，请重新登录。'
  showForcedLogoutModal.value = true
  
  // 处理被强制下线
  authStore.handleForcedLogout(message)
}
```

## 工作流程

### 1. 管理员强制退出用户
1. 管理员在在线用户监控页面点击"强制下线"按钮
2. 前端调用 `monitoringApi.forceLogout(userId)` API
3. 后端 `OnlineUsersController.forceLogout()` 处理请求
4. 调用 `UserSessionMonitor.forceLogoutUserById()` 将用户所有会话设为非活跃
5. 返回成功响应

### 2. 被强制退出用户的体验
1. 用户继续使用系统，点击其他菜单
2. 前端发送API请求
3. 后端认证中间件检查会话状态，发现会话已失效
4. 返回403状态码和"会话已失效，请重新登录"消息
5. 前端拦截器捕获403错误，触发 `auth:forced_logout` 事件
6. App.vue监听事件，显示被下线通知模态框
7. 用户看到友好的提示信息，点击"重新登录"按钮
8. 系统清除认证状态，跳转到登录页面

## 技术特点

### 1. 安全性
- 服务端控制会话状态，防止前端绕过
- 清除客户端所有认证信息
- 区分不同的退出原因

### 2. 用户体验
- 友好的错误提示信息
- 明确区分主动退出和被强制下线
- 引导用户重新登录

### 3. 系统稳定性
- 全局事件处理机制
- 完善的错误处理
- 类型安全的TypeScript实现

## 测试验证

1. **编译检查**: 通过 `npm run check` 验证TypeScript类型无错误
2. **Lint检查**: 通过 ESLint 检查，无代码规范错误
3. **功能测试**: 需要通过以下步骤验证：
   - 启动项目
   - 登录两个不同用户
   - 在在线用户监控页面强制退出其中一个用户
   - 被退出用户点击其他菜单时应看到被下线提示

## 文件清单

### 新增文件
- `src/components/auth/ForcedLogoutModal.vue` - 被下线通知模态框

### 修改文件
- `src/services/api/core/apiClient.ts` - 添加403错误处理
- `src/stores/auth.ts` - 添加强制下线处理方法
- `src/App.vue` - 添加全局事件监听和模态框

### 已存在文件（功能已完善）
- `api/services/monitoring/UserSessionMonitor.ts` - 强制退出功能
- `api/middleware/auth.ts` - 会话状态检查
- `api/controllers/monitoring/OnlineUsersController.ts` - 强制退出API
- `src/pages/Monitoring/OnlineUsers.vue` - 在线用户管理页面

## 结论

本次实现完成了用户被强制退出后的重新登录机制，提供了完整的用户体验流程，确保系统安全性和易用性的平衡。功能已通过编译和静态检查验证，建议进行端到端测试确认功能正常工作。

# Tronè´¨æŠ¼æ•°æ®ç®¡ç†æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ

### å½“å‰ç—›ç‚¹
1. **æ•°æ®å˜åŒ–é¢‘ç¹**ï¼šTronç½‘ç»œè´¨æŠ¼ã€è§£è´¨æŠ¼ã€å§”æ‰˜æ“ä½œé¢‘æ¬¡æé«˜
2. **å¤–éƒ¨APIä¾èµ–**ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½è°ƒç”¨TronGrid APIï¼Œå“åº”æ—¶é—´500ms-2s
3. **æ‰©å±•æ€§é™åˆ¶**ï¼šç”¨æˆ·å¢é•¿ä¼šå¯¼è‡´APIè°ƒç”¨é¢‘ç‡è¶…é™
4. **æ•°æ®ä¸€è‡´æ€§é—®é¢˜**ï¼šå®æ—¶æŸ¥è¯¢å¯èƒ½å‡ºç°æ•°æ®å»¶è¿Ÿæˆ–ä¸ä¸€è‡´

## ğŸ† æ¨èæ¶æ„æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©ï¼šåˆ†å±‚æ•°æ®æ¶æ„ï¼ˆæœ€ä¼˜è§£ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tron åŒºå—é“¾ç½‘ç»œ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å®æ—¶ç›‘å¬
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TronEventListener äº‹ä»¶ç›‘å¬æœåŠ¡                 â”‚
â”‚  â€¢ WebSocket ç›‘å¬æœ€æ–°åŒºå—                                   â”‚
â”‚  â€¢ è§£æè´¨æŠ¼/å§”æ‰˜/è§£è´¨æŠ¼äº‹ä»¶                                 â”‚
â”‚  â€¢ æ‰¹é‡å¤„ç†ï¼Œé™ä½ç½‘ç»œå¼€é”€                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ åŒå†™ç­–ç•¥
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Redis çƒ­æ•°æ®å±‚                               â”‚
â”‚  â€¢ æœ€æ–°çŠ¶æ€ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰                                 â”‚
â”‚  â€¢ ç»Ÿè®¡æ‘˜è¦ç¼“å­˜ï¼ˆ30åˆ†é’ŸTTLï¼‰                                â”‚
â”‚  â€¢ æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆ1å°æ—¶TTLï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æŒä¹…åŒ–
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL æŒä¹…åŒ–å±‚                            â”‚
â”‚  â€¢ stake_recordsï¼šè´¨æŠ¼è®°å½•                                  â”‚  
â”‚  â€¢ delegate_recordsï¼šå§”æ‰˜è®°å½•                               â”‚
â”‚  â€¢ unfreeze_recordsï¼šè§£è´¨æŠ¼è®°å½•                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæœ€é€‚åˆï¼Ÿ

#### âœ… ä¼˜åŠ¿
- **æ€§èƒ½æœ€ä¼˜**ï¼šæŸ¥è¯¢å“åº”æ—¶é—´ä» 500-2000ms é™è‡³ 10-50ms
- **æ•°æ®å®Œæ•´**ï¼šå®Œæ•´ä¿ç•™å†å²è®°å½•ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢å’Œåˆ†æ
- **é«˜å¯é æ€§**ï¼šå¤šå±‚å†—ä½™ï¼Œå•ç‚¹æ•…éšœä¸å½±å“æœåŠ¡
- **æˆæœ¬å¯æ§**ï¼šå¤§å¹…å‡å°‘å¤–éƒ¨APIè°ƒç”¨ï¼ŒRediså†…å­˜æˆæœ¬å¾ˆä½

#### âŒ ç›¸æ¯”å…¶ä»–æ–¹æ¡ˆçš„åŠ£åŠ¿
- **å®ç°å¤æ‚åº¦è¾ƒé«˜**ï¼šéœ€è¦å¼€å‘ç›‘å¬æœåŠ¡å’ŒåŒæ­¥é€»è¾‘
- **è¿ç»´æˆæœ¬ç•¥é«˜**ï¼šéœ€è¦ç›‘æ§å¤šä¸ªç»„ä»¶çš„å¥åº·çŠ¶æ€

## ğŸ”§ æŠ€æœ¯å®æ–½ç»†èŠ‚

### 1. äº‹ä»¶ç›‘å¬æœåŠ¡è®¾è®¡

#### ç›‘å¬ç­–ç•¥
```typescript
interface TronEventListener {
  // ä¸»è¦ç›‘å¬æ–¹å¼ï¼šWebSocket
  websocketConnection: WebSocket;
  
  // å¤‡ç”¨ç›‘å¬æ–¹å¼ï¼šHTTPè½®è¯¢ 
  fallbackPolling: NodeJS.Timer;
  
  // ç›‘å¬çš„äº‹ä»¶ç±»å‹
  eventTypes: [
    'FreezeBalanceV2',    // è´¨æŠ¼
    'UnfreezeBalanceV2',  // è§£è´¨æŠ¼
    'DelegateResource',   // å§”æ‰˜
    'UndelegateResource'  // å–æ¶ˆå§”æ‰˜
  ];
}
```

#### æ•°æ®è§£æä¸å†™å…¥
```typescript
class TronDataProcessor {
  async processEvent(event: TronEvent) {
    // 1. è§£æäº‹ä»¶æ•°æ®
    const parsedData = this.parseEventData(event);
    
    // 2. åŒå†™ç­–ç•¥ï¼šåŒæ—¶å†™å…¥Rediså’Œæ•°æ®åº“
    await Promise.all([
      this.writeToRedis(parsedData),
      this.writeToDatabase(parsedData)
    ]);
    
    // 3. æ›´æ–°ç›¸å…³ç¼“å­˜
    await this.updateRelatedCache(parsedData);
  }
}
```

### 2. Redisç¼“å­˜ç­–ç•¥

#### ç¼“å­˜é”®è®¾è®¡
```typescript
const CACHE_KEYS = {
  // è´¨æŠ¼è®°å½•åˆ—è¡¨
  STAKE_RECORDS: (address: string, page: number, limit: number) => 
    `stake:records:${address}:${page}:${limit}`,
    
  // å§”æ‰˜è®°å½•åˆ—è¡¨
  DELEGATE_RECORDS: (address: string, page: number, limit: number) => 
    `delegate:records:${address}:${page}:${limit}`,
    
  // è§£è´¨æŠ¼è®°å½•åˆ—è¡¨  
  UNFREEZE_RECORDS: (address: string, page: number, limit: number) => 
    `unfreeze:records:${address}:${page}:${limit}`,
    
  // è´¦æˆ·ç»Ÿè®¡æ‘˜è¦
  ACCOUNT_SUMMARY: (address: string) => `account:summary:${address}`,
  
  // å…¨å±€ç»Ÿè®¡æ•°æ®
  GLOBAL_STATS: () => 'global:stats',
};

const CACHE_TTL = {
  REALTIME_DATA: 300,    // 5åˆ†é’Ÿ
  SUMMARY_DATA: 1800,    // 30åˆ†é’Ÿ  
  HISTORICAL_DATA: 3600, // 1å°æ—¶
  GLOBAL_STATS: 3600,    // 1å°æ—¶
};
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥
```typescript
class CacheManager {
  // å†™å…¥æ—¶æ›´æ–°ç­–ç•¥
  async onDataWrite(data: StakeRecord | DelegateRecord | UnfreezeRecord) {
    // 1. åˆ é™¤ç›¸å…³çš„åˆ—è¡¨ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°ç”Ÿæˆï¼‰
    await this.invalidateListCaches(data.pool_account_id);
    
    // 2. æ›´æ–°ç»Ÿè®¡æ‘˜è¦ç¼“å­˜
    await this.updateSummaryCache(data.pool_account_id);
    
    // 3. æ›´æ–°å…¨å±€ç»Ÿè®¡
    await this.updateGlobalStats();
  }
  
  // æŸ¥è¯¢æ—¶ç¼“å­˜ç­–ç•¥
  async getWithCache<T>(key: string, fetcher: () => Promise<T>, ttl: number): Promise<T> {
    // 1. å…ˆæŸ¥Redis
    const cached = await redisClient.get(key);
    if (cached) {
      return JSON.parse(cached);
    }
    
    // 2. ç¼“å­˜missï¼ŒæŸ¥è¯¢æ•°æ®åº“
    const data = await fetcher();
    
    // 3. å†™å…¥ç¼“å­˜
    await redisClient.setEx(key, ttl, JSON.stringify(data));
    
    return data;
  }
}
```

### 3. æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–
```sql
-- ä¸ºæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–çš„å¤åˆç´¢å¼•
CREATE INDEX CONCURRENTLY idx_stake_records_pool_time 
ON stake_records(pool_account_id, created_at DESC);

CREATE INDEX CONCURRENTLY idx_delegate_records_pool_time 
ON delegate_records(pool_account_id, created_at DESC);

CREATE INDEX CONCURRENTLY idx_unfreeze_records_pool_time 
ON unfreeze_records(pool_account_id, created_at DESC);

-- çŠ¶æ€æŸ¥è¯¢ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_records_status 
ON stake_records(status) WHERE status = 'confirmed';
```

#### æ•°æ®æ¸…ç†ç­–ç•¥
```sql
-- å®šæœŸæ¸…ç†è¶…è¿‡1å¹´çš„å†å²æ•°æ®ï¼ˆå¯é€‰ï¼‰
DELETE FROM stake_records 
WHERE created_at < NOW() - INTERVAL '1 year' 
AND status = 'confirmed';
```

### 4. APIå±‚æ”¹é€ 

#### æŸ¥è¯¢ä¼˜åŒ–
```typescript
class StakeController {
  async getStakeRecords(req: Request, res: Response) {
    const { address, page = 1, limit = 20 } = req.query;
    
    // 1. æ„å»ºç¼“å­˜é”®
    const cacheKey = CACHE_KEYS.STAKE_RECORDS(address, page, limit);
    
    // 2. å°è¯•ä»ç¼“å­˜è·å–
    const cachedData = await cacheManager.getWithCache(
      cacheKey,
      async () => {
        // 3. ç¼“å­˜missï¼Œä»æ•°æ®åº“æŸ¥è¯¢
        return await this.queryDatabase(address, page, limit);
      },
      CACHE_TTL.HISTORICAL_DATA
    );
    
    res.json({
      success: true,
      data: cachedData,
      source: 'cache' // è°ƒè¯•ç”¨ï¼Œæ˜¾ç¤ºæ•°æ®æ¥æº
    });
  }
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”ä¸æ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰æ–¹æ¡ˆ | ä¼˜åŒ–å | æå‡ |
|------|----------|--------|------|
| æŸ¥è¯¢å“åº”æ—¶é—´ | 500-2000ms | 10-50ms | **95%+** |
| å¹¶å‘æ”¯æŒèƒ½åŠ› | 10 QPS | 1000+ QPS | **100å€** |
| æ•°æ®ä¸€è‡´æ€§ | ä¾èµ–å¤–éƒ¨API | å®æ—¶ç›‘å¬åŒæ­¥ | **å¤§å¹…æå‡** |
| ç³»ç»Ÿç¨³å®šæ€§ | å•ç‚¹æ•…éšœé£é™© | å¤šå±‚å†—ä½™ | **æ˜¾è‘—å¢å¼º** |
| è¿è¥æˆæœ¬ | APIè°ƒç”¨è´¹ç”¨é«˜ | Rediså†…å­˜æˆæœ¬ä½ | **æˆæœ¬ä¸‹é™60%+** |

## ğŸš€ å®æ–½è·¯å¾„

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ï¼ˆ1-2å‘¨ï¼‰
1. âœ… **äº‹ä»¶ç›‘å¬æœåŠ¡å¼€å‘**
   - åˆ›å»º `TronEventListener` æœåŠ¡
   - å®ç°WebSocketè¿æ¥å’Œäº‹ä»¶è§£æ
   - æ·»åŠ å®¹é”™å’Œé‡è¿æœºåˆ¶

2. âœ… **Redisç¼“å­˜å±‚å®ç°**
   - å®Œå–„Redisè¿æ¥é…ç½®
   - å®ç°ç¼“å­˜ç®¡ç†å™¨
   - å®šä¹‰ç¼“å­˜ç­–ç•¥

3. âœ… **æ•°æ®åº“ä¼˜åŒ–**
   - æ·»åŠ å¿…è¦çš„ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®è¿ç§»ï¼ˆ1å‘¨ï¼‰
1. âœ… **å†å²æ•°æ®åŒæ­¥**
   - ä»TronGrid APIè·å–å†å²æ•°æ®
   - æ‰¹é‡å¯¼å…¥åˆ°æ•°æ®åº“
   - å»ºç«‹åˆå§‹ç¼“å­˜

2. âœ… **æ•°æ®ä¸€è‡´æ€§éªŒè¯**
   - å¯¹æ¯”ç›‘å¬æ•°æ®ä¸APIæ•°æ®
   - ä¿®å¤ä¸ä¸€è‡´é—®é¢˜

### ç¬¬ä¸‰é˜¶æ®µï¼šæœåŠ¡åˆ‡æ¢ï¼ˆ1å‘¨ï¼‰
1. âœ… **APIå±‚æ”¹é€ **
   - ä¿®æ”¹æ§åˆ¶å™¨é€»è¾‘ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜/æ•°æ®åº“
   - ä¿ç•™TronGrid APIä½œä¸ºé™çº§æ–¹æ¡ˆ
   - æ·»åŠ æ•°æ®æºæ ‡è¯†

2. âœ… **æ€§èƒ½æµ‹è¯•ä¸è°ƒä¼˜**
   - å‹åŠ›æµ‹è¯•
   - ç¼“å­˜å‘½ä¸­ç‡ä¼˜åŒ–
   - ç›‘æ§å‘Šè­¦è®¾ç½®

## ğŸ” ç›‘æ§ä¸è¿ç»´

### å…³é”®æŒ‡æ ‡ç›‘æ§
```typescript
interface MonitoringMetrics {
  // æ•°æ®ä¸€è‡´æ€§
  dataLatency: number;        // äº‹ä»¶åˆ°æ•°æ®åº“çš„å»¶è¿Ÿ
  syncSuccessRate: number;    // åŒæ­¥æˆåŠŸç‡
  
  // ç¼“å­˜æ€§èƒ½
  cacheHitRate: number;       // Rediså‘½ä¸­ç‡
  averageResponseTime: number; // å¹³å‡å“åº”æ—¶é—´
  
  // ç³»ç»Ÿå¥åº·
  listenerStatus: 'online' | 'offline';  // ç›‘å¬æœåŠ¡çŠ¶æ€
  databaseStatus: 'healthy' | 'slow' | 'down';
  redisStatus: 'healthy' | 'slow' | 'down';
}
```

### å‘Šè­¦ç­–ç•¥
- ğŸš¨ **æ•°æ®å»¶è¿Ÿ > 5åˆ†é’Ÿ**ï¼šå¯èƒ½ç›‘å¬æœåŠ¡å¼‚å¸¸
- ğŸš¨ **ç¼“å­˜å‘½ä¸­ç‡ < 80%**ï¼šç¼“å­˜ç­–ç•¥éœ€è¦è°ƒæ•´  
- ğŸš¨ **åŒæ­¥å¤±è´¥ç‡ > 1%**ï¼šæ•°æ®ä¸€è‡´æ€§é£é™©
- ğŸš¨ **APIå“åº”æ—¶é—´ > 500ms**ï¼šæ€§èƒ½ä¸‹é™é¢„è­¦

### æ•…éšœé™çº§ç­–ç•¥
```typescript
class FallbackStrategy {
  async getStakeRecords(address: string) {
    try {
      // 1. ä¼˜å…ˆä»ç¼“å­˜è·å–
      return await this.getFromCache(address);
    } catch (error) {
      try {
        // 2. ç¼“å­˜å¤±è´¥ï¼Œä»æ•°æ®åº“è·å–
        return await this.getFromDatabase(address);
      } catch (error) {
        // 3. æ•°æ®åº“å¤±è´¥ï¼Œé™çº§åˆ°å¤–éƒ¨API
        return await this.getFromTronGrid(address);
      }
    }
  }
}
```

## ğŸ¯ æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒå»ºè®®
1. **é€‰æ‹©åˆ†å±‚æ¶æ„**ï¼šRedisç¼“å­˜ + æ•°æ®åº“æŒä¹…åŒ– + ç›‘å¬åŒæ­¥
2. **æ¸è¿›å¼å®æ–½**ï¼šåˆ†é˜¶æ®µä¸Šçº¿ï¼Œé™ä½é£é™©
3. **ç›‘æ§ä¸ºå…ˆ**ï¼šå®Œå–„çš„ç›‘æ§ä½“ç³»ç¡®ä¿æ•°æ®è´¨é‡
4. **é™çº§ä¿éšœ**ï¼šå¤šé‡é™çº§ç­–ç•¥ç¡®ä¿æœåŠ¡å¯ç”¨æ€§

### é¢„æœŸæ”¶ç›Š
- **ç”¨æˆ·ä½“éªŒ**ï¼šæŸ¥è¯¢é€Ÿåº¦æå‡10å€ä»¥ä¸Š
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæ¶ˆé™¤å¤–éƒ¨APIä¾èµ–é£é™©
- **è¿è¥æˆæœ¬**ï¼šå¤§å¹…é™ä½APIè°ƒç”¨è´¹ç”¨
- **ä¸šåŠ¡æ‰©å±•**ï¼šæ”¯æŒæ›´å¤æ‚çš„æ•°æ®åˆ†æéœ€æ±‚

è¿™ä¸ªæ–¹æ¡ˆæ—¢ä¿è¯äº†æ•°æ®çš„å®æ—¶æ€§å’Œå‡†ç¡®æ€§ï¼Œåˆå¤§å¹…æå‡äº†ç³»ç»Ÿæ€§èƒ½ï¼Œæ˜¯å½“å‰ä¸šåŠ¡åœºæ™¯çš„æœ€ä½³é€‰æ‹©ã€‚

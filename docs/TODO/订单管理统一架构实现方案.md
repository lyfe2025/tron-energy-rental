# 订单管理统一架构实现方案

## 📋 项目背景

### 当前状态
- ✅ 能量闪租订单已完整实现
- ⏳ 笔数套餐订单数据结构已备好，业务逻辑待完善
- ⏳ TRX闪兑订单数据结构已备好，业务逻辑待完善
- 🎯 需要统一的订单管理界面来管理三种不同类型的订单

### 项目目标
1. 实现统一的订单管理界面，支持三种订单类型的显示和管理
2. 通过智能字段映射和条件渲染解决不同订单类型的字段差异问题
3. 提供类型过滤功能，方便管理员按类型查看订单
4. 保持现有能量闪租功能的完整性，确保不影响现有业务

## 🏗️ 技术方案

### 核心架构
**统一订单管理 + 动态字段渲染 + 类型过滤**

```
订单管理页面
├── 订单类型标签页 (全部/能量闪租/笔数套餐/TRX闪兑)
├── 统一订单列表组件
│   ├── 通用字段 (ID、用户、金额、时间、状态)
│   └── 业务信息列 (根据订单类型动态渲染)
├── 订单筛选器 (增强类型过滤)
└── 订单详情模态框 (类型特定信息显示)
```

### 字段差异处理方案
| 订单类型 | 特有显示字段 | 业务信息列内容 |
|---------|------------|------------|
| **能量闪租** | `delegated_energy_amount`, `energy_pool_account_used`, `delegate_tx_hash` | 能量数量 + 委托状态 + 池账户 |
| **笔数套餐** | `transaction_count`, `package_name`, `remaining_transactions` | 套餐名称 + 笔数进度 + 有效期 |
| **TRX闪兑** | `exchange_rate`, `input_amount`, `output_amount`, `input_currency` | 汇率 + 兑换金额 + 货币类型 |

## 🚀 开发任务分解

### Phase 1: 前端界面统一适配 (预计 2-3 天)

#### 任务 1.1: 订单列表组件重构
**文件**: `src/pages/Orders/components/OrderList.vue`

**任务内容**:
1. **修改表头结构**
   - 将"能量委托状态"列改为"业务信息"列
   - 保持其他列的通用性

2. **实现动态字段渲染**
   ```vue
   <!-- 业务信息列动态内容 -->
   <td class="px-3 py-3 whitespace-nowrap">
     <!-- 能量闪租 -->
     <EnergyFlashOrderCell 
       v-if="order.order_type === 'energy_flash'" 
       :order="order" 
       :config="flashRentConfig" 
     />
     
     <!-- 笔数套餐 -->
     <TransactionPackageOrderCell 
       v-else-if="order.order_type === 'transaction_package'" 
       :order="order" 
     />
     
     <!-- TRX闪兑 -->
     <TrxExchangeOrderCell 
       v-else-if="order.order_type === 'trx_exchange'" 
       :order="order" 
     />
     
     <!-- 未知类型提示 -->
     <div v-else class="text-xs text-gray-400 italic">
       未知订单类型: {{ order.order_type }}
     </div>
   </td>
   ```

3. **更新工具函数**
   - `getOrderTypeText()` 函数支持三种类型
   - `formatPrice()`, `calculateOrderCount()` 函数适配不同类型

#### 任务 1.2: 创建订单类型专用组件
**新建文件**:
- `src/pages/Orders/components/cells/EnergyFlashOrderCell.vue`
- `src/pages/Orders/components/cells/TransactionPackageOrderCell.vue`
- `src/pages/Orders/components/cells/TrxExchangeOrderCell.vue`

**EnergyFlashOrderCell.vue 实现**:
```vue
<template>
  <div class="space-y-1">
    <div class="text-sm font-medium text-blue-700">
      {{ formatEnergy(order, config) }} 能量
    </div>
    <div class="text-xs">
      <span :class="getDelegationStatusColor(order)" 
            class="inline-flex px-2 py-0.5 text-xs font-medium rounded">
        {{ getDelegationStatusText(order) }}
      </span>
    </div>
    <div v-if="order.energy_pool_account_used" 
         class="text-xs text-blue-500 font-mono" 
         :title="order.energy_pool_account_used">
      <span class="font-medium">池:</span> 
      {{ formatAddress(order.energy_pool_account_used) }}
    </div>
    <div v-if="order.error_message" 
         class="text-xs text-red-600 truncate max-w-32" 
         :title="order.error_message">
      <span class="font-medium">错误:</span> {{ order.error_message }}
    </div>
  </div>
</template>
```

**TransactionPackageOrderCell.vue 实现**:
```vue
<template>
  <div class="space-y-1">
    <div class="text-sm font-medium text-purple-700">
      {{ order.package_name || '标准套餐' }}
    </div>
    <div class="text-xs text-gray-600">
      <span class="font-medium">笔数:</span> 
      {{ order.used_transactions || 0 }}/{{ order.transaction_count || 0 }}
    </div>
    <div v-if="order.duration_hours" class="text-xs text-orange-600">
      <span class="font-medium">有效期:</span> 
      {{ order.duration_hours }}小时
    </div>
    <div v-if="order.remaining_transactions !== undefined" 
         class="text-xs" 
         :class="order.remaining_transactions > 0 ? 'text-green-600' : 'text-gray-400'">
      <span class="font-medium">剩余:</span> 
      {{ order.remaining_transactions }} 笔
    </div>
  </div>
</template>
```

**TrxExchangeOrderCell.vue 实现**:
```vue
<template>
  <div class="space-y-1">
    <div class="text-sm font-medium text-indigo-700">
      <span v-if="order.exchange_rate">
        汇率: {{ order.exchange_rate }}
      </span>
      <span v-else class="text-gray-400">待兑换</span>
    </div>
    <div v-if="order.input_amount && order.output_amount" 
         class="text-xs text-gray-600">
      {{ order.input_amount }} {{ order.input_currency || 'TRX' }} 
      → {{ order.output_amount }} {{ order.output_currency || 'USDT' }}
    </div>
    <div class="text-xs">
      <span :class="getExchangeStatusColor(order)" 
            class="inline-flex px-2 py-0.5 text-xs font-medium rounded">
        {{ getExchangeStatusText(order) }}
      </span>
    </div>
  </div>
</template>
```

#### 任务 1.3: 添加订单类型过滤功能
**文件**: `src/pages/Orders/index.vue`

**实现标签页导航**:
```vue
<template>
  <div class="space-y-6">
    <!-- 现有的网络状态栏和页面标题 -->
    
    <!-- 订单类型标签页 -->
    <div class="bg-white rounded-lg shadow-sm">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8 px-6">
          <button
            v-for="tab in orderTypeTabs"
            :key="tab.key"
            @click="switchOrderType(tab.key)"
            :class="[
              'py-4 px-1 border-b-2 font-medium text-sm',
              activeOrderType === tab.key
                ? 'border-indigo-500 text-indigo-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
          >
            {{ tab.label }}
            <span v-if="tab.count !== undefined" 
                  class="ml-2 py-0.5 px-2 text-xs rounded-full"
                  :class="activeOrderType === tab.key 
                    ? 'bg-indigo-100 text-indigo-600' 
                    : 'bg-gray-100 text-gray-600'">
              {{ tab.count }}
            </span>
          </button>
        </nav>
      </div>
    </div>

    <!-- 现有的搜索、过滤和订单列表组件 -->
    <!-- ... -->
  </div>
</template>

<script setup>
// 订单类型标签页配置
const orderTypeTabs = computed(() => [
  { key: 'all', label: '全部订单', count: state.stats.total },
  { key: 'energy_flash', label: '能量闪租', count: getOrderCountByType('energy_flash') },
  { key: 'transaction_package', label: '笔数套餐', count: getOrderCountByType('transaction_package') },
  { key: 'trx_exchange', label: 'TRX闪兑', count: getOrderCountByType('trx_exchange') }
])

const activeOrderType = ref('all')

// 切换订单类型
const switchOrderType = (orderType: string) => {
  activeOrderType.value = orderType
  // 更新过滤条件并重新获取数据
  state.filters.order_type = orderType === 'all' ? '' : orderType
  refreshOrders()
}
</script>
```

#### 任务 1.4: 更新订单搜索过滤器
**文件**: `src/pages/Orders/components/OrderSearch.vue`

**添加订单类型过滤器**:
```vue
<!-- 在现有过滤器中添加 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <!-- 现有的搜索和状态过滤器 -->
  
  <!-- 新增：订单类型过滤器 -->
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">订单类型</label>
    <select
      :value="filters.order_type || ''"
      @change="$emit('update:filters', { ...filters, order_type: $event.target.value })"
      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
    >
      <option value="">全部类型</option>
      <option value="energy_flash">能量闪租</option>
      <option value="transaction_package">笔数套餐</option>
      <option value="trx_exchange">TRX闪兑</option>
    </select>
  </div>
</div>
```

#### 任务 1.5: 更新类型定义和工具函数
**文件**: `src/pages/Orders/types/order.types.ts`

**更新接口定义**:
```typescript
export interface OrderFilters {
  search: string
  status: string
  order_type: string  // 新增字段
  dateRange: {
    start: string
    end: string
  }
}

export interface Order {
  // ... 现有字段
  
  // 笔数套餐特有字段
  package_name?: string
  transaction_count?: number
  used_transactions?: number
  remaining_transactions?: number
  
  // TRX闪兑特有字段
  exchange_rate?: number
  input_currency?: string
  output_currency?: string
  input_amount?: number
  output_amount?: number
}
```

**文件**: `src/pages/Orders/utils/orderStatus.ts`

**新增工具函数**:
```typescript
// TRX闪兑状态处理
export const getExchangeStatusText = (order: Order): string => {
  if (order.status === 'completed') return '兑换完成'
  if (order.status === 'processing') return '兑换中'
  if (order.status === 'failed') return '兑换失败'
  return '待兑换'
}

export const getExchangeStatusColor = (order: Order): string => {
  if (order.status === 'completed') return 'bg-green-100 text-green-800'
  if (order.status === 'processing') return 'bg-blue-100 text-blue-800'
  if (order.status === 'failed') return 'bg-red-100 text-red-800'
  return 'bg-gray-100 text-gray-800'
}

// 按类型获取订单数量统计
export const getOrderCountByType = (orders: Order[], orderType: string): number => {
  if (orderType === 'all') return orders.length
  return orders.filter(order => order.order_type === orderType).length
}
```

### Phase 2: 后端API适配和完善 (预计 1-2 天)

#### 任务 2.1: 完善订单查询API
**文件**: `api/routes/orders/order-crud.ts`

**支持订单类型过滤**:
```typescript
// GET /api/orders 路由增强
app.get('/api/orders', async (req, res) => {
  try {
    const {
      page = 1,
      limit = 20,
      search,
      status,
      order_type,  // 新增参数
      network_id,
      start_date,
      end_date
    } = req.query

    const queryParams = {
      page: parseInt(page as string),
      limit: parseInt(limit as string),
      search: search as string,
      status: status as string,
      order_type: order_type as string,  // 新增
      networkId: network_id as string,
      startDate: start_date as string,
      endDate: end_date as string
    }

    const result = await orderQueryService.getOrdersWithFilters(queryParams)
    
    res.json({
      success: true,
      data: result.orders,
      pagination: result.pagination,
      stats: result.stats
    })
  } catch (error) {
    logger.error('Get orders error:', error)
    res.status(500).json({
      success: false,
      error: 'Failed to fetch orders'
    })
  }
})
```

#### 任务 2.2: 更新订单查询服务
**文件**: `api/services/order/OrderQueryService.ts`

**添加订单类型过滤逻辑**:
```typescript
async getOrdersWithFilters(params: OrderQueryParams): Promise<QueryResult> {
  try {
    let query = `
      SELECT o.*, u.username, u.first_name, u.last_name, u.telegram_id
      FROM orders o
      LEFT JOIN users u ON o.user_id = u.id
      WHERE 1=1
    `
    const conditions: string[] = []
    const values: any[] = []
    let paramIndex = 1

    // 现有条件...

    // 新增：订单类型过滤
    if (params.order_type && params.order_type !== 'all') {
      conditions.push(`o.order_type = $${paramIndex}`)
      values.push(params.order_type)
      paramIndex++
    }

    // 组装最终查询
    if (conditions.length > 0) {
      query += ' AND ' + conditions.join(' AND ')
    }

    query += ` ORDER BY o.created_at DESC LIMIT $${paramIndex} OFFSET $${paramIndex + 1}`
    values.push(params.limit, (params.page - 1) * params.limit)

    const result = await pool.query(query, values)
    
    return {
      orders: result.rows,
      pagination: await this.getPaginationInfo(params),
      stats: await this.getOrderStats(params)
    }
  } catch (error) {
    logger.error('Query orders error:', error)
    throw error
  }
}
```

#### 任务 2.3: 添加订单统计按类型分组
**文件**: `api/services/order/OrderStatsService.ts`

**创建新的统计服务**:
```typescript
export class OrderStatsService {
  async getOrderStatsByType(networkId?: string): Promise<OrderTypeStats> {
    try {
      let query = `
        SELECT 
          order_type,
          COUNT(*) as total,
          COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed,
          COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending,
          COUNT(CASE WHEN status = 'failed' THEN 1 END) as failed,
          COALESCE(SUM(price_trx), 0) as total_revenue
        FROM orders
      `
      
      const params: any[] = []
      if (networkId) {
        query += ` WHERE network_id = $1`
        params.push(networkId)
      }
      
      query += ` GROUP BY order_type ORDER BY order_type`
      
      const result = await pool.query(query, params)
      
      return {
        energy_flash: this.extractStatsForType(result.rows, 'energy_flash'),
        transaction_package: this.extractStatsForType(result.rows, 'transaction_package'),
        trx_exchange: this.extractStatsForType(result.rows, 'trx_exchange')
      }
    } catch (error) {
      logger.error('Get order stats by type error:', error)
      throw error
    }
  }

  private extractStatsForType(rows: any[], orderType: string) {
    const row = rows.find(r => r.order_type === orderType)
    return row ? {
      total: parseInt(row.total),
      completed: parseInt(row.completed),
      pending: parseInt(row.pending),
      failed: parseInt(row.failed),
      totalRevenue: parseFloat(row.total_revenue)
    } : {
      total: 0, completed: 0, pending: 0, failed: 0, totalRevenue: 0
    }
  }
}
```

### Phase 3: 业务逻辑完善 (预计 3-4 天)

#### 任务 3.1: 完善笔数套餐订单处理逻辑
**新建文件**: `api/services/order-management/transaction-package/TransactionPackageOrderProcessor.ts`

#### 任务 3.2: 完善TRX闪兑订单处理逻辑  
**新建文件**: `api/services/order-management/trx-exchange/TrxExchangeOrderProcessor.ts`

#### 任务 3.3: 统一订单生命周期管理
**更新文件**: `api/services/order/OrderLifecycleService.ts`

## ✅ 验收标准

### 功能验收
1. **订单列表显示**
   - [ ] 能正确显示三种类型的订单
   - [ ] 不同类型订单的业务信息列显示对应的特有字段
   - [ ] 通用字段（ID、用户、金额等）正常显示

2. **类型过滤功能**
   - [ ] 标签页切换能正确过滤订单类型
   - [ ] 搜索过滤器中的订单类型选择器工作正常
   - [ ] 统计数据按类型正确显示

3. **兼容性**
   - [ ] 现有能量闪租订单功能不受影响
   - [ ] 现有API接口向后兼容
   - [ ] 数据库查询性能无明显下降

### 技术验收
1. **代码质量**
   - [ ] TypeScript 类型定义完整
   - [ ] 组件职责单一，复用性好
   - [ ] 错误处理完善

2. **性能标准**
   - [ ] 订单列表加载时间 < 2秒
   - [ ] 类型切换响应时间 < 500ms
   - [ ] 数据库查询优化，避免N+1问题

## ⚠️ 注意事项

### 开发注意点
1. **数据兼容性**: 现有订单数据的 `order_type` 字段可能为空，需要做默认值处理
2. **组件复用**: 优先复用现有组件逻辑，避免重复开发
3. **错误处理**: 对未知订单类型要有友好的错误提示
4. **响应式设计**: 确保移动端显示效果良好

### 测试重点
1. **边界条件**: 空数据、未知类型、网络错误等场景
2. **性能测试**: 大量订单数据的加载和筛选性能
3. **兼容性测试**: 现有功能的回归测试

### 上线注意
1. **数据库备份**: 执行前务必备份数据库
2. **分步上线**: 先上线前端界面，再完善业务逻辑
3. **监控告警**: 关注新功能的错误率和性能指标

## 📅 开发计划

| 阶段 | 时间 | 主要任务 | 负责人 | 状态 |
|-----|------|---------|--------|------|
| Phase 1 | Day 1-3 | 前端界面统一适配 | 前端开发 | 待开始 |
| Phase 2 | Day 4-5 | 后端API适配和完善 | 后端开发 | 待开始 |
| Phase 3 | Day 6-9 | 业务逻辑完善 | 全栈开发 | 待开始 |
| Testing | Day 10-11 | 集成测试和修复 | QA + 开发 | 待开始 |
| Deployment | Day 12 | 部署上线 | DevOps | 待开始 |

---

**文档版本**: v1.0  
**创建日期**: 2025-09-24  
**更新日期**: 2025-09-24  
**负责人**: 开发团队


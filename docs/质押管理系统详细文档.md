# 质押管理系统详细文档

## 概述

质押管理系统是TRON能量租赁平台的核心功能模块，基于TRON 2.0质押机制，提供完整的TRX质押、委托、解质押和提取功能。系统采用模块化设计，支持多网络配置，具备完善的记录追踪和统计分析功能。

## 系统架构

### 1. 技术架构
- **前端**: Vue 3 + TypeScript + Vite
- **后端**: Node.js + Express + TypeScript
- **数据库**: PostgreSQL
- **区块链接口**: TronWeb + TronGrid API
- **网络支持**: 主网、测试网等多网络配置

### 2. 模块化设计
```
质押管理系统
├── 路由层 (Routes)
│   ├── index.ts - 统一路由入口
│   ├── controllers/ - 控制器层
│   ├── validators/ - 参数验证器
│   └── types/ - 类型定义
├── 服务层 (Services)
│   ├── TronService - TRON网络服务
│   ├── StakingService - 质押服务
│   └── DelegationService - 委托服务
└── 数据层 (Database)
    ├── stake_records - 质押记录表
    ├── delegate_records - 委托记录表
    ├── unfreeze_records - 解质押记录表
    └── energy_pools - 能量池配置表
```

## API接口详细说明

### 1. 概览和统计接口

#### 1.1 获取质押概览
**接口**: `GET /api/stake/overview`

**功能**: 获取指定地址或能量池的质押概览信息

**请求参数**:
```typescript
{
  address?: string    // TRON地址（可选）
  poolId?: string     // 能量池ID（可选）
}
```

**响应数据**:
```typescript
{
  success: boolean
  data: {
    totalStakedTrx: number           // 总质押TRX数量
    unlockingTrx: number             // 解锁中TRX数量
    withdrawableTrx: number          // 可提取TRX数量
    stakedEnergy: number             // 质押获得能量
    delegatedToOthersEnergy: number  // 委托给他人的能量
    delegatedToSelfEnergy: number    // 委托给自己的能量
    stakedBandwidth: number          // 质押获得带宽
    delegatedToOthersBandwidth: number // 委托给他人的带宽
    delegatedToSelfBandwidth: number   // 委托给自己的带宽
  }
}
```

**数据库查询**: 通过`energy_pools`表获取账户信息，调用TronService查询链上数据

#### 1.2 获取质押统计信息
**接口**: `GET /api/stake/statistics`

**功能**: 获取质押和委托的统计数据

**请求参数**:
```typescript
{
  poolId?: string     // 能量池ID（可选）
  pool_id?: string    // 能量池ID别名（可选）
}
```

**响应数据**:
```typescript
{
  success: boolean
  data: {
    total_stakes: number         // 总质押次数
    total_staked: number         // 总质押金额
    total_unstaked: number       // 总解质押金额
    energy_stakes: number        // 能量质押次数
    bandwidth_stakes: number     // 带宽质押次数
    total_delegates: number      // 总委托次数
    total_delegated: number      // 总委托金额
    energy_delegates: number     // 能量委托次数
    bandwidth_delegates: number  // 带宽委托次数
  }
}
```

**涉及表**: `stake_records`, `delegate_records`

#### 1.3 获取账户资源信息
**接口**: `GET /api/stake/account-resources/:address`

**功能**: 获取指定TRON地址的资源信息

**路径参数**:
- `address`: TRON地址 (必需)

**查询参数**:
```typescript
{
  networkId?: string  // 网络ID（可选）
}
```

**响应数据**: 返回TronService查询的账户资源信息

#### 1.4 获取账户信息
**接口**: `GET /api/stake/account-info/:address`

**功能**: 获取指定TRON地址的账户信息

**路径参数**:
- `address`: TRON地址 (必需)

**查询参数**:
```typescript
{
  networkId?: string  // 网络ID（可选）
}
```

### 2. 质押操作接口

#### 2.1 质押TRX
**接口**: `POST /api/stake/freeze`

**功能**: 质押TRX获取能量或带宽资源

**请求体**:
```typescript
{
  ownerAddress: string     // 质押账户地址（必需）
  frozenBalance: number    // 质押金额，单位sun（必需）
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型（必需）
  poolId?: string          // 能量池ID（可选）
}
```

**业务逻辑**:
1. 参数验证（地址格式、金额、资源类型）
2. 调用`tronService.freezeBalanceV2()`执行链上质押
3. 更新`energy_pools`表中的质押统计信息
4. 返回交易结果

**涉及表**: `energy_pools`

**TronService方法**: `freezeBalanceV2()`

#### 2.2 解质押TRX
**接口**: `POST /api/stake/unfreeze`

**功能**: 解质押TRX，启动14天解冻期

**请求体**:
```typescript
{
  ownerAddress: string     // 质押账户地址（必需）
  unfreezeBalance: number  // 解质押金额，单位sun（必需）
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型（必需）
  poolId?: string          // 能量池ID（可选）
}
```

**业务逻辑**:
1. 参数验证
2. 调用`tronService.unfreezeBalanceV2()`执行链上解质押
3. 记录解质押记录到`unfreeze_records`表
4. 更新`energy_pools`表中的待解冻统计
5. 返回交易结果

**涉及表**: `unfreeze_records`, `energy_pools`

**TronService方法**: `unfreezeBalanceV2()`

#### 2.3 批量质押操作
**接口**: `POST /api/stake/batch-freeze`

**功能**: 批量执行质押操作

**请求体**:
```typescript
{
  operations: Array<{
    ownerAddress: string
    frozenBalance: number
    resource: 'ENERGY' | 'BANDWIDTH'
    poolId?: string
  }>
}
```

**业务逻辑**:
1. 验证操作数组（不能为空，最多50个操作）
2. 依次执行每个质押操作
3. 收集成功和失败的结果
4. 返回批量操作汇总结果

### 3. 委托操作接口

#### 3.1 委托资源
**接口**: `POST /api/stake/delegate`

**功能**: 将质押获得的资源委托给其他地址

**请求体**:
```typescript
{
  ownerAddress: string      // 委托方地址（必需）
  receiverAddress: string   // 接收方地址（必需）
  balance: number          // 委托数量（必需）
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型（必需）
  lock?: boolean           // 是否锁定（可选）
  lockPeriod?: number      // 锁定期天数（可选）
  poolId?: string          // 能量池ID（可选）
}
```

**业务逻辑**:
1. 参数验证（包括不能委托给自己的检查）
2. 调用`tronService.delegateResource()`执行链上委托
3. 记录委托记录到`delegate_records`表
4. 更新`energy_pools`表中的委托统计
5. 返回交易结果

**涉及表**: `delegate_records`, `energy_pools`

**TronService方法**: `delegateResource()`

#### 3.2 取消委托资源
**接口**: `POST /api/stake/undelegate`

**功能**: 取消之前的资源委托

**请求体**:
```typescript
{
  ownerAddress: string      // 委托方地址（必需）
  receiverAddress: string   // 接收方地址（必需）
  balance: number          // 取消委托数量（必需）
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型（必需）
  poolId?: string          // 能量池ID（可选）
}
```

**业务逻辑**:
1. 参数验证
2. 调用`tronService.undelegateResource()`执行链上取消委托
3. 记录取消委托记录到`delegate_records`表
4. 更新`energy_pools`表中的委托统计（减少）
5. 返回交易结果

**涉及表**: `delegate_records`, `energy_pools`

**TronService方法**: `undelegateResource()`

#### 3.3 批量委托操作
**接口**: `POST /api/stake/batch-delegate`

**功能**: 批量执行委托操作

**请求体**:
```typescript
{
  operations: Array<{
    ownerAddress: string
    receiverAddress: string
    balance: number
    resource: 'ENERGY' | 'BANDWIDTH'
    lock?: boolean
    lockPeriod?: number
    poolId?: string
  }>
}
```

### 4. 提取操作接口

#### 4.1 提取已解冻资金
**接口**: `POST /api/stake/withdraw`

**功能**: 提取解冻期已过的TRX资金

**请求体**:
```typescript
{
  ownerAddress: string  // 账户地址（必需）
  poolId?: string       // 能量池ID（可选）
}
```

**业务逻辑**:
1. 参数验证
2. 查询`unfreeze_records`表检查可提取TRX
3. 如果有可提取TRX，调用`tronService.withdrawExpireUnfreeze()`
4. 更新解质押记录状态为"已提取"
5. 更新`energy_pools`表的提取统计
6. 返回提取结果

**涉及表**: `unfreeze_records`, `energy_pools`

**TronService方法**: `withdrawExpireUnfreeze()`

#### 4.2 获取可提取TRX信息
**接口**: `GET /api/stake/withdrawable-info`

**功能**: 查看可提取和待提取的资金详情

**查询参数**:
```typescript
{
  address?: string  // TRON地址（可选）
  poolId?: string   // 能量池ID（可选）
}
```

**响应数据**:
```typescript
{
  success: boolean
  data: {
    totalWithdrawable: number    // 可立即提取金额
    totalPending: number         // 待解冻金额
    availableRecords: number     // 可提取记录数
    pendingRecords: number       // 待解冻记录数
    records: Array<{
      id: string
      amount: number
      resourceType: string
      unfreezeTime: string
      availableTime: string
      status: string
      canWithdraw: boolean       // 是否可提取
    }>
  }
}
```

**涉及表**: `unfreeze_records`

#### 4.3 批量提取操作
**接口**: `POST /api/stake/batch-withdraw`

**功能**: 批量提取多个地址的可用资金

**请求体**:
```typescript
{
  addresses: string[]  // TRON地址数组
}
```

### 5. 记录查询接口

#### 5.1 获取质押记录
**接口**: `GET /api/stake/records`

**功能**: 查询质押和解质押记录（从TRON网络API获取真实数据）

**查询参数**:
```typescript
{
  address?: string           // TRON地址（可选）
  poolId?: string           // 能量池ID（可选）
  pool_id?: string          // 能量池ID别名（可选）
  page?: string             // 页码（默认1）
  limit?: string            // 每页数量（默认20）
  operation_type?: string   // 操作类型：freeze/unfreeze（可选）
  resource_type?: string    // 资源类型：ENERGY/BANDWIDTH（可选）
  startDate?: string        // 开始日期（可选）
  endDate?: string          // 结束日期（可选）
}
```

**响应数据**:
```typescript
{
  success: boolean
  data: Array<{
    id: string
    pool_account_id: string
    operation_type: 'freeze' | 'unfreeze'
    amount: number
    resource_type: 'ENERGY' | 'BANDWIDTH'
    txid: string
    status: 'pending' | 'confirmed' | 'failed'
    created_at: string
    confirmed_at?: string
    error_message?: string
  }>
  pagination: {
    page: number
    limit: number
    total: number
    totalPages: number
  }
}
```

**数据来源**: 通过`TronService.getStakeTransactionHistory()`从TRON网络获取

#### 5.2 获取委托记录
**接口**: `GET /api/stake/delegates`

**功能**: 查询委托和取消委托记录（从TRON网络API获取真实数据）

**查询参数**: 同质押记录接口

**响应数据**:
```typescript
{
  success: boolean
  data: Array<{
    id: string
    pool_account_id: string
    operation_type: 'delegate' | 'undelegate'
    receiver_address: string
    amount: number
    resource_type: 'ENERGY' | 'BANDWIDTH'
    txid: string
    status: 'pending' | 'confirmed' | 'failed'
    created_at: string
    confirmed_at?: string
    lock_period?: number
    is_locked: boolean
    error_message?: string
  }>
  pagination: PaginationInfo
}
```

**数据来源**: 通过`TronService.getDelegateTransactionHistory()`从TRON网络获取

#### 5.3 获取解冻记录
**接口**: `GET /api/stake/unfreezes`

**功能**: 查询解冻记录（从TRON网络API获取真实数据）

**查询参数**: 同质押记录接口（不包含operation_type）

**响应数据**:
```typescript
{
  success: boolean
  data: Array<{
    id: string
    pool_account_id: string
    amount: number
    resource_type: 'ENERGY' | 'BANDWIDTH'
    txid: string
    unfreeze_time: string
    withdrawable_time: string
    status: 'unfreezing' | 'withdrawable' | 'withdrawn'
    created_at: string
    canWithdraw: boolean           // 是否可提取
    daysUntilWithdrawable: number  // 距离可提取天数
  }>
  pagination: PaginationInfo
}
```

**数据来源**: 通过`TronService.getUnfreezeTransactionHistory()`从TRON网络获取

#### 5.4 获取综合记录摘要
**接口**: `GET /api/stake/records-summary`

**功能**: 获取质押、委托、解冻等操作的汇总统计

**查询参数**:
```typescript
{
  address?: string   // TRON地址（可选）
  pool_id?: string   // 能量池ID（可选）
}
```

**响应数据**:
```typescript
{
  success: boolean
  data: {
    staking: {
      totalOperations: number      // 总质押操作次数
      freezeOperations: number     // 质押操作次数
      unfreezeOperations: number   // 解质押操作次数
      totalFrozen: number          // 总质押金额
      totalUnfrozen: number        // 总解质押金额
      netStaked: number            // 净质押金额
    }
    delegation: {
      totalOperations: number      // 总委托操作次数
      delegateOperations: number   // 委托操作次数
      undelegateOperations: number // 取消委托操作次数
      totalDelegated: number       // 总委托金额
      totalUndelegated: number     // 总取消委托金额
      netDelegated: number         // 净委托金额
    }
    withdrawal: {
      totalUnfreezes: number       // 总解冻次数
      withdrawableCount: number    // 可提取记录数
      withdrawnCount: number       // 已提取记录数
      withdrawableAmount: number   // 可提取金额
      totalWithdrawn: number       // 总已提取金额
    }
  }
}
```

**涉及表**: `stake_records`, `delegate_records`, `unfreeze_records`

## 数据库表结构详细说明

### 1. 质押记录表 (stake_records)

**用途**: 记录所有质押和解质押操作

**表结构**:
```sql
CREATE TABLE stake_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_account_id UUID NOT NULL REFERENCES energy_pools(id) ON DELETE CASCADE,
    operation_type VARCHAR(20) NOT NULL CHECK (operation_type IN ('freeze', 'unfreeze')),
    resource_type VARCHAR(20) NOT NULL CHECK (resource_type IN ('ENERGY', 'BANDWIDTH')),
    amount BIGINT NOT NULL CHECK (amount > 0),
    tx_hash VARCHAR(64) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'failed')),
    block_number BIGINT,
    gas_used BIGINT,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明**:
- `id`: 记录唯一标识（UUID）
- `pool_account_id`: 关联的能量池账户ID
- `operation_type`: 操作类型（freeze-质押，unfreeze-解质押）
- `resource_type`: 资源类型（ENERGY-能量，BANDWIDTH-带宽）
- `amount`: 操作金额，单位为sun（1 TRX = 1,000,000 sun）
- `tx_hash`: 交易哈希值
- `status`: 交易状态（pending-待确认，confirmed-已确认，failed-失败）
- `block_number`: 区块号
- `gas_used`: 消耗的Gas
- `error_message`: 错误信息（如果有）

**索引**:
- `idx_stake_records_pool_account_id`: 能量池账户ID索引
- `idx_stake_records_created_at`: 创建时间索引（降序）
- `idx_stake_records_tx_hash`: 交易哈希索引
- `idx_stake_records_status`: 状态索引
- `idx_stake_records_operation_type`: 操作类型索引

### 2. 委托记录表 (delegate_records)

**用途**: 记录所有资源委托和取消委托操作

**表结构**:
```sql
CREATE TABLE delegate_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_account_id UUID NOT NULL REFERENCES energy_pools(id) ON DELETE CASCADE,
    receiver_address VARCHAR(34) NOT NULL,
    operation_type VARCHAR(20) NOT NULL CHECK (operation_type IN ('delegate', 'undelegate')),
    resource_type VARCHAR(20) NOT NULL CHECK (resource_type IN ('ENERGY', 'BANDWIDTH')),
    amount BIGINT NOT NULL CHECK (amount > 0),
    is_locked BOOLEAN DEFAULT false,
    lock_period INTEGER DEFAULT 0,
    tx_hash VARCHAR(64) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'failed')),
    block_number BIGINT,
    gas_used BIGINT,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE
);
```

**字段说明**:
- `receiver_address`: 接收委托资源的TRON地址
- `operation_type`: 操作类型（delegate-委托，undelegate-取消委托）
- `is_locked`: 是否锁定委托
- `lock_period`: 锁定期，单位为小时
- `expires_at`: 委托到期时间

**索引**:
- `idx_delegate_records_pool_account_id`: 能量池账户ID索引
- `idx_delegate_records_receiver_address`: 接收地址索引
- `idx_delegate_records_created_at`: 创建时间索引（降序）
- `idx_delegate_records_status`: 状态索引
- `idx_delegate_records_operation_type`: 操作类型索引
- `idx_delegate_records_expires_at`: 到期时间索引

### 3. 解质押记录表 (unfreeze_records)

**用途**: 记录解质押和提款操作，管理14天解冻期

**表结构**:
```sql
CREATE TABLE unfreeze_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pool_account_id UUID NOT NULL REFERENCES energy_pools(id) ON DELETE CASCADE,
    resource_type VARCHAR(20) NOT NULL CHECK (resource_type IN ('ENERGY', 'BANDWIDTH')),
    amount BIGINT NOT NULL CHECK (amount > 0),
    unfreeze_tx_hash VARCHAR(64) NOT NULL,
    withdraw_tx_hash VARCHAR(64),
    unfreeze_time TIMESTAMP WITH TIME ZONE NOT NULL,
    available_time TIMESTAMP WITH TIME ZONE NOT NULL,
    withdrawn_amount BIGINT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'unfrozen' CHECK (status IN ('unfrozen', 'withdrawn', 'failed')),
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明**:
- `unfreeze_tx_hash`: 解质押交易哈希
- `withdraw_tx_hash`: 提款交易哈希
- `unfreeze_time`: 解质押时间
- `available_time`: 可提款时间（解质押后14天）
- `withdrawn_amount`: 已提款金额，单位为sun
- `status`: 状态（unfrozen-已解质押，withdrawn-已提款，failed-失败）

**索引**:
- `idx_unfreeze_records_pool_account_id`: 能量池账户ID索引
- `idx_unfreeze_records_available_time`: 可提款时间索引
- `idx_unfreeze_records_status`: 状态索引
- `idx_unfreeze_records_unfreeze_tx_hash`: 解质押交易哈希索引
- `idx_unfreeze_records_withdraw_tx_hash`: 提款交易哈希索引

### 4. 能量池表扩展字段 (energy_pools)

**新增质押相关字段**:
```sql
ALTER TABLE energy_pools ADD COLUMN staked_trx_energy BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN staked_trx_bandwidth BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN delegated_energy BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN delegated_bandwidth BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN pending_unfreeze_energy BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN pending_unfreeze_bandwidth BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN last_stake_update TIMESTAMP WITH TIME ZONE DEFAULT NOW();
```

**字段说明**:
- `staked_trx_energy`: 质押用于获取能量的TRX数量，单位为sun
- `staked_trx_bandwidth`: 质押用于获取带宽的TRX数量，单位为sun
- `delegated_energy`: 已委托出去的能量数量
- `delegated_bandwidth`: 已委托出去的带宽数量
- `pending_unfreeze_energy`: 待提款的能量质押TRX数量，单位为sun
- `pending_unfreeze_bandwidth`: 待提款的带宽质押TRX数量，单位为sun
- `last_stake_update`: 最后一次质押状态更新时间

### 5. 质押统计视图 (stake_statistics)

**用途**: 提供各账户的质押、委托等统计信息

**视图定义**:
```sql
CREATE OR REPLACE VIEW stake_statistics AS
SELECT 
    ep.id as pool_account_id,
    ep.name as account_name,
    ep.tron_address,
    ep.staked_trx_energy,
    ep.staked_trx_bandwidth,
    ep.delegated_energy,
    ep.delegated_bandwidth,
    ep.pending_unfreeze_energy,
    ep.pending_unfreeze_bandwidth,
    COALESCE(stake_summary.total_staked, 0) as total_staked_amount,
    COALESCE(stake_summary.total_unfrozen, 0) as total_unfrozen_amount,
    COALESCE(delegate_summary.total_delegated, 0) as total_delegated_amount,
    COALESCE(delegate_summary.total_undelegated, 0) as total_undelegated_amount,
    ep.last_stake_update
FROM energy_pools ep
LEFT JOIN (/* 质押汇总子查询 */) stake_summary ON ep.id = stake_summary.pool_account_id
LEFT JOIN (/* 委托汇总子查询 */) delegate_summary ON ep.id = delegate_summary.pool_account_id;
```

## TronService服务层详细说明

### 1. 服务架构

TronService采用分层架构设计：

```typescript
TronService
├── AccountService - 账户信息服务
├── StakingService - 质押服务
├── DelegationService - 委托服务
└── TransactionService - 交易服务
```

### 2. 质押相关方法

#### 2.1 freezeBalanceV2()
**功能**: 执行TRX质押操作

**参数**:
```typescript
interface FreezeBalanceV2Params {
  ownerAddress: string     // 质押账户地址
  frozenBalance: number    // 质押金额（sun）
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型
}
```

**返回值**:
```typescript
interface TransactionResult {
  success: boolean
  txid?: string       // 交易哈希
  error?: string      // 错误信息
  energyUsed?: number // 消耗的能量
  netUsed?: number    // 消耗的带宽
}
```

**调用链**: 
`StakeController.freeze()` → `tronService.freezeBalanceV2()` → `stakingService.freezeBalanceV2()` → `tronWeb.transactionBuilder.freezeBalanceV2()`

#### 2.2 unfreezeBalanceV2()
**功能**: 执行TRX解质押操作

**参数**:
```typescript
interface UnfreezeBalanceV2Params {
  ownerAddress: string     // 质押账户地址
  unfreezeBalance: number  // 解质押金额（sun）
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型
}
```

**特点**: 解质押后资金需要等待14天才能提取

#### 2.3 withdrawExpireUnfreeze()
**功能**: 提取已过解冻期的资金

**参数**:
```typescript
interface WithdrawExpireUnfreezeParams {
  ownerAddress: string  // 账户地址
}
```

**注意**: 只能提取解冻期已过（14天后）的资金

#### 2.4 delegateResource()
**功能**: 委托资源给其他地址

**参数**:
```typescript
interface DelegateResourceParams {
  ownerAddress: string      // 委托方地址
  receiverAddress: string   // 接收方地址
  balance: number          // 委托数量
  resource: 'ENERGY' | 'BANDWIDTH'  // 资源类型
  lock: boolean            // 是否锁定
  lockPeriod?: number      // 锁定期（天）
}
```

#### 2.5 undelegateResource()
**功能**: 取消资源委托

**参数**: 同`delegateResource`（除了lock和lockPeriod）

### 3. 查询相关方法

#### 3.1 getStakeOverview()
**功能**: 获取账户质押概览

**返回数据**:
```typescript
interface StakeOverview {
  totalStakedTrx: number           // 总质押TRX
  unlockingTrx: number             // 解锁中TRX
  withdrawableTrx: number          // 可提取TRX
  stakedEnergy: number             // 质押获得能量
  delegatedToOthersEnergy: number  // 委托给他人能量
  delegatedToSelfEnergy: number    // 委托给自己能量
  stakedBandwidth: number          // 质押获得带宽
  delegatedToOthersBandwidth: number // 委托给他人带宽
  delegatedToSelfBandwidth: number   // 委托给自己带宽
}
```

#### 3.2 getStakeTransactionHistory()
**功能**: 获取质押交易历史（从TRON网络API）

**参数**:
- `address`: TRON地址
- `limit`: 返回数量限制
- `offset`: 偏移量

**数据来源**: TronGrid API

#### 3.3 getDelegateTransactionHistory()
**功能**: 获取委托交易历史（从TRON网络API）

#### 3.4 getUnfreezeTransactionHistory()
**功能**: 获取解质押交易历史（从TRON网络API）

## 参数验证系统

### 1. StakeValidators类

提供全面的参数验证功能：

#### 1.1 validateStakeOperation()
验证质押操作参数：
- 地址格式验证（TRON地址以'T'开头，34字符长度）
- 金额验证（必须大于0）
- 资源类型验证（ENERGY或BANDWIDTH）

#### 1.2 validateDelegateOperation()
验证委托操作参数：
- 委托方和接收方地址格式
- 不能委托给自己的检查
- 锁定期验证（0-365天）

#### 1.3 validateWithdrawOperation()
验证提取操作参数：
- 地址格式验证

#### 1.4 validatePaginationParams()
验证分页参数：
- 页码必须为正整数
- 限制数量1-100之间

#### 1.5 validateDateParams()
验证日期参数：
- ISO 8601格式检查
- 日期范围不超过1年的限制

### 2. 参数清理和标准化

`sanitizeParams()`方法提供：
- 空值清理
- 资源类型大写转换
- 数值类型转换

## 网络配置和多网络支持

### 1. 网络配置管理

系统支持多个TRON网络：
- 主网 (Mainnet)
- 测试网 (Shasta, Nile)
- 自定义网络

### 2. 动态网络切换

```typescript
await tronService.switchToNetwork(networkId);
```

根据能量池配置的网络ID自动切换到对应网络。

### 3. 网络配置来源

1. **数据库配置优先**: 从`tron_networks`表加载配置
2. **环境变量回退**: 如果数据库配置不可用，使用环境变量
3. **配置热更新**: 支持配置变更的实时监听

## 错误处理和日志

### 1. 错误分类

- **参数验证错误**: 400状态码，详细参数错误信息
- **业务逻辑错误**: 400状态码，业务相关错误
- **网络错误**: 500状态码，TRON网络连接错误
- **服务器错误**: 500状态码，内部服务错误

### 2. 错误响应格式

```typescript
{
  success: false,
  error: string,      // 错误概述
  details?: string,   // 详细错误信息
  type?: string       // 错误类型
}
```

### 3. 日志记录

- 所有质押操作都有详细的日志记录
- 包含请求参数、执行结果、错误信息
- 便于问题排查和审计

## 性能优化

### 1. 数据库优化

- **索引优化**: 为查询频繁的字段创建合适的索引
- **分页查询**: 支持分页避免大数据量查询
- **视图优化**: 使用统计视图提高复杂查询性能

### 2. 接口优化

- **批量操作**: 支持批量质押、委托、提取操作
- **并发控制**: 合理的并发限制避免系统过载
- **缓存机制**: 对频繁查询的数据进行缓存

### 3. TRON网络优化

- **连接池**: 复用TRON网络连接
- **重试机制**: 网络失败时的自动重试
- **超时控制**: 合理的超时设置

## 安全考虑

### 1. 身份验证

所有接口都需要通过`authenticateToken`中间件进行身份验证。

### 2. 参数验证

- 严格的参数格式验证
- SQL注入防护
- 地址格式验证

### 3. 权限控制

- 基于能量池的访问控制
- 操作日志记录和审计

### 4. 私钥安全

- 私钥环境变量存储
- 不在日志中记录敏感信息

## 监控和运维

### 1. 健康检查

- TRON网络连接状态
- 数据库连接状态
- 服务响应时间

### 2. 统计指标

- 质押操作成功率
- 平均响应时间
- 错误率统计

### 3. 告警机制

- 网络连接失败告警
- 操作失败率过高告警
- 资金异常变动告警

## 部署和配置

### 1. 环境变量配置

```bash
# TRON网络配置
TRON_FULL_HOST=https://api.trongrid.io
TRON_PRIVATE_KEY=your_private_key
TRON_SOLIDITY_NODE=https://api.trongrid.io
TRON_EVENT_SERVER=https://api.trongrid.io

# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/tron_energy_rental
```

### 2. 数据库迁移

```bash
# 执行质押管理表创建迁移
psql -d tron_energy_rental -f migrations/20250903_create_stake_management_tables.sql
```

### 3. 服务启动

```bash
# 开发环境
npm run dev

# 生产环境
npm run start
```

## 测试验证

### 1. 接口测试用例

#### 质押操作测试
```bash
# 质押TRX
curl -X POST http://localhost:3001/api/stake/freeze \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "ownerAddress": "Txxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "frozenBalance": 1000000000,
    "resource": "ENERGY",
    "poolId": "pool-id"
  }'
```

#### 委托操作测试
```bash
# 委托资源
curl -X POST http://localhost:3001/api/stake/delegate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "ownerAddress": "Txxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "receiverAddress": "TYyyyyyyyyyyyyyyyyyyyyyyyyyyyyy",
    "balance": 500000000,
    "resource": "ENERGY"
  }'
```

#### 查询测试
```bash
# 获取质押概览
curl -X GET "http://localhost:3001/api/stake/overview?poolId=pool-id" \
  -H "Authorization: Bearer your_token"

# 获取质押记录
curl -X GET "http://localhost:3001/api/stake/records?poolId=pool-id&page=1&limit=20" \
  -H "Authorization: Bearer your_token"
```

### 2. 数据验证

验证要点：
1. **交易状态同步**: 确保链上交易状态与数据库记录一致
2. **金额计算准确性**: 验证质押、委托、解冻金额的正确性
3. **时间计算准确性**: 验证14天解冻期的计算
4. **统计数据一致性**: 确保统计数据与实际记录匹配

### 3. 边界条件测试

- 最小质押金额测试
- 余额不足情况测试
- 网络异常情况测试
- 并发操作测试

## 常见问题和解决方案

### 1. 质押失败问题

**问题**: 质押操作返回失败
**可能原因**:
- 账户余额不足
- 网络连接问题
- 私钥配置错误
- 地址格式错误

**解决方案**:
1. 检查账户TRX余额
2. 验证网络连接状态
3. 确认私钥配置正确
4. 验证地址格式

### 2. 记录查询不一致

**问题**: 数据库记录与链上数据不一致
**原因**: 网络延迟或同步问题
**解决方案**:
1. 优先使用链上数据（接口已实现）
2. 定期同步链上数据到数据库
3. 实现数据一致性检查机制

### 3. 提取操作失败

**问题**: 无法提取解冻资金
**可能原因**:
- 解冻期未满14天
- 没有可提取的资金
- 网络问题

**解决方案**:
1. 检查解冻时间
2. 查询可提取金额
3. 重试操作

## 版本历史和更新日志

### v1.0.0 (2025-09-03)
- 初始版本发布
- 支持基础质押、委托、解质押功能
- 实现多网络配置
- 完成数据库表结构设计

### 未来计划

1. **性能优化**
   - 实现Redis缓存
   - 优化数据库查询
   - 支持更大并发量

2. **功能扩展**
   - 支持更多资源类型
   - 实现自动化质押策略
   - 添加收益分析功能

3. **监控增强**
   - 实时监控看板
   - 详细的性能指标
   - 自动化告警系统

---

本文档详细描述了质押管理系统的所有接口、数据库表、业务逻辑和技术实现。如有疑问或需要更多详细信息，请参考代码实现或联系开发团队。


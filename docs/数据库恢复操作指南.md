# 数据库恢复操作指南

> **⚠️ 重要警告**: 数据库恢复操作将完全覆盖现有数据，操作不可逆！请务必在恢复前创建备份。

## 📋 概述

本文档提供了恢复 `backups/db_backup_navicat_tron_energy_20250923_183800.sql` 备份文件的详细步骤。

## 🛠 准备工作

### 1. 环境要求

- PostgreSQL 客户端工具 (`psql`, `pg_dump`)
- 有效的数据库管理权限
- 项目根目录下的 `.env` 配置文件

### 2. 安装数据库客户端 (如果需要)

```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# CentOS/RHEL
sudo yum install postgresql
```

## 🔧 方案选择

### 方案一：使用现有项目脚本 (推荐)

项目已包含自动化的数据库操作脚本，会自动读取 `.env` 配置。

```bash
# 1. 备份当前数据库 (安全措施)
./scripts/database/backup-database.sh

# 2. 恢复指定备份文件
./scripts/database/restore-database.sh backups/db_backup_navicat_tron_energy_20250923_183800.sql
```

**优势**:
- ✅ 自动读取项目配置
- ✅ 双重确认保护
- ✅ 详细的操作日志
- ✅ 自动权限修复
- ✅ 恢复后验证

### 方案二：手动命令行操作

#### A. 使用超级用户权限 (原始方案)

适用于有 PostgreSQL 超级用户权限的情况：

```bash
# 设置数据库密码环境变量
export PGPASSWORD="postgres"

# 删除现有数据库
psql -h localhost -p 5432 -U postgres -c "DROP DATABASE IF EXISTS tron_energy_rental;"

# 创建新的空数据库
psql -h localhost -p 5432 -U postgres -c "CREATE DATABASE tron_energy_rental;"

# 验证数据库创建成功
psql -h localhost -p 5432 -U postgres -c "\l" | grep tron_energy_rental

# 导入指定的备份文件
psql -h localhost -p 5432 -U postgres -d tron_energy_rental -f backups/db_backup_navicat_tron_energy_20250923_183800.sql

# 清除密码环境变量
unset PGPASSWORD
```

#### B. 使用项目配置 (修正方案)

基于项目实际配置的恢复方案：

```bash
# 设置数据库密码环境变量 (使用项目配置)
export PGPASSWORD="AZDTswBsRbhTpbAm"

# 连接到默认数据库，删除现有数据库
psql -h localhost -p 5432 -U db_tron_admin -d postgres -c "DROP DATABASE IF EXISTS tron_energy;"

# 创建新的空数据库
psql -h localhost -p 5432 -U db_tron_admin -d postgres -c "CREATE DATABASE tron_energy;"

# 验证数据库创建成功
psql -h localhost -p 5432 -U db_tron_admin -d postgres -c "\l" | grep tron_energy

# 导入指定的备份文件
psql -h localhost -p 5432 -U db_tron_admin -d tron_energy -f backups/db_backup_navicat_tron_energy_20250923_183800.sql

# 清除密码环境变量
unset PGPASSWORD
```

## 📊 项目配置信息

从 `.env` 文件中的数据库配置：

```ini
# 数据库配置
DATABASE_URL=postgresql://db_tron_admin:AZDTswBsRbhTpbAm@localhost:5432/tron_energy
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy
DB_USER=db_tron_admin
DB_PASSWORD=AZDTswBsRbhTpbAm
```

**注意**: 项目实际使用的数据库名称是 `tron_energy`，不是 `tron_energy_rental`。

## 🔒 安全提醒

### ⚠️ 恢复前必做

1. **创建当前数据库备份**:
   ```bash
   ./scripts/database/backup-database.sh
   ```

2. **停止应用服务**:
   ```bash
   # 停止相关服务
   ps aux | grep -E 'tron-energy-rental|tsx.*server\.ts|vite.*5173' | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true
   ```

3. **验证备份文件完整性**:
   ```bash
   # 检查备份文件大小
   ls -lh backups/db_backup_navicat_tron_energy_20250923_183800.sql
   
   # 检查文件内容
   head -20 backups/db_backup_navicat_tron_energy_20250923_183800.sql
   tail -20 backups/db_backup_navicat_tron_energy_20250923_183800.sql
   ```

### 🛡️ 恢复后验证

1. **验证数据库连接**:
   ```bash
   # 测试API登录
   curl -s -X POST http://localhost:3001/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@tronrental.com","password":"admin123456"}' | jq .
   ```

2. **重启应用服务**:
   ```bash
   npm run restart
   # 或
   pnpm run restart
   ```

3. **验证应用功能**:
   - 检查前端服务 (端口 5173)
   - 检查后端API服务 (端口 3001)
   - 测试数据库查询功能

## 📝 备份文件信息

**目标备份文件**: `backups/db_backup_navicat_tron_energy_20250923_183800.sql`

**文件特征**:
- 创建时间: 2025年09月23日 18:38:00
- 文件大小: 根据实际情况查看
- 格式: PostgreSQL SQL 转储文件
- 编码: UTF-8

## 🛠 故障排除

### 常见问题及解决方案

#### 1. 权限不足错误
```bash
ERROR: permission denied to create database
```

**解决方案**:
- 使用具有 `CREATEDB` 权限的用户
- 或使用 PostgreSQL 超级用户 (如 `postgres`)

#### 2. 数据库不存在错误
```bash
FATAL: database "tron_energy" does not exist
```

**解决方案**:
- 确保先创建数据库再导入数据
- 检查数据库名称拼写是否正确

#### 3. 连接失败错误
```bash
FATAL: authentication failed
```

**解决方案**:
- 检查用户名和密码是否正确
- 确认 PostgreSQL 服务正在运行
- 检查 `pg_hba.conf` 配置

#### 4. 文件读取错误
```bash
No such file or directory
```

**解决方案**:
- 使用绝对路径指定备份文件
- 确认备份文件确实存在且可读

### 验证命令

```bash
# 检查 PostgreSQL 服务状态
pg_ctl status

# 查看数据库列表
psql -h localhost -p 5432 -U db_tron_admin -l

# 检查表数量
psql -h localhost -p 5432 -U db_tron_admin -d tron_energy -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"

# 检查应用服务状态
lsof -i :3001  # 后端服务
lsof -i :5173  # 前端服务
```

## 📚 相关脚本

项目中的其他数据库管理脚本：

- `scripts/database/backup-database.sh` - 创建数据库备份
- `scripts/database/restore-database.sh` - 恢复数据库备份
- `scripts/database/backup-database-navicat.sh` - Navicat 格式备份
- `scripts/database/verify-backup-permissions.sh` - 验证备份权限
- `scripts/database/auto-fix-sequences.sh` - 修复序列问题

## 🔄 完整操作流程

### 推荐的完整恢复流程：

```bash
# 1. 停止应用服务
ps aux | grep -E 'tron-energy-rental|tsx.*server\.ts|vite.*5173' | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true

# 2. 备份当前数据库
./scripts/database/backup-database.sh

# 3. 恢复目标备份
./scripts/database/restore-database.sh backups/db_backup_navicat_tron_energy_20250923_183800.sql

# 4. 重启应用服务
npm run restart

# 5. 验证应用功能
curl -s -X POST http://localhost:3001/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@tronrental.com","password":"admin123456"}' | jq .
```

## 📋 操作检查清单

- [ ] 已停止应用服务
- [ ] 已创建当前数据库备份
- [ ] 已验证备份文件完整性
- [ ] 已确认恢复操作的必要性
- [ ] 已了解操作不可逆的风险
- [ ] 已准备好 PostgreSQL 连接信息
- [ ] 已测试数据库连接
- [ ] 已执行数据库恢复操作
- [ ] 已验证恢复结果
- [ ] 已重启应用服务
- [ ] 已测试应用功能

---

**最后更新**: 2025年09月23日  
**备注**: 本文档基于项目实际配置生成，请根据具体环境调整相关参数。

# TRON能量租赁系统 - 宝塔面板部署指南

## 📋 文档概述

本文档提供使用宝塔面板可视化界面部署TRON能量租赁系统的详细步骤指南。宝塔面板是一款简单好用的Linux服务器管理面板，通过Web界面即可完成所有部署操作。

## 🚀 快速导航

- [系统要求](#系统要求)
- [宝塔面板安装](#宝塔面板安装)
- [环境配置](#环境配置)
- [项目部署](#项目部署)
- [网站配置](#网站配置)
- [进程管理](#进程管理)
- [数据库配置](#数据库配置)
- [SSL证书](#ssl证书)
- [监控维护](#监控维护)
- [故障排除](#故障排除)

## 🔧 系统要求

### 服务器配置

| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| 操作系统 | Ubuntu 18.04+ / CentOS 7+ | Ubuntu 20.04+ |
| CPU | 2核心 | 4核心 |
| 内存 | 2GB | 4GB+ |
| 磁盘 | 20GB | 50GB+ (SSD) |
| 网络 | 10M带宽 | 100M带宽 |

### 端口要求

```
8888  - 宝塔面板访问端口
3001  - API后端服务端口
5173  - 前端开发服务器端口 (开发环境)
5432  - PostgreSQL数据库端口
6379  - Redis缓存端口
80    - HTTP访问端口
443   - HTTPS访问端口
22    - SSH端口
```

## 📦 宝塔面板安装

### 1. 一键安装宝塔面板

```bash
# Ubuntu/Debian系统
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh

# CentOS系统
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

### 2. 获取面板信息

安装完成后，记录以下信息：
- **面板地址**: http://服务器IP:8888
- **用户名**: 安装时显示的用户名
- **密码**: 安装时显示的密码
- **安全入口**: 随机生成的安全路径

### 3. 登录宝塔面板

1. 在浏览器中访问面板地址
2. 输入用户名和密码登录
3. 首次登录会要求绑定宝塔账号（可选）

## ⚙️ 环境配置

### 1. 安装软件套件

#### 步骤1：进入软件商店
- 在宝塔面板左侧菜单点击 **"软件商店"**
- 选择 **"运行环境"** 标签页

#### 步骤2：安装必需软件

按以下顺序安装软件：

1. **Nginx** - Web服务器
   - 点击 "一键安装"
   - 等待安装完成（约5-10分钟）

2. **PostgreSQL** - 数据库
   - 选择版本：PostgreSQL 14.x
   - 点击 "一键安装"
   - 设置root密码并记录

3. **Redis** - 缓存数据库
   - 选择最新版本
   - 点击 "一键安装"

4. **Node.js版本管理器**
   - 搜索 "Node.js版本管理器"
   - 点击 "安装"

#### 步骤3：配置Node.js环境

1. 安装完成后，点击Node.js版本管理器的 **"设置"**
2. 安装Node.js 18.x版本：
   - 在版本列表中找到 "18.19.0" 或更新版本
   - 点击 **"安装"**
   - 等待安装完成
3. 设置为默认版本：
   - 点击已安装版本旁的 **"切换"**
4. 全局安装必需包：
   ```bash
   npm install -g pnpm pm2 tsx
   ```

### 2. 数据库初始化

#### 步骤1：配置PostgreSQL

1. 进入 **"数据库"** → **"PostgreSQL"**
2. 点击 **"设置"** 配置：
   - **监听地址**: 改为 `0.0.0.0`（如需远程连接）
   - **端口**: 保持默认 `5432`
3. 重启PostgreSQL服务

#### 步骤2：创建项目数据库

1. 在 **"数据库"** 页面点击 **"添加数据库"**
2. 填写信息：
   - **数据库名**: `tron_energy_rental`
   - **用户名**: `tron_user`
   - **密码**: 设置强密码并记录
3. 点击 **"提交"**

#### 步骤3：配置Redis

1. 进入 **"软件商店"** → 找到Redis → 点击 **"设置"**
2. 配置选项：
   - **密码**: 设置Redis密码
   - **最大内存**: 设置为512MB
   - **持久化**: 开启AOF和RDB
3. 重启Redis服务

## 📁 项目部署

### 1. 创建网站

#### 步骤1：添加站点

1. 在宝塔面板点击 **"网站"** → **"添加站点"**
2. 填写站点信息：
   - **域名**: 输入您的域名（如：`tron.yourdomain.com`）
   - **备注**: `TRON能量租赁系统`
   - **根目录**: `/www/wwwroot/tron-energy-rental`
   - **FTP**: 不创建
   - **数据库**: 不创建（已创建）
   - **PHP版本**: 纯静态
3. 点击 **"提交"**

#### 步骤2：配置目录权限

1. 点击站点旁的 **"设置"**
2. 进入 **"网站目录"** 标签：
   - 确保运行目录为 `/www/wwwroot/tron-energy-rental`
   - 取消勾选 **"防跨站攻击"**

### 2. 上传项目代码

#### 方法一：Git克隆（推荐）

1. 进入 **"文件"** 管理器
2. 导航到 `/www/wwwroot/`
3. 点击 **"终端"** 打开命令行
4. 执行以下命令：
   ```bash
   cd /www/wwwroot
   git clone https://github.com/your-username/tron-energy-rental.git
   cd tron-energy-rental
   chown -R www:www /www/wwwroot/tron-energy-rental
   ```

#### 方法二：文件上传

1. 在本地打包项目：
   ```bash
   tar -czf tron-energy-rental.tar.gz tron-energy-rental/
   ```
2. 在宝塔面板 **"文件"** 中点击 **"上传"**
3. 上传压缩包到 `/www/wwwroot/`
4. 右键压缩包选择 **"解压"**

### 3. 安装项目依赖

1. 在文件管理器中进入项目目录
2. 点击 **"终端"**
3. 执行安装命令：
   ```bash
   cd /www/wwwroot/tron-energy-rental
   pnpm install
   ```

### 4. 配置环境变量

#### 步骤1：复制配置模板

1. 在文件管理器中进入项目根目录
2. 复制环境配置文件：
   ```bash
   cp deployment/templates/env.production.template .env
   ```

#### 步骤2：编辑配置文件

点击 `.env` 文件进行编辑，修改以下关键配置：

```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy_rental
DB_USER=tron_user
DB_PASSWORD=你的数据库密码

# Redis配置  
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=你的Redis密码

# JWT密钥（必须修改）
JWT_SECRET=生成一个至少32位的强密码

# TRON配置
TRON_NETWORK=mainnet
TRON_API_KEY=你的TRON_API密钥
TRON_PRIVATE_KEY=你的TRON私钥

# Telegram机器人（可选）
TELEGRAM_BOT_TOKEN=你的机器人Token
```

### 5. 数据库迁移

在终端中执行：
```bash
cd /www/wwwroot/tron-energy-rental
pnpm run migrate
```

### 6. 构建项目

```bash
pnpm run build
```

## 🌐 网站配置

### 1. 配置Nginx反向代理

#### 步骤1：修改站点配置

1. 在 **"网站"** 中点击站点的 **"设置"**
2. 进入 **"配置文件"** 标签
3. 清空现有配置，粘贴以下配置：

```nginx
# TRON能量租赁系统 Nginx配置

# API后端反向代理
upstream tron_energy_api {
    server 127.0.0.1:3001;
    keepalive 32;
}

# 速率限制
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

server {
    listen 80;
    server_name tron.yourdomain.com;  # 修改为你的域名
    index index.html;
    root /www/wwwroot/tron-energy-rental/dist;
    
    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 访问日志
    access_log /www/wwwlogs/tron-energy-rental.log;
    error_log /www/wwwlogs/tron-energy-rental.error.log;
    
    # Gzip压缩
    gzip on;
    gzip_min_length 1024;
    gzip_types text/css application/javascript text/javascript application/json;
    
    # API路由代理
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://tron_energy_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 健康检查
    location /health {
        proxy_pass http://tron_energy_api/api/health;
        access_log off;
    }
    
    # 静态资源缓存
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        gzip_static on;
    }
    
    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # 隐藏敏感文件
    location ~ /\.(env|git) {
        deny all;
    }
}
```

4. 点击 **"保存"**

#### 步骤2：重载Nginx

在终端执行：
```bash
nginx -t  # 检查配置语法
nginx -s reload  # 重载配置
```

### 2. 配置防火墙

1. 进入 **"安全"** → **"防火墙"**
2. 添加以下端口规则：
   - **3001** (API端口) - 仅允许内网访问
   - **5432** (PostgreSQL) - 仅允许内网访问  
   - **6379** (Redis) - 仅允许内网访问

## 🔄 进程管理

### 1. 配置PM2

#### 步骤1：安装PM2管理器

1. 进入 **"软件商店"**
2. 搜索 **"PM2管理器"**
3. 点击 **"安装"**

#### 步骤2：添加项目到PM2

1. 安装完成后点击 **"设置"**
2. 点击 **"添加项目"**
3. 填写项目信息：
   - **项目名称**: `tron-energy-api`
   - **启动文件**: `/www/wwwroot/tron-energy-rental/api/server.ts`
   - **项目路径**: `/www/wwwroot/tron-energy-rental`
   - **启动方式**: `tsx`
   - **环境变量**: 
     ```
     NODE_ENV=production
     ```
4. 点击 **"添加"**

#### 步骤3：启动应用

1. 在PM2管理器中找到刚添加的项目
2. 点击 **"启动"**
3. 查看状态确保正常运行

### 2. 配置自动启动

1. 在PM2设置中点击 **"开机自启"**
2. 选择开启自动启动
3. 保存配置

## 🗄️ 数据库配置

### 1. 导入初始数据

如果有数据库备份文件：

1. 进入 **"数据库"** → **"PostgreSQL"**
2. 点击数据库名旁的 **"管理"**
3. 在phpPgAdmin中：
   - 选择对应数据库
   - 点击 **"SQL"** 标签
   - 粘贴SQL文件内容或点击 **"选择文件"** 上传
   - 点击 **"执行"**

### 2. 定期备份设置

1. 在数据库列表中点击 **"备份"**
2. 设置自动备份：
   - **备份类型**: 数据备份
   - **备份周期**: 每天凌晨2点
   - **保留份数**: 7天
3. 点击 **"添加"**

### 3. 数据库性能优化

1. 点击PostgreSQL的 **"设置"**
2. 进入 **"性能调整"** 标签
3. 根据服务器配置调整：
   - **共享缓冲区**: 服务器内存的25%
   - **有效缓存大小**: 服务器内存的50%
   - **最大连接数**: 200

## 🔒 SSL证书

### 1. 申请Let's Encrypt免费证书

#### 步骤1：域名解析

确保域名已正确解析到服务器IP地址

#### 步骤2：申请证书

1. 在 **"网站"** 中点击站点的 **"设置"**
2. 进入 **"SSL"** 标签
3. 选择 **"Let's Encrypt"**
4. 填写信息：
   - **域名**: 选择要申请证书的域名
   - **邮箱**: 填写你的邮箱地址
5. 点击 **"申请"**
6. 等待申请完成（通常1-2分钟）

#### 步骤3：开启强制HTTPS

1. 证书申请成功后，勾选 **"强制HTTPS"**
2. 点击 **"保存"**

### 2. 证书自动续期

宝塔面板会自动处理Let's Encrypt证书续期，无需手动操作。

## 📊 监控维护

### 1. 系统监控

#### 服务器监控

1. 在宝塔面板首页查看：
   - CPU使用率
   - 内存使用率
   - 磁盘使用情况
   - 网络流量

#### 进程监控

1. 进入 **"系统安全"** → **"系统优化"**
2. 查看进程列表，确认关键进程运行正常：
   - `nginx`
   - `postgres`
   - `redis-server`
   - `node` (PM2进程)

### 2. 日志管理

#### 应用日志

1. 进入PM2管理器
2. 点击项目的 **"日志"** 按钮查看应用日志

#### Nginx日志

1. 进入 **"文件"** 管理器
2. 导航到 `/www/wwwlogs/`
3. 查看相关日志文件：
   - `tron-energy-rental.log` (访问日志)
   - `tron-energy-rental.error.log` (错误日志)

#### 系统日志

1. 进入 **"安全"** → **"系统日志"**
2. 查看系统运行日志

### 3. 性能优化

#### 数据库优化

1. 定期执行数据库清理：
   ```sql
   VACUUM ANALYZE;
   REINDEX DATABASE tron_energy_rental;
   ```

2. 监控慢查询：
   - 在PostgreSQL设置中开启慢查询日志
   - 分析并优化慢查询SQL

#### 缓存优化

1. 监控Redis内存使用：
   ```bash
   redis-cli info memory
   ```

2. 清理过期缓存：
   ```bash
   redis-cli FLUSHDB
   ```

### 4. 定期任务设置

1. 进入 **"计划任务"**
2. 添加以下定期任务：

**数据库备份**
- **任务类型**: Shell脚本
- **任务名称**: 数据库备份
- **执行周期**: 每天 2:00
- **脚本内容**:
  ```bash
  #!/bin/bash
  cd /www/backup
  pg_dump -h localhost -U tron_user tron_energy_rental > tron_db_$(date +%Y%m%d_%H%M%S).sql
  find /www/backup -name "tron_db_*.sql" -mtime +7 -delete
  ```

**日志清理**
- **任务类型**: Shell脚本  
- **任务名称**: 清理旧日志
- **执行周期**: 每周日 3:00
- **脚本内容**:
  ```bash
  #!/bin/bash
  find /www/wwwlogs -name "*.log" -mtime +30 -delete
  pm2 flush
  ```

## ❗ 故障排除

### 1. 常见问题及解决方案

#### 问题1: API无法访问

**症状**: 前端页面显示API连接错误

**排查步骤**:
1. 检查PM2进程状态：
   - 进入PM2管理器查看进程是否正常运行
2. 检查端口占用：
   ```bash
   netstat -tlnp | grep 3001
   ```
3. 查看应用日志：
   - 在PM2管理器中查看错误日志
4. 检查数据库连接：
   ```bash
   cd /www/wwwroot/tron-energy-rental
   node -e "console.log('Testing DB connection...')"
   ```

**解决方案**:
- 重启PM2进程
- 检查环境变量配置
- 确认数据库服务正常

#### 问题2: 数据库连接失败

**症状**: 应用启动时报数据库连接错误

**排查步骤**:
1. 检查PostgreSQL服务状态
2. 验证数据库账户密码
3. 检查防火墙设置

**解决方案**:
```bash
# 重启PostgreSQL
systemctl restart postgresql

# 检查配置
cat /www/server/pgsql/data/postgresql.conf | grep listen_addresses
```

#### 问题3: Redis连接异常

**症状**: 缓存功能异常，Redis连接超时

**排查步骤**:
1. 检查Redis服务状态
2. 验证Redis密码配置
3. 检查内存使用情况

**解决方案**:
```bash
# 重启Redis
systemctl restart redis

# 清理内存
redis-cli FLUSHALL
```

#### 问题4: SSL证书问题

**症状**: HTTPS访问出现证书错误

**解决方案**:
1. 重新申请证书：
   - 在SSL标签页点击 **"重新申请"**
2. 检查域名解析：
   - 确保域名正确指向服务器IP
3. 清理证书缓存：
   ```bash
   rm -rf /etc/letsencrypt/live/your-domain.com
   ```

### 2. 性能问题排查

#### 高CPU使用率

1. 查看进程CPU占用：
   ```bash
   top -p $(pgrep -d',' -f 'node|nginx|postgres')
   ```

2. 分析应用性能：
   - 查看API响应时间
   - 检查数据库慢查询
   - 优化前端资源加载

#### 内存泄漏

1. 监控内存使用：
   ```bash
   free -h
   ps aux --sort=-%mem | head
   ```

2. PM2内存监控：
   ```bash
   pm2 monit
   ```

3. 设置内存限制：
   ```bash
   pm2 start api/server.ts --max-memory-restart 500M
   ```

### 3. 数据恢复

#### 从备份恢复数据库

1. 停止应用：
   ```bash
   pm2 stop tron-energy-api
   ```

2. 恢复数据库：
   ```bash
   cd /www/backup
   psql -h localhost -U tron_user -d tron_energy_rental < backup_file.sql
   ```

3. 重启应用：
   ```bash
   pm2 restart tron-energy-api
   ```

### 4. 紧急处理流程

#### 系统崩溃应急处理

1. **立即响应** (5分钟内):
   - 检查服务器基础状态
   - 重启关键服务
   - 通知用户维护中

2. **问题定位** (15分钟内):
   - 查看系统日志
   - 分析错误原因
   - 确定影响范围

3. **快速恢复** (30分钟内):
   - 执行数据回滚
   - 从备份恢复
   - 验证系统功能

4. **后续跟踪**:
   - 问题根因分析
   - 制定预防措施
   - 更新监控策略

## 📞 技术支持

### 联系方式
- **技术支持**: support@yourdomain.com
- **紧急联系**: +86-xxx-xxxx-xxxx
- **在线文档**: https://docs.yourdomain.com

### 远程协助
如需远程协助，请提供：
1. 宝塔面板访问地址和临时账号
2. 服务器SSH访问权限
3. 问题详细描述和错误日志
4. 问题发生的时间和触发条件

---

## 📝 附录

### A. 常用命令速查

```bash
# PM2进程管理
pm2 list                 # 查看所有进程
pm2 restart all          # 重启所有进程
pm2 logs                 # 查看日志
pm2 monit               # 实时监控

# 数据库操作
psql -h localhost -U tron_user -d tron_energy_rental  # 连接数据库
\dt                     # 查看所有表
\q                      # 退出数据库

# Redis操作  
redis-cli               # 连接Redis
INFO memory             # 查看内存信息
FLUSHALL                # 清空所有数据

# Nginx操作
nginx -t                # 检查配置语法
nginx -s reload         # 重载配置
nginx -s restart        # 重启服务
```

### B. 环境变量完整配置示例

```bash
# .env 生产环境配置示例
NODE_ENV=production
PORT=3001
TZ=Asia/Shanghai

# 数据库
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy_rental
DB_USER=tron_user
DB_PASSWORD=your_strong_password_here

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password_here

# JWT
JWT_SECRET=your_super_secure_jwt_secret_minimum_32_characters_long

# TRON
TRON_NETWORK=mainnet
TRON_API_KEY=your_tron_api_key_here
TRON_PRIVATE_KEY=your_tron_private_key_here

# 日志
LOG_LEVEL=info
LOG_FILE_PATH=/www/wwwroot/tron-energy-rental/logs/app.log
```

### C. 部署检查清单

部署完成后，请逐一检查以下项目：

- [ ] 服务器环境配置正确
- [ ] 宝塔面板正常访问
- [ ] 数据库创建并可连接
- [ ] Redis服务正常运行
- [ ] 项目代码部署完成
- [ ] 环境变量配置正确
- [ ] 数据库迁移成功执行
- [ ] 项目构建成功
- [ ] PM2进程正常启动
- [ ] Nginx配置正确
- [ ] API接口正常响应
- [ ] 前端页面正常显示
- [ ] SSL证书申请成功
- [ ] 强制HTTPS开启
- [ ] 防火墙规则配置
- [ ] 定期备份任务设置
- [ ] 监控告警配置
- [ ] 日志轮转配置

---

> 📧 **技术支持**: 如需进一步帮助，请联系技术支持团队
> 
> 🔄 **文档更新**: 本文档会定期更新，请关注最新版本
>
> ⭐ **版本**: v1.0.0 | 更新时间: 2024-12-20

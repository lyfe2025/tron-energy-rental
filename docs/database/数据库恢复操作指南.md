# æ•°æ®åº“æ¢å¤æ“ä½œæŒ‡å—

> **âš ï¸ é‡è¦è­¦å‘Š**: æ•°æ®åº“æ¢å¤æ“ä½œå°†å®Œå…¨è¦†ç›–ç°æœ‰æ•°æ®ï¼Œæ“ä½œä¸å¯é€†ï¼è¯·åŠ¡å¿…åœ¨æ¢å¤å‰åˆ›å»ºå¤‡ä»½ã€‚

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†æ¢å¤ `backups/db_backup_navicat_tron_energy_20250923_183800.sql` å¤‡ä»½æ–‡ä»¶çš„è¯¦ç»†æ­¥éª¤ã€‚

## ğŸ›  å‡†å¤‡å·¥ä½œ

### 1. ç¯å¢ƒè¦æ±‚

- PostgreSQL å®¢æˆ·ç«¯å·¥å…· (`psql`, `pg_dump`)
- æœ‰æ•ˆçš„æ•°æ®åº“ç®¡ç†æƒé™
- é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `.env` é…ç½®æ–‡ä»¶

### 2. å®‰è£…æ•°æ®åº“å®¢æˆ·ç«¯ (å¦‚æœéœ€è¦)

```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# CentOS/RHEL
sudo yum install postgresql
```

## ğŸ”§ æ–¹æ¡ˆé€‰æ‹©

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ç°æœ‰é¡¹ç›®è„šæœ¬ (æ¨è)

é¡¹ç›®å·²åŒ…å«è‡ªåŠ¨åŒ–çš„æ•°æ®åº“æ“ä½œè„šæœ¬ï¼Œä¼šè‡ªåŠ¨è¯»å– `.env` é…ç½®ã€‚

```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®åº“ (å®‰å…¨æªæ–½)
./scripts/database/backup-database.sh

# 2. æ¢å¤æŒ‡å®šå¤‡ä»½æ–‡ä»¶
./scripts/database/restore-database.sh backups/db_backup_navicat_tron_energy_20250923_183800.sql
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨è¯»å–é¡¹ç›®é…ç½®
- âœ… åŒé‡ç¡®è®¤ä¿æŠ¤
- âœ… è¯¦ç»†çš„æ“ä½œæ—¥å¿—
- âœ… è‡ªåŠ¨æƒé™ä¿®å¤
- âœ… æ¢å¤åéªŒè¯

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨å‘½ä»¤è¡Œæ“ä½œ

#### A. ä½¿ç”¨è¶…çº§ç”¨æˆ·æƒé™ (åŸå§‹æ–¹æ¡ˆ)

é€‚ç”¨äºæœ‰ PostgreSQL è¶…çº§ç”¨æˆ·æƒé™çš„æƒ…å†µï¼š

```bash
# è®¾ç½®æ•°æ®åº“å¯†ç ç¯å¢ƒå˜é‡
export PGPASSWORD="postgres"

# åˆ é™¤ç°æœ‰æ•°æ®åº“
psql -h localhost -p 5432 -U postgres -c "DROP DATABASE IF EXISTS tron_energy_rental;"

# åˆ›å»ºæ–°çš„ç©ºæ•°æ®åº“
psql -h localhost -p 5432 -U postgres -c "CREATE DATABASE tron_energy_rental;"

# éªŒè¯æ•°æ®åº“åˆ›å»ºæˆåŠŸ
psql -h localhost -p 5432 -U postgres -c "\l" | grep tron_energy_rental

# å¯¼å…¥æŒ‡å®šçš„å¤‡ä»½æ–‡ä»¶
psql -h localhost -p 5432 -U postgres -d tron_energy_rental -f backups/db_backup_navicat_tron_energy_20250923_183800.sql

# æ¸…é™¤å¯†ç ç¯å¢ƒå˜é‡
unset PGPASSWORD
```

#### B. ä½¿ç”¨é¡¹ç›®é…ç½® (ä¿®æ­£æ–¹æ¡ˆ)

åŸºäºé¡¹ç›®å®é™…é…ç½®çš„æ¢å¤æ–¹æ¡ˆï¼š

```bash
# è®¾ç½®æ•°æ®åº“å¯†ç ç¯å¢ƒå˜é‡ (ä½¿ç”¨é¡¹ç›®é…ç½®)
export PGPASSWORD="AZDTswBsRbhTpbAm"

# è¿æ¥åˆ°é»˜è®¤æ•°æ®åº“ï¼Œåˆ é™¤ç°æœ‰æ•°æ®åº“
psql -h localhost -p 5432 -U db_tron_admin -d postgres -c "DROP DATABASE IF EXISTS tron_energy;"

# åˆ›å»ºæ–°çš„ç©ºæ•°æ®åº“
psql -h localhost -p 5432 -U db_tron_admin -d postgres -c "CREATE DATABASE tron_energy;"

# éªŒè¯æ•°æ®åº“åˆ›å»ºæˆåŠŸ
psql -h localhost -p 5432 -U db_tron_admin -d postgres -c "\l" | grep tron_energy

# å¯¼å…¥æŒ‡å®šçš„å¤‡ä»½æ–‡ä»¶
psql -h localhost -p 5432 -U db_tron_admin -d tron_energy -f backups/db_backup_navicat_tron_energy_20250923_183800.sql

# æ¸…é™¤å¯†ç ç¯å¢ƒå˜é‡
unset PGPASSWORD
```

## ğŸ“Š é¡¹ç›®é…ç½®ä¿¡æ¯

ä» `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®ï¼š

```ini
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://db_tron_admin:AZDTswBsRbhTpbAm@localhost:5432/tron_energy
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy
DB_USER=db_tron_admin
DB_PASSWORD=AZDTswBsRbhTpbAm
```

**æ³¨æ„**: é¡¹ç›®å®é™…ä½¿ç”¨çš„æ•°æ®åº“åç§°æ˜¯ `tron_energy`ï¼Œä¸æ˜¯ `tron_energy_rental`ã€‚

## ğŸ”’ å®‰å…¨æé†’

### âš ï¸ æ¢å¤å‰å¿…åš

1. **åˆ›å»ºå½“å‰æ•°æ®åº“å¤‡ä»½**:
   ```bash
   ./scripts/database/backup-database.sh
   ```

2. **åœæ­¢åº”ç”¨æœåŠ¡**:
   ```bash
   # åœæ­¢ç›¸å…³æœåŠ¡
   ps aux | grep -E 'tron-energy-rental|tsx.*server\.ts|vite.*5173' | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true
   ```

3. **éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§**:
   ```bash
   # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤§å°
   ls -lh backups/db_backup_navicat_tron_energy_20250923_183800.sql
   
   # æ£€æŸ¥æ–‡ä»¶å†…å®¹
   head -20 backups/db_backup_navicat_tron_energy_20250923_183800.sql
   tail -20 backups/db_backup_navicat_tron_energy_20250923_183800.sql
   ```

### ğŸ›¡ï¸ æ¢å¤åéªŒè¯

1. **éªŒè¯æ•°æ®åº“è¿æ¥**:
   ```bash
   # æµ‹è¯•APIç™»å½•
   curl -s -X POST http://localhost:3001/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@tronrental.com","password":"admin123456"}' | jq .
   ```

2. **é‡å¯åº”ç”¨æœåŠ¡**:
   ```bash
   npm run restart
   # æˆ–
   pnpm run restart
   ```

3. **éªŒè¯åº”ç”¨åŠŸèƒ½**:
   - æ£€æŸ¥å‰ç«¯æœåŠ¡ (ç«¯å£ 5173)
   - æ£€æŸ¥åç«¯APIæœåŠ¡ (ç«¯å£ 3001)
   - æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢åŠŸèƒ½

## ğŸ“ å¤‡ä»½æ–‡ä»¶ä¿¡æ¯

**ç›®æ ‡å¤‡ä»½æ–‡ä»¶**: `backups/db_backup_navicat_tron_energy_20250923_183800.sql`

**æ–‡ä»¶ç‰¹å¾**:
- åˆ›å»ºæ—¶é—´: 2025å¹´09æœˆ23æ—¥ 18:38:00
- æ–‡ä»¶å¤§å°: æ ¹æ®å®é™…æƒ…å†µæŸ¥çœ‹
- æ ¼å¼: PostgreSQL SQL è½¬å‚¨æ–‡ä»¶
- ç¼–ç : UTF-8

## ğŸ›  æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æƒé™ä¸è¶³é”™è¯¯
```bash
ERROR: permission denied to create database
```

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨å…·æœ‰ `CREATEDB` æƒé™çš„ç”¨æˆ·
- æˆ–ä½¿ç”¨ PostgreSQL è¶…çº§ç”¨æˆ· (å¦‚ `postgres`)

#### 2. æ•°æ®åº“ä¸å­˜åœ¨é”™è¯¯
```bash
FATAL: database "tron_energy" does not exist
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿å…ˆåˆ›å»ºæ•°æ®åº“å†å¯¼å…¥æ•°æ®
- æ£€æŸ¥æ•°æ®åº“åç§°æ‹¼å†™æ˜¯å¦æ­£ç¡®

#### 3. è¿æ¥å¤±è´¥é”™è¯¯
```bash
FATAL: authentication failed
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ PostgreSQL æœåŠ¡æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ `pg_hba.conf` é…ç½®

#### 4. æ–‡ä»¶è¯»å–é”™è¯¯
```bash
No such file or directory
```

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ç»å¯¹è·¯å¾„æŒ‡å®šå¤‡ä»½æ–‡ä»¶
- ç¡®è®¤å¤‡ä»½æ–‡ä»¶ç¡®å®å­˜åœ¨ä¸”å¯è¯»

### éªŒè¯å‘½ä»¤

```bash
# æ£€æŸ¥ PostgreSQL æœåŠ¡çŠ¶æ€
pg_ctl status

# æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
psql -h localhost -p 5432 -U db_tron_admin -l

# æ£€æŸ¥è¡¨æ•°é‡
psql -h localhost -p 5432 -U db_tron_admin -d tron_energy -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"

# æ£€æŸ¥åº”ç”¨æœåŠ¡çŠ¶æ€
lsof -i :3001  # åç«¯æœåŠ¡
lsof -i :5173  # å‰ç«¯æœåŠ¡
```

## ğŸ“š ç›¸å…³è„šæœ¬

é¡¹ç›®ä¸­çš„å…¶ä»–æ•°æ®åº“ç®¡ç†è„šæœ¬ï¼š

- `scripts/database/backup-database.sh` - åˆ›å»ºæ•°æ®åº“å¤‡ä»½
- `scripts/database/restore-database.sh` - æ¢å¤æ•°æ®åº“å¤‡ä»½
- `scripts/database/backup-database-navicat.sh` - Navicat æ ¼å¼å¤‡ä»½
- `scripts/database/verify-backup-permissions.sh` - éªŒè¯å¤‡ä»½æƒé™
- `scripts/database/auto-fix-sequences.sh` - ä¿®å¤åºåˆ—é—®é¢˜

## ğŸ”„ å®Œæ•´æ“ä½œæµç¨‹

### æ¨èçš„å®Œæ•´æ¢å¤æµç¨‹ï¼š

```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡
ps aux | grep -E 'tron-energy-rental|tsx.*server\.ts|vite.*5173' | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true

# 2. å¤‡ä»½å½“å‰æ•°æ®åº“
./scripts/database/backup-database.sh

# 3. æ¢å¤ç›®æ ‡å¤‡ä»½
./scripts/database/restore-database.sh backups/db_backup_navicat_tron_energy_20250923_183800.sql

# 4. é‡å¯åº”ç”¨æœåŠ¡
npm run restart

# 5. éªŒè¯åº”ç”¨åŠŸèƒ½
curl -s -X POST http://localhost:3001/api/auth/login -H "Content-Type: application/json" -d '{"email":"admin@tronrental.com","password":"admin123456"}' | jq .
```

## ğŸ“‹ æ“ä½œæ£€æŸ¥æ¸…å•

- [ ] å·²åœæ­¢åº”ç”¨æœåŠ¡
- [ ] å·²åˆ›å»ºå½“å‰æ•°æ®åº“å¤‡ä»½
- [ ] å·²éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
- [ ] å·²ç¡®è®¤æ¢å¤æ“ä½œçš„å¿…è¦æ€§
- [ ] å·²äº†è§£æ“ä½œä¸å¯é€†çš„é£é™©
- [ ] å·²å‡†å¤‡å¥½ PostgreSQL è¿æ¥ä¿¡æ¯
- [ ] å·²æµ‹è¯•æ•°æ®åº“è¿æ¥
- [ ] å·²æ‰§è¡Œæ•°æ®åº“æ¢å¤æ“ä½œ
- [ ] å·²éªŒè¯æ¢å¤ç»“æœ
- [ ] å·²é‡å¯åº”ç”¨æœåŠ¡
- [ ] å·²æµ‹è¯•åº”ç”¨åŠŸèƒ½

---

**æœ€åæ›´æ–°**: 2025å¹´09æœˆ23æ—¥  
**å¤‡æ³¨**: æœ¬æ–‡æ¡£åŸºäºé¡¹ç›®å®é™…é…ç½®ç”Ÿæˆï¼Œè¯·æ ¹æ®å…·ä½“ç¯å¢ƒè°ƒæ•´ç›¸å…³å‚æ•°ã€‚

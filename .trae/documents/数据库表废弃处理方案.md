# TRON能量租赁系统 - 数据库表废弃处理方案

> **文档版本**: v1.0  
> **创建时间**: 2025-01-29  
> **适用场景**: Redis缓存架构迁移  
> **风险等级**: 中等风险  

## 📋 1. 方案概述

### 1.1 背景说明
基于用户提出的Redis缓存架构优化方案，系统将采用"API获取数据 → Redis缓存 → 页面展示 → 手动刷新清除缓存"的轻量级架构。由于区块链浏览器已提供完整的交易记录，本地数据库无需持久化存储区块链相关数据。

### 1.2 核心目标
- **简化数据库结构**：移除冗余的区块链数据存储表
- **提升系统性能**：减少数据库查询负担，提高响应速度
- **降低维护成本**：减少数据同步和一致性维护工作
- **优化存储空间**：释放不必要的数据库存储资源

---

## 🗑️ 2. 可废弃数据库表清单

### 2.1 完全废弃表（4张表）

#### A. 质押管理相关表（3张）

| 表名 | 用途 | 废弃理由 | 影响评估 |
|------|------|----------|----------|
| **stake_records** | 质押操作记录 | 质押操作不在当前项目进行，表中无数据 | 无影响 |
| **delegate_records** | 资源委托记录 | 委托操作通过区块链浏览器API获取 | 无影响 |
| **unfreeze_records** | 解质押记录 | 解质押数据从区块链浏览器实时获取 | 无影响 |

#### B. 统计分析相关（1个视图）

| 对象名 | 类型 | 用途 | 废弃理由 |
|--------|------|------|----------|
| **stake_statistics** | 视图 | 质押统计数据 | 基于已废弃表生成，失去数据源 |

### 2.2 部分字段清理

#### energy_pools表字段清理（7个字段）

| 字段名 | 数据类型 | 用途 | 清理理由 |
|--------|----------|------|----------|
| staked_trx_energy | BIGINT | 质押获取能量的TRX数量 | 从API实时获取 |
| staked_trx_bandwidth | BIGINT | 质押获取带宽的TRX数量 | 从API实时获取 |
| delegated_energy | BIGINT | 已委托能量数量 | 从API实时获取 |
| delegated_bandwidth | BIGINT | 已委托带宽数量 | 从API实时获取 |
| pending_unfreeze_energy | BIGINT | 待提款能量质押TRX | 从API实时获取 |
| pending_unfreeze_bandwidth | BIGINT | 待提款带宽质押TRX | 从API实时获取 |
| last_stake_update | TIMESTAMP | 最后质押更新时间 | 不再需要本地更新时间 |

### 2.3 需要评估的表

| 表名 | 当前状态 | 建议处理 | 评估依据 |
|------|----------|----------|----------|
| **energy_transactions** | 有数据 | 保留或废弃待定 | 如需本地交易状态管理则保留 |
| **energy_consumption_logs** | 有数据 | 保留或废弃待定 | 如需历史消耗分析则保留 |

---

## 📊 3. 必须保留的核心表

### 3.1 业务核心表
- **users** - 用户管理（必须保留）
- **orders** - 订单管理（必须保留）
- **energy_pools** - 能量池基础信息（保留，但清理质押字段）
- **energy_packages** - 能量套餐配置（必须保留）

### 3.2 系统配置表
- **telegram_bots** - 机器人配置（必须保留）
- **pricing_strategies** - 定价策略（必须保留）
- **admins** - 管理员账户（必须保留）
- **bot_pricing_configs** - 机器人定价配置（必须保留）

---

## 🚀 4. 分阶段实施计划

### 阶段一：准备阶段（1-2天）

#### 4.1 数据备份
```bash
# 1. 完整数据库备份
scripts/database/backup-database.sh

# 2. 单表备份（重要表）
pg_dump -h localhost -U postgres -d tron_energy_rental -t stake_records > backup_stake_records.sql
pg_dump -h localhost -U postgres -d tron_energy_rental -t delegate_records > backup_delegate_records.sql
pg_dump -h localhost -U postgres -d tron_energy_rental -t unfreeze_records > backup_unfreeze_records.sql
```

#### 4.2 依赖关系检查
```sql
-- 检查外键依赖
SELECT 
    tc.table_name, 
    kcu.column_name, 
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name 
FROM 
    information_schema.table_constraints AS tc 
    JOIN information_schema.key_column_usage AS kcu
      ON tc.constraint_name = kcu.constraint_name
    JOIN information_schema.constraint_column_usage AS ccu
      ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND (tc.table_name IN ('stake_records', 'delegate_records', 'unfreeze_records')
       OR ccu.table_name IN ('stake_records', 'delegate_records', 'unfreeze_records'));
```

#### 4.3 代码影响分析
```bash
# 搜索代码中对废弃表的引用
grep -r "stake_records" api/ src/
grep -r "delegate_records" api/ src/
grep -r "unfreeze_records" api/ src/
grep -r "stake_statistics" api/ src/
```

### 阶段二：代码适配阶段（2-3天）

#### 4.4 API接口修改
- 移除相关表的CRUD接口
- 更新统计接口，改为从Redis获取数据
- 修改前端调用逻辑

#### 4.5 Redis缓存实现
- 实现区块链数据缓存逻辑
- 添加缓存刷新机制
- 实现API数据获取服务

### 阶段三：数据库清理阶段（1天）

#### 4.6 删除表和字段
```sql
-- 删除视图
DROP VIEW IF EXISTS stake_statistics;

-- 删除表（注意顺序，先删除有外键依赖的表）
DROP TABLE IF EXISTS stake_records CASCADE;
DROP TABLE IF EXISTS delegate_records CASCADE;
DROP TABLE IF EXISTS unfreeze_records CASCADE;

-- 删除energy_pools表中的质押相关字段
ALTER TABLE energy_pools DROP COLUMN IF EXISTS staked_trx_energy;
ALTER TABLE energy_pools DROP COLUMN IF EXISTS staked_trx_bandwidth;
ALTER TABLE energy_pools DROP COLUMN IF EXISTS delegated_energy;
ALTER TABLE energy_pools DROP COLUMN IF EXISTS delegated_bandwidth;
ALTER TABLE energy_pools DROP COLUMN IF EXISTS pending_unfreeze_energy;
ALTER TABLE energy_pools DROP COLUMN IF EXISTS pending_unfreeze_bandwidth;
ALTER TABLE energy_pools DROP COLUMN IF EXISTS last_stake_update;

-- 删除相关触发器
DROP TRIGGER IF EXISTS update_stake_records_updated_at ON stake_records;
DROP TRIGGER IF EXISTS update_delegate_records_updated_at ON delegate_records;
DROP TRIGGER IF EXISTS update_unfreeze_records_updated_at ON unfreeze_records;
```

#### 4.7 清理迁移文件
- 标记相关迁移文件为已废弃
- 更新数据库schema文档

### 阶段四：测试验证阶段（2-3天）

#### 4.8 功能测试
- 验证所有业务功能正常
- 测试Redis缓存机制
- 验证数据获取的准确性

#### 4.9 性能测试
- 对比清理前后的查询性能
- 验证系统响应时间改善
- 检查内存和存储使用情况

---

## ⚠️ 5. 风险评估与注意事项

### 5.1 高风险项

| 风险项 | 风险等级 | 影响范围 | 缓解措施 |
|--------|----------|----------|----------|
| 数据丢失 | 🔴 高 | 历史质押数据 | 完整备份 + 分阶段执行 |
| 功能异常 | 🟡 中 | 统计功能 | 充分测试 + 快速回滚机制 |
| 性能问题 | 🟡 中 | API响应 | 监控 + 缓存优化 |

### 5.2 关键注意事项

#### 5.2.1 数据安全
- ✅ **必须备份**：执行任何删除操作前必须完成完整备份
- ✅ **分步执行**：不要一次性删除所有表，逐个验证
- ✅ **保留备份**：至少保留30天的数据备份

#### 5.2.2 系统稳定性
- ✅ **停机维护**：数据库结构变更需要停机执行
- ✅ **回滚准备**：准备完整的回滚脚本和流程
- ✅ **监控告警**：加强系统监控，及时发现异常

#### 5.2.3 业务连续性
- ✅ **用户通知**：提前通知用户系统维护时间
- ✅ **功能验证**：确保核心业务功能不受影响
- ✅ **数据一致性**：验证Redis缓存数据与区块链数据一致

---

## 🔄 6. 数据备份和回滚策略

### 6.1 备份策略

#### 6.1.1 备份内容
```bash
# 完整数据库备份
pg_dump -h localhost -U postgres -d tron_energy_rental > full_backup_$(date +%Y%m%d_%H%M%S).sql

# 表结构备份
pg_dump -h localhost -U postgres -d tron_energy_rental --schema-only > schema_backup_$(date +%Y%m%d_%H%M%S).sql

# 重要表数据备份
for table in stake_records delegate_records unfreeze_records; do
    pg_dump -h localhost -U postgres -d tron_energy_rental -t $table > ${table}_backup_$(date +%Y%m%d_%H%M%S).sql
done
```

#### 6.1.2 备份验证
```bash
# 验证备份文件完整性
for backup_file in *.sql; do
    echo "验证 $backup_file"
    head -10 "$backup_file"
    tail -10 "$backup_file"
    wc -l "$backup_file"
done
```

### 6.2 回滚策略

#### 6.2.1 快速回滚（紧急情况）
```bash
# 停止服务
ps aux | grep -E 'tron-energy-rental|tsx.*server\.ts|vite.*5173' | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true

# 恢复完整数据库
dropdb -h localhost -U postgres tron_energy_rental
createdb -h localhost -U postgres tron_energy_rental
psql -h localhost -U postgres -d tron_energy_rental < full_backup_YYYYMMDD_HHMMSS.sql

# 重启服务
npm run restart
```

#### 6.2.2 部分回滚（特定表）
```sql
-- 恢复特定表
\i stake_records_backup_YYYYMMDD_HHMMSS.sql
\i delegate_records_backup_YYYYMMDD_HHMMSS.sql
\i unfreeze_records_backup_YYYYMMDD_HHMMSS.sql

-- 重建视图
CREATE OR REPLACE VIEW stake_statistics AS
-- [视图定义内容]
```

---

## 📈 7. 实施后的系统优化效果预期

### 7.1 性能提升预期

| 指标 | 优化前 | 优化后 | 提升幅度 |
|------|--------|--------|----------|
| 数据库表数量 | ~15张 | ~11张 | -27% |
| 查询响应时间 | 100-500ms | 50-200ms | 50-60% |
| 数据库存储空间 | 基准值 | -30% | 30% |
| 内存使用 | 基准值 | -20% | 20% |

### 7.2 维护成本降低

#### 7.2.1 开发维护
- **减少数据同步逻辑**：无需维护本地与区块链的数据一致性
- **简化错误处理**：减少数据库操作失败的异常处理
- **降低测试复杂度**：减少数据库相关的单元测试和集成测试

#### 7.2.2 运维维护
- **减少备份数据量**：数据库备份文件大小显著减少
- **简化监控指标**：减少需要监控的表和查询
- **降低存储成本**：减少数据库存储空间需求

### 7.3 系统架构优化

#### 7.3.1 架构简化
```
优化前：
前端 → 后端API → 数据库 → 区块链同步服务
                ↓
            复杂的数据一致性维护

优化后：
前端 → 后端API → Redis缓存 → 区块链浏览器API
                ↓
            简单的缓存刷新机制
```

#### 7.3.2 数据流优化
- **实时性提升**：直接从区块链获取最新数据
- **一致性保证**：避免本地数据与区块链数据不一致
- **扩展性增强**：易于支持更多区块链数据类型

---

## 📋 8. 实施检查清单

### 8.1 实施前检查
- [ ] 完成完整数据库备份
- [ ] 完成单表数据备份
- [ ] 验证备份文件完整性
- [ ] 分析代码依赖关系
- [ ] 准备回滚脚本
- [ ] 通知相关人员维护时间

### 8.2 实施中检查
- [ ] 停止所有相关服务
- [ ] 按顺序删除表和字段
- [ ] 验证删除操作成功
- [ ] 更新相关代码
- [ ] 实现Redis缓存逻辑

### 8.3 实施后检查
- [ ] 验证所有核心功能正常
- [ ] 测试Redis缓存机制
- [ ] 检查系统性能指标
- [ ] 验证数据获取准确性
- [ ] 更新系统文档
- [ ] 清理临时文件

---

## 📞 9. 应急联系和支持

### 9.1 关键联系人
- **项目负责人**：负责整体方案决策
- **数据库管理员**：负责数据库操作执行
- **开发团队**：负责代码修改和测试
- **运维团队**：负责系统监控和故障处理

### 9.2 应急处理流程
1. **发现问题** → 立即停止操作
2. **评估影响** → 确定影响范围和严重程度
3. **决定方案** → 修复 or 回滚
4. **执行处理** → 按预定方案执行
5. **验证结果** → 确认问题解决
6. **总结复盘** → 记录经验教训

---

## 📝 10. 总结

本方案通过废弃4张质押相关表和7个冗余字段，将系统架构从"数据库持久化"模式优化为"Redis缓存"模式。预期可以实现：

- **性能提升50-60%**：减少数据库查询负担
- **存储空间节省30%**：移除冗余数据存储
- **维护成本降低**：简化数据同步和一致性维护
- **架构更加清晰**：专注核心业务功能

**关键成功因素**：
1. 充分的数据备份和回滚准备
2. 分阶段渐进式实施
3. 全面的功能测试验证
4. 完善的监控和应急机制

**风险控制**：
- 所有操作都有完整备份保障
- 每个阶段都有独立的验证和回滚点
- 关键业务功能优先保证
- 24小时应急响应机制

通过本方案的实施，TRON能量租赁系统将获得更高的性能、更低的维护成本和更清晰的架构设计。
# TRON能量租赁系统 - 核心模块开发需求文档

> **文档类型**: 产品需求文档  
> **创建日期**: 2024-12-19  
> **状态**: 🚨 紧急开发  
> **优先级**: P0 - 最高优先级  

## 1. 产品概述

本文档专门针对TRON能量租赁系统中四个完全缺失的核心模块进行详细需求分析。这些模块是系统能够正常运行的基础，目前完成度为0%，需要立即开发。

**核心缺失模块**:
- Telegram机器人集成 - 用户交互的唯一入口
- TRON区块链集成 - 业务核心功能实现
- 能量池管理系统 - 自动化运营的关键
- 支付与交易处理 - 资金安全和业务闭环

## 2. 核心功能需求

### 2.1 Telegram机器人模块

#### 功能概述
Telegram机器人是用户与系统交互的唯一界面，必须提供完整的能量租赁服务流程。

#### 核心页面和功能
1. **机器人启动页面**: 欢迎消息、用户注册、基础说明
2. **主菜单页面**: 能量包浏览、订单查询、账户管理、帮助支持
3. **能量包选择页面**: 套餐展示、价格对比、规格说明
4. **订单确认页面**: 订单详情、价格计算、支付方式
5. **支付页面**: 支付地址生成、支付状态跟踪
6. **订单状态页面**: 委托进度、完成通知、历史记录
7. **用户中心页面**: 个人信息、余额查询、推荐码

#### 详细功能规格

| 页面名称 | 模块名称 | 功能描述 |
|----------|----------|----------|
| 机器人启动 | 用户注册 | 自动绑定Telegram用户ID到users表，创建系统账户，发送欢迎消息 |
| 机器人启动 | 命令处理 | 处理/start, /help, /menu等基础命令，记录到bot_users表 |
| 主菜单 | 导航菜单 | 内联键盘导航，快速访问各功能模块，基于bots表配置 |
| 主菜单 | 状态显示 | 显示用户当前订单状态、USDT/TRX余额信息 |
| 能量包选择 | 套餐展示 | 从energy_packages表动态加载可用能量包，显示价格和规格 |
| 能量包选择 | 价格计算 | 基于price_configs表实时计算总价，支持数量选择 |
| 订单确认 | 订单生成 | 创建orders表记录，生成唯一order_number |
| 订单确认 | 地址验证 | 验证用户输入的TRON地址格式，更新target_address字段 |
| 支付页面 | 支付地址 | 生成专用支付地址，显示二维码，更新payment_method |
| 支付页面 | 状态监控 | 实时监控支付状态，自动确认，更新payment_status |
| 订单状态 | 进度跟踪 | 显示能量委托进度，从energy_transactions表获取状态 |
| 订单状态 | 历史查询 | 查看历史订单，支持分页浏览，基于orders表查询 |

### 2.2 TRON区块链集成模块

#### 功能概述
实现与TRON网络的完整集成，支持能量委托、钱包管理、交易监控等核心区块链功能。

#### 核心功能组件
1. **TronWeb SDK集成**: 连接TRON网络，支持主网和测试网切换
2. **钱包管理服务**: 创建和管理多个钱包，私钥安全存储
3. **能量委托功能**: 实现delegateResource合约调用
4. **交易监控系统**: 实时监控交易状态和确认
5. **地址验证工具**: 验证TRON地址格式和有效性

#### 详细功能规格

| 组件名称 | 模块名称 | 功能描述 |
|----------|----------|----------|
| SDK集成 | 网络连接 | 配置Shasta测试网，建立稳定连接，支持连接池 |
| SDK集成 | 错误处理 | 网络异常重试，连接状态监控，自动重连机制 |
| 钱包管理 | 钱包创建 | 生成新钱包，支持HD钱包，私钥AES-256加密 |
| 钱包管理 | 余额查询 | 查询TRX余额、能量、带宽等资源信息 |
| 能量委托 | 委托执行 | 调用delegateResource合约，执行能量委托 |
| 能量委托 | 取消委托 | 实现undelegateResource，管理解冻期 |
| 交易监控 | 状态跟踪 | 监控交易确认状态，记录区块确认数 |
| 交易监控 | 事件监听 | 订阅区块链事件，实时同步状态变化 |

### 2.3 能量池管理系统

#### 功能概述
实现智能化的能量池调度和管理，自动优化成本和效率，减少人工干预。

#### 核心管理功能
1. **能量池监控**: 实时监控各池状态、余额、使用率
2. **自动调度算法**: 根据需求自动选择最优能量池
3. **成本优化**: 最低成本路径选择，利润最大化
4. **库存预警**: 能量不足自动预警和补充
5. **性能分析**: 使用效率分析和优化建议

#### 详细功能规格

| 功能模块 | 子功能 | 功能描述 |
|----------|--------|----------|
| 状态监控 | 实时监控 | 监控energy_pools表中各池余额、可用量、委托状态 |
| 状态监控 | 健康检查 | 检测异常池，自动更新status字段，实现隔离和恢复机制 |
| 自动调度 | 负载均衡 | 根据池priority和available_energy自动分配新订单 |
| 自动调度 | 智能选择 | 基于cost_per_energy、速度、可靠性选择最优池 |
| 成本优化 | 成本计算 | 实时计算各池成本，基于cost_per_energy选择最低成本方案 |
| 成本优化 | 利润分析 | 分析各池利润率，优化price_configs表定价策略 |
| 库存管理 | 预警系统 | 基于available_energy和daily_limit实现多级阈值预警 |
| 库存管理 | 自动补充 | 预设规则自动补充能量，更新total_energy字段保证供应 |

### 2.4 支付与交易处理模块

#### 功能概述
实现安全可靠的支付处理系统，支持TRON网络支付监控、订单自动处理、风险控制。

#### 核心支付功能
1. **支付监控服务**: 实时监控TRON转账，自动确认支付
2. **订单自动处理**: 支付成功后自动执行能量委托
3. **风险控制系统**: 防重复支付、超时处理、异常检测
4. **价格计算引擎**: 动态定价、实时汇率、成本计算
5. **通知服务**: 支付状态实时通知用户

#### 详细功能规格

| 功能模块 | 子功能 | 功能描述 |
|----------|--------|----------|
| 支付监控 | 地址监控 | 监控专用支付地址的转账记录，更新orders表transaction_id |
| 支付监控 | 自动确认 | 达到确认数后自动确认支付，更新payment_status字段 |
| 订单处理 | 状态机 | 管理orders表订单生命周期，状态流转 |
| 订单处理 | 自动执行 | 支付确认后自动触发能量委托，创建energy_transactions记录 |
| 风险控制 | 重复检测 | 基于transaction_id防止重复支付，幂等性保证 |
| 风险控制 | 超时处理 | 基于expires_at字段超时订单自动取消，资源释放 |
| 价格计算 | 动态定价 | 根据price_configs表动态调整价格 |
| 价格计算 | 成本分析 | 基于energy_pools表cost_per_energy实时计算成本，保证利润率 |

## 3. 核心业务流程

### 3.1 用户购买能量流程

用户通过Telegram机器人完成整个购买流程：

1. 用户发送/start命令启动机器人
2. 系统自动注册用户账户，显示主菜单
3. 用户选择"购买能量"，浏览可用能量包
4. 用户选择合适的能量包和数量
5. 用户输入接收能量的TRON地址
6. 系统生成订单，计算总价，显示支付信息
7. 用户向指定地址转账支付
8. 系统监控到支付后自动确认订单
9. 能量池管理系统自动选择最优池执行委托
10. TRON区块链集成模块执行能量委托
11. 系统通知用户委托完成，提供交易哈希

### 3.2 系统自动化运营流程

系统后台自动化处理所有订单：

```mermaid
graph TD
    A[订单创建] --> B[支付监控]
    B --> C{支付确认?}
    C -->|是| D[能量池调度]
    C -->|否| E[超时取消]
    D --> F[选择最优池]
    F --> G[执行能量委托]
    G --> H[状态同步]
    H --> I[用户通知]
    E --> J[订单关闭]
```

## 4. 技术架构设计

### 4.1 整体架构

```mermaid
graph TD
    A[Telegram用户] --> B[Telegram Bot API]
    B --> C[机器人服务]
    C --> D[订单管理API]
    D --> E[支付监控服务]
    D --> F[能量池管理]
    F --> G[TRON区块链服务]
    E --> G
    G --> H[TRON网络]
    
    subgraph "核心服务层"
        C
        D
        E
        F
        G
    end
    
    subgraph "数据层"
        I[PostgreSQL]
        J[Redis缓存]
    end
    
    C --> I
    C --> J
    D --> I
    E --> I
    F --> I
```

### 4.2 技术栈选择

- **Telegram机器人**: node-telegram-bot-api + Express.js
- **TRON集成**: TronWeb SDK + TronGrid API
- **能量池管理**: Node.js + Redis + 调度算法
- **支付处理**: 事件驱动架构 + 状态机
- **数据存储**: PostgreSQL + Redis
- **监控**: 自研监控 + 日志系统

### 4.3 数据库设计

系统采用PostgreSQL作为主数据库，包含16个核心业务表：

#### 核心业务表结构

```mermaid
erDiagram
    users ||--o{ orders : "创建"
    users ||--o{ agent_applications : "申请"
    users ||--o{ agent_earnings : "收益"
    users ||--o{ bot_users : "使用"
    
    orders ||--o{ energy_transactions : "执行"
    orders }o--|| energy_packages : "选择"
    orders }o--|| bots : "通过"
    
    energy_pools ||--o{ energy_transactions : "提供"
    
    agents ||--o{ agent_applications : "处理"
    agents ||--o{ agent_earnings : "分配"
    
    bots ||--o{ bot_users : "管理"
    
    price_configs ||--o{ price_history : "历史"
    price_templates ||--o{ price_configs : "模板"
    
    system_configs ||--o{ system_config_history : "历史"
    
    users {
        uuid id PK
        bigint telegram_id UK
        varchar username
        varchar email UK
        varchar phone
        varchar role
        varchar status
        varchar tron_address
        numeric balance
        integer total_orders
        numeric total_spent
        bigint total_energy_used
        varchar referral_code UK
        uuid referred_by FK
        timestamp created_at
        timestamp updated_at
        varchar password_hash
        varchar login_type
        timestamp last_login_at
        varchar password_reset_token
        timestamp password_reset_expires
        numeric usdt_balance
        numeric trx_balance
    }
    
    orders {
        uuid id PK
        uuid user_id FK
        uuid bot_id FK
        uuid package_id FK
        varchar order_number UK
        varchar order_type
        varchar currency
        varchar payment_status
        varchar status
        bigint energy_amount
        integer duration_hours
        numeric price
        numeric original_price
        numeric discount_amount
        numeric final_price
        varchar payment_method
        varchar transaction_id
        varchar tron_tx_hash
        varchar delegate_tx_hash
        varchar target_address
        timestamp expires_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    energy_pools {
        uuid id PK
        varchar name
        varchar tron_address UK
        text private_key_encrypted
        bigint total_energy
        bigint available_energy
        bigint delegated_energy
        numeric trx_balance
        varchar status
        integer priority
        numeric cost_per_energy
        bigint max_delegation_amount
        bigint min_delegation_amount
        bigint daily_limit
        bigint used_today
        timestamp last_used_at
        timestamp created_at
        timestamp updated_at
    }
    
    bots {
        uuid id PK
        varchar name
        varchar token UK
        varchar username UK
        text description
        varchar status
        varchar webhook_url
        varchar webhook_secret
        jsonb settings
        jsonb commands
        text welcome_message
        text help_message
        text error_message
        boolean maintenance_mode
        integer rate_limit
        integer max_users
        integer current_users
        bigint total_messages
        timestamp last_message_at
        timestamp created_at
        timestamp updated_at
    }
    
    agents {
        uuid id PK
        uuid user_id FK
        varchar agent_code UK
        varchar name
        varchar status
        varchar level
        numeric commission_rate
        integer max_subordinates
        integer current_subordinates
        numeric total_earnings
        numeric pending_earnings
        numeric withdrawn_earnings
        uuid parent_agent_id FK
        jsonb settings
        timestamp created_at
        timestamp updated_at
    }
    
    energy_packages {
        uuid id PK
        varchar name
        text description
        bigint energy_amount
        integer duration_hours
        numeric base_price
        varchar currency
        varchar status
        integer sort_order
        boolean is_popular
        numeric discount_rate
        integer min_quantity
        integer max_quantity
        jsonb features
        timestamp created_at
        timestamp updated_at
    }
    
    energy_transactions {
        uuid id PK
        uuid order_id FK
        uuid pool_id FK
        varchar transaction_type
        varchar from_address
        varchar to_address
        bigint energy_amount
        integer duration_hours
        varchar tx_hash
        bigint block_number
        timestamp block_timestamp
        bigint gas_used
        varchar status
        text error_message
        integer retry_count
        timestamp expires_at
        timestamp created_at
        timestamp updated_at
    }
```

#### 数据库表说明

| 表名 | 用途 | 关键字段 |
|------|------|----------|
| users | 用户信息管理 | telegram_id, email, tron_address, balance |
| orders | 订单管理 | order_number, status, payment_status, energy_amount |
| energy_pools | 能量池管理 | tron_address, available_energy, status, priority |
| bots | 机器人配置 | token, username, status, settings |
| agents | 代理商管理 | agent_code, commission_rate, total_earnings |
| agent_applications | 代理申请 | user_id, agent_id, status |
| agent_earnings | 代理收益 | agent_id, order_id, commission_amount |
| bot_users | 机器人用户 | bot_id, user_id, status |
| energy_packages | 能量套餐 | name, energy_amount, base_price |
| energy_transactions | 能量交易记录 | order_id, pool_id, tx_hash, status |
| price_configs | 价格配置 | config_name, base_price, currency |
| price_history | 价格历史 | config_id, old_price, new_price |
| price_templates | 价格模板 | template_name, pricing_rules |
| system_configs | 系统配置 | config_key, config_value, category |
| system_config_history | 配置历史 | config_id, old_value, new_value |
| schema_migrations | 数据库迁移 | version, description, executed_at |

## 5. 开发优先级和时间规划

### 5.1 开发优先级

**✅ P0 (最高优先级) - 已完成**:
- ✅ Telegram机器人基础框架和核心命令
- ✅ 用户注册和认证系统
- ✅ 基础订单流程

**✅ P0 (最高优先级) - 已完成**:
- ✅ TRON区块链基础集成
- ✅ 钱包管理和能量委托
- ✅ 支付监控和确认

**✅ P1 (高优先级) - 已完成**:
- ✅ 能量池管理系统
- ✅ 自动化调度算法
- ✅ 完整业务流程打通

**🔄 P1 (高优先级) - 进行中**:
- 🔄 风险控制和异常处理
- 🔄 性能优化和监控
- 🔄 用户体验优化

### 5.2 里程碑目标

- **✅ 第2周**: 机器人可用，用户能够下单
- **✅ 第4周**: TRON集成完成，能够执行委托
- **✅ 第6周**: 完整业务流程打通，系统基本可用
- **🔄 第8周**: 系统自动化运营，可以小规模上线

## 6. 风险评估和应对策略

### 6.1 技术风险

**TRON网络稳定性风险**:
- 风险: Shasta测试网可能不稳定
- 应对: 实现重试机制，准备主网切换方案

**TronWeb API限制风险**:
- 风险: API调用频率限制
- 应对: 实现请求队列，使用多个API端点

### 6.2 业务风险

**资金安全风险**:
- 风险: 支付处理错误导致资金损失
- 应对: 多重确认机制，完善的日志和监控

**用户体验风险**:
- 风险: 机器人响应慢或功能不完整
- 应对: 性能优化，分阶段发布功能

## 7. 成功标准

### 7.1 功能完整性
- ✅ 用户可以通过Telegram机器人完成完整购买流程
- ✅ 系统能够自动执行能量委托
- ✅ 支付监控和确认机制正常工作
- ✅ 能量池管理系统自动化运营

### 7.2 性能指标
- 🔄 机器人响应时间 < 3秒
- 🔄 支付确认时间 < 5分钟
- 🔄 能量委托执行时间 < 10分钟
- 🔄 系统可用性 > 99%

### 7.3 安全标准
- ✅ 私钥安全存储，AES-256加密
- ✅ 支付防重复处理
- 🔄 异常情况自动处理
- ✅ 完整的操作日志记录

### 7.4 当前项目状态
**项目已完成核心功能开发，目前处于测试和优化阶段**

#### 已完成的核心模块：
1. ✅ **Telegram机器人集成模块** - 完整实现
2. ✅ **TRON区块链集成模块** - 完整实现  
3. ✅ **能量池管理系统** - 完整实现
4. ✅ **支付与交易处理模块** - 完整实现

#### 当前工作重点：
- 🔄 系统性能优化和稳定性提升
- 🔄 测试覆盖率完善和质量保证
- 🔄 错误处理和异常监控机制优化
- 📋 生产环境部署准备

---

**文档维护**: 开发团队  
**更新频率**: 每周更新进度  
**联系方式**: 项目负责人
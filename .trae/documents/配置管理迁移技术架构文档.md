# 配置管理迁移技术架构文档

## 1. 架构设计

### 1.1 整体架构

```mermaid
graph TD
    A[管理后台] --> B[配置管理API]
    B --> C[Telegram机器人管理]
    B --> D[TRON网络配置管理]
    B --> E[能量池账户管理]
    
    C --> F[多机器人实例]
    D --> G[多网络环境]
    E --> H[多钱包账户]
    
    F --> I[Telegram Bot API]
    G --> J[TRON主网/测试网]
    H --> K[能量委托服务]
    
    B --> L[PostgreSQL数据库]
    B --> M[Redis缓存]
    
    subgraph "前端管理层"
        A
    end
    
    subgraph "配置管理层"
        B
        C
        D
        E
    end
    
    subgraph "服务实例层"
        F
        G
        H
    end
    
    subgraph "外部服务层"
        I
        J
        K
    end
    
    subgraph "数据存储层"
        L
        M
    end
```

### 1.2 迁移策略

```mermaid
graph LR
    A[环境变量配置] --> B[数据库配置表]
    C[单机器人实例] --> D[多机器人管理]
    E[单网络配置] --> F[多网络环境]
    G[硬编码钱包] --> H[动态能量池]
    
    subgraph "迁移前"
        A
        C
        E
        G
    end
    
    subgraph "迁移后"
        B
        D
        F
        H
    end
```

## 2. 技术描述

* **前端**: Vue.js\@3 + Element Plus + TypeScript + Vite

* **后端**: Node.js\@18 + Express.js\@4 + TypeScript

* **数据库**: PostgreSQL\@14 (现有数据库扩展)

* **缓存**: Redis\@7 (配置缓存和会话管理)

* **区块链**: TronWeb\@5.3.0 + 多网络支持

* **机器人**: node-telegram-bot-api + 多实例管理

* **安全**: 配置加密存储 + 权限控制

## 3. 数据库表结构设计

### 3.1 系统配置表 (system\_configs)

```sql
-- 系统配置表（已存在，需扩展）
CREATE TABLE IF NOT EXISTS system_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) NOT NULL UNIQUE,
    config_value JSONB NOT NULL,
    config_type VARCHAR(50) NOT NULL, -- 'telegram', 'tron', 'system'
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    is_encrypted BOOLEAN DEFAULT false,
    created_by UUID REFERENCES admins(id),
    updated_by UUID REFERENCES admins(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_system_configs_type ON system_configs(config_type);
CREATE INDEX IF NOT EXISTS idx_system_configs_active ON system_configs(is_active);
```

### 3.2 Telegram机器人配置表 (telegram\_bots)

```sql
-- Telegram机器人表（已存在，需扩展字段）
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS network_config JSONB;
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS webhook_config JSONB;
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS message_templates JSONB;
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS rate_limits JSONB;
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS security_settings JSONB;
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS last_health_check TIMESTAMP WITH TIME ZONE;
ALTER TABLE telegram_bots ADD COLUMN IF NOT EXISTS health_status VARCHAR(20) DEFAULT 'unknown';

-- 添加注释
COMMENT ON COLUMN telegram_bots.network_config IS 'Telegram网络配置（API端点、超时等）';
COMMENT ON COLUMN telegram_bots.webhook_config IS 'Webhook配置（URL、密钥、允许的更新类型）';
COMMENT ON COLUMN telegram_bots.message_templates IS '消息模板配置';
COMMENT ON COLUMN telegram_bots.rate_limits IS '频率限制配置';
COMMENT ON COLUMN telegram_bots.security_settings IS '安全设置（IP白名单、加密等）';
```

### 3.3 TRON网络配置表 (tron\_networks)

```sql
-- TRON网络配置表（新建）
CREATE TABLE tron_networks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    network_name VARCHAR(50) NOT NULL UNIQUE, -- 'mainnet', 'shasta', 'nile'
    display_name VARCHAR(100) NOT NULL,
    full_host VARCHAR(255) NOT NULL,
    solidity_node VARCHAR(255),
    event_server VARCHAR(255),
    api_key TEXT, -- 加密存储
    chain_id INTEGER,
    block_time INTEGER DEFAULT 3000, -- 出块时间(ms)
    energy_price BIGINT, -- 能量价格(sun)
    bandwidth_price BIGINT, -- 带宽价格(sun)
    contracts JSONB, -- 合约地址配置
    is_testnet BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 0, -- 优先级，数字越大优先级越高
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引
CREATE INDEX idx_tron_networks_active ON tron_networks(is_active);
CREATE INDEX idx_tron_networks_priority ON tron_networks(priority DESC);

-- 初始化数据
INSERT INTO tron_networks (network_name, display_name, full_host, chain_id, is_testnet, contracts, priority) VALUES
('mainnet', 'TRON主网', 'https://api.trongrid.io', 1, false, 
 '{
   "USDT": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
   "USDC": "TEkxiTehnzSmSe2XqrBj4w32RUN966rdz8"
 }', 100),
('shasta', 'Shasta测试网', 'https://api.shasta.trongrid.io', 2, true,
 '{
   "USDT": "TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs",
   "TEST_TOKEN": "TXYZpUAh2cGS4k9fycKJitaK4Fc4BKBwif"
 }', 90),
('nile', 'Nile测试网', 'https://nile.trongrid.io', 3, true,
 '{
   "USDT": "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj"
 }', 80);
```

### 3.4 能量池账户表 (energy\_pools)

```sql
-- 能量池表（已存在，需扩展字段）
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS network_id UUID REFERENCES tron_networks(id);
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS account_name VARCHAR(100);
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS account_type public.account_type DEFAULT 'own_energy';
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS frozen_balance BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS energy_limit BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS bandwidth_limit BIGINT DEFAULT 0;
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS last_sync_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS sync_status VARCHAR(20) DEFAULT 'pending';
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS auto_refill BOOLEAN DEFAULT false;
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS min_energy_threshold BIGINT DEFAULT 100000;
ALTER TABLE energy_pools ADD COLUMN IF NOT EXISTS priority INTEGER DEFAULT 0;

-- 添加注释
COMMENT ON COLUMN energy_pools.network_id IS '关联的TRON网络ID';
COMMENT ON COLUMN energy_pools.account_name IS '账户别名';
COMMENT ON COLUMN energy_pools.account_type IS '账户类型：own_energy, agent_energy, third_party';
COMMENT ON COLUMN energy_pools.auto_refill IS '是否自动补充能量';
COMMENT ON COLUMN energy_pools.min_energy_threshold IS '最小能量阈值';
```

### 3.5 机器人网络关联表 (bot\_network\_configs)

```sql
-- 机器人网络配置关联表（新建）
CREATE TABLE bot_network_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    bot_id UUID NOT NULL REFERENCES telegram_bots(id) ON DELETE CASCADE,
    network_id UUID NOT NULL REFERENCES tron_networks(id) ON DELETE CASCADE,
    is_primary BOOLEAN DEFAULT false, -- 是否为主要网络
    energy_pool_ids UUID[], -- 关联的能量池ID数组
    pricing_config JSONB, -- 该网络下的定价配置
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(bot_id, network_id)
);

-- 创建索引
CREATE INDEX idx_bot_network_configs_bot ON bot_network_configs(bot_id);
CREATE INDEX idx_bot_network_configs_network ON bot_network_configs(network_id);
CREATE INDEX idx_bot_network_configs_primary ON bot_network_configs(bot_id, is_primary) WHERE is_primary = true;
```

### 3.6 配置变更历史表 (system\_config\_history)

```sql
-- 系统配置变更历史表（新建）
CREATE TABLE system_config_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_id UUID REFERENCES system_configs(id),
    table_name VARCHAR(50) NOT NULL, -- 'telegram_bots', 'tron_networks', 'energy_pools'
    record_id UUID NOT NULL,
    action_type VARCHAR(20) NOT NULL, -- 'create', 'update', 'delete', 'activate', 'deactivate'
    old_values JSONB,
    new_values JSONB,
    changed_fields TEXT[],
    change_reason TEXT,
    changed_by UUID REFERENCES admins(id),
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引
CREATE INDEX idx_config_history_table_record ON system_config_history(table_name, record_id);
CREATE INDEX idx_config_history_changed_by ON system_config_history(changed_by);
CREATE INDEX idx_config_history_created_at ON system_config_history(created_at DESC);
```

## 4. API接口设计

### 4.1 Telegram机器人管理API

#### 获取机器人列表

```
GET /api/admin/bots
```

Query Parameters:

| 参数名     | 类型     | 必需    | 描述                         |
| ------- | ------ | ----- | -------------------------- |
| page    | number | false | 页码，默认1                     |
| limit   | number | false | 每页数量，默认20                  |
| status  | string | false | 状态筛选：active, inactive, all |
| network | string | false | 网络筛选：mainnet, shasta, nile |

Response:

```json
{
  "success": true,
  "data": {
    "bots": [
      {
        "id": "uuid",
        "bot_name": "主力机器人",
        "bot_username": "energy_rental_bot",
        "is_active": true,
        "health_status": "healthy",
        "last_activity_at": "2024-01-15T10:30:00Z",
        "networks": [
          {
            "network_name": "shasta",
            "display_name": "Shasta测试网",
            "is_primary": true,
            "energy_pools_count": 3
          }
        ],
        "stats": {
          "total_users": 1250,
          "active_users_24h": 89,
          "orders_today": 45
        }
      }
    ],
    "pagination": {
      "current_page": 1,
      "total_pages": 5,
      "total_count": 12,
      "per_page": 20
    }
  }
}
```

#### 创建机器人

```
POST /api/admin/bots
```

Request:

```json
{
  "bot_name": "新机器人",
  "bot_token": "1234567890:ABCDEF...",
  "description": "用于测试的机器人",
  "webhook_config": {
    "url": "https://yourdomain.com/webhook/telegram",
    "secret_token": "your-secret-token",
    "allowed_updates": ["message", "callback_query"]
  },
  "network_configs": [
    {
      "network_id": "uuid",
      "is_primary": true,
      "energy_pool_ids": ["uuid1", "uuid2"]
    }
  ],
  "rate_limits": {
    "messages_per_minute": 30,
    "commands_per_hour": 100
  }
}
```

#### 更新机器人配置

```
PUT /api/admin/bots/:id
```

#### 切换机器人状态

```
PUT /api/admin/bots/:id/status
```

Request:

```json
{
  "is_active": true,
  "reason": "恢复服务"
}
```

#### 获取机器人健康状态

```
GET /api/admin/bots/:id/health
```

#### 测试机器人连接

```
POST /api/admin/bots/:id/test
```

### 4.2 TRON网络配置API

#### 获取网络列表

```
GET /api/admin/tron/networks
```

Response:

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "network_name": "mainnet",
      "display_name": "TRON主网",
      "full_host": "https://api.trongrid.io",
      "is_testnet": false,
      "is_active": true,
      "energy_price": 420,
      "contracts": {
        "USDT": "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"
      },
      "stats": {
        "connected_bots": 5,
        "energy_pools": 12,
        "daily_transactions": 234
      }
    }
  ]
}
```

#### 创建网络配置

```
POST /api/admin/tron/networks
```

Request:

```json
{
  "network_name": "custom_testnet",
  "display_name": "自定义测试网",
  "full_host": "https://custom.trongrid.io",
  "api_key": "your-api-key",
  "is_testnet": true,
  "contracts": {
    "USDT": "contract-address"
  }
}
```

#### 更新网络配置

```
PUT /api/admin/tron/networks/:id
```

#### 测试网络连接

```
POST /api/admin/tron/networks/:id/test
```

### 4.3 能量池管理API

#### 获取能量池列表

```
GET /api/admin/energy-pools
```

Query Parameters:

| 参数名           | 类型     | 必需    | 描述     |
| ------------- | ------ | ----- | ------ |
| network\_id   | string | false | 网络ID筛选 |
| account\_type | string | false | 账户类型筛选 |
| status        | string | false | 状态筛选   |

Response:

```json
{
  "success": true,
  "data": {
    "pools": [
      {
        "id": "uuid",
        "account_name": "主力能量池1",
        "address": "TRX_ADDRESS",
        "account_type": "own_energy",
        "network": {
          "id": "uuid",
          "network_name": "shasta",
          "display_name": "Shasta测试网"
        },
        "balance": {
          "trx": "1000.5",
          "energy": 500000,
          "bandwidth": 5000
        },
        "is_active": true,
        "last_sync_at": "2024-01-15T10:30:00Z",
        "stats": {
          "delegations_today": 25,
          "energy_used_today": 150000
        }
      }
    ]
  }
}
```

#### 创建能量池账户

```
POST /api/admin/energy-pools
```

Request:

```json
{
  "account_name": "新能量池",
  "network_id": "uuid",
  "account_type": "own_energy",
  "private_key": "private-key-here", // 将被加密存储
  "auto_refill": true,
  "min_energy_threshold": 100000
}
```

#### 导入现有账户

```
POST /api/admin/energy-pools/import
```

Request:

```json
{
  "account_name": "导入的账户",
  "address": "TRX_ADDRESS",
  "private_key": "private-key",
  "network_id": "uuid"
}
```

#### 同步账户余额

```
POST /api/admin/energy-pools/:id/sync
```

#### 批量操作

```
POST /api/admin/energy-pools/batch
```

Request:

```json
{
  "action": "activate", // activate, deactivate, sync
  "pool_ids": ["uuid1", "uuid2"],
  "reason": "批量激活"
}
```

### 4.4 配置关联API

#### 获取机器人网络配置

```
GET /api/admin/bots/:id/networks
```

#### 更新机器人网络配置

```
PUT /api/admin/bots/:id/networks
```

Request:

```json
{
  "network_configs": [
    {
      "network_id": "uuid",
      "is_primary": true,
      "energy_pool_ids": ["uuid1", "uuid2"],
      "pricing_config": {
        "energy_flash_rent": {
          "32000": {"price": 1.5, "currency": "TRX"}
        }
      }
    }
  ]
}
```

#### 获取网络下的能量池

```
GET /api/admin/tron/networks/:id/energy-pools
```

## 5. 前端管理界面设计

### 5.1 页面路由扩展

```typescript
// 在现有路由基础上扩展
const routes = [
  // 现有路由...
  {
    path: '/bots',
    name: 'BotManagement',
    component: () => import('@/views/BotManagement/index.vue'),
    children: [
      {
        path: '',
        name: 'BotList',
        component: () => import('@/views/BotManagement/BotList.vue')
      },
      {
        path: 'create',
        name: 'BotCreate',
        component: () => import('@/views/BotManagement/BotForm.vue')
      },
      {
        path: ':id/edit',
        name: 'BotEdit',
        component: () => import('@/views/BotManagement/BotForm.vue')
      },
      {
        path: ':id/networks',
        name: 'BotNetworks',
        component: () => import('@/views/BotManagement/BotNetworks.vue')
      }
    ]
  },
  {
    path: '/tron-networks',
    name: 'TronNetworks',
    component: () => import('@/views/TronNetworks/index.vue')
  },
  {
    path: '/energy-pools',
    name: 'EnergyPools',
    component: () => import('@/views/EnergyPools/index.vue')
  }
];
```

### 5.2 机器人管理界面

#### 机器人列表页面

```vue
<!-- BotList.vue -->
<template>
  <div class="bot-management">
    <!-- 顶部操作栏 -->
    <div class="toolbar">
      <el-button type="primary" @click="createBot">
        <el-icon><Plus /></el-icon>
        添加机器人
      </el-button>
      <el-button @click="batchOperation">
        <el-icon><Operation /></el-icon>
        批量操作
      </el-button>
      <div class="filters">
        <el-select v-model="filters.status" placeholder="状态筛选">
          <el-option label="全部" value="all" />
          <el-option label="活跃" value="active" />
          <el-option label="停用" value="inactive" />
        </el-select>
        <el-select v-model="filters.network" placeholder="网络筛选">
          <el-option label="全部网络" value="all" />
          <el-option label="主网" value="mainnet" />
          <el-option label="Shasta测试网" value="shasta" />
        </el-select>
      </div>
    </div>

    <!-- 机器人卡片列表 -->
    <div class="bot-grid">
      <el-card 
        v-for="bot in bots" 
        :key="bot.id" 
        class="bot-card"
        :class="{ 'inactive': !bot.is_active }"
      >
        <template #header>
          <div class="card-header">
            <div class="bot-info">
              <h3>{{ bot.bot_name }}</h3>
              <span class="username">@{{ bot.bot_username }}</span>
            </div>
            <div class="status-indicator">
              <el-tag 
                :type="getStatusType(bot.health_status)"
                size="small"
              >
                {{ getStatusText(bot.health_status) }}
              </el-tag>
            </div>
          </div>
        </template>

        <div class="bot-content">
          <!-- 网络配置 -->
          <div class="networks">
            <h4>关联网络</h4>
            <div class="network-tags">
              <el-tag 
                v-for="network in bot.networks" 
                :key="network.network_name"
                :type="network.is_primary ? 'primary' : 'info'"
                size="small"
              >
                {{ network.display_name }}
                <span v-if="network.is_primary">（主）</span>
              </el-tag>
            </div>
          </div>

          <!-- 统计信息 -->
          <div class="stats">
            <div class="stat-item">
              <span class="label">总用户数</span>
              <span class="value">{{ bot.stats.total_users }}</span>
            </div>
            <div class="stat-item">
              <span class="label">24h活跃</span>
              <span class="value">{{ bot.stats.active_users_24h }}</span>
            </div>
            <div class="stat-item">
              <span class="label">今日订单</span>
              <span class="value">{{ bot.stats.orders_today }}</span>
            </div>
          </div>

          <!-- 最后活动时间 -->
          <div class="last-activity">
            <el-icon><Clock /></el-icon>
            最后活动: {{ formatTime(bot.last_activity_at) }}
          </div>
        </div>

        <template #footer>
          <div class="card-actions">
            <el-button size="small" @click="editBot(bot.id)">
              编辑
            </el-button>
            <el-button size="small" @click="configNetworks(bot.id)">
              网络配置
            </el-button>
            <el-button 
              size="small" 
              @click="testBot(bot.id)"
              :loading="testing[bot.id]"
            >
              测试连接
            </el-button>
            <el-button 
              size="small" 
              :type="bot.is_active ? 'danger' : 'success'"
              @click="toggleStatus(bot)"
            >
              {{ bot.is_active ? '停用' : '启用' }}
            </el-button>
          </div>
        </template>
      </el-card>
    </div>

    <!-- 分页 -->
    <el-pagination
      v-model:current-page="pagination.current_page"
      v-model:page-size="pagination.per_page"
      :total="pagination.total_count"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
    />
  </div>
</template>
```

#### 机器人表单页面

```vue
<!-- BotForm.vue -->
<template>
  <div class="bot-form">
    <el-form 
      ref="formRef" 
      :model="form" 
      :rules="rules" 
      label-width="120px"
    >
      <!-- 基本信息 -->
      <el-card title="基本信息">
        <el-form-item label="机器人名称" prop="bot_name">
          <el-input v-model="form.bot_name" placeholder="请输入机器人名称" />
        </el-form-item>
        
        <el-form-item label="Bot Token" prop="bot_token">
          <el-input 
            v-model="form.bot_token" 
            type="password" 
            show-password
            placeholder="请输入Telegram Bot Token"
          />
          <div class="form-tip">
            从 @BotFather 获取的机器人Token
          </div>
        </el-form-item>
        
        <el-form-item label="描述" prop="description">
          <el-input 
            v-model="form.description" 
            type="textarea" 
            :rows="3"
            placeholder="请输入机器人描述"
          />
        </el-form-item>
      </el-card>

      <!-- Webhook配置 -->
      <el-card title="Webhook配置">
        <el-form-item label="Webhook URL" prop="webhook_config.url">
          <el-input 
            v-model="form.webhook_config.url" 
            placeholder="https://yourdomain.com/webhook/telegram"
          />
        </el-form-item>
        
        <el-form-item label="密钥Token" prop="webhook_config.secret_token">
          <el-input 
            v-model="form.webhook_config.secret_token" 
            type="password" 
            show-password
            placeholder="Webhook验证密钥"
          />
        </el-form-item>
        
        <el-form-item label="允许的更新类型">
          <el-checkbox-group v-model="form.webhook_config.allowed_updates">
            <el-checkbox label="message">消息</el-checkbox>
            <el-checkbox label="callback_query">回调查询</el-checkbox>
            <el-checkbox label="inline_query">内联查询</el-checkbox>
          </el-checkbox-group>
        </el-form-item>
      </el-card>

      <!-- 网络配置 -->
      <el-card title="网络配置">
        <div class="network-configs">
          <div 
            v-for="(config, index) in form.network_configs" 
            :key="index"
            class="network-config-item"
          >
            <el-form-item :label="`网络 ${index + 1}`">
              <el-select 
                v-model="config.network_id" 
                placeholder="选择TRON网络"
                style="width: 200px;"
              >
                <el-option 
                  v-for="network in availableNetworks" 
                  :key="network.id"
                  :label="network.display_name"
                  :value="network.id"
                />
              </el-select>
              
              <el-checkbox 
                v-model="config.is_primary" 
                style="margin-left: 10px;"
              >
                主要网络
              </el-checkbox>
              
              <el-button 
                type="danger" 
                size="small" 
                @click="removeNetworkConfig(index)"
                style="margin-left: 10px;"
              >
                删除
              </el-button>
            </el-form-item>
            
            <el-form-item label="关联能量池">
              <el-select 
                v-model="config.energy_pool_ids" 
                multiple 
                placeholder="选择能量池账户"
                style="width: 100%;"
              >
                <el-option 
                  v-for="pool in getNetworkPools(config.network_id)" 
                  :key="pool.id"
                  :label="`${pool.account_name} (${pool.address})`"
                  :value="pool.id"
                />
              </el-select>
            </el-form-item>
          </div>
          
          <el-button @click="addNetworkConfig" type="dashed">
            <el-icon><Plus /></el-icon>
            添加网络配置
          </el-button>
        </div>
      </el-card>

      <!-- 安全设置 -->
      <el-card title="安全设置">
        <el-form-item label="频率限制">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-input 
                v-model.number="form.rate_limits.messages_per_minute" 
                type="number"
                placeholder="每分钟消息数"
              >
                <template #append>条/分钟</template>
              </el-input>
            </el-col>
            <el-col :span="12">
              <el-input 
                v-model.number="form.rate_limits.commands_per_hour" 
                type="number"
                placeholder="每小时命令数"
              >
                <template #append>条/小时</template>
              </el-input>
            </el-col>
          </el-row>
        </el-form-item>
      </el-card>

      <!-- 提交按钮 -->
      <div class="form-actions">
        <el-button @click="$router.back()">取消</el-button>
        <el-button type="primary" @click="submitForm" :loading="submitting">
          {{ isEdit ? '更新' : '创建' }}机器人
        </el-button>
      </div>
    </el-form>
  </div>
</template>
```

### 5.3 TRON网络管理界面

```vue
<!-- TronNetworks/index.vue -->
<template>
  <div class="tron-networks">
    <div class="page-header">
      <h2>TRON网络配置</h2>
      <el-button type="primary" @click="createNetwork">
        <el-icon><Plus /></el-icon>
        添加网络
      </el-button>
    </div>

    <div class="network-list">
      <el-card 
        v-for="network in networks" 
        :key="network.id" 
        class="network-card"
      >
        <template #header>
          <div class="card-header">
            <div class="network-info">
              <h3>{{ network.display_name }}</h3>
              <el-tag 
                :type="network.is_testnet ? 'warning' : 'success'"
                size="small"
              >
                {{ network.is_testnet ? '测试网' : '主网' }}
              </el-tag>
            </div>
            <div class="status">
              <el-switch 
                v-model="network.is_active" 
                @change="toggleNetworkStatus(network)"
              />
            </div>
          </div>
        </template>

        <div class="network-content">
          <div class="network-details">
            <div class="detail-item">
              <span class="label">节点地址:</span>
              <span class="value">{{ network.full_host }}</span>
            </div>
            <div class="detail-item">
              <span class="label">链ID:</span>
              <span class="value">{{ network.chain_id }}</span>
            </div>
            <div class="detail-item">
              <span class="label">能量价格:</span>
              <span class="value">{{ network.energy_price }} sun</span>
            </div>
          </div>

          <div class="contracts">
            <h4>合约地址</h4>
            <div class="contract-list">
              <div 
                v-for="(address, name) in network.contracts" 
                :key="name"
                class="contract-item"
              >
                <span class="contract-name">{{ name }}:</span>
                <span class="contract-address">{{ address }}</span>
                <el-button 
                  size="small" 
                  text 
                  @click="copyToClipboard(address)"
                >
                  复制
                </el-button>
              </div>
            </div>
          </div>

          <div class="stats">
            <div class="stat-item">
              <span class="label">关联机器人</span>
              <span class="value">{{ network.stats.connected_bots }}</span>
            </div>
            <div class="stat-item">
              <span class="label">能量池数量</span>
              <span class="value">{{ network.stats.energy_pools }}</span>
            </div>
            <div class="stat-item">
              <span class="label">日交易量</span>
              <span class="value">{{ network.stats.daily_transactions }}</span>
            </div>
          </div>
        </div>

        <template #footer>
          <div class="card-actions">
            <el-button size="small" @click="editNetwork(network.id)">
              编辑
            </el-button>
            <el-button 
              size="small" 
              @click="testConnection(network.id)"
              :loading="testing[network.id]"
            >
              测试连接
            </el-button>
            <el-button size="small" @click="viewPools(network.id)">
              查看能量池
            </el-button>
          </div>
        </template>
      </el-card>
    </div>
  </div>
</template>
```

### 5.4 能量池管理界面

```vue
<!-- EnergyPools/index.vue -->
<template>
  <div class="energy-pools">
    <div class="page-header">
      <h2>能量池管理</h2>
      <div class="header-actions">
        <el-button @click="syncAllPools" :loading="syncing">
          <el-icon><Refresh /></el-icon>
          同步余额
        </el-button>
        <el-button type="primary" @click="createPool">
          <el-icon><Plus /></el-icon>
          添加能量池
        </el-button>
        <el-button @click="importPool">
          <el-icon><Upload /></el-icon>
          导入账户
        </el-button>
      </div>
    </div>

    <!-- 筛选器 -->
    <div class="filters">
      <el-select v-model="filters.network_id" placeholder="选择网络">
        <el-option label="全部网络" value="" />
        <el-option 
          v-for="network in networks" 
          :key="network.id"
          :label="network.display_name"
          :value="network.id"
        />
      </el-select>
      
      <el-select v-model="filters.account_type" placeholder="账户类型">
        <el-option label="全部类型" value="" />
        <el-option label="自有能量" value="own_energy" />
        <el-option label="代理能量" value="agent_energy" />
        <el-option label="第三方" value="third_party" />
      </el-select>
      
      <el-select v-model="filters.status" placeholder="状态">
        <el-option label="全部状态" value="" />
        <el-option label="活跃" value="active" />
        <el-option label="停用" value="inactive" />
      </el-select>
    </div>

    <!-- 能量池表格 -->
    <el-table 
      :data="pools" 
      v-loading="loading"
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55" />
      
      <el-table-column label="账户名称" prop="account_name" width="150">
        <template #default="{ row }">
          <div class="account-info">
            <div class="name">{{ row.account_name }}</div>
            <div class="type">
              <el-tag size="small" :type="getAccountTypeColor(row.account_type)">
                {{ getAccountTypeText(row.account_type) }}
              </el-tag>
            </div>
          </div>
        </template>
      </el-table-column>
      
      <el-table-column label="地址" prop="address" width="200">
        <template #default="{ row }">
          <div class="address-cell">
            <span class="address">{{ formatAddress(row.address) }}</span>
            <el-button 
              size="small" 
              text 
              @click="copyToClipboard(row.address)"
            >
              复制
            </el-button>
          </div>
        </template>
      </el-table-column>
      
      <el-table-column label="网络" width="120">
        <template #default="{ row }">
          <el-tag 
            size="small" 
            :type="row.network.is_testnet ? 'warning' : 'success'"
          >
            {{ row.network.display_name }}
          </el-tag>
        </template>
      </el-table-column>
      
      <el-table-column label="余额信息" width="200">
        <template #default="{ row }">
          <div class="balance-info">
            <div class="balance-item">
              <span class="label">TRX:</span>
              <span class="value">{{ row.balance.trx }}</span>
            </div>
            <div class="balance-item">
              <span class="label">能量:</span>
              <span class="value">{{ formatNumber(row.balance.energy) }}</span>
            </div>
            <div class="balance-item">
              <span class="label">带宽:</span>
              <span class="value">{{ formatNumber(row.balance.bandwidth) }}</span>
            </div>
          </div>
        </template>
      </el-table-column>
      
      <el-table-column label="状态" width="100">
        <template #default="{ row }">
          <el-tag 
            :type="row.is_active ? 'success' : 'danger'"
            size="small"
          >
            {{ row.is_active ? '活跃' : '停用' }}
          </el-tag>
        </template>
      </el-table-column>
      
      <el-table-column label="统计" width="150">
        <template #default="{ row }">
          <div class="stats-info">
            <div class="stat-item">
              <span class="label">今日委托:</span>
              <span class="value">{{ row.stats.delegations_today }}</span>
            </div>
            <div class="stat-item">
              <span class="label">能量消耗:</span>
              <span class="value">{{ formatNumber(row.stats.energy_used_today) }}</span>
            </div>
          </div>
        </template>
      </el-table-column>
      
      <el-table-column label="最后同步" width="150">
        <template #default="{ row }">
          <div class="sync-info">
            <div class="time">{{ formatTime(row.last_sync_at) }}</div>
            <el-tag 
              size="small" 
              :type="getSyncStatusColor(row.sync_status)"
            >
              {{ getSyncStatusText(row.sync_status) }}
            </el-tag>
          </div>
        </template>
      </el-table-column>
      
      <el-table-column label="操作" width="200" fixed="right">
        <template #default="{ row }">
          <div class="actions">
            <el-button size="small" @click="editPool(row.id)">
              编辑
            </el-button>
            <el-button 
              size="small" 
              @click="syncPool(row.id)"
              :loading="syncing"
            >
              同步
            </el-button>
            <el-button 
              size="small" 
              :type="row.is_active ? 'danger' : 'success'"
              @click="togglePoolStatus(row)"
            >
              {{ row.is_active ? '停用' : '启用' }}
            </el-button>
          </div>
        </template>
      </el-table-column>
    </el-table>

    <!-- 批量操作 -->
    <div v-if="selectedPools.length > 0" class="batch-actions">
      <span>已选择 {{ selectedPools.length }} 个账户</span>
      <el-button @click="batchSync">批量同步</el-button>
      <el-button @click="batchActivate">批量启用</el-button>
      <el-button @click="batchDeactivate">批量停用</el-button>
    </div>
  </div>
</template>
```

## 6. 配置迁移实施方案

### 6.1 迁移步骤

#### 第一阶段：数据库准备

1. 创建新的配置表结构
2. 数据迁移脚本开发
3. 从环境变量导入现有配置

#### 第二阶段：后端API开发

1. 配置管理API开发
2. 配置缓存机制实现
3. 配置变更通知系统

#### 第三阶段：前端界面开发

1. 管理界面开发
2. 配置表单和验证
3. 实时状态监控

#### 第四阶段：服务重构

1. 机器人服务动态配置加载
2. TRON服务多网络支持
3. 能量池动态管理

#### 第五阶段：测试和部署

1. 功能测试
2. 性能测试
3. 灰度发布

### 6.2 数据迁移脚本

```sql
-- 迁移脚本：从环境变量到数据库配置

-- 1. 迁移TRON网络配置
INSERT INTO tron_networks (network_name, display_name, full_host, is_testnet, priority)
SELECT 
    CASE 
        WHEN '${TRON_NETWORK}' = 'mainnet' THEN 'mainnet'
        WHEN '${TRON_NETWORK}' = 'shasta' THEN 'shasta'
        ELSE 'nile'
    END,
    CASE 
        WHEN '${TRON_NETWORK}' = 'mainnet' THEN 'TRON主网'
        WHEN '${TRON_NETWORK}' = 'shasta' THEN 'Shasta测试网'
        ELSE 'Nile测试网'
    END,
    '${TRON_FULL_NODE}',
    '${TRON_NETWORK}' != 'mainnet',
    100
WHERE NOT EXISTS (
    SELECT 1 FROM tron_networks WHERE network_name = '${TRON_NETWORK}'
);

-- 2. 迁移Telegram机器人配置
INSERT INTO telegram_bots (
    bot_name, 
    bot_token, 
    webhook_config,
    is_active
)
SELECT 
    '默认机器人',
    '${TELEGRAM_BOT_TOKEN}',
    jsonb_build_object(
        'url', '${TELEGRAM_WEBHOOK_URL}',
        'secret_token', '${TELEGRAM_WEBHOOK_SECRET}',
        'allowed_updates', array['message', 'callback_query']
    ),
    true
WHERE NOT EXISTS (
    SELECT 1 FROM telegram_bots WHERE bot_token = '${TELEGRAM_BOT_TOKEN}'
);

-- 3. 迁移能量池配置
INSERT INTO energy_pools (
    account_name,
    address,
    encrypted_private_key,
    network_id,
    account_type,
    is_active
)
SELECT 
    '默认能量池',
    '${TRON_ADDRESS}',
    encrypt_private_key('${TRON_PRIVATE_KEY}'), -- 需要实现加密函数
    (SELECT id FROM tron_networks WHERE network_name = '${TRON_NETWORK}'),
    'own_energy',
    true
WHERE NOT EXISTS (
    SELECT 1 FROM energy_pools WHERE address = '${TRON_ADDRESS}'
);

-- 4. 创建机器人网络关联
INSERT INTO bot_network_configs (
    bot_id,
    network_id,
    is_primary,
    energy_pool_ids
)
SELECT 
    b.id,
    n.id,
    true,
    array[p.id]
FROM telegram_bots b
CROSS JOIN tron_networks n
JOIN energy_pools p ON p.network_id = n.id
WHERE b.bot_token = '${TELEGRAM_BOT_TOKEN}'
    AND n.network_name = '${TRON_NETWORK}'
    AND NOT EXISTS (
        SELECT 1 FROM bot_network_configs 
        WHERE bot_id = b.id AND network_id = n.id
    );
```

### 6.3 配置服务重构

```typescript
// 配置管理服务
class ConfigurationService {
    private configCache = new Map<string, any>();
    private cacheExpiry = new Map<string, number>();
    
    // 获取机器人配置
    async getBotConfig(botId: string): Promise<BotConfig> {
        const cacheKey = `bot_config:${botId}`;
        
        if (this.isConfigCached(cacheKey)) {
            return this.configCache.get(cacheKey);
        }
        
        const bot = await TelegramBot.findByPk(botId, {
            include: [
                {
                    model: BotNetworkConfig,
                    include: [TronNetwork, EnergyPool]
                }
            ]
        });
        
        const config = this.transformBotConfig(bot);
        this.cacheConfig(cacheKey, config, 300); // 缓存5分钟
        
        return config;
    }
    
    // 获取TRON网络配置
    async getTronNetworkConfig(networkId: string): Promise<TronNetworkConfig> {
        const cacheKey = `tron_network:${networkId}`;
        
        if (this.isConfigCached(cacheKey)) {
            return this.configCache.get(cacheKey);
        }
        
        const network = await TronNetwork.findByPk(networkId);
        if (!network) {
            throw new Error(`TRON网络配置不存在: ${networkId}`);
        }
        
        const config = {
            networkName: network.network_name,
            fullHost: network.full_host,
            apiKey: await this.decryptApiKey(network.api_key),
            contracts: network.contracts,
            energyPrice: network.energy_price
        };
        
        this.cacheConfig(cacheKey, config, 600); // 缓存10分钟
        return config;
    }
    
    // 获取能量池配置
    async getEnergyPoolConfig(poolId: string): Promise<EnergyPoolConfig> {
        const cacheKey = `energy_pool:${poolId}`;
        
        if (this.isConfigCached(cacheKey)) {
            return this.configCache.get(cacheKey);
        }
        
        const pool = await EnergyPool.findByPk(poolId, {
            include: [TronNetwork]
        });
        
        if (!pool) {
            throw new Error(`能量池配置不存在: ${poolId}`);
        }
        
        const config = {
            address: pool.address,
            privateKey: await this.decryptPrivateKey(pool.encrypted_private_key),
            network: await this.getTronNetworkConfig(pool.network_id),
            accountType: pool.account_type,
            autoRefill: pool.auto_refill,
            minEnergyThreshold: pool.min_energy_threshold
        };
        
        this.cacheConfig(cacheKey, config, 300); // 缓存5分钟
        return config;
    }
    
    // 配置变更通知
    async notifyConfigChange(type: string, id: string) {
        const cacheKeys = Array.from(this.configCache.keys())
            .filter(key => key.includes(id));
            
        // 清除相关缓存
        cacheKeys.forEach(key => {
            this.configCache.delete(key);
            this.cacheExpiry.delete(key);
        });
        
        // 发送配置变更事件
        EventBus.emit('config:changed', { type, id });
        
        // 通知相关服务重新加载配置
        if (type === 'telegram_bot') {
            await TelegramBotManager.reloadBotConfig(id);
        } else if (type === 'tron_network') {
            await TronService.reloadNetworkConfig(id);
        } else if (type === 'energy_pool') {
            await EnergyPoolManager.reloadPoolConfig(id);
        }
    }
    
    private isConfigCached(key: string): boolean {
        const expiry = this.cacheExpiry.get(key);
        if (!expiry || Date.now() > expiry) {
            this.configCache.delete(key);
            this.cacheExpiry.delete(key);
            return false;
        }
        return this.configCache.has(key);
    }
    
    private cacheConfig(key: string, config: any, ttlSeconds: number) {
        this.configCache.set(key, config);
        this.cacheExpiry.set(key, Date.now() + ttlSeconds * 1000);
    }
}
```

### 6.4 环境变量清理

```bash
# 更新后的 .env 文件（移除已迁移的配置）

# =================================================================================================
# TRON 能量租赁系统 - 环境配置文件 (配置迁移后版本)
# =================================================================================================

# =================================================================================================
# 🚀 前端配置 (VITE_)
# =================================================================================================
VITE_VUE_DEVTOOLS=true
VITE_ENV=development
VITE_API_URL=http://localhost:3001
VITE_PORT=5173

# =================================================================================================
# 🌍 环境和服务器配置
# =================================================================================================
NODE_ENV=development
PORT=3001
HOST_ADDRESS=localhost
API_BASE_URL=http://localhost:3001

# =================================================================================================
# 🗄️ 数据库配置 (PostgreSQL)
# =================================================================================================
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy_rental
DB_USER=postgres
DB_PASSWORD=postgres
DB_SCHEMA=tron_energy
DB_SSL=false
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/tron_energy_rental
DB_MAX_CONNECTIONS=20
DB_IDLE_TIMEOUT=30000
DB_CONNECTION_TIMEOUT=2000

# =================================================================================================
# 🔄 Redis 配置
# =================================================================================================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_KEY_PREFIX=tron_energy
REDIS_SESSION_TTL=86400
REDIS_CACHE_TTL=3600

# =================================================================================================
# 🔐 JWT 配置
# =================================================================================================
JWT_SECRET=tron-energy-rental-super-secret-jwt-key-2024-production-ready
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# =================================================================================================
# 🔒 安全配置
# =================================================================================================
ENCRYPTION_KEY=your-32-character-encryption-key-here
HASH_SALT_ROUNDS=12
API_RATE_LIMIT=100
API_RATE_WINDOW=900000

# =================================================================================================
# 📝 日志配置
# =================================================================================================
LOG_LEVEL=info
LOG_FILE_PATH=./logs
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5
LOG_DATE_PATTERN=YYYY-MM-DD

# =================================================================================================
# 📧 邮件配置 (可选)
# =================================================================================================
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
MAIL_FROM=noreply@tronrental.com

# =================================================================================================
# 🔧 系统配置
# =================================================================================================
TIMEZONE=Asia/Shanghai
DEFAULT_LANGUAGE=zh-CN
FILE_UPLOAD_MAX_SIZE=10485760
SESSION_SECRET=tron-energy-session-secret-key-2024

# =================================================================================================
# 📊 监控配置
# =================================================================================================
HEALTH_CHECK_INTERVAL=30000
METRICS_ENABLED=true
METRICS_PORT=9090

# =================================================================================================
# 注意事项
# =================================================================================================
# 1. Telegram机器人配置已迁移到管理后台数据库
# 2. TRON网络配置已迁移到管理后台数据库
# 3. 能量池账户配置已迁移到管理后台数据库
# 4. 敏感信息（如私钥、Token）现在加密存储在数据库中
# 5. 配置变更通过管理后台进行，支持实时生效
```

## 7. 安全考虑

### 7.1 敏感信息加密

```typescript
// 加密服务
class EncryptionService {
    private readonly algorithm = 'aes-256-gcm';
    private readonly keyLength = 32;
    
    constructor(private encryptionKey: string) {
        if (encryptionKey.length !== this.keyLength) {
            throw new Error('加密密钥长度必须为32字符');
        }
    }
    
    // 加密私钥
    encryptPrivateKey(privateKey: string): string {
        const iv = crypto.randomBytes(16);
        const cipher = crypto.createCipher(this.algorithm, this.encryptionKey);
        cipher.setAAD(Buffer.from('private_key'));
        
        let encrypted = cipher.update(privateKey, 'utf8', 'hex');
        encrypted += cipher.final('hex');
        
        const authTag = cipher.getAuthTag();
        
        return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
    }
    
    // 解密私钥
    decryptPrivateKey(encryptedData: string): string {
        const [ivHex, authTagHex, encrypted] = encryptedData.split(':');
        
        const iv = Buffer.from(ivHex, 'hex');
        const authTag = Buffer.from(authTagHex, 'hex');
        
        const decipher = crypto.createDecipher(this.algorithm, this.encryptionKey);
        decipher.setAAD(Buffer.from('private_key'));
        decipher.setAuthTag(authTag);
        
        let decrypted = decipher.update(encrypted, 'hex', 'utf8');
        decrypted += decipher.final('utf8');
        
        return decrypted;
    }
    
    // 加密API密钥
    encryptApiKey(apiKey: string): string {
        // 类似私钥加密逻辑
        return this.encryptPrivateKey(apiKey);
    }
    
    // 解密API密钥
    decryptApiKey(encryptedApiKey: string): string {
        // 类似私钥解密逻辑
        return this.decryptPrivateKey(encryptedApiKey);
    }
}
```

### 7.2 权限控制

```typescript
// 权限中间件
class PermissionMiddleware {
    // 检查配置管理权限
    static checkConfigPermission(requiredPermission: string) {
        return async (req: Request, res: Response, next: NextFunction) => {
            try {
                const user = req.user as AdminUser;
                
                if (!user) {
                    return res.status(401).json({ error: '未授权访问' });
                }
                
                const hasPermission = await this.hasPermission(
                    user.id, 
                    requiredPermission
                );
                
                if (!hasPermission) {
                    return res.status(403).json({ 
                        error: '权限不足',
                        required: requiredPermission
                    });
                }
                
                next();
            } catch (error) {
                res.status(500).json({ error: '权限检查失败' });
            }
        };
    }
    
    private static async hasPermission(
        userId: string, 
        permission: string
    ): Promise<boolean> {
        // 检查用户权限逻辑
        const userPermissions = await AdminPermission.findAll({
            where: { admin_id: userId },
            include: [Permission]
        });
        
        return userPermissions.some(
            up => up.Permission.permission_name === permission
        );
    }
}

// 路由权限配置
router.get('/bots', 
    PermissionMiddleware.checkConfigPermission('bot:read'),
    BotController.list
);

router.post('/bots', 
    PermissionMiddleware.checkConfigPermission('bot:create'),
    BotController.create
);

router.put('/bots/:id', 
    PermissionMiddleware.checkConfigPermission('bot:update'),
    BotController.update
);
```

### 7.3 审计日志

```typescript
// 审计日志服务
class AuditLogService {
    static async logConfigChange({
        tableName,
        recordId,
        actionType,
        oldValues,
        newValues,
        changedBy,
        ipAddress,
        userAgent,
        changeReason
    }: AuditLogData) {
        try {
            const changedFields = this.getChangedFields(oldValues, newValues);
            
            await SystemConfigHistory.create({
                table_name: tableName,
                record_id: recordId,
                action_type: actionType,
                old_values: oldValues,
                new_values: newValues,
                changed_fields: changedFields,
                change_reason: changeReason,
                changed_by: changedBy,
                ip_address: ipAddress,
                user_agent: userAgent
            });
            
            // 发送审计事件
            EventBus.emit('audit:config_changed', {
                tableName,
                recordId,
                actionType,
                changedBy
            });
            
        } catch (error) {
            logger.error('审计日志记录失败:', error);
        }
    }
    
    private static getChangedFields(
        oldValues: any, 
        newValues: any
    ): string[] {
        const changed: string[] = [];
        
        if (!oldValues) return Object.keys(newValues || {});
        
        for (const key in newValues) {
            if (JSON.stringify(oldValues[key]) !== JSON.stringify(newValues[key])) {
                changed.push(key);
            }
        }
        
        return changed;
    }
}
```

## 8. 部署和运维

### 8.1 部署检查清单

- [ ] 数据库表结构已创建
- [ ] 现有配置已迁移到数据库
- [ ] 加密密钥已配置
- [ ] 权限系统已设置
- [ ] 审计日志已启用
- [ ] 配置缓存已启用
- [ ] 健康检查已配置
- [ ] 监控告警已设置
- [ ] 备份策略已制定

### 8.2 监控指标

```typescript
// 监控指标收集
class ConfigMetrics {
    // 配置变更频率
    static configChangeRate = new prometheus.Counter({
        name: 'config_changes_total',
        help: '配置变更总数',
        labelNames: ['table_name', 'action_type']
    });
    
    // 配置加载时间
    static configLoadTime = new prometheus.Histogram({
        name: 'config_load_duration_seconds',
        help: '配置加载耗时',
        labelNames: ['config_type']
    });
    
    // 缓存命中率
    static cacheHitRate = new prometheus.Gauge({
        name: 'config_cache_hit_rate',
        help: '配置缓存命中率'
    });
    
    // 活跃机器人数量
    static activeBots = new prometheus.Gauge({
        name: 'active_bots_count',
        help: '活跃机器人数量'
    });
    
    // 活跃能量池数量
    static activeEnergyPools = new prometheus.Gauge({
        name: 'active_energy_pools_count',
        help: '活跃能量池数量'
    });
}
```

### 8.3 故障恢复

```typescript
// 配置故障恢复
class ConfigRecoveryService {
    // 配置回滚
    static async rollbackConfig(
        tableName: string, 
        recordId: string, 
        targetVersion: string
    ) {
        const history = await SystemConfigHistory.findOne({
            where: {
                table_name: tableName,
                record_id: recordId,
                id: targetVersion
            }
        });
        
        if (!history) {
            throw new Error('目标版本不存在');
        }
        
        // 执行回滚操作
        await this.applyConfigValues(
            tableName, 
            recordId, 
            history.old_values
        );
        
        // 记录回滚操作
        await AuditLogService.logConfigChange({
            tableName,
            recordId,
            actionType: 'rollback',
            oldValues: history.new_values,
            newValues: history.old_values,
            changedBy: 'system',
            changeReason: `回滚到版本 ${targetVersion}`
        });
    }
    
    // 配置健康检查
    static async healthCheck(): Promise<ConfigHealthStatus> {
        const checks = {
            database: await this.checkDatabaseConnection(),
            cache: await this.checkCacheConnection(),
            bots: await this.checkBotsHealth(),
            networks: await this.checkNetworksHealth(),
            energyPools: await this.checkEnergyPoolsHealth()
        };
        
        const isHealthy = Object.values(checks).every(check => check.status === 'healthy');
        
        return {
            overall: isHealthy ? 'healthy' : 'unhealthy',
            checks,
            timestamp: new Date().toISOString()
        };
    }
}
```

## 9. 总结

本技术架构文档详细描述了将Telegram机器人和TRON配置从环境变量迁移到管理后台的完整方案。主要特点包括：

1. **数据库驱动配置**：所有配置存储在PostgreSQL数据库中，支持动态修改
2. **多实例管理**：支持多个Telegram机器人和多个TRON网络环境
3. **安全加密存储**：敏感信息（私钥、Token）采用AES-256-GCM加密
4. **实时配置更新**：配置变更后自动通知相关服务重新加载
5. **完整的审计追踪**：记录所有配置变更历史和操作日志
6. **用户友好界面**：提供直观的管理后台界面
7. **高可用性设计**：包含缓存、监控、故障恢复等机制

通过这个架构，系统将具备更好的可维护性、安全性和扩展性，为后续的业务发展提供坚实的技术基础。
```


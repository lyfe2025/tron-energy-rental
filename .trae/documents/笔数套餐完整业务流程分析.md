# 笔数套餐完整业务流程分析

## 1. 产品概述

笔数套餐是一种按交易笔数计费的能量代理服务，用户购买指定笔数的交易能量，系统采用分批代理机制，每次只代理一笔能量，监听使用完成后再代理下一笔，直到用户用完所有购买的笔数。同时具备占费机制，对24小时内未使用能量的用户扣除相应笔数。

## 2. 用户交互流程

### 2.1 套餐选择流程

**流程图：**

```
用户点击笔数套餐
        ↓
    显示套餐选项
        ↓
   用户选择具体笔数
        ↓
  显示"选择后回复消息"
        ↓
  提示用户输入能量接收地址
        ↓
    用户输入TRON地址
        ↓
    系统验证地址格式
        ↓
      地址验证
    ┌─────┴─────┐
    ↓           ↓
   有效        无效
    ↓           ↓
生成订单确认消息  提示地址格式错误
    ↓           ↓
  显示支付信息     ↑
    ↓           │
  用户完成支付     │
    ↓           │
  系统确认支付     │
    ↓           │
开始分批能量代理   │
                └─┘
```

**详细步骤说明：**

1. **用户点击笔数套餐** - 用户在Telegram Bot中选择笔数套餐功能
2. **显示套餐选项** - 系统展示可用的笔数套餐（如10笔、20笔、50笔等）
3. **用户选择具体笔数** - 用户点击选择所需的笔数套餐
4. **显示选择后回复消息** - 系统提示用户需要输入能量接收地址
5. **提示用户输入能量接收地址** - 系统发送消息要求用户输入TRON地址
6. **用户输入TRON地址** - 用户回复包含TRON地址的文本消息
7. **系统验证地址格式** - 调用地址验证服务检查格式正确性
8. **地址验证分支**：

   * **有效**：生成订单确认消息，显示支付信息

   * **无效**：提示地址格式错误，重新要求输入
9. **用户完成支付** - 用户向指定地址转账
10. **系统确认支付** - 监听到支付交易并验证
11. **开始分批能量代理** - 启动分批能量代理机制

### 2.2 订单确认消息格式

根据用户需求，订单确认消息应包含以下信息：（需要在价格配置-对应的笔数套餐里面添加以下配置信息）

```
每笔单价：1.1438 USDT
收款金额：11.504 USDT(点击复制)
使用笔数：10 笔转账
能量代理地址：TVSrQHNWcHvzjrd684MpT5h7e7p99kgTDr

收款trc20地址为：
TWdcgk9NEsV1nt5yPrNfSYktbA12345678
(点击地址自动复制)

‼️请务必核对金额尾数，金额不对则无法确认
‼️请务必核对金额尾数，金额不对则无法确认
‼️请务必核对金额尾数，金额不对则无法确认
订单将于 2025-09-24 19:05:02 过期，请尽快支付！
```

## 3. 订单创建和支付确认流程

### 3.1 订单创建

**当前实现状态：** ✅ 已实现基础框架

* 订单类型：`transaction_package`

* 关联价格配置：通过 `price_config_id` 字段

* 订单状态：`pending` → `processing` → `completed`

* 支付状态：`unpaid` → `paid`

**相关代码文件：**

* `api/services/order/OrderCreationService.ts` - 订单创建服务

* `api/services/order-management/OrderService.ts` - 订单管理服务

* `docs/database/orders_table_complete_comments.sql` - 订单表结构

### 3.2 支付确认

**当前实现状态：** ✅ 已实现

* 支付监听：通过交易监听服务

* 支付验证：验证 `tron_tx_hash` 和 `payment_trx_amount`

* 状态更新：`payment_status` 更新为 `paid`

## 4. 分批能量代理机制

### 4.1 核心机制设计

**设计原理：**

* 用户购买N笔交易能量

* 系统首次只代理1笔能量给用户

* 监听用户地址的能量使用情况

* 当检测到能量用完时，自动代理下一笔

* 重复此过程直到N笔全部使用完毕

### 4.2 当前实现状态

**❌ 缺失功能 - 需要实现**

当前系统缺少以下关键组件：

#### 4.2.1 订单笔数字段

**数据库字段缺失：**

```sql
-- 需要在orders表添加以下字段
ALTER TABLE orders ADD COLUMN transaction_count INTEGER DEFAULT 1;
ALTER TABLE orders ADD COLUMN used_transactions INTEGER DEFAULT 0;
ALTER TABLE orders ADD COLUMN remaining_transactions INTEGER DEFAULT 0;
```

#### 4.2.2 能量使用监听服务

**需要实现的服务：**

```typescript
// 能量使用监听服务
export class EnergyUsageMonitorService {
  // 监听用户地址能量变化
  async monitorEnergyUsage(address: string, orderId: number): Promise<void>
  
  // 检测能量是否用完
  async checkEnergyDepletion(address: string): Promise<boolean>
  
  // 触发下一笔能量代理
  async triggerNextDelegation(orderId: number): Promise<void>
}
```

#### 4.2.3 分批代理控制器

**需要实现的控制器：**

```typescript
// 分批代理控制器
export class BatchDelegationController {
  // 执行单笔能量代理
  async delegateSingleTransaction(orderId: number): Promise<void>
  
  // 更新订单笔数状态
  async updateTransactionCount(orderId: number): Promise<void>
  
  // 检查是否完成所有笔数
  async checkCompletionStatus(orderId: number): Promise<boolean>
}
```

### 4.3 技术实现要点

#### 4.3.1 能量监听机制

* **监听频率：** 每30秒检查一次用户地址能量状态

* **检测逻辑：** 对比前后两次查询的能量值变化

* **触发条件：** 当前能量 < 单笔交易所需能量阈值

#### 4.3.2 代理时机控制

* **首次代理：** 支付确认后立即执行

* **后续代理：** 检测到能量不足时自动触发

* **代理数量：** 每次固定代理单笔交易所需能量

#### 4.3.3 状态同步

* **实时更新：** `used_transactions` 和 `remaining_transactions`

* **完成检测：** `remaining_transactions = 0` 时标记订单完成

* **异常处理：** 代理失败时的重试机制

## 5. 占费机制

### 5.1 占费规则

**当前配置状态：** ✅ 已实现配置界面

* **占费周期：** 24小时

* **扣费条件：** 用户24小时内未使用任何能量

* **扣费数量：** 可配置的笔数（默认值可在价格配置中设置）

* **配置字段：** `daily_fee` (单位：笔/24h)

**相关代码文件：**

* `src/pages/PriceConfig/TransactionPackage/components/PackageSettings.vue` - 占费配置界面

* `api/middleware/validation.ts` - 占费配置验证

### 5.2 占费实现机制

**❌ 缺失功能 - 需要实现**

#### 5.2.1 占费检测服务

```typescript
// 占费检测服务
export class DailyFeeService {
  // 检查24小时内是否有能量使用
  async checkEnergyUsageIn24Hours(orderId: number): Promise<boolean>
  
  // 执行占费扣除
  async deductDailyFee(orderId: number, feeAmount: number): Promise<void>
  
  // 定时任务：每日占费检查
  async scheduleDailyFeeCheck(): Promise<void>
}
```

#### 5.2.2 使用记录追踪

**需要新增数据表：**

```sql
-- 能量使用记录表
CREATE TABLE energy_usage_logs (
  id SERIAL PRIMARY KEY,
  order_id INTEGER REFERENCES orders(id),
  usage_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  energy_consumed INTEGER,
  transaction_hash VARCHAR(64),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 5.3 占费执行流程

**流程图：**

```
      定时任务启动
          ↓
  查询所有活跃笔数套餐订单
          ↓
  检查每个订单的最后使用时间
          ↓
    超过24小时未使用？
    ┌─────┴─────┐
    ↓           ↓
   是          否
    ↓           ↓
  获取占费配置   跳过此订单
    ↓           ↓
  扣除对应笔数    │
    ↓           │
remaining_transactions-1 │
    ↓           │
  记录占费日志    │
    ↓           │
  剩余笔数为0？   │
  ┌─────┴─────┐ │
  ↓           ↓ │
 是          否 │
  ↓           ↓ │
标记订单完成   继续监听
  ↓           ↓ │
发送通知给用户  │ │
  ↓           │ │
  └───────────┼─┘
              ↓
        处理下一个订单
```

**详细步骤说明：**

1. **定时任务启动** - 系统每日定时检查占费情况
2. **查询活跃订单** - 获取所有状态为processing的笔数套餐订单
3. **检查使用时间** - 查看每个订单的最后能量使用时间
4. **24小时判断**：

   * **是**：超过24小时未使用，执行占费流程

   * **否**：跳过此订单，继续检查下一个
5. **获取占费配置** - 从价格配置中获取daily\_fee设置
6. **扣除笔数** - 从remaining\_transactions中扣除占费笔数
7. **更新数据库** - 更新订单的剩余笔数字段
8. **记录日志** - 在占费日志表中记录此次扣费
9. **完成判断**：

   * **剩余为0**：标记订单完成，发送通知

   * **剩余>0**：继续监听该订单
10. **处理下一个** - 继续处理队列中的下一个订单

## 6. 技术架构设计

### 6.1 系统架构图

**架构图：**

```
┌─────────────────┐
│   Telegram Bot  │
└─────────┬───────┘
          ↓
┌─────────────────┐
│   订单创建服务   │ ──────┐
└─────────┬───────┘       │
          ↓               ↓
┌─────────────────┐   ┌───────────┐
│   支付监听服务   │   │ Orders表  │
└─────────┬───────┘   └───────────┘
          ↓
┌─────────────────┐
│  分批代理控制器  │ ──────┐
└─────────┬───────┘       │
          ↓               ↓
┌─────────────────┐   ┌───────────┐
│ 能量使用监听服务 │   │ 能量池账户 │
└─────────┬───────┘   └───────────┘
          ↓               ↑
┌─────────────────┐       │
│   占费检测服务   │ ──────┼──────┐
└─────────┬───────┘       │      │
          ↓               │      ↓
┌─────────────────┐   ┌───────────┐ ┌──────────────────┐
│     通知服务     │   │TRON网络   │ │Energy Usage Logs │
└─────────────────┘   └───────────┘ └──────────────────┘
                                              ↑
                      ┌───────────────────────┘
                      │
                  ┌───────────────┐
                  │Price Configs表│
                  └───────────────┘
```

**架构层次说明：**

**1. 应用服务层**

* **Telegram Bot** - 用户交互入口，处理消息和回调

* **订单创建服务** - 处理笔数套餐订单创建逻辑

* **支付监听服务** - 监听和验证用户支付交易

* **分批代理控制器** - 控制分批能量代理的执行

* **能量使用监听服务** - 实时监听用户能量使用情况

* **占费检测服务** - 执行24小时占费检测和扣除

* **通知服务** - 向用户发送各类通知消息

**2. 数据存储层**

* **Orders表** - 存储订单信息和笔数状态

* **Energy Usage Logs表** - 记录能量使用历史

* **Price Configs表** - 存储价格和占费配置

**3. 外部服务层**

* **TRON网络** - 获取地址能量状态和交易信息

* **能量池账户** - 执行能量代理操作的资源池

**4. 数据流向**

* 订单创建 → Orders表存储

* 分批代理 → 能量池账户执行

* 能量监听 → TRON网络查询

* 占费检测 → Energy Usage Logs记录

### 6.2 核心服务依赖

* **订单管理：** 基于现有 `OrderService` 扩展

* **能量代理：** 基于现有 `EnergyDelegationService` 扩展

* **TRON交互：** 使用现有 TRON API 服务

* **通知系统：** 基于现有 Telegram Bot 服务

## 7. 缺失功能清单

### 7.1 高优先级（核心功能）

#### 7.1.1 数据库扩展

* [ ] **订单表字段扩展**

  * `transaction_count` - 购买的总笔数

  * `used_transactions` - 已使用笔数

  * `remaining_transactions` - 剩余笔数

  * `last_energy_usage_time` - 最后使用能量时间

* [ ] **能量使用记录表**

  * 创建 `energy_usage_logs` 表

  * 记录每次能量使用详情

#### 7.1.2 核心业务服务

* [ ] **订单确认消息生成器**

  * 实现用户需求的订单确认消息格式

  * 支持金额复制、地址复制功能

  * 集成过期时间显示

* [ ] **分批代理控制器**

  * `BatchDelegationController` 服务

  * 单笔能量代理逻辑

  * 笔数状态更新机制

* [ ] **能量使用监听服务**

  * `EnergyUsageMonitorService` 服务

  * 实时监听用户地址能量变化

  * 自动触发下一笔代理

#### 7.1.3 占费机制

* [ ] **占费检测服务**

  * `DailyFeeService` 服务

  * 24小时使用检测逻辑

  * 自动扣费执行

* [ ] **定时任务调度**

  * 每日占费检查任务

  * 能量使用监听任务

### 7.2 中优先级（用户体验）

#### 7.2.1 用户界面优化

* [ ] **Telegram Bot 交互优化**

  * 地址输入验证提示

  * 订单状态实时推送

  * 笔数使用进度通知

* [ ] **管理后台功能**

  * 笔数套餐订单管理界面

  * 占费记录查询

  * 能量使用统计

#### 7.2.2 监控和日志

* [ ] **业务监控**

  * 分批代理成功率监控

  * 占费执行情况监控

  * 用户使用行为分析

* [ ] **异常处理**

  * 代理失败重试机制

  * 监听服务异常恢复

  * 用户通知失败处理

### 7.3 低优先级（扩展功能）

#### 7.3.1 高级功能

* [ ] **智能代理优化**

  * 根据用户使用模式预测代理时机

  * 动态调整单笔能量数量

  * 批量用户代理优化

* [ ] **数据分析**

  * 用户使用习惯分析

  * 占费率统计

  * 收益优化建议

## 8. 实施建议

### 8.1 开发阶段规划

**阶段一：核心功能实现（预计5-7天）**

1. 数据库表结构扩展
2. 订单确认消息生成器
3. 分批代理控制器基础版本
4. 简单的能量使用检测

**阶段二：监听和占费机制（预计3-5天）**

1. 完整的能量使用监听服务
2. 占费检测和执行服务
3. 定时任务调度系统

**阶段三：优化和完善（预计2-3天）**

1. 异常处理和重试机制
2. 用户通知优化
3. 管理后台界面

### 8.2 技术风险评估

**高风险项：**

* 能量使用监听的实时性和准确性

* 分批代理的时机控制

* 占费机制的公平性和准确性

**缓解措施：**

* 实施充分的测试环境验证

* 建立完善的日志和监控系统

* 设计回滚和手动干预机制

### 8.3 测试策略

**功能测试：**

* 完整的用户购买流程测试

* 分批代理机制测试

* 占费扣除准确性测试

**性能测试：**

* 大量并发订单处理能力

* 监听服务的资源消耗

* 数据库查询性能优化

**安全测试：**

* 地址验证安全性

* 支付确认防重放

* 占费扣除防误操作

## 9. 总结

笔数套餐功能具有完整的业务逻辑设计，当前系统已具备基础的订单管理和支付确认能力，但核心的分批代理机制和占费机制尚未实现。需要重点开发能量使用监听服务、分批代理控制器和占费检测服务，同时完善数据库结构以支持笔数追踪和使用记录。

建议采用分阶段实施策略，优先实现核心功能，确保基本业务流程可用，再逐步完善监控、优化和扩展功能。整个实施过程需要密切关注TRON网络的实时性和系统的稳定性，确保用户体验和资金安全。

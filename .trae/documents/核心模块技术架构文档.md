# TRONèƒ½é‡ç§Ÿèµç³»ç»Ÿ - æ ¸å¿ƒæ¨¡å—æŠ€æœ¯æ¶æ„æ–‡æ¡£

> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ¶æ„æ–‡æ¡£  
> **åˆ›å»ºæ—¥æœŸ**: 2024-12-19  
> **çŠ¶æ€**: ğŸš¨ ç´§æ€¥å¼€å‘  
> **æŠ€æœ¯è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  

## 1. æ¶æ„è®¾è®¡

### 1.1 æ•´ä½“ç³»ç»Ÿæ¶æ„

```mermaid
graph TD
    A[Telegramç”¨æˆ·] --> B[Telegram Bot API]
    B --> C[æœºå™¨äººæœåŠ¡å±‚]
    C --> D[ä¸šåŠ¡é€»è¾‘å±‚]
    D --> E[æ•°æ®è®¿é—®å±‚]
    
    subgraph "æ ¸å¿ƒæœåŠ¡æ¨¡å—"
        F[è®¢å•ç®¡ç†æœåŠ¡]
        G[æ”¯ä»˜ç›‘æ§æœåŠ¡]
        H[èƒ½é‡æ± ç®¡ç†æœåŠ¡]
        I[TRONåŒºå—é“¾æœåŠ¡]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        J[TRONç½‘ç»œ]
        K[TronGrid API]
    end
    
    subgraph "æ•°æ®å­˜å‚¨å±‚"
        L[PostgreSQLæ•°æ®åº“]
        M[Redisç¼“å­˜]
    end
    
    C --> F
    C --> G
    F --> H
    F --> I
    G --> I
    H --> I
    I --> J
    I --> K
    
    F --> L
    G --> L
    H --> L
    I --> L
    C --> M
    H --> M
```

### 1.2 å¾®æœåŠ¡æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[API Gateway] --> B[Telegram Bot Service]
    A --> C[Order Management Service]
    A --> D[Payment Service]
    A --> E[Energy Pool Service]
    A --> F[TRON Blockchain Service]
    
    B --> G[Message Queue]
    C --> G
    D --> G
    E --> G
    F --> G
    
    G --> H[Event Bus]
    H --> I[Notification Service]
    H --> J[Monitoring Service]
    
    subgraph "æ•°æ®å±‚"
        K[Orders DB]
        L[Users DB]
        M[Energy Pools DB]
        N[Transactions DB]
        O[Redis Cache]
    end
    
    C --> K
    B --> L
    E --> M
    F --> N
    B --> O
    E --> O
```

## 2. æŠ€æœ¯æ ˆæè¿°

### 2.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **å‰ç«¯**: æ—  (çº¯Telegramæœºå™¨äººäº¤äº’)
- **åç«¯**: Node.js + Express.js + TypeScript
- **æ•°æ®åº“**: PostgreSQL (ä¸»æ•°æ®åº“) + Redis (ç¼“å­˜å’Œä¼šè¯)
- **åŒºå—é“¾**: TronWeb SDK + TronGrid API
- **æ¶ˆæ¯é˜Ÿåˆ—**: Redis Pub/Sub + Bull Queue
- **ç›‘æ§**: è‡ªç ”ç›‘æ§ç³»ç»Ÿ + Winstonæ—¥å¿—

### 2.2 å…³é”®ä¾èµ–åŒ…

```json
{
  "dependencies": {
    "express": "^4.18.2",
    "node-telegram-bot-api": "^0.64.0",
    "tronweb": "^5.3.2",
    "pg": "^8.11.3",
    "redis": "^4.6.10",
    "bull": "^4.12.2",
    "winston": "^3.11.0",
    "crypto": "^1.0.1",
    "joi": "^17.11.0",
    "jsonwebtoken": "^9.0.2"
  }
}
```

## 3. è·¯ç”±å®šä¹‰

### 3.1 Telegramæœºå™¨äººè·¯ç”±

| è·¯ç”±ç±»å‹ | è·¯å¾„/å‘½ä»¤ | åŠŸèƒ½æè¿° |
|----------|-----------|----------|
| Webhook | /webhook/telegram | æ¥æ”¶Telegramæ¶ˆæ¯ |
| Command | /start | æœºå™¨äººå¯åŠ¨å’Œç”¨æˆ·æ³¨å†Œ |
| Command | /menu | æ˜¾ç¤ºä¸»èœå• |
| Command | /help | å¸®åŠ©ä¿¡æ¯ |
| Command | /balance | æŸ¥è¯¢ä½™é¢ |
| Command | /orders | è®¢å•å†å² |
| Callback | energy_package_* | èƒ½é‡åŒ…é€‰æ‹©å›è°ƒ |
| Callback | confirm_order_* | è®¢å•ç¡®è®¤å›è°ƒ |
| Callback | check_payment_* | æ”¯ä»˜çŠ¶æ€æ£€æŸ¥ |

### 3.2 å†…éƒ¨APIè·¯ç”±

| è·¯ç”± | æ–¹æ³• | åŠŸèƒ½æè¿° |
|------|------|----------|
| /api/orders | POST | åˆ›å»ºè®¢å• |
| /api/orders/:id | GET | è·å–è®¢å•è¯¦æƒ… |
| /api/orders/:id/payment | POST | å¤„ç†æ”¯ä»˜ |
| /api/energy-pools | GET | è·å–èƒ½é‡æ± çŠ¶æ€ |
| /api/energy-pools/allocate | POST | åˆ†é…èƒ½é‡æ±  |
| /api/tron/delegate | POST | æ‰§è¡Œèƒ½é‡å§”æ‰˜ |
| /api/tron/balance/:address | GET | æŸ¥è¯¢åœ°å€ä½™é¢ |
| /api/payments/monitor | POST | å¯åŠ¨æ”¯ä»˜ç›‘æ§ |

## 4. APIå®šä¹‰

### 4.1 Telegramæœºå™¨äººAPI

#### ç”¨æˆ·æ³¨å†Œ
```typescript
interface TelegramUser {
  id: number;
  username?: string;
  first_name: string;
  last_name?: string;
  language_code?: string;
}

interface UserRegistration {
  telegram_id: number;
  username?: string;
  first_name: string;
  created_at: Date;
}
```

#### è®¢å•åˆ›å»º
```typescript
interface OrderRequest {
  user_id: string;
  energy_package_id: string;
  quantity: number;
  recipient_address: string;
}

interface OrderResponse {
  order_id: string;
  total_amount: number;
  payment_address: string;
  expires_at: Date;
}
```

### 4.2 TRONåŒºå—é“¾API

#### èƒ½é‡å§”æ‰˜
```typescript
interface DelegateEnergyRequest {
  from_address: string;
  to_address: string;
  amount: number;
  private_key: string;
}

interface DelegateEnergyResponse {
  transaction_id: string;
  status: 'pending' | 'confirmed' | 'failed';
  block_number?: number;
  energy_delegated: number;
}
```

#### ä½™é¢æŸ¥è¯¢
```typescript
interface BalanceQuery {
  address: string;
}

interface BalanceResponse {
  trx_balance: number;
  energy: number;
  bandwidth: number;
  delegated_energy: number;
}
```

### 4.3 èƒ½é‡æ± ç®¡ç†API

#### æ± çŠ¶æ€æŸ¥è¯¢
```typescript
interface EnergyPoolStatus {
  pool_id: string;
  name: string;
  total_energy: number;
  available_energy: number;
  reserved_energy: number;
  utilization_rate: number;
  status: 'active' | 'inactive' | 'maintenance';
}
```

#### èƒ½é‡åˆ†é…
```typescript
interface EnergyAllocationRequest {
  required_energy: number;
  recipient_address: string;
  priority: 'low' | 'normal' | 'high';
}

interface EnergyAllocationResponse {
  allocated_pools: {
    pool_id: string;
    allocated_energy: number;
    estimated_cost: number;
  }[];
  total_cost: number;
  estimated_completion_time: Date;
}
```

### 4.4 æ”¯ä»˜ç›‘æ§API

#### æ”¯ä»˜ç›‘æ§å¯åŠ¨
```typescript
interface PaymentMonitorRequest {
  order_id: string;
  payment_address: string;
  expected_amount: number;
  timeout_minutes: number;
}

interface PaymentMonitorResponse {
  monitor_id: string;
  status: 'monitoring' | 'completed' | 'timeout';
  confirmed_amount?: number;
  transaction_hash?: string;
}
```

## 5. æœåŠ¡å™¨æ¶æ„å›¾

### 5.1 æœåŠ¡åˆ†å±‚æ¶æ„

```mermaid
graph TD
    A[Presentation Layer] --> B[Business Logic Layer]
    B --> C[Data Access Layer]
    C --> D[Database Layer]
    
    subgraph "Presentation Layer"
        E[Telegram Bot Handler]
        F[Webhook Controller]
        G[API Controller]
    end
    
    subgraph "Business Logic Layer"
        H[Order Service]
        I[Payment Service]
        J[Energy Pool Service]
        K[TRON Service]
        L[User Service]
    end
    
    subgraph "Data Access Layer"
        M[Order Repository]
        N[User Repository]
        O[Energy Pool Repository]
        P[Transaction Repository]
    end
    
    subgraph "Database Layer"
        Q[PostgreSQL]
        R[Redis]
    end
    
    E --> H
    E --> L
    F --> H
    F --> I
    G --> J
    G --> K
    
    H --> M
    I --> P
    J --> O
    L --> N
    
    M --> Q
    N --> Q
    O --> Q
    P --> Q
    
    H --> R
    I --> R
    J --> R
```

### 5.2 æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„

```mermaid
graph TD
    A[Telegram Bot] --> B[Message Queue]
    C[Payment Monitor] --> B
    D[Energy Pool Manager] --> B
    
    B --> E[Order Processing Worker]
    B --> F[Payment Processing Worker]
    B --> G[Energy Delegation Worker]
    B --> H[Notification Worker]
    
    E --> I[Order Service]
    F --> J[Payment Service]
    G --> K[TRON Service]
    H --> L[Notification Service]
    
    subgraph "Queue Types"
        M[High Priority Queue]
        N[Normal Priority Queue]
        O[Low Priority Queue]
        P[Dead Letter Queue]
    end
    
    B --> M
    B --> N
    B --> O
    B --> P
```

## 6. æ•°æ®æ¨¡å‹

### 6.1 æ•°æ®æ¨¡å‹å®šä¹‰

```mermaid
erDiagram
    users ||--o{ orders : places
    users ||--o{ agents : becomes
    users ||--o{ agent_applications : applies
    users ||--o{ bot_users : uses
    orders ||--o{ energy_transactions : generates
    orders ||--o{ agent_earnings : earns
    energy_pools ||--o{ energy_transactions : provides
    energy_packages ||--o{ orders : selected
    bots ||--o{ bot_users : serves
    bots ||--o{ orders : processes
    bots ||--o{ price_configs : configures
    agents ||--o{ agent_earnings : receives
    agents ||--o{ agents : manages
    price_configs ||--o{ price_history : tracks
    price_templates ||--o{ price_configs : templates
    system_configs ||--o{ system_config_history : tracks
    
    users {
        uuid id PK
        bigint telegram_id UK
        varchar username
        varchar email UK
        varchar phone
        varchar role
        varchar status
        varchar tron_address
        numeric balance
        integer total_orders
        numeric total_spent
        bigint total_energy_used
        varchar referral_code UK
        uuid referred_by FK
        varchar login_type
        numeric usdt_balance
        numeric trx_balance
        timestamp created_at
        timestamp updated_at
    }
    
    orders {
        uuid id PK
        uuid user_id FK
        uuid bot_id FK
        uuid package_id FK
        varchar order_number UK
        varchar order_type
        varchar currency
        varchar payment_status
        varchar status
        bigint energy_amount
        integer duration_hours
        numeric price
        numeric original_price
        numeric discount_amount
        numeric final_price
        varchar payment_method
        varchar transaction_id
        varchar tron_tx_hash
        varchar delegate_tx_hash
        varchar target_address
        timestamp expires_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    energy_pools {
        uuid id PK
        varchar name
        varchar tron_address UK
        text private_key_encrypted
        bigint total_energy
        bigint available_energy
        bigint delegated_energy
        numeric trx_balance
        varchar status
        integer priority
        numeric cost_per_energy
        bigint max_delegation_amount
        bigint min_delegation_amount
        bigint daily_limit
        bigint used_today
        timestamp last_used_at
        timestamp created_at
        timestamp updated_at
    }
    
    bots {
        uuid id PK
        varchar name
        varchar token UK
        varchar username UK
        text description
        varchar status
        varchar webhook_url
        varchar webhook_secret
        jsonb settings
        jsonb commands
        text welcome_message
        text help_message
        text error_message
        boolean maintenance_mode
        integer rate_limit
        integer max_users
        integer current_users
        bigint total_messages
        timestamp last_message_at
        timestamp created_at
        timestamp updated_at
    }
    
    agents {
        uuid id PK
        uuid user_id FK UK
        varchar agent_code UK
        integer level
        numeric commission_rate
        uuid parent_agent_id FK
        varchar status
        uuid approved_by FK
        timestamp approved_at
        integer total_referrals
        numeric total_earnings
        numeric available_balance
        numeric withdrawn_amount
        timestamp last_settlement_at
        timestamp created_at
        timestamp updated_at
    }
    
    agent_applications {
        uuid id PK
        uuid user_id FK
        varchar application_type
        jsonb business_info
        jsonb contact_info
        text experience
        numeric expected_volume
        varchar status
        uuid reviewed_by FK
        timestamp reviewed_at
        text review_notes
        timestamp created_at
        timestamp updated_at
    }
    
    agent_earnings {
        uuid id PK
        uuid agent_id FK
        uuid order_id FK
        varchar earning_type
        numeric amount
        numeric commission_rate
        numeric base_amount
        varchar currency
        varchar status
        timestamp settled_at
        varchar settlement_tx_id
        timestamp created_at
        timestamp updated_at
    }
    
    bot_users {
        uuid id PK
        uuid user_id FK
        uuid bot_id FK
        bigint telegram_chat_id
        varchar status
        timestamp first_interaction_at
        timestamp last_interaction_at
        integer total_messages
        jsonb preferences
        timestamp created_at
        timestamp updated_at
    }
    
    energy_packages {
        uuid id PK
        varchar name
        text description
        bigint energy_amount
        integer duration_hours
        numeric base_price
        varchar currency
        bigint min_order_amount
        bigint max_order_amount
        boolean is_active
        integer sort_order
        jsonb tags
        timestamp created_at
        timestamp updated_at
    }
    
    energy_transactions {
        uuid id PK
        uuid order_id FK
        uuid pool_id FK
        varchar transaction_type
        varchar from_address
        varchar to_address
        bigint energy_amount
        integer duration_hours
        varchar tx_hash
        bigint block_number
        timestamp block_timestamp
        bigint gas_used
        varchar status
        text error_message
        integer retry_count
        timestamp expires_at
        timestamp created_at
        timestamp updated_at
    }
    
    price_configs {
        uuid id PK
        uuid bot_id FK
        uuid package_id FK
        varchar config_name
        numeric base_price
        numeric markup_percentage
        numeric markup_fixed
        numeric min_price
        numeric max_price
        varchar currency
        boolean is_active
        integer priority
        jsonb conditions
        timestamp created_at
        timestamp updated_at
    }
    
    price_history {
        uuid id PK
        uuid config_id FK
        varchar change_type
        jsonb old_value
        jsonb new_value
        uuid changed_by FK
        text change_reason
        timestamp created_at
    }
    
    price_templates {
        uuid id PK
        varchar name
        text description
        varchar template_type
        jsonb config_data
        boolean is_system
        boolean is_active
        integer usage_count
        uuid created_by FK
        timestamp created_at
        timestamp updated_at
    }
    
    system_configs {
        uuid id PK
        varchar config_key UK
        text config_value
        varchar config_type
        varchar category
        text description
        boolean is_encrypted
        boolean is_public
        text validation_rule
        text default_value
        timestamp created_at
        timestamp updated_at
    }
    
    system_config_history {
        uuid id PK
        uuid config_id FK
        text old_value
        text new_value
        uuid changed_by FK
        text change_reason
        timestamp created_at
    }
    
    schema_migrations {
        varchar version PK
        boolean dirty
    }
```

### 6.2 æ•°æ®å®šä¹‰è¯­è¨€

#### ç”¨æˆ·ä¿¡æ¯è¡¨
```sql
-- ç”¨æˆ·ä¿¡æ¯è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_id BIGINT UNIQUE,
    username VARCHAR(50),
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    tron_address VARCHAR(50),
    balance NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    total_orders INTEGER NOT NULL DEFAULT 0,
    total_spent NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    total_energy_used BIGINT DEFAULT 0,
    referral_code VARCHAR(50) UNIQUE,
    referred_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    password_hash VARCHAR(255),
    login_type VARCHAR(20) DEFAULT 'telegram',
    last_login_at TIMESTAMP,
    password_reset_token VARCHAR(255),
    password_reset_expires TIMESTAMP,
    usdt_balance NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    trx_balance NUMERIC(20,8) NOT NULL DEFAULT 0.00000000
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_telegram_id ON users(telegram_id);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_login_type ON users(login_type);
CREATE INDEX idx_users_referral_code ON users(referral_code);
CREATE INDEX idx_users_usdt_balance ON users(usdt_balance);
CREATE INDEX idx_users_trx_balance ON users(trx_balance);
CREATE INDEX idx_users_password_reset_token ON users(password_reset_token) WHERE password_reset_token IS NOT NULL;
```

#### è®¢å•ä¿¡æ¯è¡¨
```sql
-- è®¢å•ä¿¡æ¯è¡¨
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    bot_id UUID REFERENCES bots(id),
    package_id UUID REFERENCES energy_packages(id),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    order_type VARCHAR(20) NOT NULL DEFAULT 'energy_rental',
    currency VARCHAR(10) NOT NULL DEFAULT 'USDT',
    payment_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    energy_amount BIGINT NOT NULL,
    duration_hours INTEGER NOT NULL,
    price NUMERIC(20,8) NOT NULL,
    original_price NUMERIC(20,8),
    discount_amount NUMERIC(20,8) DEFAULT 0.00000000,
    final_price NUMERIC(20,8) NOT NULL,
    payment_method VARCHAR(20),
    transaction_id VARCHAR(100),
    tron_tx_hash VARCHAR(100),
    delegate_tx_hash VARCHAR(100),
    target_address VARCHAR(50),
    expires_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT orders_energy_amount_check CHECK (energy_amount > 0),
    CONSTRAINT orders_duration_hours_check CHECK (duration_hours > 0),
    CONSTRAINT orders_price_check CHECK (price >= 0),
    CONSTRAINT orders_final_price_check CHECK (final_price >= 0)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_payment_status ON orders(payment_status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_order_number ON orders(order_number);
CREATE INDEX idx_orders_transaction_id ON orders(transaction_id);
CREATE INDEX idx_orders_tron_tx_hash ON orders(tron_tx_hash);
```

#### èƒ½é‡æ± ç®¡ç†è¡¨
```sql
-- èƒ½é‡æ± ç®¡ç†è¡¨
CREATE TABLE energy_pools (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    tron_address VARCHAR(50) UNIQUE NOT NULL,
    private_key_encrypted TEXT NOT NULL,
    total_energy BIGINT NOT NULL DEFAULT 0,
    available_energy BIGINT NOT NULL DEFAULT 0,
    delegated_energy BIGINT NOT NULL DEFAULT 0,
    trx_balance NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    priority INTEGER NOT NULL DEFAULT 1,
    cost_per_energy NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    max_delegation_amount BIGINT,
    min_delegation_amount BIGINT,
    daily_limit BIGINT,
    used_today BIGINT NOT NULL DEFAULT 0,
    last_used_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT energy_pools_total_energy_check CHECK (total_energy >= 0),
    CONSTRAINT energy_pools_available_energy_check CHECK (available_energy >= 0),
    CONSTRAINT energy_pools_delegated_energy_check CHECK (delegated_energy >= 0),
    CONSTRAINT energy_pools_priority_check CHECK (priority > 0)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_energy_pools_status ON energy_pools(status);
CREATE INDEX idx_energy_pools_priority ON energy_pools(priority);
CREATE INDEX idx_energy_pools_available_energy ON energy_pools(available_energy);
```

#### æœºå™¨äººé…ç½®è¡¨
```sql
-- æœºå™¨äººé…ç½®è¡¨
CREATE TABLE bots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    token VARCHAR(200) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    webhook_url VARCHAR(500),
    webhook_secret VARCHAR(100),
    settings JSONB DEFAULT '{}',
    commands JSONB DEFAULT '[]',
    welcome_message TEXT,
    help_message TEXT,
    error_message TEXT,
    maintenance_mode BOOLEAN NOT NULL DEFAULT false,
    rate_limit INTEGER NOT NULL DEFAULT 30,
    max_users INTEGER,
    current_users INTEGER NOT NULL DEFAULT 0,
    total_messages BIGINT NOT NULL DEFAULT 0,
    last_message_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_bots_status ON bots(status);
CREATE INDEX idx_bots_username ON bots(username);
```

#### èƒ½é‡äº¤æ˜“è®°å½•è¡¨
```sql
-- èƒ½é‡äº¤æ˜“è®°å½•è¡¨
CREATE TABLE energy_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id),
    pool_id UUID NOT NULL REFERENCES energy_pools(id),
    transaction_type VARCHAR(20) NOT NULL DEFAULT 'delegate',
    from_address VARCHAR(50) NOT NULL,
    to_address VARCHAR(50) NOT NULL,
    energy_amount BIGINT NOT NULL,
    duration_hours INTEGER NOT NULL,
    tx_hash VARCHAR(100),
    block_number BIGINT,
    block_timestamp TIMESTAMP WITH TIME ZONE,
    gas_used BIGINT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    error_message TEXT,
    retry_count INTEGER NOT NULL DEFAULT 0,
    expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_energy_transactions_order_id ON energy_transactions(order_id);
CREATE INDEX idx_energy_transactions_pool_id ON energy_transactions(pool_id);
CREATE INDEX idx_energy_transactions_tx_hash ON energy_transactions(tx_hash);
CREATE INDEX idx_energy_transactions_status ON energy_transactions(status);
CREATE INDEX idx_energy_transactions_created_at ON energy_transactions(created_at);
```

#### ç³»ç»Ÿé…ç½®è¡¨
```sql
-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE system_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    config_type VARCHAR(20) NOT NULL DEFAULT 'string',
    category VARCHAR(50) NOT NULL DEFAULT 'general',
    description TEXT,
    is_encrypted BOOLEAN NOT NULL DEFAULT false,
    is_public BOOLEAN NOT NULL DEFAULT false,
    validation_rule TEXT,
    default_value TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_system_configs_category ON system_configs(category);
CREATE INDEX idx_system_configs_config_type ON system_configs(config_type);
CREATE INDEX idx_system_configs_is_public ON system_configs(is_public);
```

## 7. å…³é”®æŠ€æœ¯å®ç°

### 7.1 Telegramæœºå™¨äººçŠ¶æ€ç®¡ç†

```typescript
// ç”¨æˆ·çŠ¶æ€ç®¡ç†
class TelegramSessionManager {
  private redis: Redis;
  
  async getUserState(telegramId: number): Promise<UserState> {
    const sessionKey = `telegram:session:${telegramId}`;
    const sessionData = await this.redis.get(sessionKey);
    return sessionData ? JSON.parse(sessionData) : { state: 'idle' };
  }
  
  async updateUserState(telegramId: number, state: UserState): Promise<void> {
    const sessionKey = `telegram:session:${telegramId}`;
    await this.redis.setex(sessionKey, 3600, JSON.stringify(state));
  }
}

// æ¶ˆæ¯å¤„ç†è·¯ç”±
class MessageRouter {
  async handleMessage(message: TelegramMessage): Promise<void> {
    const userState = await this.sessionManager.getUserState(message.from.id);
    
    switch (userState.state) {
      case 'idle':
        return this.handleIdleState(message);
      case 'selecting_package':
        return this.handlePackageSelection(message);
      case 'entering_address':
        return this.handleAddressInput(message);
      case 'confirming_order':
        return this.handleOrderConfirmation(message);
      default:
        return this.handleUnknownState(message);
    }
  }
}
```

### 7.2 TRONåŒºå—é“¾é›†æˆ

```typescript
// TronWebé…ç½®å’Œè¿æ¥ç®¡ç†
class TronService {
  private tronWeb: TronWeb;
  private connectionPool: TronWeb[];
  
  constructor() {
    this.initializeTronWeb();
    this.setupConnectionPool();
  }
  
  private initializeTronWeb(): void {
    this.tronWeb = new TronWeb({
      fullHost: 'https://api.shasta.trongrid.io',
      headers: { 'TRON-PRO-API-KEY': process.env.TRON_API_KEY },
      privateKey: process.env.MASTER_PRIVATE_KEY
    });
  }
  
  async delegateEnergy(params: DelegateEnergyParams): Promise<DelegateResult> {
    try {
      const transaction = await this.tronWeb.transactionBuilder.delegateResource(
        params.amount,
        params.toAddress,
        'ENERGY',
        params.fromAddress
      );
      
      const signedTx = await this.tronWeb.trx.sign(transaction, params.privateKey);
      const result = await this.tronWeb.trx.sendRawTransaction(signedTx);
      
      return {
        transactionId: result.txid,
        status: 'pending',
        energyDelegated: params.amount
      };
    } catch (error) {
      throw new TronServiceError(`èƒ½é‡å§”æ‰˜å¤±è´¥: ${error.message}`);
    }
  }
}
```

### 7.3 èƒ½é‡æ± ç®¡ç†ç®—æ³•

```typescript
// èƒ½é‡æ± è°ƒåº¦ç®—æ³•
class EnergyPoolScheduler {
  async allocateOptimalPools(requirement: EnergyRequirement): Promise<AllocationResult> {
    const availablePools = await this.getAvailablePools();
    const sortedPools = this.sortPoolsByCostEfficiency(availablePools);
    
    const allocation: PoolAllocation[] = [];
    let remainingEnergy = requirement.energyAmount;
    
    for (const pool of sortedPools) {
      if (remainingEnergy <= 0) break;
      
      const allocatedEnergy = Math.min(remainingEnergy, pool.availableEnergy);
      if (allocatedEnergy > 0) {
        allocation.push({
          poolId: pool.id,
          allocatedEnergy,
          estimatedCost: allocatedEnergy * pool.costPerEnergy
        });
        remainingEnergy -= allocatedEnergy;
      }
    }
    
    if (remainingEnergy > 0) {
      throw new InsufficientEnergyError('å¯ç”¨èƒ½é‡ä¸è¶³');
    }
    
    return {
      allocations: allocation,
      totalCost: allocation.reduce((sum, a) => sum + a.estimatedCost, 0)
    };
  }
  
  private sortPoolsByCostEfficiency(pools: EnergyPool[]): EnergyPool[] {
    return pools.sort((a, b) => {
      // ç»¼åˆè€ƒè™‘æˆæœ¬ã€å¯ç”¨æ€§å’Œå¯é æ€§
      const scoreA = this.calculatePoolScore(a);
      const scoreB = this.calculatePoolScore(b);
      return scoreB - scoreA; // é™åºæ’åˆ—
    });
  }
}
```

### 7.4 æ”¯ä»˜ç›‘æ§ç³»ç»Ÿ

```typescript
// æ”¯ä»˜ç›‘æ§æœåŠ¡
class PaymentMonitorService {
  private monitoringJobs = new Map<string, NodeJS.Timeout>();
  
  async startMonitoring(params: PaymentMonitorParams): Promise<void> {
    const monitorId = `payment:${params.orderId}`;
    
    // å¯åŠ¨å®šæ—¶æ£€æŸ¥
    const intervalId = setInterval(async () => {
      await this.checkPaymentStatus(params);
    }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    
    this.monitoringJobs.set(monitorId, intervalId);
    
    // è®¾ç½®è¶…æ—¶
    setTimeout(() => {
      this.handlePaymentTimeout(params.orderId);
    }, params.timeoutMinutes * 60 * 1000);
  }
  
  private async checkPaymentStatus(params: PaymentMonitorParams): Promise<void> {
    try {
      const transactions = await this.tronService.getAddressTransactions(
        params.paymentAddress
      );
      
      for (const tx of transactions) {
        if (tx.value >= params.expectedAmount && tx.confirmations >= 19) {
          await this.confirmPayment(params.orderId, tx);
          this.stopMonitoring(params.orderId);
          break;
        }
      }
    } catch (error) {
      console.error('æ”¯ä»˜æ£€æŸ¥å¤±è´¥:', error);
    }
  }
}
```

## 8. éƒ¨ç½²å’Œè¿ç»´

### 8.1 Dockerå®¹å™¨åŒ–

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

### 8.2 ç¯å¢ƒé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/tron_energy
      - REDIS_URL=redis://redis:6379
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TRON_API_KEY=${TRON_API_KEY}
    depends_on:
      - db
      - redis
  
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=tron_energy
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

---

**æ–‡æ¡£ç»´æŠ¤**: æŠ€æœ¯å›¢é˜Ÿ  
**æ›´æ–°é¢‘ç‡**: æ¯æ¬¡æ¶æ„å˜æ›´åæ›´æ–°  
**æŠ€æœ¯æ”¯æŒ**: å¼€å‘å›¢é˜Ÿè´Ÿè´£äºº
# ğŸš€ TRONèƒ½é‡ç§Ÿèµç³»ç»Ÿ - å®å¡”é¢æ¿éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [æœåŠ¡å™¨è¦æ±‚](#æœåŠ¡å™¨è¦æ±‚)
2. [å®å¡”é¢æ¿åŸºç¡€é…ç½®](#å®å¡”é¢æ¿åŸºç¡€é…ç½®)
3. [ç¯å¢ƒä¾èµ–å®‰è£…](#ç¯å¢ƒä¾èµ–å®‰è£…)
4. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
5. [é¡¹ç›®éƒ¨ç½²](#é¡¹ç›®éƒ¨ç½²)
6. [Nginxé…ç½®](#nginxé…ç½®)
7. [è¿›ç¨‹ç®¡ç†](#è¿›ç¨‹ç®¡ç†)
8. [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
9. [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
10. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ–¥ï¸ æœåŠ¡å™¨è¦æ±‚

### æœ€ä½é…ç½®
- **CPU**: 2æ ¸
- **å†…å­˜**: 4GB RAM
- **å­˜å‚¨**: 40GB SSD
- **å¸¦å®½**: 5Mbps

### æ¨èé…ç½®
- **CPU**: 4æ ¸ä»¥ä¸Š
- **å†…å­˜**: 8GB RAMä»¥ä¸Š
- **å­˜å‚¨**: 100GB SSDä»¥ä¸Š
- **å¸¦å®½**: 10Mbpsä»¥ä¸Š

### æ“ä½œç³»ç»Ÿ
- Ubuntu 20.04 LTS æˆ–æ›´é«˜ç‰ˆæœ¬
- CentOS 7/8
- Debian 10/11

---

## ğŸ› ï¸ å®å¡”é¢æ¿åŸºç¡€é…ç½®

### 1. å®‰è£…å®å¡”é¢æ¿

```bash
# Ubuntu/Debian
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec

# CentOS
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

### 2. åˆå§‹é…ç½®
- ç™»å½•å®å¡”é¢æ¿
- å®‰è£…æ¨èçš„LNMPå¥—ä»¶
- é…ç½®å®‰å…¨è®¾ç½®ï¼ˆä¿®æ”¹é»˜è®¤ç«¯å£ã€è®¾ç½®å¤æ‚å¯†ç ï¼‰

---

## ğŸ“¦ ç¯å¢ƒä¾èµ–å®‰è£…

### 1. åœ¨å®å¡”é¢æ¿å®‰è£…ä»¥ä¸‹ç»„ä»¶ï¼š

#### å¿…éœ€ç»„ä»¶
- âœ… **Nginx** (1.20+)
- âœ… **PostgreSQL** (13+)
- âœ… **Redis** (6.0+)
- âœ… **Node.js** (18+)
- âœ… **PM2** (è¿›ç¨‹ç®¡ç†å™¨)

#### å®‰è£…æ­¥éª¤
1. è¿›å…¥å®å¡”é¢æ¿ â†’ **è½¯ä»¶å•†åº—**
2. é€ä¸€å®‰è£…ä¸Šè¿°ç»„ä»¶
3. ç­‰å¾…å®‰è£…å®Œæˆ

### 2. Node.js ç‰ˆæœ¬ç®¡ç†
```bash
# å®‰è£…nvm (å¦‚æœå®å¡”è‡ªå¸¦çš„Node.jsç‰ˆæœ¬ä¸å¤Ÿ)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# å®‰è£…Node.js 18+
nvm install 18
nvm use 18
nvm alias default 18

# å®‰è£…pnpm
npm install -g pnpm pm2
```

---

## ğŸ—„ï¸ æ•°æ®åº“é…ç½®

### 1. PostgreSQLé…ç½®

#### åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
```sql
-- è¿æ¥åˆ°PostgreSQL
sudo -u postgres psql

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE tron_energy_rental;

-- åˆ›å»ºç”¨æˆ·
CREATE USER tron_user WITH PASSWORD 'your_secure_password';

-- æˆæƒ
GRANT ALL PRIVILEGES ON DATABASE tron_energy_rental TO tron_user;
ALTER DATABASE tron_energy_rental OWNER TO tron_user;

-- é€€å‡º
\q
```

#### é…ç½®PostgreSQL
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/postgresql/13/main/postgresql.conf

# ä¿®æ”¹ä»¥ä¸‹é…ç½®
listen_addresses = 'localhost'
port = 5432
max_connections = 200
shared_buffers = 256MB
```

#### é…ç½®è®¿é—®æƒé™
```bash
# ç¼–è¾‘pg_hba.conf
sudo nano /etc/postgresql/13/main/pg_hba.conf

# æ·»åŠ æœ¬åœ°è¿æ¥æƒé™
local   all             tron_user                               md5
host    all             tron_user       127.0.0.1/32            md5
```

#### é‡å¯PostgreSQL
```bash
sudo systemctl restart postgresql
```

### 2. Redisé…ç½®
```bash
# ç¼–è¾‘Redisé…ç½®
sudo nano /etc/redis/redis.conf

# ä¿®æ”¹é…ç½®
bind 127.0.0.1
port 6379
# å¯é€‰ï¼šè®¾ç½®å¯†ç 
# requirepass your_redis_password

# é‡å¯Redis
sudo systemctl restart redis-server
```

---

## ğŸš€ é¡¹ç›®éƒ¨ç½²

### 1. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
```bash
# åœ¨æœåŠ¡å™¨åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /www/wwwroot/tron-energy-rental
cd /www/wwwroot/tron-energy-rental

# ä¸Šä¼ é¡¹ç›®æ–‡ä»¶ (å¯é€šè¿‡å®å¡”æ–‡ä»¶ç®¡ç†å™¨ã€scpã€gitç­‰æ–¹å¼)
# æ–¹å¼1: Gitå…‹éš† (æ¨è)
git clone [ä½ çš„ä»“åº“åœ°å€] .

# æ–¹å¼2: å®å¡”æ–‡ä»¶ç®¡ç†å™¨ä¸Šä¼ zipåŒ…åè§£å‹
```

### 2. å®‰è£…ä¾èµ–
```bash
cd /www/wwwroot/tron-energy-rental

# å®‰è£…ä¾èµ–
pnpm install

# æ„å»ºå‰ç«¯
pnpm run build
```

### 3. ç¯å¢ƒé…ç½®
```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
cp .env .env.production

# ç¼–è¾‘ç”Ÿäº§ç¯å¢ƒé…ç½®
nano .env.production
```

#### ç”Ÿäº§ç¯å¢ƒé…ç½® (.env.production)
```env
# åŸºç¡€ç¯å¢ƒ
NODE_ENV=production

# å‰ç«¯é…ç½®
VITE_VUE_DEVTOOLS=false
VITE_PORT=5173
VITE_HOST=0.0.0.0
VITE_API_URL=https://yourdomain.com
VITE_ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# åç«¯é…ç½®
PORT=3001
HOST_ADDRESS=127.0.0.1

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://tron_user:your_secure_password@localhost:5432/tron_energy_rental
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy_rental
DB_USER=tron_user
DB_PASSWORD=your_secure_password

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# å®‰å…¨é…ç½® (å¿…é¡»ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²)
JWT_SECRET=your-super-secret-jwt-key-at-least-32-characters-long
SESSION_SECRET=your-session-secret-change-this
CSRF_SECRET=your-csrf-secret-change-this
ADMIN_PASSWORD=change-this-admin-password

# ç³»ç»Ÿé…ç½®
ADMIN_EMAIL=admin@yourdomain.com
LOG_LEVEL=info
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX_REQUESTS=50
```

### 4. æ•°æ®åº“åˆå§‹åŒ–
```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm run migrate

# å¦‚æœéœ€è¦åˆå§‹åŒ–æ•°æ®
pnpm run db:setup
```

---

## ğŸŒ Nginxé…ç½®

### 1. åˆ›å»ºç«™ç‚¹é…ç½®
åœ¨å®å¡”é¢æ¿ä¸­ï¼š
1. è¿›å…¥ **ç½‘ç«™** â†’ **æ·»åŠ ç«™ç‚¹**
2. åŸŸåï¼š`yourdomain.com`
3. ç›®å½•ï¼š`/www/wwwroot/tron-energy-rental/dist`

### 2. Nginxé…ç½®æ–‡ä»¶
```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSLé…ç½® (é€šè¿‡å®å¡”é¢æ¿ç”³è¯·è¯ä¹¦)
    ssl_certificate /www/server/panel/vhost/cert/yourdomain.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/yourdomain.com/privkey.pem;
    
    # å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_prefer_server_ciphers on;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # å¼ºåˆ¶HTTPS
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /www/wwwroot/tron-energy-rental/dist;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜é…ç½®
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # APIä»£ç†
    location /api {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # æ–‡ä»¶ä¸Šä¼ ä»£ç†
    location /uploads {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocketæ”¯æŒ (å¦‚æœéœ€è¦)
    location /ws {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # å®‰å…¨é…ç½®
    location ~ /\. {
        deny all;
    }
    
    # é”™è¯¯é¡µé¢
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /www/wwwroot/tron-energy-rental/dist;
    }
}
```

---

## âš™ï¸ è¿›ç¨‹ç®¡ç†

### 1. ä½¿ç”¨PM2ç®¡ç†Node.jsè¿›ç¨‹

#### åˆ›å»ºPM2é…ç½®æ–‡ä»¶
```bash
# åˆ›å»ºecosystem.config.js
nano /www/wwwroot/tron-energy-rental/ecosystem.config.js
```

```javascript
module.exports = {
  apps: [
    {
      name: 'tron-energy-api',
      script: './api/server.ts',
      interpreter: 'tsx',
      instances: 2,
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      },
      env_file: '.env.production',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      error_file: './logs/api-error.log',
      out_file: './logs/api-out.log',
      log_file: './logs/api-combined.log',
      time: true,
      autorestart: true,
      max_restarts: 10,
      min_uptime: '10s',
      max_memory_restart: '1G',
      watch: false,
      ignore_watch: ['logs', 'node_modules', 'uploads'],
    }
  ]
};
```

#### å¯åŠ¨åº”ç”¨
```bash
cd /www/wwwroot/tron-energy-rental

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
```

### 2. PM2å¸¸ç”¨å‘½ä»¤
```bash
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs tron-energy-api

# é‡å¯åº”ç”¨
pm2 restart tron-energy-api

# åœæ­¢åº”ç”¨
pm2 stop tron-energy-api

# åˆ é™¤åº”ç”¨
pm2 delete tron-energy-api

# ç›‘æ§
pm2 monit
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®
åœ¨å®å¡”é¢æ¿ä¸­ï¼š
1. è¿›å…¥ **å®‰å…¨** â†’ **é˜²ç«å¢™**
2. å¼€æ”¾å¿…è¦ç«¯å£ï¼š
   - 80 (HTTP)
   - 443 (HTTPS)
   - 22 (SSHï¼Œå»ºè®®ä¿®æ”¹é»˜è®¤ç«¯å£)
   - 8888 (å®å¡”é¢æ¿ï¼Œå»ºè®®ä¿®æ”¹é»˜è®¤ç«¯å£)

### 2. ä¿®æ”¹é»˜è®¤ç«¯å£
```bash
# ä¿®æ”¹SSHç«¯å£
sudo nano /etc/ssh/sshd_config
# ä¿®æ”¹ Port 22 ä¸ºå…¶ä»–ç«¯å£ï¼Œå¦‚ Port 2022

# é‡å¯SSHæœåŠ¡
sudo systemctl restart ssh
```

### 3. å®‰å…¨åŠ å›º
1. **ç¦ç”¨rootè¿œç¨‹ç™»å½•**
2. **ä½¿ç”¨å¯†é’¥ç™»å½•**
3. **å®‰è£…fail2bané˜²æš´åŠ›ç ´è§£**
4. **å®šæœŸæ›´æ–°ç³»ç»Ÿ**

### 4. SSLè¯ä¹¦é…ç½®
åœ¨å®å¡”é¢æ¿ä¸­ï¼š
1. è¿›å…¥ç«™ç‚¹è®¾ç½® â†’ **SSL**
2. é€‰æ‹© **Let's Encrypt** å…è´¹è¯ä¹¦
3. ç”³è¯·å¹¶éƒ¨ç½²è¯ä¹¦
4. å¼€å¯ **å¼ºåˆ¶HTTPS**

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—é…ç½®
```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /www/wwwroot/tron-energy-rental/logs

# é…ç½®æ—¥å¿—è½®è½¬
sudo nano /etc/logrotate.d/tron-energy-rental
```

```conf
/www/wwwroot/tron-energy-rental/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 2. ç›‘æ§é…ç½®
```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
nano /www/wwwroot/tron-energy-rental/scripts/health-check.sh
```

```bash
#!/bin/bash
# å¥åº·æ£€æŸ¥è„šæœ¬

API_URL="http://127.0.0.1:3001/api/health"
LOG_FILE="/www/wwwroot/tron-energy-rental/logs/health-check.log"

# æ£€æŸ¥APIæ˜¯å¦æ­£å¸¸
response=$(curl -s -o /dev/null -w "%{http_code}" $API_URL)

if [ $response -eq 200 ]; then
    echo "$(date): APIå¥åº·æ£€æŸ¥é€šè¿‡" >> $LOG_FILE
else
    echo "$(date): APIå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : $response" >> $LOG_FILE
    # é‡å¯PM2æœåŠ¡
    cd /www/wwwroot/tron-energy-rental
    pm2 restart tron-energy-api
fi
```

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /www/wwwroot/tron-energy-rental/scripts/health-check.sh

# æ·»åŠ åˆ°crontab
crontab -e
# æ·»åŠ ï¼šæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
*/5 * * * * /www/wwwroot/tron-energy-rental/scripts/health-check.sh
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. ç«¯å£å ç”¨é—®é¢˜
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep :3001
# æˆ–
lsof -i :3001

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 [è¿›ç¨‹ID]
```

### 2. æƒé™é—®é¢˜
```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
chown -R www-data:www-data /www/wwwroot/tron-energy-rental
chmod -R 755 /www/wwwroot/tron-energy-rental
chmod -R 644 /www/wwwroot/tron-energy-rental/logs
```

### 3. æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -U tron_user -d tron_energy_rental

# æ£€æŸ¥PostgreSQLçŠ¶æ€
sudo systemctl status postgresql
```

### 4. Node.jså†…å­˜ä¸è¶³
```bash
# å¢åŠ Node.jså†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=4096"

# æˆ–åœ¨PM2é…ç½®ä¸­æ·»åŠ 
node_args: '--max-old-space-size=4096'
```

### 5. å‰ç«¯æ„å»ºå¤±è´¥
```bash
# æ¸…ç†ç¼“å­˜é‡æ–°æ„å»º
rm -rf node_modules/.cache
rm -rf dist
pnpm install
pnpm run build
```

---

## ğŸš€ éƒ¨ç½²å®Œæˆåçš„éªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥PM2è¿›ç¨‹
pm2 status

# æ£€æŸ¥Nginxé…ç½®
nginx -t

# æ£€æŸ¥SSLè¯ä¹¦
curl -I https://yourdomain.com
```

### 2. åŠŸèƒ½æµ‹è¯•
```bash
# æµ‹è¯•API
curl -X POST https://yourdomain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tronrental.com","password":"your_admin_password"}'

# æµ‹è¯•å‰ç«¯
curl -I https://yourdomain.com
```

### 3. æ€§èƒ½æµ‹è¯•
```bash
# ä½¿ç”¨abè¿›è¡Œç®€å•å‹åŠ›æµ‹è¯•
ab -n 100 -c 10 https://yourdomain.com/api/health
```

---

## ğŸ“š ç»´æŠ¤å»ºè®®

1. **å®šæœŸå¤‡ä»½æ•°æ®åº“**
2. **ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ**
3. **å®šæœŸæ›´æ–°ä¾èµ–åŒ…**
4. **æŸ¥çœ‹åº”ç”¨æ—¥å¿—**
5. **å®šæœŸæ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæœŸ**

---

æ­å–œï¼ğŸ‰ ä½ çš„TRONèƒ½é‡ç§Ÿèµç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ°å®å¡”é¢æ¿ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒä¸Šè¿°æ•…éšœæ’é™¤æŒ‡å—æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚

# 🚀 TRON能量租赁系统 - 宝塔面板部署指南

## 📋 目录
1. [服务器要求](#服务器要求)
2. [宝塔面板基础配置](#宝塔面板基础配置)
3. [环境依赖安装](#环境依赖安装)
4. [数据库配置](#数据库配置)
5. [项目部署](#项目部署)
6. [Nginx配置](#nginx配置)
7. [进程管理](#进程管理)
8. [安全配置](#安全配置)
9. [监控和日志](#监控和日志)
10. [常见问题](#常见问题)

---

## 🖥️ 服务器要求

### 最低配置
- **CPU**: 2核
- **内存**: 4GB RAM
- **存储**: 40GB SSD
- **带宽**: 5Mbps

### 推荐配置
- **CPU**: 4核以上
- **内存**: 8GB RAM以上
- **存储**: 100GB SSD以上
- **带宽**: 10Mbps以上

### 操作系统
- Ubuntu 20.04 LTS 或更高版本
- CentOS 7/8
- Debian 10/11

---

## 🛠️ 宝塔面板基础配置

### 1. 安装宝塔面板

```bash
# Ubuntu/Debian
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec

# CentOS
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

### 2. 初始配置
- 登录宝塔面板
- 安装推荐的LNMP套件
- 配置安全设置（修改默认端口、设置复杂密码）

---

## 📦 环境依赖安装

### 1. 在宝塔面板安装以下组件：

#### 必需组件
- ✅ **Nginx** (1.20+)
- ✅ **PostgreSQL** (13+)
- ✅ **Redis** (6.0+)
- ✅ **Node.js** (18+)
- ✅ **PM2** (进程管理器)

#### 安装步骤
1. 进入宝塔面板 → **软件商店**
2. 逐一安装上述组件
3. 等待安装完成

### 2. Node.js 版本管理
```bash
# 安装nvm (如果宝塔自带的Node.js版本不够)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装Node.js 18+
nvm install 18
nvm use 18
nvm alias default 18

# 安装pnpm
npm install -g pnpm pm2
```

---

## 🗄️ 数据库配置

### 1. PostgreSQL配置

#### 创建数据库和用户
```sql
-- 连接到PostgreSQL
sudo -u postgres psql

-- 创建数据库
CREATE DATABASE tron_energy_rental;

-- 创建用户
CREATE USER tron_user WITH PASSWORD 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE tron_energy_rental TO tron_user;
ALTER DATABASE tron_energy_rental OWNER TO tron_user;

-- 退出
\q
```

#### 配置PostgreSQL
```bash
# 编辑配置文件
sudo nano /etc/postgresql/13/main/postgresql.conf

# 修改以下配置
listen_addresses = 'localhost'
port = 5432
max_connections = 200
shared_buffers = 256MB
```

#### 配置访问权限
```bash
# 编辑pg_hba.conf
sudo nano /etc/postgresql/13/main/pg_hba.conf

# 添加本地连接权限
local   all             tron_user                               md5
host    all             tron_user       127.0.0.1/32            md5
```

#### 重启PostgreSQL
```bash
sudo systemctl restart postgresql
```

### 2. Redis配置
```bash
# 编辑Redis配置
sudo nano /etc/redis/redis.conf

# 修改配置
bind 127.0.0.1
port 6379
# 可选：设置密码
# requirepass your_redis_password

# 重启Redis
sudo systemctl restart redis-server
```

---

## 🚀 项目部署

### 1. 上传项目文件
```bash
# 在服务器创建项目目录
mkdir -p /www/wwwroot/tron-energy-rental
cd /www/wwwroot/tron-energy-rental

# 上传项目文件 (可通过宝塔文件管理器、scp、git等方式)
# 方式1: Git克隆 (推荐)
git clone [你的仓库地址] .

# 方式2: 宝塔文件管理器上传zip包后解压
```

### 2. 安装依赖
```bash
cd /www/wwwroot/tron-energy-rental

# 安装依赖
pnpm install

# 构建前端
pnpm run build
```

### 3. 环境配置
```bash
# 复制环境配置文件
cp .env .env.production

# 编辑生产环境配置
nano .env.production
```

#### 生产环境配置 (.env.production)
```env
# 基础环境
NODE_ENV=production

# 前端配置
VITE_VUE_DEVTOOLS=false
VITE_PORT=5173
VITE_HOST=0.0.0.0
VITE_API_URL=https://yourdomain.com
VITE_ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# 后端配置
PORT=3001
HOST_ADDRESS=127.0.0.1

# 数据库配置
DATABASE_URL=postgresql://tron_user:your_secure_password@localhost:5432/tron_energy_rental
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tron_energy_rental
DB_USER=tron_user
DB_PASSWORD=your_secure_password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# 安全配置 (必须修改为随机字符串)
JWT_SECRET=your-super-secret-jwt-key-at-least-32-characters-long
SESSION_SECRET=your-session-secret-change-this
CSRF_SECRET=your-csrf-secret-change-this
ADMIN_PASSWORD=change-this-admin-password

# 系统配置
ADMIN_EMAIL=admin@yourdomain.com
LOG_LEVEL=info
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX_REQUESTS=50
```

### 4. 数据库初始化
```bash
# 运行数据库迁移
pnpm run migrate

# 如果需要初始化数据
pnpm run db:setup
```

---

## 🌐 Nginx配置

### 1. 创建站点配置
在宝塔面板中：
1. 进入 **网站** → **添加站点**
2. 域名：`yourdomain.com`
3. 目录：`/www/wwwroot/tron-energy-rental/dist`

### 2. Nginx配置文件
```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSL配置 (通过宝塔面板申请证书)
    ssl_certificate /www/server/panel/vhost/cert/yourdomain.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/yourdomain.com/privkey.pem;
    
    # 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_prefer_server_ciphers on;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # 强制HTTPS
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
    
    # 前端静态文件
    location / {
        root /www/wwwroot/tron-energy-rental/dist;
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理
    location /api {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 文件上传代理
    location /uploads {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket支持 (如果需要)
    location /ws {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 安全配置
    location ~ /\. {
        deny all;
    }
    
    # 错误页面
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /www/wwwroot/tron-energy-rental/dist;
    }
}
```

---

## ⚙️ 进程管理

### 1. 使用PM2管理Node.js进程

#### 创建PM2配置文件
```bash
# 创建ecosystem.config.js
nano /www/wwwroot/tron-energy-rental/ecosystem.config.js
```

```javascript
module.exports = {
  apps: [
    {
      name: 'tron-energy-api',
      script: './api/server.ts',
      interpreter: 'tsx',
      instances: 2,
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      },
      env_file: '.env.production',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      error_file: './logs/api-error.log',
      out_file: './logs/api-out.log',
      log_file: './logs/api-combined.log',
      time: true,
      autorestart: true,
      max_restarts: 10,
      min_uptime: '10s',
      max_memory_restart: '1G',
      watch: false,
      ignore_watch: ['logs', 'node_modules', 'uploads'],
    }
  ]
};
```

#### 启动应用
```bash
cd /www/wwwroot/tron-energy-rental

# 启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
```

### 2. PM2常用命令
```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs tron-energy-api

# 重启应用
pm2 restart tron-energy-api

# 停止应用
pm2 stop tron-energy-api

# 删除应用
pm2 delete tron-energy-api

# 监控
pm2 monit
```

---

## 🔒 安全配置

### 1. 防火墙配置
在宝塔面板中：
1. 进入 **安全** → **防火墙**
2. 开放必要端口：
   - 80 (HTTP)
   - 443 (HTTPS)
   - 22 (SSH，建议修改默认端口)
   - 8888 (宝塔面板，建议修改默认端口)

### 2. 修改默认端口
```bash
# 修改SSH端口
sudo nano /etc/ssh/sshd_config
# 修改 Port 22 为其他端口，如 Port 2022

# 重启SSH服务
sudo systemctl restart ssh
```

### 3. 安全加固
1. **禁用root远程登录**
2. **使用密钥登录**
3. **安装fail2ban防暴力破解**
4. **定期更新系统**

### 4. SSL证书配置
在宝塔面板中：
1. 进入站点设置 → **SSL**
2. 选择 **Let's Encrypt** 免费证书
3. 申请并部署证书
4. 开启 **强制HTTPS**

---

## 📊 监控和日志

### 1. 日志配置
```bash
# 创建日志目录
mkdir -p /www/wwwroot/tron-energy-rental/logs

# 配置日志轮转
sudo nano /etc/logrotate.d/tron-energy-rental
```

```conf
/www/wwwroot/tron-energy-rental/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 2. 监控配置
```bash
# 创建监控脚本
nano /www/wwwroot/tron-energy-rental/scripts/health-check.sh
```

```bash
#!/bin/bash
# 健康检查脚本

API_URL="http://127.0.0.1:3001/api/health"
LOG_FILE="/www/wwwroot/tron-energy-rental/logs/health-check.log"

# 检查API是否正常
response=$(curl -s -o /dev/null -w "%{http_code}" $API_URL)

if [ $response -eq 200 ]; then
    echo "$(date): API健康检查通过" >> $LOG_FILE
else
    echo "$(date): API健康检查失败，状态码: $response" >> $LOG_FILE
    # 重启PM2服务
    cd /www/wwwroot/tron-energy-rental
    pm2 restart tron-energy-api
fi
```

```bash
# 添加执行权限
chmod +x /www/wwwroot/tron-energy-rental/scripts/health-check.sh

# 添加到crontab
crontab -e
# 添加：每5分钟执行一次健康检查
*/5 * * * * /www/wwwroot/tron-energy-rental/scripts/health-check.sh
```

---

## 🔧 常见问题

### 1. 端口占用问题
```bash
# 查看端口占用
netstat -tlnp | grep :3001
# 或
lsof -i :3001

# 杀死占用进程
kill -9 [进程ID]
```

### 2. 权限问题
```bash
# 设置正确的文件权限
chown -R www-data:www-data /www/wwwroot/tron-energy-rental
chmod -R 755 /www/wwwroot/tron-energy-rental
chmod -R 644 /www/wwwroot/tron-energy-rental/logs
```

### 3. 数据库连接问题
```bash
# 测试数据库连接
psql -h localhost -U tron_user -d tron_energy_rental

# 检查PostgreSQL状态
sudo systemctl status postgresql
```

### 4. Node.js内存不足
```bash
# 增加Node.js内存限制
export NODE_OPTIONS="--max-old-space-size=4096"

# 或在PM2配置中添加
node_args: '--max-old-space-size=4096'
```

### 5. 前端构建失败
```bash
# 清理缓存重新构建
rm -rf node_modules/.cache
rm -rf dist
pnpm install
pnpm run build
```

---

## 🚀 部署完成后的验证

### 1. 检查服务状态
```bash
# 检查PM2进程
pm2 status

# 检查Nginx配置
nginx -t

# 检查SSL证书
curl -I https://yourdomain.com
```

### 2. 功能测试
```bash
# 测试API
curl -X POST https://yourdomain.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tronrental.com","password":"your_admin_password"}'

# 测试前端
curl -I https://yourdomain.com
```

### 3. 性能测试
```bash
# 使用ab进行简单压力测试
ab -n 100 -c 10 https://yourdomain.com/api/health
```

---

## 📚 维护建议

1. **定期备份数据库**
2. **监控服务器资源使用情况**
3. **定期更新依赖包**
4. **查看应用日志**
5. **定期检查SSL证书有效期**

---

恭喜！🎉 你的TRON能量租赁系统已成功部署到宝塔面板。如有问题，请参考上述故障排除指南或联系技术支持。

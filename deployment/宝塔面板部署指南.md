# TRON能量租赁系统 - 宝塔面板部署指南 📦

## 📋 概述

本指南详细介绍如何在宝塔面板上部署TRON能量租赁系统。宝塔面板提供可视化的服务器管理界面，让部署过程更加简单直观。

## 🏗️ 系统架构

```
宝塔面板部署架构
├── Node.js 应用管理      # 管理后端API服务
├── 网站管理             # 管理前端静态文件
├── 数据库管理           # PostgreSQL 数据库
├── Redis管理            # 缓存服务
├── PM2管理器            # 进程监控
├── 文件管理             # 项目文件上传
├── 定时任务             # 自动化运维
└── SSL证书管理          # HTTPS配置
```

## 🔧 环境要求

### 服务器配置
- **操作系统**: CentOS 7+/Ubuntu 18.04+
- **CPU**: 2核心 (推荐4核心)
- **内存**: 4GB (推荐8GB)
- **磁盘**: 40GB SSD
- **宝塔版本**: 7.0+ (推荐最新版)

### 必需软件栈
- **Node.js**: >= 18.x
- **PostgreSQL**: >= 12.x
- **Redis**: >= 6.x
- **PM2**: 最新版本
- **Nginx**: 自动配置

## 📦 第一步：安装宝塔面板

### 1.1 安装命令

**CentOS安装:**
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

**Ubuntu安装:**
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

### 1.2 获取登录信息

安装完成后，记录以下信息：
- 面板地址: `http://您的服务器IP:8888`
- 用户名: `xxxxxxx`
- 密码: `xxxxxxx`

### 1.3 初始配置

1. 登录宝塔面板
2. 选择**LNMP**环境一键安装
3. 推荐配置：
   - Nginx 1.20+
   - MySQL 8.0 (用于管理，实际使用PostgreSQL)
   - PHP 8.0 (用于宝塔面板功能)

## 🎯 第二步：安装项目依赖

### 2.1 安装Node.js

1. 进入**软件商店** → **运行环境**
2. 找到**Node.js版本管理器**，点击**安装**
3. 安装Node.js 18.x或20.x版本
4. 设置为默认版本

### 2.2 安装PostgreSQL

1. 进入**软件商店** → **数据库**
2. 找到**PostgreSQL**，选择版本12+
3. 点击**安装**并等待完成
4. 记录数据库管理信息

### 2.3 安装Redis

1. 进入**软件商店** → **数据库**
2. 找到**Redis**，选择最新版本
3. 点击**安装**
4. 启用**密码认证**

### 2.4 安装PM2管理器

1. 进入**软件商店** → **系统工具**
2. 搜索**PM2管理器**
3. 点击**安装**

## 📁 第三步：上传项目文件

### 3.1 创建项目目录

1. 进入**文件管理**
2. 在`/www/wwwroot/`下创建文件夹：`tron-energy-rental`
3. 设置权限为755

### 3.2 上传代码

**方法一：文件上传**
1. 将项目打包为zip文件
2. 通过宝塔**文件管理**上传
3. 解压到项目目录

**方法二：Git克隆**
1. 打开**终端**
2. 执行以下命令：
```bash
cd /www/wwwroot
git clone <你的项目仓库地址> tron-energy-rental
cd tron-energy-rental
```

### 3.3 安装项目依赖

在终端中执行：
```bash
cd /www/wwwroot/tron-energy-rental

# 启用 corepack
corepack enable

# 安装并使用 pnpm
corepack prepare pnpm@latest --activate


# 1. 清理 pnpm 缓存
pnpm store prune
pnpm store clean

# 2. 删除 node_modules 和锁文件
rm -rf node_modules
rm pnpm-lock.yaml

# 使用官方源
pnpm config set registry https://registry.npmjs.org/

# 安装项目依赖
pnpm install

# 安装全局依赖
npm install -g tsx
npm install -g pm2
```

## 🗄️ 第四步：配置数据库

### 4.1 创建PostgreSQL数据库

1. 进入**数据库** → **PostgreSQL**
2. 点击**添加数据库**
3. 填写信息：
   - 数据库名: `tron_energy_rental`
   - 用户名: `tron_user`
   - 密码: `设置强密码`

### 4.2 配置Redis

1. 进入**数据库** → **Redis**
2. 点击**设置**
3. 设置密码并重启服务

### 4.3 创建环境配置

在项目根目录创建`.env`文件：

```bash
# 在文件管理中创建 .env 文件
cd /www/wwwroot/tron-energy-rental
```

```env
# 数据库配置
DB_HOST=127.0.0.1
DB_PORT=5432
DB_NAME=tron_energy_rental
DB_USER=tron_user
DB_PASSWORD=你的数据库密码

# Redis配置
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=你的Redis密码

# JWT配置
JWT_SECRET=你的超级安全的JWT密钥至少32个字符

# 应用配置
NODE_ENV=production
PORT=3001
TZ=Asia/Shanghai

# TRON网络配置
TRON_NETWORK=mainnet
TRON_API_KEY=你的TRON_API密钥
TRON_PRIVATE_KEY=你的TRON私钥

# Telegram机器人配置 (可选)
TELEGRAM_BOT_TOKEN=你的机器人Token
```

### 4.4 数据库迁移

```bash
# 运行数据库迁移
cd /www/wwwroot/tron-energy-rental
pnpm run migrate
```

## 🚀 第五步：构建和部署

### 5.1 构建前端

```bash
cd /www/wwwroot/tron-energy-rental

# 构建前端项目
pnpm run build
```

### 5.2 配置PM2

1. 修改`deployment/configs/pm2.config.js`中的路径：
```javascript
cwd: '/www/wwwroot/tron-energy-rental',
```

2. 通过PM2管理器启动应用：
   - 进入**软件商店** → **已安装** → **PM2管理器**
   - 点击**设置**
   - 添加项目：
     - 项目路径: `/www/wwwroot/tron-energy-rental`
     - 启动文件: `api/server.ts`
     - 运行模式: `fork`

### 5.3 启动服务

在终端中执行：
```bash
cd /www/wwwroot/tron-energy-rental

# 启动PM2服务
pm2 start deployment/configs/pm2.config.js --env production

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
```

## 🌐 第六步：配置网站和反向代理

### 6.1 创建网站

1. 进入**网站** → **添加站点**
2. 填写信息：
   - 域名: `你的域名.com` 或 `服务器IP`
   - 根目录: `/www/wwwroot/tron-energy-rental/dist`
   - PHP版本: 纯静态

### 6.2 配置反向代理

1. 点击网站**设置**
2. 选择**反向代理**
3. 添加代理：
   - 代理名称: `api`
   - 目标URL: `http://127.0.0.1:3001`
   - 代理目录: `/api`

### 6.3 配置Nginx (手动)

如需更精细的配置，可以手动编辑Nginx配置：

1. 进入**网站** → **设置** → **配置文件**
2. 参考项目中的`deployment/configs/nginx.conf`进行配置

## 🔒 第七步：SSL证书配置

### 7.1 申请免费SSL证书

1. 进入**网站** → **设置** → **SSL**
2. 选择**Let's Encrypt**
3. 填写邮箱并申请
4. 开启**强制HTTPS**

### 7.2 配置自动续期

宝塔面板会自动配置SSL证书的定时续期任务。

## 📊 第八步：监控和日志管理

### 8.1 PM2进程监控

1. 进入**软件商店** → **PM2管理器**
2. 查看进程状态、CPU、内存使用情况
3. 查看日志输出

### 8.2 系统监控

1. 使用宝塔面板的**系统监控**功能
2. 监控CPU、内存、磁盘、网络使用情况

### 8.3 日志管理

项目日志位置：
- 应用日志: `/www/wwwroot/tron-energy-rental/logs/`
- PM2日志: `~/.pm2/logs/`
- Nginx日志: `/www/wwwlogs/`

在宝塔面板中可以通过**文件管理**直接查看日志。

## 🔄 第九步：定时任务和备份

### 9.1 设置数据库自动备份

1. 进入**计划任务**
2. 添加任务：
   - 任务类型: **备份数据库**
   - 执行周期: **每天**
   - 执行时间: **03:00**
   - 备份保留: **7天**

### 9.2 设置项目文件备份

1. 添加任务：
   - 任务类型: **备份网站**
   - 执行周期: **每周**
   - 执行时间: **周日 02:00**

### 9.3 日志清理任务

```bash
# 添加shell脚本任务
# 任务类型: Shell脚本
# 脚本内容:
#!/bin/bash
cd /www/wwwroot/tron-energy-rental/logs
find . -name "*.log" -mtime +7 -delete
echo "日志清理完成: $(date)"
```

## 🚨 第十步：故障排除

### 10.1 常见问题

**1. Node.js应用无法启动**
```bash
# 检查Node.js版本
node -v
npm -v

# 检查依赖安装
cd /www/wwwroot/tron-energy-rental
pnpm list

# 查看详细错误
pm2 logs
```

**2. 数据库连接失败**
- 检查PostgreSQL服务状态
- 验证数据库用户权限
- 确认防火墙设置

**3. 反向代理不工作**
- 检查Nginx配置语法
- 确认后端服务运行正常
- 查看Nginx错误日志

### 10.2 性能优化建议

**数据库优化:**
1. 进入**数据库** → **PostgreSQL** → **性能调优**
2. 根据服务器配置调整参数

**Redis优化:**
1. 进入**数据库** → **Redis** → **配置修改**
2. 设置合适的内存限制和持久化策略

## 📋 维护检查清单

### 日常检查 ✅

- [ ] 检查应用进程状态 (PM2管理器)
- [ ] 查看系统资源使用情况
- [ ] 检查SSL证书有效期
- [ ] 查看错误日志

### 定期维护 ✅

- [ ] 更新系统安全补丁
- [ ] 备份验证和恢复测试
- [ ] 清理临时文件和日志
- [ ] 检查磁盘空间使用

### 月度维护 ✅

- [ ] 检查数据库性能指标
- [ ] 更新项目依赖
- [ ] 安全漏洞扫描
- [ ] 性能监控分析

## 🔧 快速命令参考

### 宝塔面板相关
```bash
# 重启宝塔面板
bt restart

# 修改面板端口
bt 5

# 查看面板状态
bt 1
```

### 项目管理
```bash
# 进入项目目录
cd /www/wwwroot/tron-energy-rental

# 查看PM2状态
pm2 status

# 重启应用
pm2 restart all

# 查看日志
pm2 logs

# 更新项目
git pull origin main
pnpm install
pnpm run build
pm2 restart all
```

### 服务管理
```bash
# PostgreSQL
systemctl status postgresql
systemctl restart postgresql

# Redis
systemctl status redis
systemctl restart redis

# Nginx
systemctl status nginx
systemctl restart nginx
```

## 📞 技术支持

如遇到部署问题，请按以下步骤排查：

1. **检查宝塔面板日志**: 系统日志 → 面板日志
2. **查看应用日志**: PM2管理器 → 查看日志
3. **检查系统资源**: 系统监控
4. **验证服务状态**: 终端执行检查命令
5. **查看详细错误**: 文件管理查看项目日志

## 🎯 部署完成验证

部署完成后，请验证以下功能：

1. **访问前端**: `https://你的域名.com`
2. **API健康检查**: `https://你的域名.com/api/health`
3. **数据库连接**: 检查应用日志无连接错误
4. **SSL证书**: 浏览器显示安全锁图标

---

## 📝 更新日志

- **v1.0.0** (2025-09-18): 初始版本发布
- **v1.1.0** (待定): 增加监控告警配置
- **v1.2.0** (待定): 添加自动化部署脚本

---

> 🎉 **恭喜！** 您已成功在宝塔面板上部署了TRON能量租赁系统。
> 
> 📧 如需进一步技术支持，请查看项目文档或联系开发团队。

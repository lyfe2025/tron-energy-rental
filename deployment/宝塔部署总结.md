# 🎯 TRON能量租赁系统 - 宝塔面板部署总结

## 📋 部署文件清单

我已经为你的项目创建了完整的宝塔面板部署方案，包含以下文件：

### 📁 核心文档
- `deployment/宝塔面板部署指南.md` - **详细部署文档**（60页详细指南）
- `deployment/README.md` - **快速部署指南**（适合有经验的开发者）
- `deployment/宝塔部署总结.md` - **本文档**（总结概览）

### ⚙️ 配置文件
- `deployment/configs/ecosystem.config.js` - **PM2进程管理配置**
- `deployment/configs/.env.production.template` - **生产环境变量模板**
- `deployment/configs/nginx-same-server.conf` - **Nginx配置示例**

### 🚀 自动化脚本
- `deployment/scripts/install.sh` - **一键环境安装脚本**
- `deployment/scripts/deploy.sh` - **自动化部署脚本**  
- `deployment/scripts/health-check.sh` - **健康检查脚本**

---

## 🖥️ 服务器要求

### 最低配置要求
```
CPU:    2核
内存:   4GB RAM
存储:   40GB SSD
带宽:   5Mbps
操作系统: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
```

### 推荐配置
```
CPU:    4核以上
内存:   8GB RAM以上
存储:   100GB SSD以上
带宽:   10Mbps以上
```

### 软件依赖
- **宝塔面板** 7.0+
- **Nginx** 1.20+
- **Node.js** 18.0+
- **PostgreSQL** 13+
- **Redis** 6.0+
- **PM2** (进程管理)

---

## 🚀 三种部署方式

### 方式1：一键自动部署 ⭐⭐⭐⭐⭐
```bash
# 适用于全新服务器
sudo ./deployment/scripts/install.sh  # 安装环境
./deployment/scripts/deploy.sh        # 部署项目
```
**优点：** 全自动化，适合新手  
**时间：** 20-30分钟

### 方式2：脚本辅助部署 ⭐⭐⭐⭐☆
```bash
# 手动安装宝塔环境后
./deployment/scripts/deploy.sh        # 自动部署项目
```
**优点：** 灵活性高，适合有宝塔经验者  
**时间：** 30-45分钟

### 方式3：手动逐步部署 ⭐⭐⭐☆☆
按照 `宝塔面板部署指南.md` 逐步操作
**优点：** 完全可控，适合深度定制  
**时间：** 60-90分钟

---

## 🔐 安全配置要点

### 必须修改的配置
1. **数据库密码** - 默认postgres/postgres需要修改
2. **JWT密钥** - 生成32位以上随机字符串
3. **管理员密码** - 默认admin123456需要修改
4. **域名配置** - 修改为实际域名
5. **CORS设置** - 限制允许的来源域名

### 推荐的安全措施
```bash
# 1. 启用防火墙
ufw enable
ufw allow 80,443,22/tcp

# 2. 修改SSH端口
# 编辑 /etc/ssh/sshd_config
Port 2022

# 3. 安装fail2ban
apt install fail2ban

# 4. 设置SSL证书
# 通过宝塔面板申请Let's Encrypt证书

# 5. 定期备份
# 设置自动数据库备份
```

### 生产环境检查清单
- [ ] 修改所有默认密码
- [ ] 配置SSL证书
- [ ] 设置防火墙规则
- [ ] 启用自动备份
- [ ] 配置监控告警
- [ ] 测试故障恢复
- [ ] 压力测试
- [ ] 安全扫描

---

## 📊 监控和日志

### 健康检查配置
```bash
# 添加到crontab
*/5 * * * * /www/wwwroot/tron-energy-rental/deployment/scripts/health-check.sh -q -r

# 检查项目：
# ✓ PM2进程状态
# ✓ API健康检查  
# ✓ 数据库连接
# ✓ Redis连接
# ✓ 磁盘空间
# ✓ 内存使用
# ✓ CPU负载
```

### 日志管理
```bash
# 日志文件位置
/www/wwwroot/tron-energy-rental/logs/
├── api-error.log          # API错误日志
├── api-out.log            # API输出日志
├── telegram-error.log     # Telegram机器人错误日志
└── health-check.log       # 健康检查日志

# 自动日志轮转
# 每日保留，7天后自动删除
```

### 监控面板集成
- **宝塔面板监控** - 系统资源监控
- **PM2监控** - 进程状态监控
- **自定义监控** - 业务指标监控

---

## 🔧 常用运维命令

### 服务管理
```bash
# 启动服务
pm2 start ecosystem.config.js --env production

# 重启服务
pm2 restart ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs

# 查看监控
pm2 monit
```

### 数据库操作
```bash
# 连接数据库
psql postgresql://tron_user:password@localhost:5432/tron_energy_rental

# 备份数据库
pg_dump -h localhost -U tron_user -d tron_energy_rental > backup_$(date +%Y%m%d).sql

# 恢复数据库
psql -h localhost -U tron_user -d tron_energy_rental < backup.sql

# 运行迁移
pnpm run migrate
```

### 项目更新
```bash
# 更新流程
git pull origin main          # 拉取代码
pnpm install                  # 安装依赖
pnpm run build               # 构建前端
pnpm run migrate             # 运行迁移
pm2 restart ecosystem.config.js  # 重启服务
```

---

## 📈 性能优化建议

### 服务器层面
- **CPU**: 监控负载，必要时升级
- **内存**: 建议至少8GB，预留30%空间
- **存储**: 使用SSD，定期清理日志
- **网络**: CDN加速静态资源

### 应用层面
- **数据库连接池**: 默认50个连接
- **Redis缓存**: 启用数据缓存
- **PM2集群**: 根据CPU核心数调整
- **Nginx缓存**: 静态资源缓存1年

### 监控指标
```bash
# 关键指标
- API响应时间 < 500ms
- 数据库连接数 < 40
- 内存使用率 < 80%
- CPU使用率 < 70%
- 磁盘使用率 < 85%
```

---

## 🚨 故障排除

### 常见问题及解决方案

#### 1. 服务无法启动
```bash
# 检查日志
pm2 logs
tail -f /www/wwwroot/tron-energy-rental/logs/api-error.log

# 常见原因
- 端口被占用: netstat -tlnp | grep :3001
- 权限问题: chown -R www-data:www-data /www/wwwroot/tron-energy-rental
- 依赖缺失: pnpm install
```

#### 2. 数据库连接失败
```bash
# 检查PostgreSQL状态
systemctl status postgresql

# 测试连接
psql -h localhost -U tron_user -d tron_energy_rental -c "SELECT 1;"

# 常见原因
- 密码错误: 检查.env.production配置
- 服务未启动: systemctl start postgresql
- 防火墙阻止: ufw allow 5432
```

#### 3. 前端页面无法访问
```bash
# 检查Nginx状态
systemctl status nginx

# 测试配置
nginx -t

# 常见原因
- 配置语法错误: nginx -t
- 文件权限问题: chmod -R 755 /www/wwwroot/tron-energy-rental/dist
- SSL证书过期: 重新申请证书
```

#### 4. API接口错误
```bash
# 健康检查
curl http://localhost:3001/api/health

# 检查进程
pm2 status

# 常见原因
- 环境变量错误: 检查.env.production
- 数据库迁移未执行: pnpm run migrate
- JWT密钥配置错误: 检查JWT_SECRET
```

---

## 🎯 部署成功验证

### 检查清单
- [ ] **PM2进程正常运行**: `pm2 status` 显示 online
- [ ] **API健康检查通过**: `curl http://localhost:3001/api/health` 返回200
- [ ] **前端页面可访问**: 浏览器能打开首页
- [ ] **数据库连接正常**: 能够登录管理后台
- [ ] **Redis缓存工作**: 缓存功能正常
- [ ] **日志记录正常**: 日志文件有内容生成
- [ ] **SSL证书有效**: HTTPS访问正常
- [ ] **监控告警配置**: 健康检查脚本正常运行

### 性能测试
```bash
# 简单压力测试
ab -n 100 -c 10 https://yourdomain.com/api/health

# 预期结果
# Requests per second: > 50
# Time per request: < 200ms
# Failed requests: 0
```

---

## 📞 后续支持

### 文档位置
- **详细指南**: `deployment/宝塔面板部署指南.md`
- **快速指南**: `deployment/README.md`
- **配置示例**: `deployment/configs/`
- **自动脚本**: `deployment/scripts/`

### 维护建议
1. **定期更新依赖包**（月度）
2. **检查安全补丁**（周度）
3. **备份数据库**（每日）
4. **监控系统资源**（实时）
5. **查看错误日志**（每日）

### 扩展功能
- **负载均衡**: 使用Nginx upstream配置
- **数据库主从**: PostgreSQL流复制
- **容器化部署**: Docker + Docker Compose
- **自动化CI/CD**: GitHub Actions部署

---

## 🎉 总结

通过本部署方案，你可以在宝塔面板上快速、安全地部署TRON能量租赁系统。

**核心优势：**
✅ **完全自动化** - 一键脚本部署  
✅ **生产级安全** - 完整的安全配置  
✅ **监控告警** - 主动故障发现  
✅ **易于维护** - 标准化运维流程  
✅ **高可用性** - 集群模式部署  

**适用场景：**
- 中小型企业生产环境
- 个人项目快速上线
- 开发测试环境搭建
- 系统原型验证

祝你部署顺利！🚀

---

*如有问题，请参考详细部署指南或联系技术支持。*

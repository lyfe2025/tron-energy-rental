# TronResourceDev 项目

这是一个基于 Vue 3 + TypeScript + Express + PostgreSQL + Redis 的全栈项目，提供 Tron 资源租赁服务。

## 🚀 快速开始

### 开发环境要求
- Node.js >= 18
- pnpm >= 8
- TypeScript >= 5
- PostgreSQL >= 14
- Redis >= 6

### 安装依赖
```bash
pnpm install
```

### 启动开发服务器
```bash
# 同时启动前后端（推荐）
pnpm dev

# 项目重启（推荐）- 自动关闭旧进程并重启
pnpm restart

# 仅启动客户端
pnpm client:dev

# 仅启动服务端
pnpm server:dev

# 启动 API 服务器
pnpm dev:api

# 启动前端开发服务器
pnpm dev:frontend
```

## 📝 开发规范

### 代码质量检查
```bash
# Vue 类型检查（推荐）
pnpm check

# TypeScript 类型检查
pnpm type-check
pnpm type-check:api

# ESLint 检查
pnpm lint

# 自动修复 ESLint 问题
pnpm lint:fix

# 测试运行
pnpm test
pnpm test:run
pnpm test:coverage
pnpm test:unit
pnpm test:integration
pnpm test:ui
pnpm test:watch

# 运行完整的开发检查（脚本工具）
./scripts/dev-check.sh

# 仅检查API代码（脚本工具）
./scripts/api-check.sh

# 仅检查前端代码（脚本工具）
./scripts/frontend-check.sh

# 快速检测常见问题（脚本工具）
./scripts/quick-fix.sh
```

### 数据库操作
```bash
# 数据库连接测试
psql postgresql://postgres:postgres@localhost:5432/tron_energy_rental

# 数据库备份（重要！修改前必须备份）
./scripts/database/backup-database.sh

# 数据库操作脚本
pnpm db:create          # 创建数据库
pnpm migrate            # 运行迁移
pnpm migrate:status     # 查看迁移状态  
pnpm migrate:rollback   # 回滚迁移
pnpm db:setup          # 一键设置数据库（创建+迁移）
```

### 项目构建和预览
```bash
# 构建项目
pnpm build

# 预览构建结果
pnpm preview
```

### 中文注释管理
```bash
# 一键完成注释迁移和验证
pnpm comments:setup

# 分别执行
pnpm comments:apply    # 添加中文注释
pnpm comments:verify   # 验证注释结果
```

## 🔧 技术栈

### 前端
- **Vue 3** - 渐进式 JavaScript 框架
- **TypeScript** - 类型安全的 JavaScript
- **Vite** - 快速的前端构建工具
- **Tailwind CSS** - 实用优先的 CSS 框架
- **Pinia** - Vue 状态管理
- **Vue Router** - Vue.js 官方路由管理器
- **Recharts** - 基于 React 的图表库
- **Lucide Vue** - 精美的图标库
- **Sonner** - 现代化的 Toast 通知组件

### 后端
- **Express.js** - Node.js Web 应用框架
- **PostgreSQL** - 强大的开源关系型数据库
- **Redis** - 高性能的内存数据库
- **JWT** - JSON Web Token 身份验证
- **bcryptjs** - 密码哈希加密
- **Joi** - 数据验证库
- **TronWeb** - TRON 区块链交互库
- **WebSocket** - 实时通信支持
- **Node-Cron** - 定时任务调度

### 开发工具
- **ESLint** - 代码质量检查
- **Prettier** - 代码格式化
- **TypeScript** - 类型检查
- **Nodemon** - 开发环境自动重启
- **TSX** - TypeScript 执行器
- **Vitest** - 单元测试框架

## 📚 项目特性

### 🎯 核心功能
- **用户管理** - 完整的用户注册、登录、权限管理
- **用户等级系统** - 支持 normal、vip、premium、agent、admin 五个等级
- **能量包管理** - TRON 能量资源包配置和销售
- **订单系统** - 完整的订单流程管理
- **价格管理** - 灵活的价格配置和模板系统
- **代理系统** - 多级代理和收益分配
- **机器人集成** - Telegram 机器人自动化服务
- **统计分析** - 数据可视化和报表功能
- **通知系统** - 全局 Toast 通知和消息提醒

### 🗄️ 数据库特性
- **100% 中文注释覆盖** - 31个表，300+个字段全部注释
- **完整的迁移系统** - 支持版本控制和回滚
- **数据完整性** - 外键约束和业务规则验证
- **性能优化** - 索引优化和查询优化
- **用户等级变更追踪** - 完整的等级变更历史记录
- **全面功能覆盖** - 从用户管理到TRON资源管理的完整表结构

### 🔒 安全特性
- **JWT 身份验证** - 安全的用户会话管理
- **密码加密** - bcrypt 哈希加密
- **输入验证** - 严格的数据验证和清理
- **权限控制** - 基于角色的访问控制
- **API 限流** - 防止恶意请求

## 🆕 最新更新 (2025年1月)

### 项目规模大幅扩展
- **数据库规模**: 从17个表扩展到31个表（300+字段）
- **前端页面**: 从15+个扩展到126个Vue组件（178个文件）
- **API路由**: 从20+个扩展到66个TypeScript文件（86个文件总计）
- **测试体系**: 完整的Vitest测试框架，支持UI、覆盖率、单元、集成测试
- **脚本工具**: 完善的开发、维护、数据库管理脚本

### 用户等级管理系统
- 新增用户等级变更记录表 (`user_level_changes`)
- 支持手动、自动、系统三种变更类型
- 完整的变更历史追踪和审计
- 用户类型字段重构：`role` → `user_type`
- 支持 normal、vip、premium、agent、admin 五个等级

### 数据库大幅扩展与优化
- **规模扩展**: 从17个表扩展到31个表，覆盖完整业务场景
- **表结构完善**: 新增 stake_records、task_execution_logs、system_monitoring_logs 等
- **约束优化**: 修复 Telegram 用户表约束问题
- **角色管理**: 优化用户角色管理结构，新增用户等级变更索引
- **迁移系统**: 完善数据库迁移脚本（包含合并schema）

### 开发工具完善
- 完整的备份机制（多个时间点备份）
- 文件拆分备份系统
- 完善的开发脚本集合
- 强化的TypeScript和Vue类型检查

## 📊 项目完成度分析

基于项目需求文档的深度分析，以下是各模块的完成情况：

### ✅ 已完成的核心模块 (100%)

#### 1. 基础架构系统
- **数据库设计** - 31个表，300+字段，100%中文注释
- **API框架** - Express.js + TypeScript，66个路由文件
- **前端框架** - Vue 3 + TypeScript，126个Vue组件
- **认证系统** - JWT + 权限控制
- **用户管理** - 完整的CRUD操作

#### 2. 管理后台系统
- **仪表盘** - 数据统计和图表展示
- **用户管理** - 用户信息、等级管理、批量操作
- **订单管理** - 订单查询、状态跟踪、异常处理
- **代理管理** - 代理审核、等级管理、佣金设置
- **机器人管理** - 多机器人配置、权限分配
- **能量池管理** - 库存监控、供应商管理
- **价格配置** - 机器人价格配置、模板管理
- **财务统计** - 收入统计、成本分析、利润报表

#### 3. 数据库和基础设施
- **迁移系统** - 20+迁移文件，支持版本控制
- **中文注释** - 100%覆盖，31个表全部注释
- **性能优化** - N+1查询修复，索引优化
- **备份系统** - 自动化数据库备份，11个时间点备份

### 🔄 进行中的功能模块 (80-90%)

#### 1. 用户等级管理系统
- ✅ 数据库表结构设计
- ✅ API接口开发（66+路由文件）
- ✅ 前端界面大规模扩展（126个Vue组件）
- 🔄 功能整合和优化

#### 2. 系统架构优化
- ✅ 大规模代码结构重组
- ✅ 完整测试框架搭建
- ✅ 开发工具脚本完善
- 🔄 性能和响应时间优化
- 🔄 并发处理优化

### 📋 待开发的核心模块 (0-20%)

#### 1. Telegram机器人集成模块
- **当前状态**: 基础框架已搭建，核心功能待实现
- **缺失功能**:
  - 机器人启动页面和欢迎消息
  - 能量包选择和购买流程
  - 支付地址生成和状态监控
  - 订单状态实时更新
  - 用户注册和认证流程

#### 2. TRON区块链集成模块
- **当前状态**: 技术方案已设计，集成代码待开发
- **缺失功能**:
  - TronWeb SDK集成
  - 钱包管理和私钥安全存储
  - 能量委托合约调用
  - 交易监控和状态同步
  - 地址验证和格式检查

#### 3. 能量池管理系统
- **当前状态**: 数据库表已设计，自动化逻辑待实现
- **缺失功能**:
  - 实时监控和健康检查
  - 自动调度算法
  - 成本优化和利润分析
  - 库存预警和自动补充

#### 4. 支付与交易处理模块
- **当前状态**: 基础架构已搭建，核心逻辑待开发
- **缺失功能**:
  - TRON支付监控服务
  - 订单自动处理流程
  - 风险控制和异常处理
  - 价格计算引擎

### 🎯 业务功能完成度

| 功能模块 | 完成度 | 状态 | 说明 |
|----------|--------|------|------|
| 管理后台 | 98% | ✅ 基本完成 | 126个Vue组件，功能完整，界面现代化 |
| 用户管理 | 95% | ✅ 基本完成 | 用户等级系统完整，大规模界面扩展完成 |
| API架构 | 95% | ✅ 基本完成 | 66+路由文件，完整的TypeScript支持 |
| 测试体系 | 85% | ✅ 基本完成 | Vitest框架，支持UI、覆盖率、单元、集成测试 |
| 订单管理 | 85% | ✅ 基本完成 | 基础流程完整，自动化处理待完善 |
| 代理系统 | 80% | ✅ 基本完成 | 基础功能完整，收益计算待优化 |
| 价格管理 | 85% | ✅ 基本完成 | 配置和模板完整，动态定价待实现 |
| 统计分析 | 90% | ✅ 基本完成 | 数据展示完整，实时更新待优化 |
| 开发工具 | 90% | ✅ 基本完成 | 完整的脚本集合，自动化备份机制 |
| Telegram机器人 | 20% | 🔄 开发中 | 基础框架已搭建，核心功能待开发 |
| TRON区块链集成 | 15% | 📋 待开发 | 技术方案已设计，集成代码待开发 |
| 能量池管理 | 30% | 🔄 开发中 | 数据库设计完整，自动化逻辑待实现 |
| 支付处理 | 25% | 🔄 开发中 | 基础架构已搭建，核心逻辑待开发 |

## 🚨 常见问题

### TypeScript 错误
如果遇到 TypeScript 错误，请：
1. 运行 `pnpm type-check` 查看具体错误
2. 参考 [开发规范指南](./docs/DONE/开发指南.md) 中的常见错误解决方案
3. 使用 `pnpm lint:fix` 自动修复格式问题

### 导入错误
- 类型导入使用 `type` 关键字：`import { type Request } from 'express'`
- 默认导出使用默认导入：`import pool from '../config/database'`
- 用户ID使用 `userId` 而不是 `id`

### 数据库连接问题
1. 确保 PostgreSQL 服务正在运行
2. 检查环境变量配置
3. 运行 `pnpm db:setup` 初始化数据库

### API 登录测试
```bash
# 测试管理员登录
curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tronrental.com","password":"admin123456"}' | jq .
```

## 📖 文档

- [开发规范指南](./docs/DONE/开发指南.md) - 详细的开发规范和最佳实践
- [项目完成报告](./docs/DONE/项目完成报告.md) - 项目开发进度和成果
- [中文注释说明](./docs/DONE/中文注释说明文档.md) - 数据库中文注释使用指南
- [API 测试报告](./docs/DONE/API测试报告.md) - API 功能测试结果
- [N+1查询修复报告](./docs/DONE/N+1查询问题修复报告.md) - 数据库性能优化报告

## 🤝 贡献指南

1. 遵循项目开发规范
2. 提交代码前运行开发检查脚本
3. 使用提供的代码模板
4. 保持代码风格一致
5. 添加适当的中文注释

## 🎉 项目状态

- **开发状态**: 🟢 活跃开发中（大规模扩展阶段）
- **代码质量**: 🟢 优秀 (ESLint + TypeScript + Vue TypeCheck)
- **测试覆盖**: 🟢 完整测试框架 (Vitest + UI + Coverage)
- **文档完整度**: 🟢 完整（DONE目录 + 进度跟踪）
- **数据库注释**: 🟢 100% 中文注释覆盖
- **项目规模**: 🟢 大型项目（300+文件）
- **备份机制**: 🟢 完善的自动化备份
- **最新功能**: 🆕 用户等级管理系统 + 大规模架构扩展

## 📊 项目统计

- **数据库表**: 31个（完全中文注释覆盖）
- **API 路由**: 66个 TypeScript 文件（86个文件总计）
- **前端页面**: 126个 Vue 组件（178个文件总计）
- **迁移文件**: 20+个（包含合并schema）
- **脚本工具**: 多个目录（admin、core、database、development、maintenance）
- **测试框架**: Vitest（支持UI、覆盖率、单元、集成测试）
- **文档**: 完整的DONE目录和TODO清单
- **数据库备份**: 11个时间点备份文件，完善的备份机制

## 🚀 下一步开发重点

### 短期目标 (1-2周)
1. **大规模架构整合** - 整合126个Vue组件和66+API路由的功能
2. **测试覆盖率完善** - 利用完整的Vitest测试框架提升覆盖率
3. **系统性能优化** - 大规模代码的缓存策略和响应时间优化
4. **开发流程标准化** - 完善备份、检查、部署脚本

### 中期目标 (1-2月)
1. **Telegram机器人核心功能** - 用户注册、能量购买、订单管理
2. **TRON区块链集成** - 钱包管理、能量委托、交易监控
3. **能量池自动化** - 智能调度、成本优化、库存管理

### 长期目标 (3-6月)
1. **完整业务流程** - 从机器人下单到能量委托的完整闭环
2. **生产环境部署** - 系统稳定性和安全性优化
3. **用户规模扩展** - 支持更多用户和更高并发

---

**记住**：遵循规范可以避免大部分错误，提高开发效率！

> 💡 **提示**: 使用 `pnpm restart` 可以快速重启开发服务器，使用 `pnpm check` 进行类型检查。
> 🚀 **重大更新**: 项目规模大幅扩展！126个Vue组件，66+API路由，完整测试框架！
> 📋 **开发重点**: 大规模架构整合优化，然后继续开发Telegram机器人和TRON区块链集成模块！
> ⚠️ **重要**: 修改代码前必须运行 `./scripts/database/backup-database.sh` 进行数据库备份！
